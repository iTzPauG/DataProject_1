[0m15:32:36.454684 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F293F0AC50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F296208AF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F296208910>]}


============================== 15:32:36.461207 | 879b74a6-ebbc-4308-8f2b-1a48fe0fc747 ==============================
[0m15:32:36.461207 [info ] [MainThread]: Running with dbt=1.10.15
[0m15:32:36.462204 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'log_format': 'default', 'printer_width': '80', 'no_print': 'None', 'invocation_command': 'dbt debug', 'warn_error': 'None', 'log_path': 'logs', 'partial_parse': 'True', 'fail_fast': 'False', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'indirect_selection': 'eager', 'version_check': 'True', 'use_experimental_parser': 'False', 'quiet': 'False', 'introspect': 'True', 'empty': 'None', 'log_cache_events': 'False', 'debug': 'False', 'profiles_dir': 'C:\\Users\\gbala\\OneDrive\\Escritorio\\MÃ¡ster Big Data\\apis\\DataProject_1', 'use_colors': 'True', 'cache_selected_only': 'False', 'write_json': 'True'}
[0m15:32:36.501905 [info ] [MainThread]: dbt version: 1.10.15
[0m15:32:36.502906 [info ] [MainThread]: python version: 3.10.11
[0m15:32:36.503911 [info ] [MainThread]: python path: C:\Users\gbala\AppData\Local\Programs\Python\Python310\python.exe
[0m15:32:36.504904 [info ] [MainThread]: os info: Windows-10-10.0.26200-SP0
[0m15:32:36.504904 [error] [MainThread]: Encountered an error:
[Errno 13] Permission denied: 'C:\\Users\\gbala\\OneDrive\\Escritorio\\MÃ¡ster Big Data\\apis\\DataProject_1\\profiles.yml'
[0m15:32:36.506905 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\cli\requires.py", line 178, in wrapper
    result, success = func(*args, **kwargs)
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\cli\requires.py", line 128, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\cli\main.py", line 420, in debug
    results = task.run()
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\task\debug.py", line 114, in run
    load_profile_status: SubtaskStatus = self._load_profile()
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\task\debug.py", line 195, in _load_profile
    dbt_common.clients.system.load_file_contents(self.profile_path)
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt_common\record.py", line 538, in record_replay_wrapper
    return func_to_record(*call_args, **kwargs)
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt_common\clients\system.py", line 182, in load_file_contents
    with open(path, "rb") as handle:
PermissionError: [Errno 13] Permission denied: 'C:\\Users\\gbala\\OneDrive\\Escritorio\\MÃ¡ster Big Data\\apis\\DataProject_1\\profiles.yml'

[0m15:32:36.509425 [debug] [MainThread]: Command `dbt debug` failed at 15:32:36.509425 after 0.25 seconds
[0m15:32:36.510428 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F293F0AC50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F296208820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F296207A00>]}
[0m15:32:36.510428 [debug] [MainThread]: Flushing usage events
[0m15:32:37.297013 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:33:42.306894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C08AF0AC80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C08D208B20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C08D208940>]}


============================== 15:33:42.311894 | d131ef89-fac4-4c60-93c1-f5a39b6f270a ==============================
[0m15:33:42.311894 [info ] [MainThread]: Running with dbt=1.10.15
[0m15:33:42.314400 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'use_colors': 'True', 'printer_width': '80', 'no_print': 'None', 'target_path': 'None', 'warn_error': 'None', 'static_parser': 'True', 'partial_parse': 'True', 'log_path': 'logs', 'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'indirect_selection': 'eager', 'version_check': 'True', 'use_experimental_parser': 'False', 'quiet': 'False', 'introspect': 'True', 'empty': 'None', 'log_cache_events': 'False', 'debug': 'False', 'profiles_dir': 'C:\\Users\\gbala\\OneDrive\\Escritorio\\MÃ¡ster Big Data\\apis\\DataProject_1', 'invocation_command': 'dbt debug', 'cache_selected_only': 'False', 'write_json': 'True'}
[0m15:33:42.331833 [info ] [MainThread]: dbt version: 1.10.15
[0m15:33:42.332832 [info ] [MainThread]: python version: 3.10.11
[0m15:33:42.333832 [info ] [MainThread]: python path: C:\Users\gbala\AppData\Local\Programs\Python\Python310\python.exe
[0m15:33:42.335334 [info ] [MainThread]: os info: Windows-10-10.0.26200-SP0
[0m15:33:42.335334 [error] [MainThread]: Encountered an error:
[Errno 13] Permission denied: 'C:\\Users\\gbala\\OneDrive\\Escritorio\\MÃ¡ster Big Data\\apis\\DataProject_1\\profiles.yml'
[0m15:33:42.339338 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\cli\requires.py", line 178, in wrapper
    result, success = func(*args, **kwargs)
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\cli\requires.py", line 128, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\cli\main.py", line 420, in debug
    results = task.run()
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\task\debug.py", line 114, in run
    load_profile_status: SubtaskStatus = self._load_profile()
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\task\debug.py", line 195, in _load_profile
    dbt_common.clients.system.load_file_contents(self.profile_path)
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt_common\record.py", line 538, in record_replay_wrapper
    return func_to_record(*call_args, **kwargs)
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt_common\clients\system.py", line 182, in load_file_contents
    with open(path, "rb") as handle:
PermissionError: [Errno 13] Permission denied: 'C:\\Users\\gbala\\OneDrive\\Escritorio\\MÃ¡ster Big Data\\apis\\DataProject_1\\profiles.yml'

[0m15:33:42.340337 [debug] [MainThread]: Command `dbt debug` failed at 15:33:42.340337 after 0.22 seconds
[0m15:33:42.341338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C08AF0AC80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C08D208850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C08D207A00>]}
[0m15:33:42.341338 [debug] [MainThread]: Flushing usage events
[0m15:33:43.140781 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:34:32.782202 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C4335AC20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C45656F80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C45656DA0>]}


============================== 15:34:32.791866 | dfe32839-0c13-44a2-8f3f-cf49ec2cbc53 ==============================
[0m15:34:32.791866 [info ] [MainThread]: Running with dbt=1.10.15
[0m15:34:32.792866 [debug] [MainThread]: running dbt with arguments {'write_json': 'True', 'log_format': 'default', 'printer_width': '80', 'profiles_dir': 'C:\\Users\\gbala\\OneDrive\\Escritorio\\MÃ¡ster Big Data\\apis\\DataProject_1', 'invocation_command': 'dbt run', 'warn_error': 'None', 'static_parser': 'True', 'partial_parse': 'True', 'indirect_selection': 'eager', 'send_anonymous_usage_stats': 'True', 'log_path': 'logs', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'fail_fast': 'False', 'version_check': 'True', 'use_experimental_parser': 'False', 'introspect': 'True', 'quiet': 'False', 'empty': 'False', 'log_cache_events': 'False', 'debug': 'False', 'no_print': 'None', 'use_colors': 'True', 'cache_selected_only': 'False', 'target_path': 'None'}
[0m15:34:32.794871 [error] [MainThread]: Encountered an error:
Runtime Error
  No dbt_project.yml found at expected path C:\Users\gbala\OneDrive\Escritorio\MÃ¡ster Big Data\apis\DataProject_1\dbt\dbt_project.yml
  Verify that each entry within packages.yml (and their transitive dependencies) contains a file named dbt_project.yml
  
[0m15:34:32.795915 [debug] [MainThread]: Command `dbt run` failed at 15:34:32.795915 after 0.21 seconds
[0m15:34:32.796913 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C4335AC20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C45656DA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022C45657040>]}
[0m15:34:32.797908 [debug] [MainThread]: Flushing usage events
[0m15:34:33.719172 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:36:00.746296 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029C8E9AABF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029C90C9CA90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029C90C9C8B0>]}


============================== 15:36:00.754838 | 900cef32-bdab-4ed8-a097-a0f7076d47b6 ==============================
[0m15:36:00.754838 [info ] [MainThread]: Running with dbt=1.10.15
[0m15:36:00.756835 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'no_print': 'None', 'use_colors': 'True', 'printer_width': '80', 'write_json': 'True', 'warn_error': 'None', 'static_parser': 'True', 'partial_parse': 'True', 'indirect_selection': 'eager', 'send_anonymous_usage_stats': 'True', 'log_path': 'logs', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'fail_fast': 'False', 'use_experimental_parser': 'False', 'version_check': 'True', 'quiet': 'False', 'introspect': 'True', 'empty': 'None', 'log_cache_events': 'False', 'debug': 'False', 'profiles_dir': 'C:\\Users\\gbala\\OneDrive\\Escritorio\\MÃ¡ster Big Data\\apis\\DataProject_1', 'invocation_command': 'dbt debug', 'cache_selected_only': 'False', 'target_path': 'None'}
[0m15:36:00.788665 [info ] [MainThread]: dbt version: 1.10.15
[0m15:36:00.790424 [info ] [MainThread]: python version: 3.10.11
[0m15:36:00.791697 [info ] [MainThread]: python path: C:\Users\gbala\AppData\Local\Programs\Python\Python310\python.exe
[0m15:36:00.793498 [info ] [MainThread]: os info: Windows-10-10.0.26200-SP0
[0m15:36:00.796161 [error] [MainThread]: Encountered an error:
[Errno 13] Permission denied: 'C:\\Users\\gbala\\OneDrive\\Escritorio\\MÃ¡ster Big Data\\apis\\DataProject_1\\profiles.yml'
[0m15:36:00.800495 [error] [MainThread]: Traceback (most recent call last):
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\cli\requires.py", line 178, in wrapper
    result, success = func(*args, **kwargs)
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\cli\requires.py", line 128, in wrapper
    return func(*args, **kwargs)
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\cli\main.py", line 420, in debug
    results = task.run()
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\task\debug.py", line 114, in run
    load_profile_status: SubtaskStatus = self._load_profile()
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt\task\debug.py", line 195, in _load_profile
    dbt_common.clients.system.load_file_contents(self.profile_path)
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt_common\record.py", line 538, in record_replay_wrapper
    return func_to_record(*call_args, **kwargs)
  File "C:\Users\gbala\AppData\Local\Programs\Python\Python310\lib\site-packages\dbt_common\clients\system.py", line 182, in load_file_contents
    with open(path, "rb") as handle:
PermissionError: [Errno 13] Permission denied: 'C:\\Users\\gbala\\OneDrive\\Escritorio\\MÃ¡ster Big Data\\apis\\DataProject_1\\profiles.yml'

[0m15:36:00.803501 [debug] [MainThread]: Command `dbt debug` failed at 15:36:00.802496 after 0.26 seconds
[0m15:36:00.803501 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029C8E9AABF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029C90C9C7C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029C90CA3A00>]}
[0m15:36:00.805882 [debug] [MainThread]: Flushing usage events
[0m15:36:01.481056 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:02:31.562387 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70184def2310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7018506df790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70184defe7d0>]}


============================== 22:02:31.569161 | 1d3776c5-a37f-4205-a4f2-14067f24bf8b ==============================
[0m22:02:31.569161 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:02:31.571739 [debug] [MainThread]: running dbt with arguments {'log_path': '/usr/app/dbt/dbt/logs', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None', 'version_check': 'True', 'empty': 'False', 'target_path': 'None', 'profiles_dir': '/usr/app/dbt/dbt', 'indirect_selection': 'eager', 'log_format': 'default', 'invocation_command': 'dbt run', 'debug': 'False', 'introspect': 'True', 'write_json': 'True', 'no_print': 'None', 'printer_width': '80', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'quiet': 'False', 'use_colors': 'True', 'partial_parse': 'True', 'use_experimental_parser': 'False', 'log_cache_events': 'False', 'fail_fast': 'False', 'cache_selected_only': 'False'}
[0m22:02:31.600516 [error] [MainThread]: Encountered an error:
Runtime Error
  dbt cannot run because no profile was specified for this dbt project.
  To specify a profile for this project, add a line like the this to
  your dbt_project.yml file:
  
  profile: [profile name]
  
  Here, [profile name] should be replaced with a profile name
  defined in your profiles.yml file. You can find profiles.yml here:
  
  /usr/app/dbt/dbt/profiles.yml
  
[0m22:02:31.605048 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.10927596, "process_in_blocks": "0", "process_kernel_time": 0.519203, "process_mem_max_rss": "104224", "process_out_blocks": "0", "process_user_time": 1.194168}
[0m22:02:31.606970 [debug] [MainThread]: Command `dbt run` failed at 22:02:31.606829 after 0.11 seconds
[0m22:02:31.608395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7018526f6e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70184def0bd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70184e013790>]}
[0m22:02:31.609769 [debug] [MainThread]: Flushing usage events
[0m22:02:32.265318 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:02:34.750041 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af4554e4810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af4554e4790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af4554e4a50>]}


============================== 22:02:34.756485 | d6640e8f-1d2a-4194-92c6-e37f9db280b3 ==============================
[0m22:02:34.756485 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:02:34.758401 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'partial_parse': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'quiet': 'False', 'invocation_command': 'dbt run', 'cache_selected_only': 'False', 'fail_fast': 'False', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'debug': 'False', 'introspect': 'True', 'use_colors': 'True', 'log_cache_events': 'False', 'static_parser': 'True', 'warn_error': 'None', 'log_format': 'default', 'printer_width': '80', 'indirect_selection': 'eager', 'version_check': 'True', 'target_path': 'None', 'write_json': 'True', 'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])'}
[0m22:02:34.771281 [error] [MainThread]: Encountered an error:
Runtime Error
  dbt cannot run because no profile was specified for this dbt project.
  To specify a profile for this project, add a line like the this to
  your dbt_project.yml file:
  
  profile: [profile name]
  
  Here, [profile name] should be replaced with a profile name
  defined in your profiles.yml file. You can find profiles.yml here:
  
  /usr/app/dbt/dbt/profiles.yml
  
[0m22:02:34.773356 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.10074192, "process_in_blocks": "0", "process_kernel_time": 0.393414, "process_mem_max_rss": "104052", "process_out_blocks": "0", "process_user_time": 1.334187}
[0m22:02:34.775204 [debug] [MainThread]: Command `dbt run` failed at 22:02:34.775015 after 0.10 seconds
[0m22:02:34.776603 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af455151310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af455152610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af4551abf10>]}
[0m22:02:34.777707 [debug] [MainThread]: Flushing usage events
[0m22:02:35.636031 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:02:37.752182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x701e33e2a1d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x701e33ee3b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x701e33e35cd0>]}


============================== 22:02:37.759529 | 017c86e6-5e3e-4418-b17f-427a7cb13e64 ==============================
[0m22:02:37.759529 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:02:37.761861 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'cache_selected_only': 'False', 'log_cache_events': 'False', 'target_path': 'None', 'debug': 'False', 'introspect': 'True', 'invocation_command': 'dbt run', 'partial_parse': 'True', 'version_check': 'True', 'empty': 'False', 'quiet': 'False', 'write_json': 'True', 'indirect_selection': 'eager', 'static_parser': 'True', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'log_format': 'default', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_colors': 'True', 'fail_fast': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'no_print': 'None'}
[0m22:02:37.773321 [error] [MainThread]: Encountered an error:
Runtime Error
  dbt cannot run because no profile was specified for this dbt project.
  To specify a profile for this project, add a line like the this to
  your dbt_project.yml file:
  
  profile: [profile name]
  
  Here, [profile name] should be replaced with a profile name
  defined in your profiles.yml file. You can find profiles.yml here:
  
  /usr/app/dbt/dbt/profiles.yml
  
[0m22:02:37.775461 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.10659985, "process_in_blocks": "0", "process_kernel_time": 0.292774, "process_mem_max_rss": "103932", "process_out_blocks": "0", "process_user_time": 1.078853}
[0m22:02:37.777233 [debug] [MainThread]: Command `dbt run` failed at 22:02:37.777015 after 0.11 seconds
[0m22:02:37.778647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x701e33e35cd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x701e33dd4890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x701e33e28e90>]}
[0m22:02:37.779903 [debug] [MainThread]: Flushing usage events
[0m22:02:38.499198 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:02:40.772979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706ad16ce250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706ad1ae3450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706ad1ae0990>]}


============================== 22:02:40.778634 | cb61047c-b745-4c5b-8cc7-a082c8b14198 ==============================
[0m22:02:40.778634 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:02:40.779692 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'write_json': 'True', 'partial_parse': 'True', 'log_format': 'default', 'no_print': 'None', 'fail_fast': 'False', 'introspect': 'True', 'log_cache_events': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'printer_width': '80', 'quiet': 'False', 'cache_selected_only': 'False', 'warn_error': 'None', 'indirect_selection': 'eager', 'use_colors': 'True', 'static_parser': 'True', 'version_check': 'True', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'invocation_command': 'dbt run', 'profiles_dir': '/usr/app/dbt/dbt'}
[0m22:02:40.787378 [error] [MainThread]: Encountered an error:
Runtime Error
  dbt cannot run because no profile was specified for this dbt project.
  To specify a profile for this project, add a line like the this to
  your dbt_project.yml file:
  
  profile: [profile name]
  
  Here, [profile name] should be replaced with a profile name
  defined in your profiles.yml file. You can find profiles.yml here:
  
  /usr/app/dbt/dbt/profiles.yml
  
[0m22:02:40.789206 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.078284286, "process_in_blocks": "0", "process_kernel_time": 0.339181, "process_mem_max_rss": "104184", "process_out_blocks": "0", "process_user_time": 0.973651}
[0m22:02:40.790145 [debug] [MainThread]: Command `dbt run` failed at 22:02:40.790055 after 0.08 seconds
[0m22:02:40.790956 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706ad5ed2d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706ad16ccb90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x706ad16cfe50>]}
[0m22:02:40.791716 [debug] [MainThread]: Flushing usage events
[0m22:02:41.584249 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:02:44.274610 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b5d223aa3d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b5d226b47d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b5d226b4710>]}


============================== 22:02:44.284477 | edf0d116-2e21-4803-a1fc-6a021ecd2719 ==============================
[0m22:02:44.284477 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:02:44.288407 [debug] [MainThread]: running dbt with arguments {'warn_error': 'None', 'use_experimental_parser': 'False', 'static_parser': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'printer_width': '80', 'no_print': 'None', 'log_cache_events': 'False', 'write_json': 'True', 'fail_fast': 'False', 'target_path': 'None', 'empty': 'False', 'send_anonymous_usage_stats': 'True', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'indirect_selection': 'eager', 'introspect': 'True', 'log_format': 'default', 'version_check': 'True', 'use_colors': 'True', 'cache_selected_only': 'False', 'quiet': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'debug': 'False'}
[0m22:02:44.308129 [error] [MainThread]: Encountered an error:
Runtime Error
  dbt cannot run because no profile was specified for this dbt project.
  To specify a profile for this project, add a line like the this to
  your dbt_project.yml file:
  
  profile: [profile name]
  
  Here, [profile name] should be replaced with a profile name
  defined in your profiles.yml file. You can find profiles.yml here:
  
  /usr/app/dbt/dbt/profiles.yml
  
[0m22:02:44.314224 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.13790442, "process_in_blocks": "0", "process_kernel_time": 0.329933, "process_mem_max_rss": "104192", "process_out_blocks": "0", "process_user_time": 0.942099}
[0m22:02:44.316722 [debug] [MainThread]: Command `dbt run` failed at 22:02:44.316593 after 0.14 seconds
[0m22:02:44.318129 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b5d226b4710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b5d226b4490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b5d223a3fd0>]}
[0m22:02:44.320145 [debug] [MainThread]: Flushing usage events
[0m22:02:45.047304 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:02:48.614274 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a052db7cbd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a052db48f90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a052db496d0>]}


============================== 22:02:48.622981 | 570e3782-600f-4622-9cd2-56c78fb791aa ==============================
[0m22:02:48.622981 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:02:48.626589 [debug] [MainThread]: running dbt with arguments {'use_colors': 'True', 'write_json': 'True', 'warn_error': 'None', 'empty': 'False', 'static_parser': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'quiet': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'no_print': 'None', 'version_check': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'printer_width': '80', 'fail_fast': 'False', 'use_experimental_parser': 'False', 'log_format': 'default', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'debug': 'False', 'introspect': 'True', 'cache_selected_only': 'False'}
[0m22:02:48.637684 [error] [MainThread]: Encountered an error:
Runtime Error
  dbt cannot run because no profile was specified for this dbt project.
  To specify a profile for this project, add a line like the this to
  your dbt_project.yml file:
  
  profile: [profile name]
  
  Here, [profile name] should be replaced with a profile name
  defined in your profiles.yml file. You can find profiles.yml here:
  
  /usr/app/dbt/dbt/profiles.yml
  
[0m22:02:48.639154 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.09573463, "process_in_blocks": "0", "process_kernel_time": 0.325589, "process_mem_max_rss": "104192", "process_out_blocks": "0", "process_user_time": 1.0652}
[0m22:02:48.640982 [debug] [MainThread]: Command `dbt run` failed at 22:02:48.640761 after 0.10 seconds
[0m22:02:48.642959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a052db8a950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a052db7de10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a052deb8d90>]}
[0m22:02:48.644026 [debug] [MainThread]: Flushing usage events
[0m22:02:49.455610 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:02:54.645763 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x768a295ca750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x768a295955d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x768a29594490>]}


============================== 22:02:54.654471 | 183ab491-0576-4042-a127-e2e1c9f24ae4 ==============================
[0m22:02:54.654471 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:02:54.656520 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'log_cache_events': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'send_anonymous_usage_stats': 'True', 'empty': 'False', 'version_check': 'True', 'quiet': 'False', 'log_format': 'default', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'no_print': 'None', 'profiles_dir': '/usr/app/dbt/dbt', 'static_parser': 'True', 'printer_width': '80', 'invocation_command': 'dbt run', 'target_path': 'None', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'write_json': 'True', 'introspect': 'True', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True'}
[0m22:02:54.669556 [error] [MainThread]: Encountered an error:
Runtime Error
  dbt cannot run because no profile was specified for this dbt project.
  To specify a profile for this project, add a line like the this to
  your dbt_project.yml file:
  
  profile: [profile name]
  
  Here, [profile name] should be replaced with a profile name
  defined in your profiles.yml file. You can find profiles.yml here:
  
  /usr/app/dbt/dbt/profiles.yml
  
[0m22:02:54.671917 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.13827485, "process_in_blocks": "0", "process_kernel_time": 0.278324, "process_mem_max_rss": "103908", "process_out_blocks": "0", "process_user_time": 1.057633}
[0m22:02:54.673501 [debug] [MainThread]: Command `dbt run` failed at 22:02:54.673302 after 0.14 seconds
[0m22:02:54.674632 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x768a299d0410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x768a295ca4d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x768a295cbf50>]}
[0m22:02:54.675896 [debug] [MainThread]: Flushing usage events
[0m22:02:55.399825 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:03:03.849650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b387db4d790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b3880887810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b387db9e810>]}


============================== 22:03:03.855383 | 3b25f55d-eae3-474c-92bc-f5a1622c1aa8 ==============================
[0m22:03:03.855383 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:03:03.858184 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'introspect': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'version_check': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'log_format': 'default', 'static_parser': 'True', 'warn_error': 'None', 'partial_parse': 'True', 'printer_width': '80', 'empty': 'False', 'no_print': 'None', 'log_cache_events': 'False', 'write_json': 'True', 'indirect_selection': 'eager', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'target_path': 'None', 'use_colors': 'True', 'send_anonymous_usage_stats': 'True', 'invocation_command': 'dbt run', 'fail_fast': 'False', 'use_experimental_parser': 'False', 'debug': 'False', 'quiet': 'False'}
[0m22:03:03.867870 [error] [MainThread]: Encountered an error:
Runtime Error
  dbt cannot run because no profile was specified for this dbt project.
  To specify a profile for this project, add a line like the this to
  your dbt_project.yml file:
  
  profile: [profile name]
  
  Here, [profile name] should be replaced with a profile name
  defined in your profiles.yml file. You can find profiles.yml here:
  
  /usr/app/dbt/dbt/profiles.yml
  
[0m22:03:03.870039 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.095092185, "process_in_blocks": "0", "process_kernel_time": 0.402365, "process_mem_max_rss": "104428", "process_out_blocks": "0", "process_user_time": 1.119452}
[0m22:03:03.872017 [debug] [MainThread]: Command `dbt run` failed at 22:03:03.871906 after 0.10 seconds
[0m22:03:03.873142 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b388238ed90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b387dd978d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b387e150a50>]}
[0m22:03:03.876045 [debug] [MainThread]: Flushing usage events
[0m22:03:04.514238 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:03:19.256673 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ffdadbdad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ffdad88550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ffdad89250>]}


============================== 22:03:19.263966 | 469f5da1-441e-4d8a-8ce4-2ecd45592223 ==============================
[0m22:03:19.263966 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:03:19.266267 [debug] [MainThread]: running dbt with arguments {'version_check': 'True', 'invocation_command': 'dbt run', 'log_cache_events': 'False', 'fail_fast': 'False', 'no_print': 'None', 'printer_width': '80', 'cache_selected_only': 'False', 'indirect_selection': 'eager', 'static_parser': 'True', 'empty': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'debug': 'False', 'introspect': 'True', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'profiles_dir': '/usr/app/dbt/dbt', 'target_path': 'None', 'partial_parse': 'True', 'write_json': 'True', 'use_experimental_parser': 'False', 'warn_error': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'use_colors': 'True'}
[0m22:03:19.283123 [error] [MainThread]: Encountered an error:
Runtime Error
  dbt cannot run because no profile was specified for this dbt project.
  To specify a profile for this project, add a line like the this to
  your dbt_project.yml file:
  
  profile: [profile name]
  
  Here, [profile name] should be replaced with a profile name
  defined in your profiles.yml file. You can find profiles.yml here:
  
  /usr/app/dbt/dbt/profiles.yml
  
[0m22:03:19.285883 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.101348504, "process_in_blocks": "0", "process_kernel_time": 0.329696, "process_mem_max_rss": "103924", "process_out_blocks": "0", "process_user_time": 1.088397}
[0m22:03:19.290251 [debug] [MainThread]: Command `dbt run` failed at 22:03:19.289983 after 0.11 seconds
[0m22:03:19.292076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ffdf5d2e90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ffdadbe3d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ffdad89210>]}
[0m22:03:19.293755 [debug] [MainThread]: Flushing usage events
[0m22:03:19.964253 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:03:47.831345 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c36714ea210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c3672359b10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c36714e2410>]}


============================== 22:03:47.842672 | 18565f1c-d574-462a-a9b7-dc259aefeaf2 ==============================
[0m22:03:47.842672 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:03:47.845121 [debug] [MainThread]: running dbt with arguments {'quiet': 'False', 'send_anonymous_usage_stats': 'True', 'use_colors': 'True', 'log_cache_events': 'False', 'version_check': 'True', 'cache_selected_only': 'False', 'debug': 'False', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'empty': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'use_experimental_parser': 'False', 'indirect_selection': 'eager', 'target_path': 'None', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'no_print': 'None', 'introspect': 'True', 'fail_fast': 'False', 'warn_error': 'None', 'printer_width': '80', 'profiles_dir': '/usr/app/dbt/dbt', 'write_json': 'True'}
[0m22:03:47.858920 [error] [MainThread]: Encountered an error:
Runtime Error
  dbt cannot run because no profile was specified for this dbt project.
  To specify a profile for this project, add a line like the this to
  your dbt_project.yml file:
  
  profile: [profile name]
  
  Here, [profile name] should be replaced with a profile name
  defined in your profiles.yml file. You can find profiles.yml here:
  
  /usr/app/dbt/dbt/profiles.yml
  
[0m22:03:47.862726 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.101612315, "process_in_blocks": "0", "process_kernel_time": 0.397136, "process_mem_max_rss": "103556", "process_out_blocks": "0", "process_user_time": 1.159638}
[0m22:03:47.865581 [debug] [MainThread]: Command `dbt run` failed at 22:03:47.865443 after 0.10 seconds
[0m22:03:47.866544 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c3675ceec50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c3671492250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c3675db2b90>]}
[0m22:03:47.867611 [debug] [MainThread]: Flushing usage events
[0m22:03:48.744994 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:04:42.102625 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742bd34c70d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742bd0761ad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742bd0762ad0>]}


============================== 22:04:42.115716 | a729b193-19e3-41b5-aca1-2b2305ad51f1 ==============================
[0m22:04:42.115716 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:04:42.119543 [debug] [MainThread]: running dbt with arguments {'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'empty': 'False', 'fail_fast': 'False', 'target_path': 'None', 'cache_selected_only': 'False', 'static_parser': 'True', 'quiet': 'False', 'warn_error': 'None', 'introspect': 'True', 'printer_width': '80', 'profiles_dir': '/usr/app/dbt/dbt', 'no_print': 'None', 'version_check': 'True', 'use_experimental_parser': 'False', 'use_colors': 'True', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True', 'log_format': 'default', 'debug': 'False', 'log_cache_events': 'False', 'indirect_selection': 'eager', 'partial_parse': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'write_json': 'True'}
[0m22:04:42.293151 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:04:42.295628 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'a729b193-19e3-41b5-aca1-2b2305ad51f1', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742bd0780fd0>]}
[0m22:04:42.397334 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a729b193-19e3-41b5-aca1-2b2305ad51f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742bcff18f50>]}
[0m22:04:42.450611 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a729b193-19e3-41b5-aca1-2b2305ad51f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742bd34de6d0>]}
[0m22:04:42.453298 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:04:42.778613 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:04:42.825387 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:04:42.830250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'a729b193-19e3-41b5-aca1-2b2305ad51f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742bcfb9e3d0>]}
[0m22:04:46.130124 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:04:46.133069 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:04:46.136305 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 4.1923976, "process_in_blocks": "1472", "process_kernel_time": 0.596056, "process_mem_max_rss": "118196", "process_out_blocks": "0", "process_user_time": 2.3882}
[0m22:04:46.138482 [debug] [MainThread]: Command `dbt run` failed at 22:04:46.138374 after 4.19 seconds
[0m22:04:46.141613 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742bd4fcae50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742bd4fcae90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742bcfbc1190>]}
[0m22:04:46.144064 [debug] [MainThread]: Flushing usage events
[0m22:04:46.820961 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:05:21.785469 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x790fc47fa110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x790fc47f9c50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x790fc47abe50>]}


============================== 22:05:21.794015 | 9e83294b-fcf4-48b5-948d-a3838293ed42 ==============================
[0m22:05:21.794015 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:05:21.795576 [debug] [MainThread]: running dbt with arguments {'use_experimental_parser': 'False', 'log_cache_events': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'static_parser': 'True', 'quiet': 'False', 'fail_fast': 'False', 'log_format': 'default', 'indirect_selection': 'eager', 'no_print': 'None', 'use_colors': 'True', 'write_json': 'True', 'debug': 'False', 'warn_error': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'empty': 'False', 'invocation_command': 'dbt run', 'partial_parse': 'True', 'target_path': 'None', 'profiles_dir': '/usr/app/dbt/dbt', 'cache_selected_only': 'False', 'send_anonymous_usage_stats': 'True', 'version_check': 'True', 'introspect': 'True', 'printer_width': '80'}
[0m22:05:21.860203 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:05:21.861890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '9e83294b-fcf4-48b5-948d-a3838293ed42', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x790fc47a5610>]}
[0m22:05:21.942787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9e83294b-fcf4-48b5-948d-a3838293ed42', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x790fc3b5c750>]}
[0m22:05:21.985941 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9e83294b-fcf4-48b5-948d-a3838293ed42', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x790fc750a910>]}
[0m22:05:21.988831 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:05:22.137366 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:05:22.161171 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:05:22.162872 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '9e83294b-fcf4-48b5-948d-a3838293ed42', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x790fc37d86d0>]}
[0m22:05:25.262452 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:05:25.265084 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:05:25.268715 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.5570295, "process_in_blocks": "0", "process_kernel_time": 0.617405, "process_mem_max_rss": "117528", "process_out_blocks": "0", "process_user_time": 2.325293}
[0m22:05:25.271526 [debug] [MainThread]: Command `dbt run` failed at 22:05:25.271301 after 3.56 seconds
[0m22:05:25.273231 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x790fc4805f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x790fc4806110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x790fc49fb050>]}
[0m22:05:25.274891 [debug] [MainThread]: Flushing usage events
[0m22:05:26.018153 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:05:28.201642 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75cfb0001bd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75cfb111b0d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75cfb00a7c50>]}


============================== 22:05:28.209111 | 5069d877-4360-4532-8964-c705edb1515e ==============================
[0m22:05:28.209111 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:05:28.211384 [debug] [MainThread]: running dbt with arguments {'profiles_dir': '/usr/app/dbt/dbt', 'log_format': 'default', 'printer_width': '80', 'log_cache_events': 'False', 'debug': 'False', 'write_json': 'True', 'empty': 'False', 'partial_parse': 'True', 'indirect_selection': 'eager', 'introspect': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'use_colors': 'True', 'send_anonymous_usage_stats': 'True', 'no_print': 'None', 'fail_fast': 'False', 'version_check': 'True', 'quiet': 'False', 'cache_selected_only': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'static_parser': 'True', 'invocation_command': 'dbt run', 'use_experimental_parser': 'False', 'warn_error': 'None', 'target_path': 'None'}
[0m22:05:28.271944 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:05:28.273658 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '5069d877-4360-4532-8964-c705edb1515e', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75cfb0003bd0>]}
[0m22:05:28.348314 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5069d877-4360-4532-8964-c705edb1515e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75cfaf312850>]}
[0m22:05:28.404327 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5069d877-4360-4532-8964-c705edb1515e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75cfb2d14850>]}
[0m22:05:28.409962 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:05:28.562639 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:05:28.579080 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:05:28.580339 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '5069d877-4360-4532-8964-c705edb1515e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75cfaff9c850>]}
[0m22:05:30.967511 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:05:30.969589 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:05:30.971134 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.8367815, "process_in_blocks": "0", "process_kernel_time": 0.546657, "process_mem_max_rss": "117664", "process_out_blocks": "0", "process_user_time": 2.272301}
[0m22:05:30.972218 [debug] [MainThread]: Command `dbt run` failed at 22:05:30.972138 after 2.84 seconds
[0m22:05:30.973324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75cfb4806e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75cfb0408290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75cfaf368f90>]}
[0m22:05:30.974240 [debug] [MainThread]: Flushing usage events
[0m22:05:31.768386 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:05:33.940586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74bcf7436350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74bcf829e050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74bcf7788a90>]}


============================== 22:05:33.946888 | fff85a4c-5170-4143-8adc-499e520ef92e ==============================
[0m22:05:33.946888 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:05:33.948865 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'partial_parse': 'True', 'target_path': 'None', 'printer_width': '80', 'introspect': 'True', 'use_experimental_parser': 'False', 'cache_selected_only': 'False', 'static_parser': 'True', 'write_json': 'True', 'quiet': 'False', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'indirect_selection': 'eager', 'warn_error': 'None', 'log_cache_events': 'False', 'invocation_command': 'dbt run', 'use_colors': 'True', 'fail_fast': 'False', 'version_check': 'True', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/app/dbt/dbt/logs', 'empty': 'False'}
[0m22:05:34.006447 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:05:34.008112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'fff85a4c-5170-4143-8adc-499e520ef92e', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74bcf73e7ed0>]}
[0m22:05:34.079999 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fff85a4c-5170-4143-8adc-499e520ef92e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74bcf65462d0>]}
[0m22:05:34.123215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fff85a4c-5170-4143-8adc-499e520ef92e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74bcfa144690>]}
[0m22:05:34.126234 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:05:34.343464 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:05:34.431837 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:05:34.433368 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'fff85a4c-5170-4143-8adc-499e520ef92e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74bcf65ab2d0>]}
[0m22:05:37.004150 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:05:37.006098 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:05:37.008559 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.1499603, "process_in_blocks": "0", "process_kernel_time": 0.572933, "process_mem_max_rss": "117640", "process_out_blocks": "0", "process_user_time": 2.167533}
[0m22:05:37.010015 [debug] [MainThread]: Command `dbt run` failed at 22:05:37.009803 after 3.15 seconds
[0m22:05:37.011324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74bcf73e1250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74bcf51e9850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74bcf75e0b10>]}
[0m22:05:37.012894 [debug] [MainThread]: Flushing usage events
[0m22:05:37.905384 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:05:40.272383 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7b874ae50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7b8880110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7b874a690>]}


============================== 22:05:40.285001 | 6bd2f5bc-6434-49a6-90ee-cc303ca17b51 ==============================
[0m22:05:40.285001 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:05:40.287379 [debug] [MainThread]: running dbt with arguments {'static_parser': 'True', 'debug': 'False', 'quiet': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'log_cache_events': 'False', 'use_experimental_parser': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'partial_parse': 'True', 'use_colors': 'True', 'target_path': 'None', 'log_format': 'default', 'invocation_command': 'dbt run', 'introspect': 'True', 'empty': 'False', 'send_anonymous_usage_stats': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'version_check': 'True', 'no_print': 'None', 'write_json': 'True', 'warn_error': 'None', 'indirect_selection': 'eager', 'fail_fast': 'False', 'printer_width': '80', 'cache_selected_only': 'False'}
[0m22:05:40.353261 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:05:40.355225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '6bd2f5bc-6434-49a6-90ee-cc303ca17b51', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7b87a1950>]}
[0m22:05:40.424371 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6bd2f5bc-6434-49a6-90ee-cc303ca17b51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7b7bca890>]}
[0m22:05:40.490012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6bd2f5bc-6434-49a6-90ee-cc303ca17b51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7bb44ab90>]}
[0m22:05:40.492626 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:05:40.646290 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:05:40.679001 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:05:40.679900 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '6bd2f5bc-6434-49a6-90ee-cc303ca17b51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7b8a707d0>]}
[0m22:05:42.837553 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:05:42.840371 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:05:42.846442 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.634635, "process_in_blocks": "0", "process_kernel_time": 0.458701, "process_mem_max_rss": "117800", "process_out_blocks": "0", "process_user_time": 2.277268}
[0m22:05:42.848401 [debug] [MainThread]: Command `dbt run` failed at 22:05:42.848200 after 2.64 seconds
[0m22:05:42.849839 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7bcf42d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7b8708c50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72b7b675e050>]}
[0m22:05:42.851570 [debug] [MainThread]: Flushing usage events
[0m22:05:43.673085 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:05:46.451258 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c6f60261d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c6f60324d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c6f6026150>]}


============================== 22:05:46.460125 | 313ee6ba-1c1d-4916-baa9-e23d9ad4ae33 ==============================
[0m22:05:46.460125 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:05:46.462380 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'fail_fast': 'False', 'log_format': 'default', 'version_check': 'True', 'use_colors': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/app/dbt/dbt/logs', 'no_print': 'None', 'quiet': 'False', 'write_json': 'True', 'warn_error': 'None', 'partial_parse': 'True', 'introspect': 'True', 'invocation_command': 'dbt run', 'empty': 'False', 'printer_width': '80', 'cache_selected_only': 'False', 'static_parser': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'debug': 'False', 'use_experimental_parser': 'False', 'log_cache_events': 'False', 'target_path': 'None', 'send_anonymous_usage_stats': 'True'}
[0m22:05:46.538594 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:05:46.540089 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '313ee6ba-1c1d-4916-baa9-e23d9ad4ae33', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c6f5fd3b50>]}
[0m22:05:46.609950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '313ee6ba-1c1d-4916-baa9-e23d9ad4ae33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c6f53577d0>]}
[0m22:05:46.674610 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '313ee6ba-1c1d-4916-baa9-e23d9ad4ae33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c6f8d344d0>]}
[0m22:05:46.679067 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:05:46.983708 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:05:47.012817 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:05:47.015390 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '313ee6ba-1c1d-4916-baa9-e23d9ad4ae33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c6f57080d0>]}
[0m22:05:49.731028 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:05:49.734202 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:05:49.737329 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.4094687, "process_in_blocks": "0", "process_kernel_time": 0.623924, "process_mem_max_rss": "117788", "process_out_blocks": "0", "process_user_time": 2.198007}
[0m22:05:49.739711 [debug] [MainThread]: Command `dbt run` failed at 22:05:49.739521 after 3.41 seconds
[0m22:05:49.742200 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c6f614f5d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c6f47d3b10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c6fa8e6a50>]}
[0m22:05:49.744001 [debug] [MainThread]: Flushing usage events
[0m22:05:50.694838 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:05:54.302807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727003a8a6d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727005a104d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727003a8a890>]}


============================== 22:05:54.313518 | 5aec6715-2743-4876-90da-5c44a13e3b0c ==============================
[0m22:05:54.313518 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:05:54.319457 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'printer_width': '80', 'warn_error': 'None', 'debug': 'False', 'log_cache_events': 'False', 'introspect': 'True', 'target_path': 'None', 'partial_parse': 'True', 'no_print': 'None', 'cache_selected_only': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'write_json': 'True', 'indirect_selection': 'eager', 'send_anonymous_usage_stats': 'True', 'version_check': 'True', 'fail_fast': 'False', 'static_parser': 'True', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'empty': 'False', 'use_colors': 'True', 'quiet': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'invocation_command': 'dbt run'}
[0m22:05:54.383171 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:05:54.391677 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '5aec6715-2743-4876-90da-5c44a13e3b0c', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727003dbce50>]}
[0m22:05:54.488361 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5aec6715-2743-4876-90da-5c44a13e3b0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727002b6a610>]}
[0m22:05:54.534894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5aec6715-2743-4876-90da-5c44a13e3b0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727006798910>]}
[0m22:05:54.536783 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:05:54.743214 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:05:54.783443 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:05:54.794432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '5aec6715-2743-4876-90da-5c44a13e3b0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727002b4ff10>]}
[0m22:05:57.114052 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:05:57.116430 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:05:57.118432 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.8976145, "process_in_blocks": "0", "process_kernel_time": 0.464031, "process_mem_max_rss": "118008", "process_out_blocks": "0", "process_user_time": 2.185309}
[0m22:05:57.120225 [debug] [MainThread]: Command `dbt run` failed at 22:05:57.120120 after 2.90 seconds
[0m22:05:57.122323 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72700828ecd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727003b57b10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727001f1e110>]}
[0m22:05:57.124346 [debug] [MainThread]: Flushing usage events
[0m22:05:57.968171 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:06:03.042695 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa37593cbd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa375946ad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa375946550>]}


============================== 22:06:03.048844 | 77d7ded9-f9df-4de9-a043-376367ce15db ==============================
[0m22:06:03.048844 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:06:03.050185 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'quiet': 'False', 'warn_error': 'None', 'empty': 'False', 'partial_parse': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'version_check': 'True', 'log_cache_events': 'False', 'static_parser': 'True', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'invocation_command': 'dbt run', 'cache_selected_only': 'False', 'use_colors': 'True', 'no_print': 'None', 'debug': 'False', 'introspect': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'log_format': 'default', 'fail_fast': 'False', 'target_path': 'None', 'indirect_selection': 'eager', 'write_json': 'True'}
[0m22:06:03.102428 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:06:03.104059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '77d7ded9-f9df-4de9-a043-376367ce15db', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa3758e9ad0>]}
[0m22:06:03.191799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '77d7ded9-f9df-4de9-a043-376367ce15db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa374dddb90>]}
[0m22:06:03.244641 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '77d7ded9-f9df-4de9-a043-376367ce15db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa378666c50>]}
[0m22:06:03.246598 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:06:03.349373 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:06:03.357830 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:06:03.358722 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '77d7ded9-f9df-4de9-a043-376367ce15db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa374dd4350>]}
[0m22:06:05.849595 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:06:05.852096 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:06:05.854925 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.892235, "process_in_blocks": "0", "process_kernel_time": 0.430029, "process_mem_max_rss": "117704", "process_out_blocks": "0", "process_user_time": 2.210998}
[0m22:06:05.856648 [debug] [MainThread]: Command `dbt run` failed at 22:06:05.856445 after 2.89 seconds
[0m22:06:05.858380 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa3758e8150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa3758eaa10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa373dd9f90>]}
[0m22:06:05.859620 [debug] [MainThread]: Flushing usage events
[0m22:06:06.738050 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:06:15.223221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73013a814d50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73013a4b8190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73013a4b8890>]}


============================== 22:06:15.229661 | d24ac611-5830-4ae6-87f6-9ac295b824b3 ==============================
[0m22:06:15.229661 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:06:15.230994 [debug] [MainThread]: running dbt with arguments {'version_check': 'True', 'quiet': 'False', 'fail_fast': 'False', 'cache_selected_only': 'False', 'log_format': 'default', 'log_cache_events': 'False', 'printer_width': '80', 'indirect_selection': 'eager', 'use_colors': 'True', 'debug': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'introspect': 'True', 'warn_error': 'None', 'static_parser': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'empty': 'False', 'target_path': 'None', 'no_print': 'None', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'write_json': 'True', 'invocation_command': 'dbt run', 'partial_parse': 'True'}
[0m22:06:15.277836 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:06:15.279079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'd24ac611-5830-4ae6-87f6-9ac295b824b3', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73013a523090>]}
[0m22:06:15.346261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd24ac611-5830-4ae6-87f6-9ac295b824b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7301395760d0>]}
[0m22:06:15.398800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd24ac611-5830-4ae6-87f6-9ac295b824b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73013d214c10>]}
[0m22:06:15.403978 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:06:15.518284 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:06:15.531649 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:06:15.533042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'd24ac611-5830-4ae6-87f6-9ac295b824b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x730139582b90>]}
[0m22:06:17.759886 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:06:17.761846 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:06:17.764330 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.6385384, "process_in_blocks": "0", "process_kernel_time": 0.335923, "process_mem_max_rss": "117052", "process_out_blocks": "0", "process_user_time": 2.38424}
[0m22:06:17.766115 [debug] [MainThread]: Command `dbt run` failed at 22:06:17.765769 after 2.64 seconds
[0m22:06:17.767745 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73013a4a3d50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73013895c210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x730138d05f90>]}
[0m22:06:17.769239 [debug] [MainThread]: Flushing usage events
[0m22:06:18.445110 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:06:33.276502 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7645b1e26810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7645b2e1d5d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7645b1e32ad0>]}


============================== 22:06:33.283568 | 4c8031c2-494a-4e2b-868c-09d5fcf55a0c ==============================
[0m22:06:33.283568 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:06:33.285462 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'warn_error': 'None', 'empty': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'cache_selected_only': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'use_colors': 'True', 'version_check': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'quiet': 'False', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'introspect': 'True', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'printer_width': '80', 'debug': 'False', 'no_print': 'None', 'partial_parse': 'True', 'target_path': 'None', 'static_parser': 'True'}
[0m22:06:33.351173 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:06:33.352888 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '4c8031c2-494a-4e2b-868c-09d5fcf55a0c', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7645b1e6f090>]}
[0m22:06:33.434319 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4c8031c2-494a-4e2b-868c-09d5fcf55a0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7645b1d0e890>]}
[0m22:06:33.483064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4c8031c2-494a-4e2b-868c-09d5fcf55a0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7645b11f9f10>]}
[0m22:06:33.485073 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:06:33.647798 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:06:33.668811 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:06:33.673044 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '4c8031c2-494a-4e2b-868c-09d5fcf55a0c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7645b1e269d0>]}
[0m22:06:36.750832 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:06:36.753443 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:06:36.757665 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.5591166, "process_in_blocks": "0", "process_kernel_time": 0.438284, "process_mem_max_rss": "117920", "process_out_blocks": "0", "process_user_time": 2.317225}
[0m22:06:36.759080 [debug] [MainThread]: Command `dbt run` failed at 22:06:36.758970 after 3.56 seconds
[0m22:06:36.760140 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7645b1e32950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7645b019e850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7645b01f6050>]}
[0m22:06:36.761004 [debug] [MainThread]: Flushing usage events
[0m22:06:37.518961 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:07:05.187930 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a5c901ea5d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a5c901ea550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a5c901ea790>]}


============================== 22:07:05.194217 | 2a7fe359-465c-45d6-9922-c4e283871bb4 ==============================
[0m22:07:05.194217 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:07:05.196085 [debug] [MainThread]: running dbt with arguments {'warn_error': 'None', 'no_print': 'None', 'introspect': 'True', 'use_colors': 'True', 'log_format': 'default', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'target_path': 'None', 'empty': 'False', 'debug': 'False', 'log_cache_events': 'False', 'write_json': 'True', 'quiet': 'False', 'indirect_selection': 'eager', 'fail_fast': 'False', 'static_parser': 'True', 'partial_parse': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'printer_width': '80', 'invocation_command': 'dbt run', 'cache_selected_only': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'version_check': 'True'}
[0m22:07:05.268516 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:07:05.271680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '2a7fe359-465c-45d6-9922-c4e283871bb4', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a5c900d2910>]}
[0m22:07:05.371382 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2a7fe359-465c-45d6-9922-c4e283871bb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a5c8f5a1290>]}
[0m22:07:05.414038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2a7fe359-465c-45d6-9922-c4e283871bb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a5c92ef2850>]}
[0m22:07:05.417286 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:07:05.579454 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:07:05.601210 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:07:05.603344 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '2a7fe359-465c-45d6-9922-c4e283871bb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a5c8f5edd10>]}
[0m22:07:08.581550 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:07:08.583408 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:07:08.586076 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.4606073, "process_in_blocks": "0", "process_kernel_time": 0.404572, "process_mem_max_rss": "117828", "process_out_blocks": "0", "process_user_time": 2.37484}
[0m22:07:08.587529 [debug] [MainThread]: Command `dbt run` failed at 22:07:08.587379 after 3.46 seconds
[0m22:07:08.588672 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a5c949d2d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a5c901f6950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a5c8e5264d0>]}
[0m22:07:08.589907 [debug] [MainThread]: Flushing usage events
[0m22:07:09.342386 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:07:46.325842 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af98aed1910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af98aed7cd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af98aed13d0>]}


============================== 22:07:46.332051 | df2eb243-d140-4b02-a195-2f471f0588b4 ==============================
[0m22:07:46.332051 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:07:46.333572 [debug] [MainThread]: running dbt with arguments {'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'debug': 'False', 'no_print': 'None', 'log_cache_events': 'False', 'target_path': 'None', 'use_colors': 'True', 'introspect': 'True', 'printer_width': '80', 'fail_fast': 'False', 'version_check': 'True', 'log_format': 'default', 'quiet': 'False', 'invocation_command': 'dbt run', 'static_parser': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'empty': 'False', 'indirect_selection': 'eager', 'partial_parse': 'True', 'write_json': 'True', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True'}
[0m22:07:46.392839 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:07:46.394434 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'df2eb243-d140-4b02-a195-2f471f0588b4', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af98a369910>]}
[0m22:07:46.484747 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'df2eb243-d140-4b02-a195-2f471f0588b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af98a3f1390>]}
[0m22:07:46.536830 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'df2eb243-d140-4b02-a195-2f471f0588b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af98af26510>]}
[0m22:07:46.539180 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:07:46.698087 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:07:46.730801 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:07:46.732655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'df2eb243-d140-4b02-a195-2f471f0588b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af98b2581d0>]}
[0m22:07:49.624994 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:07:49.627475 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:07:49.630211 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.3725836, "process_in_blocks": "0", "process_kernel_time": 0.476681, "process_mem_max_rss": "117068", "process_out_blocks": "0", "process_user_time": 2.336133}
[0m22:07:49.632319 [debug] [MainThread]: Command `dbt run` failed at 22:07:49.632241 after 3.37 seconds
[0m22:07:49.633664 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af98f7eea50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af98af31fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7af98a3d1850>]}
[0m22:07:49.634690 [debug] [MainThread]: Flushing usage events
[0m22:07:50.502018 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:07:52.662762 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x725d66646b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x725d66651e90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x725d66652290>]}


============================== 22:07:52.672857 | 535c5180-d62a-416d-887d-d80425e42ecb ==============================
[0m22:07:52.672857 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:07:52.675784 [debug] [MainThread]: running dbt with arguments {'use_experimental_parser': 'False', 'indirect_selection': 'eager', 'quiet': 'False', 'use_colors': 'True', 'version_check': 'True', 'no_print': 'None', 'warn_error': 'None', 'debug': 'False', 'log_format': 'default', 'static_parser': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'empty': 'False', 'partial_parse': 'True', 'write_json': 'True', 'send_anonymous_usage_stats': 'True', 'printer_width': '80', 'log_path': '/usr/app/dbt/dbt/logs', 'introspect': 'True', 'log_cache_events': 'False', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'fail_fast': 'False', 'target_path': 'None', 'cache_selected_only': 'False'}
[0m22:07:52.751623 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:07:52.754157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '535c5180-d62a-416d-887d-d80425e42ecb', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x725d666ae110>]}
[0m22:07:52.841808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '535c5180-d62a-416d-887d-d80425e42ecb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x725d65373810>]}
[0m22:07:52.888686 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '535c5180-d62a-416d-887d-d80425e42ecb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x725d69360710>]}
[0m22:07:52.892269 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:07:53.081837 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:07:53.095774 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:07:53.096791 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '535c5180-d62a-416d-887d-d80425e42ecb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x725d64b1f2d0>]}
[0m22:07:55.718781 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:07:55.720728 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:07:55.723093 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.1381123, "process_in_blocks": "0", "process_kernel_time": 0.389928, "process_mem_max_rss": "117096", "process_out_blocks": "0", "process_user_time": 2.198876}
[0m22:07:55.724419 [debug] [MainThread]: Command `dbt run` failed at 22:07:55.724323 after 3.14 seconds
[0m22:07:55.727310 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x725d6ae4ed90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x725d64b07b10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x725d665e0490>]}
[0m22:07:55.728036 [debug] [MainThread]: Flushing usage events
[0m22:07:56.559502 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:07:58.635259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8e6da91910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8e6ddf8990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8e6da91f10>]}


============================== 22:07:58.640980 | 370493bb-edda-44a6-bfc5-7d192dd0e9a1 ==============================
[0m22:07:58.640980 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:07:58.643055 [debug] [MainThread]: running dbt with arguments {'use_colors': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'printer_width': '80', 'log_path': '/usr/app/dbt/dbt/logs', 'invocation_command': 'dbt run', 'fail_fast': 'False', 'use_experimental_parser': 'False', 'empty': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'target_path': 'None', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'no_print': 'None', 'send_anonymous_usage_stats': 'True', 'debug': 'False', 'write_json': 'True', 'indirect_selection': 'eager', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None', 'version_check': 'True', 'quiet': 'False', 'log_cache_events': 'False'}
[0m22:07:58.700163 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:07:58.701902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '370493bb-edda-44a6-bfc5-7d192dd0e9a1', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8e6da93450>]}
[0m22:07:58.780149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '370493bb-edda-44a6-bfc5-7d192dd0e9a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8e6dae6d10>]}
[0m22:07:58.828737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '370493bb-edda-44a6-bfc5-7d192dd0e9a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8e707f4690>]}
[0m22:07:58.830987 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:07:58.979207 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:07:58.998401 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:07:58.999989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '370493bb-edda-44a6-bfc5-7d192dd0e9a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8e6cbc0950>]}
[0m22:08:01.597466 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:08:01.600424 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:08:01.602835 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.04219, "process_in_blocks": "0", "process_kernel_time": 0.421374, "process_mem_max_rss": "117976", "process_out_blocks": "0", "process_user_time": 2.175095}
[0m22:08:01.604480 [debug] [MainThread]: Command `dbt run` failed at 22:08:01.604311 after 3.04 seconds
[0m22:08:01.605901 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8e722e2d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8e6cf2a7d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8e6bbcaf90>]}
[0m22:08:01.606885 [debug] [MainThread]: Flushing usage events
[0m22:08:02.388176 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:08:05.064385 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cc0eef90610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cc0ec275450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cc0ec2b5f90>]}


============================== 22:08:05.071805 | 086bac93-43ee-45ed-a087-1d7bf76ddc92 ==============================
[0m22:08:05.071805 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:08:05.074196 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'version_check': 'True', 'send_anonymous_usage_stats': 'True', 'debug': 'False', 'fail_fast': 'False', 'write_json': 'True', 'no_print': 'None', 'log_format': 'default', 'invocation_command': 'dbt run', 'printer_width': '80', 'static_parser': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'introspect': 'True', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'cache_selected_only': 'False', 'quiet': 'False', 'empty': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'target_path': 'None'}
[0m22:08:05.129815 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:08:05.131428 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '086bac93-43ee-45ed-a087-1d7bf76ddc92', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cc0ed11db90>]}
[0m22:08:05.207441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '086bac93-43ee-45ed-a087-1d7bf76ddc92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cc0ed27c910>]}
[0m22:08:05.253783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '086bac93-43ee-45ed-a087-1d7bf76ddc92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cc0eefb8b90>]}
[0m22:08:05.256152 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:08:05.467381 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:08:05.502635 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:08:05.504337 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '086bac93-43ee-45ed-a087-1d7bf76ddc92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cc0ea714b10>]}
[0m22:08:09.137603 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:08:09.139311 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:08:09.141722 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 4.2057467, "process_in_blocks": "0", "process_kernel_time": 0.418153, "process_mem_max_rss": "117680", "process_out_blocks": "0", "process_user_time": 2.479937}
[0m22:08:09.143198 [debug] [MainThread]: Command `dbt run` failed at 22:08:09.143096 after 4.21 seconds
[0m22:08:09.144126 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cc0f0ab2c50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cc0eb3cbb10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cc0eafd8b10>]}
[0m22:08:09.144994 [debug] [MainThread]: Flushing usage events
[0m22:08:09.766127 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:08:12.915038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75918b5d9750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75918b5da490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75918b5d8290>]}


============================== 22:08:12.924087 | ab0f950e-d8d9-4f28-9c92-e12e2161ba17 ==============================
[0m22:08:12.924087 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:08:12.927377 [debug] [MainThread]: running dbt with arguments {'quiet': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False', 'static_parser': 'True', 'write_json': 'True', 'introspect': 'True', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'empty': 'False', 'no_print': 'None', 'target_path': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'indirect_selection': 'eager', 'use_experimental_parser': 'False', 'invocation_command': 'dbt run', 'version_check': 'True', 'printer_width': '80', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_format': 'default', 'warn_error': 'None'}
[0m22:08:13.016344 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:08:13.018849 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'ab0f950e-d8d9-4f28-9c92-e12e2161ba17', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75918b657350>]}
[0m22:08:13.109504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ab0f950e-d8d9-4f28-9c92-e12e2161ba17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75918a7b3150>]}
[0m22:08:13.173715 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ab0f950e-d8d9-4f28-9c92-e12e2161ba17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75918e3607d0>]}
[0m22:08:13.180480 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:08:13.546532 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:08:13.613386 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:08:13.615646 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'ab0f950e-d8d9-4f28-9c92-e12e2161ba17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75918b5d8350>]}
[0m22:08:16.654832 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:08:16.657531 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:08:16.660489 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.8702667, "process_in_blocks": "0", "process_kernel_time": 0.477466, "process_mem_max_rss": "117000", "process_out_blocks": "0", "process_user_time": 2.563238}
[0m22:08:16.662434 [debug] [MainThread]: Command `dbt run` failed at 22:08:16.662244 after 3.87 seconds
[0m22:08:16.669043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7591897ead90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75918932bf90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75918b62ed90>]}
[0m22:08:16.671313 [debug] [MainThread]: Flushing usage events
[0m22:08:17.331908 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:08:21.431234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b05a9f6b550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b05a9f16990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b05a9f6b450>]}


============================== 22:08:21.441965 | 151c517f-72ba-40cb-84ac-e0159fbf207d ==============================
[0m22:08:21.441965 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:08:21.445238 [debug] [MainThread]: running dbt with arguments {'invocation_command': 'dbt run', 'use_colors': 'True', 'indirect_selection': 'eager', 'log_format': 'default', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'profiles_dir': '/usr/app/dbt/dbt', 'debug': 'False', 'empty': 'False', 'partial_parse': 'True', 'target_path': 'None', 'introspect': 'True', 'quiet': 'False', 'write_json': 'True', 'printer_width': '80', 'fail_fast': 'False', 'warn_error': 'None', 'cache_selected_only': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'version_check': 'True', 'no_print': 'None'}
[0m22:08:21.531588 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:08:21.534008 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '151c517f-72ba-40cb-84ac-e0159fbf207d', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b05a9f15d50>]}
[0m22:08:21.623897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '151c517f-72ba-40cb-84ac-e0159fbf207d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b05a9f34d50>]}
[0m22:08:21.672300 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '151c517f-72ba-40cb-84ac-e0159fbf207d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b05a9f06390>]}
[0m22:08:21.679448 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:08:21.807136 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:08:21.823346 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:08:21.825105 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '151c517f-72ba-40cb-84ac-e0159fbf207d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b05a8bfdcd0>]}
[0m22:08:24.866195 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:08:24.870991 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:08:24.874107 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.5701041, "process_in_blocks": "0", "process_kernel_time": 0.46824, "process_mem_max_rss": "117556", "process_out_blocks": "0", "process_user_time": 2.484625}
[0m22:08:24.875992 [debug] [MainThread]: Command `dbt run` failed at 22:08:24.875892 after 3.57 seconds
[0m22:08:24.877722 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b05ae77ef10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b05a9f72710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b05a7f08f90>]}
[0m22:08:24.880040 [debug] [MainThread]: Flushing usage events
[0m22:08:25.766965 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:08:31.382026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2c2f3029d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2c2f2c9350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2c2f2c85d0>]}


============================== 22:08:31.389593 | cee3ff52-1292-4386-be5f-7aa33a859765 ==============================
[0m22:08:31.389593 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:08:31.391914 [debug] [MainThread]: running dbt with arguments {'fail_fast': 'False', 'use_colors': 'True', 'empty': 'False', 'send_anonymous_usage_stats': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'version_check': 'True', 'use_experimental_parser': 'False', 'quiet': 'False', 'no_print': 'None', 'log_cache_events': 'False', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None', 'target_path': 'None', 'partial_parse': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'cache_selected_only': 'False', 'debug': 'False', 'printer_width': '80', 'static_parser': 'True', 'write_json': 'True', 'indirect_selection': 'eager', 'profiles_dir': '/usr/app/dbt/dbt'}
[0m22:08:31.466124 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:08:31.468087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'cee3ff52-1292-4386-be5f-7aa33a859765', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2c2e79edd0>]}
[0m22:08:31.563383 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cee3ff52-1292-4386-be5f-7aa33a859765', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2c2e79cdd0>]}
[0m22:08:31.607400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cee3ff52-1292-4386-be5f-7aa33a859765', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2c32012750>]}
[0m22:08:31.610474 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:08:31.803604 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:08:31.830423 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:08:31.831965 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'cee3ff52-1292-4386-be5f-7aa33a859765', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2c2dfed490>]}
[0m22:08:34.793589 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:08:34.795444 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:08:34.797244 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.5047119, "process_in_blocks": "0", "process_kernel_time": 0.49366, "process_mem_max_rss": "117668", "process_out_blocks": "0", "process_user_time": 2.586444}
[0m22:08:34.798865 [debug] [MainThread]: Command `dbt run` failed at 22:08:34.798715 after 3.51 seconds
[0m22:08:34.800150 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2c2f2c9350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2c2f30e350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2c2f30e190>]}
[0m22:08:34.801393 [debug] [MainThread]: Flushing usage events
[0m22:08:35.574220 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:08:44.094345 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x726724cc1090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x726724cc2f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7267251235d0>]}


============================== 22:08:44.101398 | 3b612aa2-666d-4ecf-9745-6e7561581d93 ==============================
[0m22:08:44.101398 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:08:44.102918 [debug] [MainThread]: running dbt with arguments {'write_json': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'quiet': 'False', 'log_cache_events': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error': 'None', 'send_anonymous_usage_stats': 'True', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'introspect': 'True', 'fail_fast': 'False', 'log_format': 'default', 'empty': 'False', 'no_print': 'None', 'printer_width': '80', 'debug': 'False', 'cache_selected_only': 'False', 'static_parser': 'True', 'use_experimental_parser': 'False', 'version_check': 'True', 'use_colors': 'True', 'target_path': 'None', 'indirect_selection': 'eager', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])'}
[0m22:08:44.168261 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m22:08:44.173232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '3b612aa2-666d-4ecf-9745-6e7561581d93', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x726724d3e0d0>]}
[0m22:08:44.250358 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3b612aa2-666d-4ecf-9745-6e7561581d93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x726723d227d0>]}
[0m22:08:44.297100 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3b612aa2-666d-4ecf-9745-6e7561581d93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x726727a4c810>]}
[0m22:08:44.301174 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:08:44.486581 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:08:44.563777 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:08:44.566416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '3b612aa2-666d-4ecf-9745-6e7561581d93', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7267239e1110>]}
[0m22:08:47.617956 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:08:47.620902 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- ConfigSourcePathDeprecation: 1 occurrence
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m22:08:47.624160 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.596013, "process_in_blocks": "0", "process_kernel_time": 0.455309, "process_mem_max_rss": "117744", "process_out_blocks": "0", "process_user_time": 2.341589}
[0m22:08:47.626101 [debug] [MainThread]: Command `dbt run` failed at 22:08:47.625869 after 3.60 seconds
[0m22:08:47.627919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x726724cc2d10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x726724cc1090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7267241b3f90>]}
[0m22:08:47.629513 [debug] [MainThread]: Flushing usage events
[0m22:08:48.388145 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:09:03.258747 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78ca173323d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78ca1733e050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78ca17333b10>]}


============================== 22:09:03.265830 | ebcc3727-ebcf-4856-8bd1-a29d4c7b9f91 ==============================
[0m22:09:03.265830 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:09:03.267750 [debug] [MainThread]: running dbt with arguments {'empty': 'False', 'log_format': 'default', 'log_path': '/usr/app/dbt/dbt/logs', 'send_anonymous_usage_stats': 'True', 'warn_error': 'None', 'printer_width': '80', 'cache_selected_only': 'False', 'indirect_selection': 'eager', 'fail_fast': 'False', 'introspect': 'True', 'use_experimental_parser': 'False', 'invocation_command': 'dbt run', 'version_check': 'True', 'use_colors': 'True', 'quiet': 'False', 'partial_parse': 'True', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'write_json': 'True', 'static_parser': 'True', 'target_path': 'None', 'debug': 'False', 'no_print': 'None', 'profiles_dir': '/usr/app/dbt/dbt'}
[0m22:09:03.334214 [error] [MainThread]: Encountered an error:
Runtime Error
  Required "name" field not present in project

Error encountered in /usr/app/dbt/dbt/dbt_project.yml
[0m22:09:03.337251 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.17175733, "process_in_blocks": "0", "process_kernel_time": 0.292533, "process_mem_max_rss": "108660", "process_out_blocks": "0", "process_user_time": 1.150369}
[0m22:09:03.338677 [debug] [MainThread]: Command `dbt run` failed at 22:09:03.338537 after 0.17 seconds
[0m22:09:03.339760 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78ca181a1950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78ca1bbfaa50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78ca172dda90>]}
[0m22:09:03.340855 [debug] [MainThread]: Flushing usage events
[0m22:09:04.066060 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:09:31.609610 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d5fac9ee8d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d5fac9ee650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d5fac9ee610>]}


============================== 22:09:31.621622 | f58e8f66-1932-44f0-916e-139117b9653f ==============================
[0m22:09:31.621622 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:09:31.638731 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'introspect': 'True', 'empty': 'False', 'send_anonymous_usage_stats': 'True', 'printer_width': '80', 'log_format': 'default', 'target_path': 'None', 'quiet': 'False', 'no_print': 'None', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'version_check': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'partial_parse': 'True', 'warn_error': 'None', 'use_experimental_parser': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'log_cache_events': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'invocation_command': 'dbt run', 'static_parser': 'True', 'cache_selected_only': 'False', 'indirect_selection': 'eager'}
[0m22:09:31.732377 [error] [MainThread]: Encountered an error:
Runtime Error
  Required "name" field not present in project

Error encountered in /usr/app/dbt/dbt/dbt_project.yml
[0m22:09:31.734749 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.22383465, "process_in_blocks": "0", "process_kernel_time": 0.25194, "process_mem_max_rss": "108984", "process_out_blocks": "0", "process_user_time": 1.109351}
[0m22:09:31.736742 [debug] [MainThread]: Command `dbt run` failed at 22:09:31.736495 after 0.23 seconds
[0m22:09:31.738287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d5fb11f2d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d5fac0e2850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d5fb11f2dd0>]}
[0m22:09:31.739397 [debug] [MainThread]: Flushing usage events
[0m22:09:32.450588 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:10:25.651366 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c621bfa8d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c621bfa8f90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c621bfe67d0>]}


============================== 22:10:25.658067 | d49ac864-fa76-4749-b4e3-993f5dfd728b ==============================
[0m22:10:25.658067 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:10:25.660366 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'partial_parse': 'True', 'write_json': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'introspect': 'True', 'static_parser': 'True', 'log_cache_events': 'False', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'send_anonymous_usage_stats': 'True', 'no_print': 'None', 'invocation_command': 'dbt run', 'log_path': '/usr/app/dbt/dbt/logs', 'log_format': 'default', 'printer_width': '80', 'warn_error': 'None', 'version_check': 'True', 'quiet': 'False', 'empty': 'False', 'indirect_selection': 'eager', 'use_colors': 'True', 'cache_selected_only': 'False', 'use_experimental_parser': 'False', 'fail_fast': 'False'}
[0m22:10:25.823703 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd49ac864-fa76-4749-b4e3-993f5dfd728b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c621c300cd0>]}
[0m22:10:25.868917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd49ac864-fa76-4749-b4e3-993f5dfd728b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c621b3c6990>]}
[0m22:10:25.871100 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:10:26.028377 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:10:26.049368 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:10:26.051212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'd49ac864-fa76-4749-b4e3-993f5dfd728b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c621c032810>]}
[0m22:10:28.895927 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:10:28.898126 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.323643, "process_in_blocks": "0", "process_kernel_time": 0.441879, "process_mem_max_rss": "117600", "process_out_blocks": "0", "process_user_time": 2.246223}
[0m22:10:28.899756 [debug] [MainThread]: Command `dbt run` failed at 22:10:28.899545 after 3.33 seconds
[0m22:10:28.900908 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6219f1cd90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c621a3ca850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c621b38b290>]}
[0m22:10:28.901892 [debug] [MainThread]: Flushing usage events
[0m22:10:29.732077 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:10:44.254565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7586e8f9af10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7586e65dca50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7586e62aa550>]}


============================== 22:10:44.261044 | a05e0592-3835-4947-9e0f-99219a66bad4 ==============================
[0m22:10:44.261044 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:10:44.262962 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'indirect_selection': 'eager', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'write_json': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'debug': 'False', 'log_cache_events': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'printer_width': '80', 'no_print': 'None', 'quiet': 'False', 'warn_error': 'None', 'use_colors': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'fail_fast': 'False', 'version_check': 'True', 'partial_parse': 'True', 'introspect': 'True', 'empty': 'False', 'target_path': 'None', 'use_experimental_parser': 'False'}
[0m22:10:44.393125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a05e0592-3835-4947-9e0f-99219a66bad4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7586e558fa50>]}
[0m22:10:44.441839 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a05e0592-3835-4947-9e0f-99219a66bad4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7586e8fb25d0>]}
[0m22:10:44.445565 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:10:44.589920 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:10:44.611124 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:10:44.612518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'a05e0592-3835-4947-9e0f-99219a66bad4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7586e6189850>]}
[0m22:10:47.466222 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:10:47.469477 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.2818594, "process_in_blocks": "0", "process_kernel_time": 0.387441, "process_mem_max_rss": "116996", "process_out_blocks": "0", "process_user_time": 2.299917}
[0m22:10:47.471932 [debug] [MainThread]: Command `dbt run` failed at 22:10:47.471824 after 3.28 seconds
[0m22:10:47.473725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7586eaa8ad90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7586e6249810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7586e49cdf90>]}
[0m22:10:47.475464 [debug] [MainThread]: Flushing usage events
[0m22:10:48.471396 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:10:50.659517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d132af7b310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d132af2bfd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d132af2be50>]}


============================== 22:10:50.667173 | 53e3b29f-42eb-4186-b38d-8a7f1e1426d2 ==============================
[0m22:10:50.667173 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:10:50.669025 [debug] [MainThread]: running dbt with arguments {'introspect': 'True', 'static_parser': 'True', 'empty': 'False', 'warn_error': 'None', 'invocation_command': 'dbt run', 'log_path': '/usr/app/dbt/dbt/logs', 'use_colors': 'True', 'fail_fast': 'False', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'write_json': 'True', 'cache_selected_only': 'False', 'printer_width': '80', 'use_experimental_parser': 'False', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'no_print': 'None', 'version_check': 'True', 'partial_parse': 'True', 'indirect_selection': 'eager', 'target_path': 'None', 'log_cache_events': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'log_format': 'default'}
[0m22:10:50.797562 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '53e3b29f-42eb-4186-b38d-8a7f1e1426d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d132af78710>]}
[0m22:10:50.842282 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '53e3b29f-42eb-4186-b38d-8a7f1e1426d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d132dc84bd0>]}
[0m22:10:50.844566 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:10:51.007060 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:10:51.034198 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:10:51.036188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '53e3b29f-42eb-4186-b38d-8a7f1e1426d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d1329fbfc10>]}
[0m22:10:53.832262 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:10:53.834416 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.2574008, "process_in_blocks": "0", "process_kernel_time": 0.399608, "process_mem_max_rss": "117524", "process_out_blocks": "0", "process_user_time": 2.228745}
[0m22:10:53.835490 [debug] [MainThread]: Command `dbt run` failed at 22:10:53.835390 after 3.26 seconds
[0m22:10:53.836481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d132f77ec50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d132a3d6010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d132b2ac450>]}
[0m22:10:53.837313 [debug] [MainThread]: Flushing usage events
[0m22:10:54.717073 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:10:56.898688 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71110faffe90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71110ff1b410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71110fb06550>]}


============================== 22:10:56.908111 | 272ad709-5496-4fb3-a3e1-733750a2b4d4 ==============================
[0m22:10:56.908111 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:10:56.910651 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'invocation_command': 'dbt run', 'use_experimental_parser': 'False', 'log_format': 'default', 'cache_selected_only': 'False', 'write_json': 'True', 'partial_parse': 'True', 'introspect': 'True', 'warn_error': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'version_check': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'quiet': 'False', 'static_parser': 'True', 'use_colors': 'True', 'debug': 'False', 'log_cache_events': 'False', 'empty': 'False', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'fail_fast': 'False', 'target_path': 'None', 'printer_width': '80', 'indirect_selection': 'eager'}
[0m22:10:57.068663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '272ad709-5496-4fb3-a3e1-733750a2b4d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71110fac93d0>]}
[0m22:10:57.125336 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '272ad709-5496-4fb3-a3e1-733750a2b4d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71110f9b9f10>]}
[0m22:10:57.128382 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:10:57.292555 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:10:57.333731 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:10:57.335875 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '272ad709-5496-4fb3-a3e1-733750a2b4d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71110faa6750>]}
[0m22:11:00.335433 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:11:00.338766 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.5041642, "process_in_blocks": "0", "process_kernel_time": 0.374993, "process_mem_max_rss": "117508", "process_out_blocks": "0", "process_user_time": 2.337726}
[0m22:11:00.340392 [debug] [MainThread]: Command `dbt run` failed at 22:11:00.340301 after 3.51 seconds
[0m22:11:00.341724 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71110fb06010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71110fb05f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7111143ae9d0>]}
[0m22:11:00.344261 [debug] [MainThread]: Flushing usage events
[0m22:11:00.996537 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:11:03.578769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c3aba46dcd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c3aba47a810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c3aba41a0d0>]}


============================== 22:11:03.584150 | 3fde5118-c0c9-4c1b-9b56-08760677e780 ==============================
[0m22:11:03.584150 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:11:03.586015 [debug] [MainThread]: running dbt with arguments {'write_json': 'True', 'empty': 'False', 'log_format': 'default', 'printer_width': '80', 'log_path': '/usr/app/dbt/dbt/logs', 'version_check': 'True', 'warn_error': 'None', 'use_experimental_parser': 'False', 'log_cache_events': 'False', 'quiet': 'False', 'indirect_selection': 'eager', 'debug': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'use_colors': 'True', 'target_path': 'None', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'no_print': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'invocation_command': 'dbt run'}
[0m22:11:03.747893 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3fde5118-c0c9-4c1b-9b56-08760677e780', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c3aba58f790>]}
[0m22:11:03.800992 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3fde5118-c0c9-4c1b-9b56-08760677e780', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c3abd186710>]}
[0m22:11:03.804524 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:11:03.915202 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:11:03.928141 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:11:03.929399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '3fde5118-c0c9-4c1b-9b56-08760677e780', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c3ab95228d0>]}
[0m22:11:07.275016 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:11:07.277090 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.7646687, "process_in_blocks": "0", "process_kernel_time": 0.38983, "process_mem_max_rss": "117428", "process_out_blocks": "0", "process_user_time": 2.477049}
[0m22:11:07.280332 [debug] [MainThread]: Command `dbt run` failed at 22:11:07.280046 after 3.77 seconds
[0m22:11:07.282240 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c3aba41a3d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c3ab85bbf50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c3ab85c6c10>]}
[0m22:11:07.297567 [debug] [MainThread]: Flushing usage events
[0m22:11:07.927035 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:11:10.859899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7be7cbbd0090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7be7c8ef5ed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7be7c8eb08d0>]}


============================== 22:11:10.866016 | 5fca89db-c1be-4197-8679-31ac3462825f ==============================
[0m22:11:10.866016 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:11:10.868253 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'static_parser': 'True', 'use_colors': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'no_print': 'None', 'debug': 'False', 'partial_parse': 'True', 'send_anonymous_usage_stats': 'True', 'write_json': 'True', 'target_path': 'None', 'quiet': 'False', 'log_format': 'default', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'fail_fast': 'False', 'log_cache_events': 'False', 'introspect': 'True', 'cache_selected_only': 'False', 'use_experimental_parser': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'indirect_selection': 'eager', 'warn_error': 'None', 'invocation_command': 'dbt run', 'empty': 'False', 'version_check': 'True'}
[0m22:11:11.009808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5fca89db-c1be-4197-8679-31ac3462825f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7be7c83e0dd0>]}
[0m22:11:11.065250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5fca89db-c1be-4197-8679-31ac3462825f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7be7cbc04650>]}
[0m22:11:11.067800 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:11:11.238147 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:11:11.252649 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:11:11.253910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '5fca89db-c1be-4197-8679-31ac3462825f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7be7c7bb7450>]}
[0m22:11:14.089584 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:11:14.092089 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.3033948, "process_in_blocks": "0", "process_kernel_time": 0.388034, "process_mem_max_rss": "117816", "process_out_blocks": "0", "process_user_time": 2.431156}
[0m22:11:14.094742 [debug] [MainThread]: Command `dbt run` failed at 22:11:14.094501 after 3.31 seconds
[0m22:11:14.096946 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7be7c8e96550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7be7c8e950d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7be7c957cf90>]}
[0m22:11:14.099213 [debug] [MainThread]: Flushing usage events
[0m22:11:15.106713 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:11:18.666025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ebaa6877010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ebaa3b9e510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ebaa3b3d2d0>]}


============================== 22:11:18.672944 | 56aff213-607f-49b9-88c2-c7be67e40a37 ==============================
[0m22:11:18.672944 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:11:18.674440 [debug] [MainThread]: running dbt with arguments {'write_json': 'True', 'target_path': 'None', 'fail_fast': 'False', 'quiet': 'False', 'partial_parse': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'version_check': 'True', 'use_colors': 'True', 'cache_selected_only': 'False', 'no_print': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'log_cache_events': 'False', 'indirect_selection': 'eager', 'static_parser': 'True', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'printer_width': '80', 'empty': 'False', 'warn_error': 'None', 'log_format': 'default', 'use_experimental_parser': 'False', 'debug': 'False', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])'}
[0m22:11:18.853113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '56aff213-607f-49b9-88c2-c7be67e40a37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ebaa3b9e250>]}
[0m22:11:18.904743 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '56aff213-607f-49b9-88c2-c7be67e40a37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ebaa2bcdfd0>]}
[0m22:11:18.906448 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:11:19.073989 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:11:19.095250 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:11:19.096793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '56aff213-607f-49b9-88c2-c7be67e40a37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ebaa27cfb90>]}
[0m22:11:21.619198 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:11:21.621879 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.026399, "process_in_blocks": "0", "process_kernel_time": 0.39884, "process_mem_max_rss": "117468", "process_out_blocks": "0", "process_user_time": 2.268154}
[0m22:11:21.623707 [debug] [MainThread]: Command `dbt run` failed at 22:11:21.623452 after 3.03 seconds
[0m22:11:21.625136 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ebaa8396c50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ebaa4a01950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ebaa1f9eb10>]}
[0m22:11:21.626267 [debug] [MainThread]: Flushing usage events
[0m22:11:22.264057 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:11:27.575689 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74f82059ead0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74f820918410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74f8209189d0>]}


============================== 22:11:27.584326 | ad243fea-2444-4298-8859-138c5523268d ==============================
[0m22:11:27.584326 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:11:27.585795 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'log_format': 'default', 'fail_fast': 'False', 'no_print': 'None', 'cache_selected_only': 'False', 'static_parser': 'True', 'partial_parse': 'True', 'introspect': 'True', 'write_json': 'True', 'indirect_selection': 'eager', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None', 'invocation_command': 'dbt run', 'empty': 'False', 'printer_width': '80', 'profiles_dir': '/usr/app/dbt/dbt', 'use_colors': 'True', 'debug': 'False', 'use_experimental_parser': 'False', 'log_cache_events': 'False', 'target_path': 'None', 'quiet': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'version_check': 'True'}
[0m22:11:27.722642 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ad243fea-2444-4298-8859-138c5523268d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74f81fd52590>]}
[0m22:11:27.770175 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ad243fea-2444-4298-8859-138c5523268d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74f81fcbdf10>]}
[0m22:11:27.772949 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:11:27.936501 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:11:27.956532 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:11:27.958012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'ad243fea-2444-4298-8859-138c5523268d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74f81f9868d0>]}
[0m22:11:30.642754 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:11:30.645790 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.1406796, "process_in_blocks": "0", "process_kernel_time": 0.49625, "process_mem_max_rss": "117412", "process_out_blocks": "0", "process_user_time": 2.33601}
[0m22:11:30.648753 [debug] [MainThread]: Command `dbt run` failed at 22:11:30.648647 after 3.14 seconds
[0m22:11:30.650556 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74f81eda2ed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74f81eddaad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74f824dfadd0>]}
[0m22:11:30.652353 [debug] [MainThread]: Flushing usage events
[0m22:11:31.786968 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:11:40.474176 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c4442bf0d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c444288cd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c4442cab90>]}


============================== 22:11:40.484882 | 497f02c7-9ba1-442b-b9ab-e5718694cf75 ==============================
[0m22:11:40.484882 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:11:40.487125 [debug] [MainThread]: running dbt with arguments {'empty': 'False', 'static_parser': 'True', 'indirect_selection': 'eager', 'target_path': 'None', 'fail_fast': 'False', 'cache_selected_only': 'False', 'use_colors': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'no_print': 'None', 'debug': 'False', 'quiet': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'write_json': 'True', 'warn_error': 'None', 'printer_width': '80', 'use_experimental_parser': 'False', 'invocation_command': 'dbt run', 'log_cache_events': 'False', 'version_check': 'True', 'introspect': 'True', 'partial_parse': 'True', 'send_anonymous_usage_stats': 'True', 'log_format': 'default', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])'}
[0m22:11:40.742473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '497f02c7-9ba1-442b-b9ab-e5718694cf75', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c44430a250>]}
[0m22:11:40.793053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '497f02c7-9ba1-442b-b9ab-e5718694cf75', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c446ff4690>]}
[0m22:11:40.795542 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:11:40.966297 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:11:40.984025 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:11:40.985572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '497f02c7-9ba1-442b-b9ab-e5718694cf75', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c4433628d0>]}
[0m22:11:44.052870 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:11:44.055630 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.6603937, "process_in_blocks": "0", "process_kernel_time": 0.486897, "process_mem_max_rss": "117468", "process_out_blocks": "0", "process_user_time": 2.575978}
[0m22:11:44.057746 [debug] [MainThread]: Command `dbt run` failed at 22:11:44.057550 after 3.66 seconds
[0m22:11:44.060787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c4427f3090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c44278ff90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c4445e4490>]}
[0m22:11:44.062225 [debug] [MainThread]: Flushing usage events
[0m22:11:45.118891 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:11:59.907806 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78859172fd10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78858ea01a50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78858ea025d0>]}


============================== 22:11:59.914994 | 537af27c-d918-443c-9ced-bc6815d9ae54 ==============================
[0m22:11:59.914994 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:11:59.916301 [debug] [MainThread]: running dbt with arguments {'introspect': 'True', 'target_path': 'None', 'no_print': 'None', 'printer_width': '80', 'warn_error': 'None', 'static_parser': 'True', 'use_experimental_parser': 'False', 'quiet': 'False', 'log_cache_events': 'False', 'indirect_selection': 'eager', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'profiles_dir': '/usr/app/dbt/dbt', 'log_format': 'default', 'invocation_command': 'dbt run', 'use_colors': 'True', 'version_check': 'True', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'empty': 'False'}
[0m22:12:00.069067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '537af27c-d918-443c-9ced-bc6815d9ae54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78858e9f29d0>]}
[0m22:12:00.112268 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '537af27c-d918-443c-9ced-bc6815d9ae54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78859176c310>]}
[0m22:12:00.114705 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:12:00.293034 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:12:00.317599 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:12:00.319781 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '537af27c-d918-443c-9ced-bc6815d9ae54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78858d7ceb50>]}
[0m22:12:03.157814 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:12:03.160564 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.36368, "process_in_blocks": "0", "process_kernel_time": 0.389171, "process_mem_max_rss": "117580", "process_out_blocks": "0", "process_user_time": 2.262062}
[0m22:12:03.162785 [debug] [MainThread]: Command `dbt run` failed at 22:12:03.162622 after 3.37 seconds
[0m22:12:03.164436 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78859325ac50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78858c311850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78858f8c5950>]}
[0m22:12:03.166596 [debug] [MainThread]: Flushing usage events
[0m22:12:03.893066 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:12:31.524464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7212e3e60d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7212e3e47dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7212e3ea2550>]}


============================== 22:12:31.535584 | 35c026d5-4b30-4cec-bf23-bb4968e1930a ==============================
[0m22:12:31.535584 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:12:31.537975 [debug] [MainThread]: running dbt with arguments {'use_experimental_parser': 'False', 'indirect_selection': 'eager', 'empty': 'False', 'debug': 'False', 'use_colors': 'True', 'fail_fast': 'False', 'send_anonymous_usage_stats': 'True', 'warn_error': 'None', 'invocation_command': 'dbt run', 'static_parser': 'True', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_format': 'default', 'version_check': 'True', 'no_print': 'None', 'target_path': 'None', 'introspect': 'True', 'write_json': 'True', 'printer_width': '80', 'cache_selected_only': 'False', 'quiet': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'partial_parse': 'True', 'log_path': '/usr/app/dbt/dbt/logs'}
[0m22:12:31.726302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '35c026d5-4b30-4cec-bf23-bb4968e1930a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7212e2fb8e10>]}
[0m22:12:31.776755 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '35c026d5-4b30-4cec-bf23-bb4968e1930a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7212e6bb8d10>]}
[0m22:12:31.779744 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:12:31.935619 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:12:31.952594 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:12:31.954031 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '35c026d5-4b30-4cec-bf23-bb4968e1930a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7212e3eea610>]}
[0m22:12:34.353145 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:12:34.356808 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.9156141, "process_in_blocks": "0", "process_kernel_time": 0.440046, "process_mem_max_rss": "117444", "process_out_blocks": "0", "process_user_time": 2.365757}
[0m22:12:34.358428 [debug] [MainThread]: Command `dbt run` failed at 22:12:34.358341 after 2.92 seconds
[0m22:12:34.360287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7212e3e32650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7212e1ff0250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7212e3e60d10>]}
[0m22:12:34.361742 [debug] [MainThread]: Flushing usage events
[0m22:12:34.970270 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:13:28.208741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70276dde9fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70276dddd110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70276ddde8d0>]}


============================== 22:13:28.215691 | f09a342c-009e-4e35-b650-65a0f9a9a8f5 ==============================
[0m22:13:28.215691 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:13:28.217411 [debug] [MainThread]: running dbt with arguments {'fail_fast': 'False', 'cache_selected_only': 'False', 'indirect_selection': 'eager', 'write_json': 'True', 'quiet': 'False', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True', 'introspect': 'True', 'empty': 'False', 'target_path': 'None', 'log_format': 'default', 'printer_width': '80', 'log_path': '/usr/app/dbt/dbt/logs', 'no_print': 'None', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'version_check': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'debug': 'False', 'use_colors': 'True', 'warn_error': 'None', 'log_cache_events': 'False'}
[0m22:13:28.358730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f09a342c-009e-4e35-b650-65a0f9a9a8f5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70276deff790>]}
[0m22:13:28.406621 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f09a342c-009e-4e35-b650-65a0f9a9a8f5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70276d4ba410>]}
[0m22:13:28.409331 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:13:28.584346 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:13:28.612847 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:13:28.615459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'f09a342c-009e-4e35-b650-65a0f9a9a8f5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70276d1663d0>]}
[0m22:13:31.523280 [error] [MainThread]: Encountered an error:
Compilation Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  
  Warning: `dbt_utils.surrogate_key` has been replaced by `dbt_utils.generate_surrogate_key`. The new macro treats null values differently to empty strings. To restore the behaviour of the original macro, add a global variable in dbt_project.yml called `surrogate_key_treat_nulls_as_empty_strings` to your dbt_project.yml file with a value of True. The data_project_1.stg_air_quality_valencia model triggered this warning. 
  
  > in macro default__surrogate_key (macros/sql/surrogate_key.sql)
  > called by macro surrogate_key (macros/sql/surrogate_key.sql)
  > called by model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
[0m22:13:31.528661 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.3934755, "process_in_blocks": "0", "process_kernel_time": 0.432747, "process_mem_max_rss": "117304", "process_out_blocks": "0", "process_user_time": 2.322955}
[0m22:13:31.531702 [debug] [MainThread]: Command `dbt run` failed at 22:13:31.531604 after 3.40 seconds
[0m22:13:31.536431 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7027725e2f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70276dd8a610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70276c5c2c10>]}
[0m22:13:31.538514 [debug] [MainThread]: Flushing usage events
[0m22:13:32.314567 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:14:10.574313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7932c68099d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7932c6f67850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7932c680b290>]}


============================== 22:14:10.582742 | 1bad3012-477f-468c-8167-f96f2a28e4a6 ==============================
[0m22:14:10.582742 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:14:10.583917 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'introspect': 'True', 'invocation_command': 'dbt run', 'use_colors': 'True', 'partial_parse': 'True', 'printer_width': '80', 'write_json': 'True', 'fail_fast': 'False', 'cache_selected_only': 'False', 'empty': 'False', 'send_anonymous_usage_stats': 'True', 'target_path': 'None', 'log_cache_events': 'False', 'warn_error': 'None', 'profiles_dir': '/usr/app/dbt/dbt', 'quiet': 'False', 'indirect_selection': 'eager', 'log_format': 'default', 'use_experimental_parser': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/app/dbt/dbt/logs', 'static_parser': 'True', 'version_check': 'True'}
[0m22:14:10.727447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1bad3012-477f-468c-8167-f96f2a28e4a6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7932c551e2d0>]}
[0m22:14:10.775873 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1bad3012-477f-468c-8167-f96f2a28e4a6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7932c9586650>]}
[0m22:14:10.779455 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:14:10.923557 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:14:10.943013 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:14:10.944629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '1bad3012-477f-468c-8167-f96f2a28e4a6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7932c55ae3d0>]}
[0m22:14:13.789978 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.data_project_1.int_evolucion_temporal' (models/intermediate/int_evolucion_temporal.sql) depends on a node named 'staging_valenbisi' which was not found
[0m22:14:13.793279 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.2949317, "process_in_blocks": "0", "process_kernel_time": 0.488495, "process_mem_max_rss": "122016", "process_out_blocks": "0", "process_user_time": 2.446448}
[0m22:14:13.795577 [debug] [MainThread]: Command `dbt run` failed at 22:14:13.795499 after 3.30 seconds
[0m22:14:13.797372 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7932c6b70990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7932cb072e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7932cb072dd0>]}
[0m22:14:13.798957 [debug] [MainThread]: Flushing usage events
[0m22:14:14.603887 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:14:16.767234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x747bbf3cc5d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x747bc1d86fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x747bbf09ec10>]}


============================== 22:14:16.776228 | a5b87a60-50a6-4945-9001-045d5ac76c74 ==============================
[0m22:14:16.776228 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:14:16.777983 [debug] [MainThread]: running dbt with arguments {'profiles_dir': '/usr/app/dbt/dbt', 'use_colors': 'True', 'invocation_command': 'dbt run', 'fail_fast': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'quiet': 'False', 'warn_error': 'None', 'target_path': 'None', 'cache_selected_only': 'False', 'indirect_selection': 'eager', 'partial_parse': 'True', 'version_check': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'static_parser': 'True', 'log_format': 'default', 'write_json': 'True', 'debug': 'False', 'no_print': 'None', 'use_experimental_parser': 'False', 'printer_width': '80', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'empty': 'False', 'log_cache_events': 'False'}
[0m22:14:16.947779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a5b87a60-50a6-4945-9001-045d5ac76c74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x747bbefd8dd0>]}
[0m22:14:16.994835 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a5b87a60-50a6-4945-9001-045d5ac76c74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x747bc1d9a790>]}
[0m22:14:16.997568 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:14:17.150238 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:14:17.171709 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:14:17.174764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'a5b87a60-50a6-4945-9001-045d5ac76c74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x747bbf04d590>]}
[0m22:14:19.936285 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.data_project_1.int_evolucion_temporal' (models/intermediate/int_evolucion_temporal.sql) depends on a node named 'staging_valenbisi' which was not found
[0m22:14:19.939338 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.245116, "process_in_blocks": "0", "process_kernel_time": 0.498118, "process_mem_max_rss": "121644", "process_out_blocks": "0", "process_user_time": 2.383852}
[0m22:14:19.942083 [debug] [MainThread]: Command `dbt run` failed at 22:14:19.941996 after 3.25 seconds
[0m22:14:19.945502 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x747bc387ad90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x747bbf02edd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x747bbcf32050>]}
[0m22:14:19.947476 [debug] [MainThread]: Flushing usage events
[0m22:14:20.595034 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:14:22.865507 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x770834b32d10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x770834b33d50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x770834b32f10>]}


============================== 22:14:22.871101 | bbf8c519-07dc-4206-8612-acec79e1f3a5 ==============================
[0m22:14:22.871101 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:14:22.875637 [debug] [MainThread]: running dbt with arguments {'version_check': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'log_cache_events': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'send_anonymous_usage_stats': 'True', 'log_format': 'default', 'fail_fast': 'False', 'partial_parse': 'True', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'indirect_selection': 'eager', 'use_experimental_parser': 'False', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'use_colors': 'True', 'write_json': 'True', 'debug': 'False', 'cache_selected_only': 'False', 'introspect': 'True', 'static_parser': 'True', 'printer_width': '80', 'no_print': 'None'}
[0m22:14:23.018275 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bbf8c519-07dc-4206-8612-acec79e1f3a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x770834adcd50>]}
[0m22:14:23.073796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bbf8c519-07dc-4206-8612-acec79e1f3a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x770837856850>]}
[0m22:14:23.085483 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:14:23.207474 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:14:23.218157 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:14:23.219682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'bbf8c519-07dc-4206-8612-acec79e1f3a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x770833fc16d0>]}
[0m22:14:26.405185 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.data_project_1.int_evolucion_temporal' (models/intermediate/int_evolucion_temporal.sql) depends on a node named 'staging_valenbisi' which was not found
[0m22:14:26.408410 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.6042283, "process_in_blocks": "0", "process_kernel_time": 0.430393, "process_mem_max_rss": "121528", "process_out_blocks": "0", "process_user_time": 2.658786}
[0m22:14:26.410103 [debug] [MainThread]: Command `dbt run` failed at 22:14:26.409901 after 3.61 seconds
[0m22:14:26.411137 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7708396115d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x770834f50450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x770839336dd0>]}
[0m22:14:26.412282 [debug] [MainThread]: Flushing usage events
[0m22:14:27.203394 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:14:29.679744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704f642eb6d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704f615de9d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704f642d7c50>]}


============================== 22:14:29.690013 | b574f11c-e0a4-4ed2-b48a-ca60d0842b1a ==============================
[0m22:14:29.690013 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:14:29.691782 [debug] [MainThread]: running dbt with arguments {'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/app/dbt/dbt/logs', 'write_json': 'True', 'static_parser': 'True', 'debug': 'False', 'printer_width': '80', 'target_path': 'None', 'no_print': 'None', 'indirect_selection': 'eager', 'profiles_dir': '/usr/app/dbt/dbt', 'use_experimental_parser': 'False', 'quiet': 'False', 'empty': 'False', 'partial_parse': 'True', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'version_check': 'True', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'invocation_command': 'dbt run', 'log_format': 'default', 'fail_fast': 'False', 'use_colors': 'True', 'warn_error': 'None'}
[0m22:14:29.832870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b574f11c-e0a4-4ed2-b48a-ca60d0842b1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704f609799d0>]}
[0m22:14:29.885685 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b574f11c-e0a4-4ed2-b48a-ca60d0842b1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704f60d3afd0>]}
[0m22:14:29.888431 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:14:30.043976 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:14:30.057840 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:14:30.058832 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'b574f11c-e0a4-4ed2-b48a-ca60d0842b1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704f60ca1d10>]}
[0m22:14:32.840812 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.data_project_1.int_evolucion_temporal' (models/intermediate/int_evolucion_temporal.sql) depends on a node named 'staging_valenbisi' which was not found
[0m22:14:32.846030 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.2308276, "process_in_blocks": "0", "process_kernel_time": 0.393404, "process_mem_max_rss": "122084", "process_out_blocks": "0", "process_user_time": 2.595657}
[0m22:14:32.848312 [debug] [MainThread]: Command `dbt run` failed at 22:14:32.848180 after 3.23 seconds
[0m22:14:32.849763 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704f65dded90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704f61582950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x704f5f533090>]}
[0m22:14:32.851660 [debug] [MainThread]: Flushing usage events
[0m22:14:33.598152 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:14:36.475716 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76cd2ae3ee10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76cd2ae467d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76cd2b24b5d0>]}


============================== 22:14:36.481943 | 9b39a65b-5733-4067-b9b4-e9ee3bce36b2 ==============================
[0m22:14:36.481943 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:14:36.483440 [debug] [MainThread]: running dbt with arguments {'warn_error': 'None', 'empty': 'False', 'printer_width': '80', 'cache_selected_only': 'False', 'log_cache_events': 'False', 'introspect': 'True', 'invocation_command': 'dbt run', 'debug': 'False', 'partial_parse': 'True', 'fail_fast': 'False', 'static_parser': 'True', 'write_json': 'True', 'use_colors': 'True', 'quiet': 'False', 'log_format': 'default', 'version_check': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'indirect_selection': 'eager', 'send_anonymous_usage_stats': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'no_print': 'None', 'use_experimental_parser': 'False', 'target_path': 'None'}
[0m22:14:36.608850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9b39a65b-5733-4067-b9b4-e9ee3bce36b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76cd2be62c10>]}
[0m22:14:36.652682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9b39a65b-5733-4067-b9b4-e9ee3bce36b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76cd2db74690>]}
[0m22:14:36.654438 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:14:36.790434 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:14:36.816668 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:14:36.818742 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '9b39a65b-5733-4067-b9b4-e9ee3bce36b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76cd29f4abd0>]}
[0m22:14:39.687362 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.data_project_1.int_evolucion_temporal' (models/intermediate/int_evolucion_temporal.sql) depends on a node named 'staging_valenbisi' which was not found
[0m22:14:39.690922 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.2787578, "process_in_blocks": "0", "process_kernel_time": 0.353864, "process_mem_max_rss": "121396", "process_out_blocks": "0", "process_user_time": 2.619412}
[0m22:14:39.692630 [debug] [MainThread]: Command `dbt run` failed at 22:14:39.692508 after 3.28 seconds
[0m22:14:39.693915 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76cd29ba0310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76cd28708a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76cd2f64add0>]}
[0m22:14:39.695188 [debug] [MainThread]: Flushing usage events
[0m22:14:40.311095 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:14:43.978359 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71ec2d3b27d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71ec2d35d350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71ec2d35e5d0>]}


============================== 22:14:43.985950 | 189c4d7e-3f15-4de7-9468-79a429fd06d2 ==============================
[0m22:14:43.985950 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:14:43.988244 [debug] [MainThread]: running dbt with arguments {'empty': 'False', 'debug': 'False', 'quiet': 'False', 'log_cache_events': 'False', 'introspect': 'True', 'warn_error': 'None', 'fail_fast': 'False', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'indirect_selection': 'eager', 'invocation_command': 'dbt run', 'log_format': 'default', 'no_print': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'write_json': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'target_path': 'None', 'static_parser': 'True', 'use_colors': 'True', 'version_check': 'True', 'cache_selected_only': 'False', 'printer_width': '80'}
[0m22:14:44.147108 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '189c4d7e-3f15-4de7-9468-79a429fd06d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71ec2c74e790>]}
[0m22:14:44.194374 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '189c4d7e-3f15-4de7-9468-79a429fd06d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71ec300bcb10>]}
[0m22:14:44.196803 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:14:44.319296 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:14:44.329090 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:14:44.330097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '189c4d7e-3f15-4de7-9468-79a429fd06d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71ec2bb0ec10>]}
[0m22:14:47.308365 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.data_project_1.int_evolucion_temporal' (models/intermediate/int_evolucion_temporal.sql) depends on a node named 'staging_valenbisi' which was not found
[0m22:14:47.315969 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.4114053, "process_in_blocks": "0", "process_kernel_time": 0.386492, "process_mem_max_rss": "121808", "process_out_blocks": "0", "process_user_time": 2.550056}
[0m22:14:47.318785 [debug] [MainThread]: Command `dbt run` failed at 22:14:47.318490 after 3.41 seconds
[0m22:14:47.321224 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71ec31c7acd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71ec2af64d10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71ec23da24d0>]}
[0m22:14:47.323390 [debug] [MainThread]: Flushing usage events
[0m22:14:47.987308 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:14:53.349583 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70bbe09e7090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70bbe0997e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70bbe0992b90>]}


============================== 22:14:53.355087 | bbf1767c-8427-4785-919b-61f2cc389355 ==============================
[0m22:14:53.355087 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:14:53.357129 [debug] [MainThread]: running dbt with arguments {'use_experimental_parser': 'False', 'quiet': 'False', 'cache_selected_only': 'False', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'indirect_selection': 'eager', 'profiles_dir': '/usr/app/dbt/dbt', 'use_colors': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'fail_fast': 'False', 'invocation_command': 'dbt run', 'no_print': 'None', 'log_cache_events': 'False', 'partial_parse': 'True', 'log_format': 'default', 'log_path': '/usr/app/dbt/dbt/logs', 'warn_error': 'None', 'printer_width': '80', 'write_json': 'True', 'static_parser': 'True', 'version_check': 'True', 'empty': 'False', 'debug': 'False'}
[0m22:14:53.514904 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bbf1767c-8427-4785-919b-61f2cc389355', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70bbdfd6dad0>]}
[0m22:14:53.569975 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bbf1767c-8427-4785-919b-61f2cc389355', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70bbe371e710>]}
[0m22:14:53.572386 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:14:53.691324 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:14:53.739200 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:14:53.744305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'bbf1767c-8427-4785-919b-61f2cc389355', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70bbdf9ae690>]}
[0m22:14:57.073925 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.data_project_1.int_evolucion_temporal' (models/intermediate/int_evolucion_temporal.sql) depends on a node named 'staging_valenbisi' which was not found
[0m22:14:57.077517 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.805238, "process_in_blocks": "0", "process_kernel_time": 0.422334, "process_mem_max_rss": "121764", "process_out_blocks": "0", "process_user_time": 2.641582}
[0m22:14:57.079374 [debug] [MainThread]: Command `dbt run` failed at 22:14:57.079138 after 3.81 seconds
[0m22:14:57.080898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70bbe0980790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70bbde5b0850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70bbe0982b10>]}
[0m22:14:57.082180 [debug] [MainThread]: Flushing usage events
[0m22:14:57.590925 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:15:06.245977 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78c7b65a9a50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78c7b655be10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78c7b6555f50>]}


============================== 22:15:06.257071 | 80b94d24-0a64-427b-8357-f517c7499f6b ==============================
[0m22:15:06.257071 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:15:06.259596 [debug] [MainThread]: running dbt with arguments {'static_parser': 'True', 'indirect_selection': 'eager', 'fail_fast': 'False', 'write_json': 'True', 'introspect': 'True', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'send_anonymous_usage_stats': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'invocation_command': 'dbt run', 'no_print': 'None', 'printer_width': '80', 'partial_parse': 'True', 'log_cache_events': 'False', 'empty': 'False', 'target_path': 'None', 'version_check': 'True', 'cache_selected_only': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'log_format': 'default', 'debug': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error': 'None'}
[0m22:15:06.422234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '80b94d24-0a64-427b-8357-f517c7499f6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78c7b6c86990>]}
[0m22:15:06.465866 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '80b94d24-0a64-427b-8357-f517c7499f6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78c7b55ddfd0>]}
[0m22:15:06.468027 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:15:06.586175 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:15:06.627779 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:15:06.634558 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '80b94d24-0a64-427b-8357-f517c7499f6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78c7b5596ad0>]}
[0m22:15:09.986336 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.data_project_1.int_evolucion_temporal' (models/intermediate/int_evolucion_temporal.sql) depends on a node named 'staging_valenbisi' which was not found
[0m22:15:09.989730 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.8611434, "process_in_blocks": "0", "process_kernel_time": 0.408973, "process_mem_max_rss": "121776", "process_out_blocks": "0", "process_user_time": 2.77778}
[0m22:15:09.992622 [debug] [MainThread]: Command `dbt run` failed at 22:15:09.992474 after 3.86 seconds
[0m22:15:09.994716 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78c7b6546790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78c7b4555d10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78c7b494cd10>]}
[0m22:15:09.996622 [debug] [MainThread]: Flushing usage events
[0m22:15:10.532695 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:15:25.517873 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765ecaa1ea10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765eca9e8e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765ecaa1e490>]}


============================== 22:15:25.524862 | a239a69b-1a60-4126-a8cb-a09e5b0bc2a8 ==============================
[0m22:15:25.524862 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:15:25.526550 [debug] [MainThread]: running dbt with arguments {'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'fail_fast': 'False', 'log_format': 'default', 'empty': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'cache_selected_only': 'False', 'use_experimental_parser': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'partial_parse': 'True', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'no_print': 'None', 'target_path': 'None', 'introspect': 'True', 'write_json': 'True', 'log_cache_events': 'False', 'indirect_selection': 'eager', 'quiet': 'False', 'printer_width': '80', 'warn_error': 'None'}
[0m22:15:25.675181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a239a69b-1a60-4126-a8cb-a09e5b0bc2a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765eca189e50>]}
[0m22:15:25.730203 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a239a69b-1a60-4126-a8cb-a09e5b0bc2a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765ecd730890>]}
[0m22:15:25.732182 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:15:25.868822 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:15:25.895721 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:15:25.898042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'a239a69b-1a60-4126-a8cb-a09e5b0bc2a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765ec9d96b90>]}
[0m22:15:28.442750 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.data_project_1.int_evolucion_temporal' (models/intermediate/int_evolucion_temporal.sql) depends on a node named 'staging_valenbisi' which was not found
[0m22:15:28.445777 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.0031567, "process_in_blocks": "0", "process_kernel_time": 0.403534, "process_mem_max_rss": "122276", "process_out_blocks": "0", "process_user_time": 2.558408}
[0m22:15:28.448181 [debug] [MainThread]: Command `dbt run` failed at 22:15:28.447965 after 3.01 seconds
[0m22:15:28.450057 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765ecb88d950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765ec89416d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765ecf222c50>]}
[0m22:15:28.452029 [debug] [MainThread]: Flushing usage events
[0m22:15:29.151115 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:15:56.788030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7002b3083d10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7002b302c990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7002b308e810>]}


============================== 22:15:56.798002 | ba593906-9071-4aaf-9361-389e8f19c224 ==============================
[0m22:15:56.798002 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:15:56.801652 [debug] [MainThread]: running dbt with arguments {'use_experimental_parser': 'False', 'cache_selected_only': 'False', 'invocation_command': 'dbt run', 'write_json': 'True', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'printer_width': '80', 'fail_fast': 'False', 'static_parser': 'True', 'introspect': 'True', 'indirect_selection': 'eager', 'no_print': 'None', 'profiles_dir': '/usr/app/dbt/dbt', 'use_colors': 'True', 'target_path': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'debug': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_cache_events': 'False', 'partial_parse': 'True', 'warn_error': 'None', 'version_check': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:15:56.990825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ba593906-9071-4aaf-9361-389e8f19c224', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7002b301eb50>]}
[0m22:15:57.041941 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ba593906-9071-4aaf-9361-389e8f19c224', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7002b5da2910>]}
[0m22:15:57.046026 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:15:57.201591 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:15:57.268922 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:15:57.271661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'ba593906-9071-4aaf-9361-389e8f19c224', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7002b21c3250>]}
[0m22:16:00.342722 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.data_project_1.int_evolucion_temporal' (models/intermediate/int_evolucion_temporal.sql) depends on a node named 'staging_valenbisi' which was not found
[0m22:16:00.362943 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.6444218, "process_in_blocks": "0", "process_kernel_time": 0.448797, "process_mem_max_rss": "122036", "process_out_blocks": "0", "process_user_time": 2.567445}
[0m22:16:00.368113 [debug] [MainThread]: Command `dbt run` failed at 22:16:00.367551 after 3.65 seconds
[0m22:16:00.372856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7002b3394810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7002b41d9550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7002b7896dd0>]}
[0m22:16:00.377012 [debug] [MainThread]: Flushing usage events
[0m22:16:01.307278 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:16:54.630807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7dd1e85b6b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7dd1e85b6c90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7dd1e85b6410>]}


============================== 22:16:54.638469 | cf505cb2-f918-4761-ad0c-3401ab64c898 ==============================
[0m22:16:54.638469 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:16:54.643602 [debug] [MainThread]: running dbt with arguments {'version_check': 'True', 'static_parser': 'True', 'write_json': 'True', 'warn_error': 'None', 'fail_fast': 'False', 'target_path': 'None', 'debug': 'False', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'indirect_selection': 'eager', 'quiet': 'False', 'invocation_command': 'dbt run', 'printer_width': '80', 'no_print': 'None', 'log_format': 'default', 'cache_selected_only': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'introspect': 'True', 'empty': 'False', 'log_cache_events': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'send_anonymous_usage_stats': 'True', 'use_colors': 'True'}
[0m22:16:54.800915 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cf505cb2-f918-4761-ad0c-3401ab64c898', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7dd1e95de550>]}
[0m22:16:54.859508 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cf505cb2-f918-4761-ad0c-3401ab64c898', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7dd1eb2c47d0>]}
[0m22:16:54.862157 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:16:54.992006 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:16:55.010964 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:16:55.012524 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'cf505cb2-f918-4761-ad0c-3401ab64c898', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7dd1e85fe650>]}
[0m22:17:02.119990 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9d6f45e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9d72447d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9d6f46950>]}


============================== 22:17:02.130364 | 99feae6d-ab51-40bf-9c9c-cf57456eb992 ==============================
[0m22:17:02.130364 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:17:02.132132 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'write_json': 'True', 'send_anonymous_usage_stats': 'True', 'quiet': 'False', 'cache_selected_only': 'False', 'use_colors': 'True', 'debug': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'partial_parse': 'True', 'no_print': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'empty': 'False', 'log_format': 'default', 'fail_fast': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_cache_events': 'False', 'printer_width': '80', 'invocation_command': 'dbt run', 'use_experimental_parser': 'False', 'introspect': 'True', 'indirect_selection': 'eager', 'version_check': 'True', 'static_parser': 'True', 'warn_error': 'None'}
[0m22:17:02.268812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '99feae6d-ab51-40bf-9c9c-cf57456eb992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9d6f76650>]}
[0m22:17:02.313556 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '99feae6d-ab51-40bf-9c9c-cf57456eb992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9d9c4a8d0>]}
[0m22:17:02.315756 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:17:02.472161 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:17:02.499922 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m22:17:02.501861 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '99feae6d-ab51-40bf-9c9c-cf57456eb992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9d6ef5f50>]}
[0m22:17:05.635712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '99feae6d-ab51-40bf-9c9c-cf57456eb992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9d46ab050>]}
[0m22:17:05.846449 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:05.859504 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:05.929950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '99feae6d-ab51-40bf-9c9c-cf57456eb992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9d4b40390>]}
[0m22:17:05.931626 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:17:05.933165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '99feae6d-ab51-40bf-9c9c-cf57456eb992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9d45b9090>]}
[0m22:17:05.937062 [info ] [MainThread]: 
[0m22:17:05.938253 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:17:05.939378 [info ] [MainThread]: 
[0m22:17:05.941364 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:17:05.943304 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:17:06.030125 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:17:06.031950 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:17:06.033567 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:17:06.135972 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.102 seconds
[0m22:17:06.141148 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:17:06.145282 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:17:06.156948 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:06.159659 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:17:06.162005 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:17:06.177126 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m22:17:06.179075 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:06.180692 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:17:06.231551 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.049 seconds
[0m22:17:06.235000 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:17:06.236754 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:17:06.244797 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:06.245962 [debug] [MainThread]: On master: BEGIN
[0m22:17:06.247424 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:17:06.257806 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m22:17:06.259479 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:06.260904 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:17:06.292311 [debug] [MainThread]: SQL status: SELECT 5 in 0.030 seconds
[0m22:17:06.296833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '99feae6d-ab51-40bf-9c9c-cf57456eb992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9d4b41a10>]}
[0m22:17:06.298237 [debug] [MainThread]: On master: ROLLBACK
[0m22:17:06.299952 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:06.301105 [debug] [MainThread]: On master: BEGIN
[0m22:17:06.302467 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:17:06.303806 [debug] [MainThread]: On master: COMMIT
[0m22:17:06.305162 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:06.306476 [debug] [MainThread]: On master: COMMIT
[0m22:17:06.307855 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:17:06.309584 [debug] [MainThread]: On master: Close
[0m22:17:06.317343 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:17:06.318856 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:17:06.320396 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:17:06.321947 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:17:06.329496 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:06.365633 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:17:06.399028 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:06.426735 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:06.428313 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:17:06.429624 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:17:06.440158 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m22:17:06.441918 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:06.443780 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0;
  );
[0m22:17:06.448874 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 139: WHERE concentration_ug_m3 >= 0;
                                        ^

[0m22:17:06.450070 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: ROLLBACK
[0m22:17:06.451431 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:17:06.461195 [debug] [Thread-1 (]: Database Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  syntax error at or near ";"
  LINE 139: WHERE concentration_ug_m3 >= 0;
                                          ^
  compiled code at target/run/data_project_1/models/staging/stg_air_quality_valencia.sql
[0m22:17:06.464795 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '99feae6d-ab51-40bf-9c9c-cf57456eb992', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9d3b3c790>]}
[0m22:17:06.466702 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model public.stg_air_quality_valencia ........... [[31mERROR[0m in 0.14s]
[0m22:17:06.468599 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:17:06.470243 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.stg_air_quality_valencia' to be skipped because of status 'error'.  Reason: Database Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  syntax error at or near ";"
  LINE 139: WHERE concentration_ug_m3 >= 0;
                                          ^
  compiled code at target/run/data_project_1/models/staging/stg_air_quality_valencia.sql.
[0m22:17:06.474144 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:06.475350 [debug] [MainThread]: On master: BEGIN
[0m22:17:06.476480 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:17:06.488391 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m22:17:06.490485 [debug] [MainThread]: On master: COMMIT
[0m22:17:06.491736 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:06.493093 [debug] [MainThread]: On master: COMMIT
[0m22:17:06.494606 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:17:06.495836 [debug] [MainThread]: On master: Close
[0m22:17:06.497348 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:17:06.498819 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:17:06.500007 [info ] [MainThread]: 
[0m22:17:06.501662 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.56 seconds (0.56s).
[0m22:17:06.504043 [debug] [MainThread]: Command end result
[0m22:17:06.564542 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:06.576509 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:06.590172 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:17:06.591865 [info ] [MainThread]: 
[0m22:17:06.593693 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m22:17:06.595305 [info ] [MainThread]: 
[0m22:17:06.597078 [error] [MainThread]: [31mFailure in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)[0m
[0m22:17:06.598878 [error] [MainThread]:   Database Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  syntax error at or near ";"
  LINE 139: WHERE concentration_ug_m3 >= 0;
                                          ^
  compiled code at target/run/data_project_1/models/staging/stg_air_quality_valencia.sql
[0m22:17:06.600663 [info ] [MainThread]: 
[0m22:17:06.602158 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/staging/stg_air_quality_valencia.sql
[0m22:17:06.603533 [info ] [MainThread]: 
[0m22:17:06.605055 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=1
[0m22:17:06.608000 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 4.575983, "process_in_blocks": "160", "process_kernel_time": 0.515646, "process_mem_max_rss": "132168", "process_out_blocks": "0", "process_user_time": 3.06568}
[0m22:17:06.609741 [debug] [MainThread]: Command `dbt run` failed at 22:17:06.609552 after 4.58 seconds
[0m22:17:06.611303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9db73ee90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9db73edd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71d9d6f38f90>]}
[0m22:17:06.612380 [debug] [MainThread]: Flushing usage events
[0m22:17:07.451014 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:17:09.661458 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3009bf30d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3009b9cb50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3009b9ef50>]}


============================== 22:17:09.667430 | 5fa9dd4d-cb95-45ef-b645-c490f7e73c47 ==============================
[0m22:17:09.667430 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:17:09.669587 [debug] [MainThread]: running dbt with arguments {'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_format': 'default', 'indirect_selection': 'eager', 'warn_error': 'None', 'introspect': 'True', 'partial_parse': 'True', 'version_check': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'log_cache_events': 'False', 'quiet': 'False', 'static_parser': 'True', 'empty': 'False', 'printer_width': '80', 'write_json': 'True', 'no_print': 'None', 'fail_fast': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'send_anonymous_usage_stats': 'True', 'debug': 'False', 'use_experimental_parser': 'False', 'use_colors': 'True', 'target_path': 'None'}
[0m22:17:09.795602 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5fa9dd4d-cb95-45ef-b645-c490f7e73c47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3009b9e850>]}
[0m22:17:09.838636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5fa9dd4d-cb95-45ef-b645-c490f7e73c47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f300c924850>]}
[0m22:17:09.841299 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:17:09.975251 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:17:11.286722 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:17:11.287602 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:17:11.319682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5fa9dd4d-cb95-45ef-b645-c490f7e73c47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3008391590>]}
[0m22:17:11.438413 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:11.446644 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:11.510553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5fa9dd4d-cb95-45ef-b645-c490f7e73c47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f30083c5190>]}
[0m22:17:11.512239 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:17:11.514338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5fa9dd4d-cb95-45ef-b645-c490f7e73c47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3007b2c0d0>]}
[0m22:17:11.518317 [info ] [MainThread]: 
[0m22:17:11.521334 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:17:11.524118 [info ] [MainThread]: 
[0m22:17:11.526835 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:17:11.530041 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:17:11.658584 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:17:11.666685 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:17:11.672846 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:17:11.707088 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.034 seconds
[0m22:17:11.710715 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:17:11.715040 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:17:11.723647 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:11.725665 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:17:11.727509 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:17:11.743367 [debug] [ThreadPool]: SQL status: BEGIN in 0.016 seconds
[0m22:17:11.746097 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:11.748030 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:17:11.759437 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.009 seconds
[0m22:17:11.764812 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:17:11.767150 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:17:11.778251 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:11.780403 [debug] [MainThread]: On master: BEGIN
[0m22:17:11.782243 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:17:11.794859 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m22:17:11.796925 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:11.799024 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:17:11.809730 [debug] [MainThread]: SQL status: SELECT 5 in 0.009 seconds
[0m22:17:11.813639 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5fa9dd4d-cb95-45ef-b645-c490f7e73c47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f30083e0210>]}
[0m22:17:11.815513 [debug] [MainThread]: On master: ROLLBACK
[0m22:17:11.817046 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:11.818882 [debug] [MainThread]: On master: BEGIN
[0m22:17:11.820808 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:17:11.822386 [debug] [MainThread]: On master: COMMIT
[0m22:17:11.824173 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:11.825426 [debug] [MainThread]: On master: COMMIT
[0m22:17:11.826740 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:17:11.827909 [debug] [MainThread]: On master: Close
[0m22:17:11.836212 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:17:11.837554 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:17:11.839740 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:17:11.841028 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:17:11.860849 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:11.898838 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:17:11.934994 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:11.949367 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:11.951024 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:17:11.952026 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:17:11.963558 [debug] [Thread-1 (]: SQL status: BEGIN in 0.011 seconds
[0m22:17:11.965148 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:11.967270 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0;
  );
[0m22:17:11.973332 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 139: WHERE concentration_ug_m3 >= 0;
                                        ^

[0m22:17:11.985371 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: ROLLBACK
[0m22:17:11.988335 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:17:11.996242 [debug] [Thread-1 (]: Database Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  syntax error at or near ";"
  LINE 139: WHERE concentration_ug_m3 >= 0;
                                          ^
  compiled code at target/run/data_project_1/models/staging/stg_air_quality_valencia.sql
[0m22:17:11.999596 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5fa9dd4d-cb95-45ef-b645-c490f7e73c47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3006a61cd0>]}
[0m22:17:12.002542 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model public.stg_air_quality_valencia ........... [[31mERROR[0m in 0.16s]
[0m22:17:12.005094 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:17:12.007292 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.stg_air_quality_valencia' to be skipped because of status 'error'.  Reason: Database Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  syntax error at or near ";"
  LINE 139: WHERE concentration_ug_m3 >= 0;
                                          ^
  compiled code at target/run/data_project_1/models/staging/stg_air_quality_valencia.sql.
[0m22:17:12.012045 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:12.013734 [debug] [MainThread]: On master: BEGIN
[0m22:17:12.015738 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:17:12.029024 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m22:17:12.030989 [debug] [MainThread]: On master: COMMIT
[0m22:17:12.032494 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:12.033790 [debug] [MainThread]: On master: COMMIT
[0m22:17:12.038690 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:17:12.040452 [debug] [MainThread]: On master: Close
[0m22:17:12.042109 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:17:12.043571 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:17:12.045018 [info ] [MainThread]: 
[0m22:17:12.046882 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.52 seconds (0.52s).
[0m22:17:12.049269 [debug] [MainThread]: Command end result
[0m22:17:12.113039 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:12.120876 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:12.130477 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:17:12.131607 [info ] [MainThread]: 
[0m22:17:12.132837 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m22:17:12.135319 [info ] [MainThread]: 
[0m22:17:12.136834 [error] [MainThread]: [31mFailure in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)[0m
[0m22:17:12.138493 [error] [MainThread]:   Database Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  syntax error at or near ";"
  LINE 139: WHERE concentration_ug_m3 >= 0;
                                          ^
  compiled code at target/run/data_project_1/models/staging/stg_air_quality_valencia.sql
[0m22:17:12.139916 [info ] [MainThread]: 
[0m22:17:12.141378 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/staging/stg_air_quality_valencia.sql
[0m22:17:12.142734 [info ] [MainThread]: 
[0m22:17:12.144409 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=1
[0m22:17:12.146870 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.5652514, "process_in_blocks": "0", "process_kernel_time": 0.356089, "process_mem_max_rss": "126672", "process_out_blocks": "0", "process_user_time": 1.907055}
[0m22:17:12.148184 [debug] [MainThread]: Command `dbt run` failed at 22:17:12.148053 after 2.57 seconds
[0m22:17:12.149753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3009b8e8d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f300e4c6b10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f30041c5a10>]}
[0m22:17:12.151155 [debug] [MainThread]: Flushing usage events
[0m22:17:13.189461 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:17:15.358429 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79ef6c9e2610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79ef6ca42450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79ef6c9e2a10>]}


============================== 22:17:15.368287 | 158775b6-6e36-41c9-bb00-be8766c0a502 ==============================
[0m22:17:15.368287 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:17:15.371059 [debug] [MainThread]: running dbt with arguments {'log_path': '/usr/app/dbt/dbt/logs', 'indirect_selection': 'eager', 'printer_width': '80', 'profiles_dir': '/usr/app/dbt/dbt', 'static_parser': 'True', 'no_print': 'None', 'partial_parse': 'True', 'use_experimental_parser': 'False', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'quiet': 'False', 'debug': 'False', 'fail_fast': 'False', 'log_format': 'default', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'invocation_command': 'dbt run', 'empty': 'False', 'cache_selected_only': 'False', 'use_colors': 'True', 'write_json': 'True', 'warn_error': 'None', 'introspect': 'True', 'version_check': 'True', 'log_cache_events': 'False'}
[0m22:17:15.526729 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '158775b6-6e36-41c9-bb00-be8766c0a502', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79ef6bbc7190>]}
[0m22:17:15.568391 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '158775b6-6e36-41c9-bb00-be8766c0a502', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79ef6f74a750>]}
[0m22:17:15.570570 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:17:15.727676 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:17:17.483371 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:17:17.484557 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:17:17.516211 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '158775b6-6e36-41c9-bb00-be8766c0a502', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79ef6b7665d0>]}
[0m22:17:17.666248 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:17.675908 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:17.710687 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '158775b6-6e36-41c9-bb00-be8766c0a502', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79ef6aba8e50>]}
[0m22:17:17.712648 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:17:17.714887 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '158775b6-6e36-41c9-bb00-be8766c0a502', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79ef6a316890>]}
[0m22:17:17.718460 [info ] [MainThread]: 
[0m22:17:17.720967 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:17:17.723257 [info ] [MainThread]: 
[0m22:17:17.725610 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:17:17.728474 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:17:17.854512 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:17:17.856461 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:17:17.858047 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:17:17.875356 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m22:17:17.878962 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:17:17.883107 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:17:17.890142 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:17.892100 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:17:17.893745 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:17:17.903731 [debug] [ThreadPool]: SQL status: BEGIN in 0.010 seconds
[0m22:17:17.905479 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:17.906755 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:17:17.915737 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.007 seconds
[0m22:17:17.919283 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:17:17.921417 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:17:17.929114 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:17.931126 [debug] [MainThread]: On master: BEGIN
[0m22:17:17.932807 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:17:17.943299 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m22:17:17.945327 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:17.947980 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:17:17.956684 [debug] [MainThread]: SQL status: SELECT 5 in 0.007 seconds
[0m22:17:17.961029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '158775b6-6e36-41c9-bb00-be8766c0a502', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79ef6bbbd810>]}
[0m22:17:17.962759 [debug] [MainThread]: On master: ROLLBACK
[0m22:17:17.964792 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:17.966244 [debug] [MainThread]: On master: BEGIN
[0m22:17:17.968159 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:17:17.969607 [debug] [MainThread]: On master: COMMIT
[0m22:17:17.971133 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:17.972469 [debug] [MainThread]: On master: COMMIT
[0m22:17:17.974233 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:17:17.975807 [debug] [MainThread]: On master: Close
[0m22:17:17.985347 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:17:17.987259 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:17:17.988974 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:17:17.990349 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:17:18.006004 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:18.019864 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:17:18.044930 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:18.059474 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:18.060636 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:17:18.062319 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:17:18.074049 [debug] [Thread-1 (]: SQL status: BEGIN in 0.012 seconds
[0m22:17:18.075532 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:18.076827 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0;
  );
[0m22:17:18.081786 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 139: WHERE concentration_ug_m3 >= 0;
                                        ^

[0m22:17:18.083419 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: ROLLBACK
[0m22:17:18.085404 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:17:18.091879 [debug] [Thread-1 (]: Database Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  syntax error at or near ";"
  LINE 139: WHERE concentration_ug_m3 >= 0;
                                          ^
  compiled code at target/run/data_project_1/models/staging/stg_air_quality_valencia.sql
[0m22:17:18.095194 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '158775b6-6e36-41c9-bb00-be8766c0a502', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79ef69845690>]}
[0m22:17:18.097761 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model public.stg_air_quality_valencia ........... [[31mERROR[0m in 0.11s]
[0m22:17:18.099721 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:17:18.101751 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.stg_air_quality_valencia' to be skipped because of status 'error'.  Reason: Database Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  syntax error at or near ";"
  LINE 139: WHERE concentration_ug_m3 >= 0;
                                          ^
  compiled code at target/run/data_project_1/models/staging/stg_air_quality_valencia.sql.
[0m22:17:18.105949 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:18.107539 [debug] [MainThread]: On master: BEGIN
[0m22:17:18.108908 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:17:18.122830 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m22:17:18.124814 [debug] [MainThread]: On master: COMMIT
[0m22:17:18.126856 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:18.128173 [debug] [MainThread]: On master: COMMIT
[0m22:17:18.130216 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:17:18.131876 [debug] [MainThread]: On master: Close
[0m22:17:18.133379 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:17:18.134699 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:17:18.136358 [info ] [MainThread]: 
[0m22:17:18.138080 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.41 seconds (0.41s).
[0m22:17:18.140085 [debug] [MainThread]: Command end result
[0m22:17:18.218119 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:18.227818 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:18.243065 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:17:18.244280 [info ] [MainThread]: 
[0m22:17:18.245714 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m22:17:18.247324 [info ] [MainThread]: 
[0m22:17:18.249100 [error] [MainThread]: [31mFailure in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)[0m
[0m22:17:18.251176 [error] [MainThread]:   Database Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  syntax error at or near ";"
  LINE 139: WHERE concentration_ug_m3 >= 0;
                                          ^
  compiled code at target/run/data_project_1/models/staging/stg_air_quality_valencia.sql
[0m22:17:18.252768 [info ] [MainThread]: 
[0m22:17:18.254255 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/staging/stg_air_quality_valencia.sql
[0m22:17:18.255733 [info ] [MainThread]: 
[0m22:17:18.257063 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=1
[0m22:17:18.259159 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.9578576, "process_in_blocks": "0", "process_kernel_time": 0.395972, "process_mem_max_rss": "127168", "process_out_blocks": "0", "process_user_time": 1.893243}
[0m22:17:18.260568 [debug] [MainThread]: Command `dbt run` failed at 22:17:18.260407 after 2.96 seconds
[0m22:17:18.261960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79ef7123ae50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79ef7123ae90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79ef6d9e0a50>]}
[0m22:17:18.264628 [debug] [MainThread]: Flushing usage events
[0m22:17:19.039952 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:17:21.503185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb9999bd990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb9999680d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb99996a6d0>]}


============================== 22:17:21.508425 | fd9bb17f-2898-446b-992b-dad3749829a8 ==============================
[0m22:17:21.508425 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:17:21.509811 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'invocation_command': 'dbt run', 'empty': 'False', 'version_check': 'True', 'warn_error': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'send_anonymous_usage_stats': 'True', 'quiet': 'False', 'introspect': 'True', 'write_json': 'True', 'use_colors': 'True', 'log_cache_events': 'False', 'target_path': 'None', 'fail_fast': 'False', 'partial_parse': 'True', 'debug': 'False', 'cache_selected_only': 'False', 'static_parser': 'True', 'use_experimental_parser': 'False', 'indirect_selection': 'eager', 'log_format': 'default', 'log_path': '/usr/app/dbt/dbt/logs', 'profiles_dir': '/usr/app/dbt/dbt', 'no_print': 'None'}
[0m22:17:21.703928 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fd9bb17f-2898-446b-992b-dad3749829a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb99995a050>]}
[0m22:17:21.749660 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fd9bb17f-2898-446b-992b-dad3749829a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb99c6ca790>]}
[0m22:17:21.752924 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:17:21.900851 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:17:25.213301 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:17:25.215087 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:17:25.248496 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fd9bb17f-2898-446b-992b-dad3749829a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb9989e8510>]}
[0m22:17:25.437793 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:25.450695 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:25.497155 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fd9bb17f-2898-446b-992b-dad3749829a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb997de0c90>]}
[0m22:17:25.499858 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:17:25.501749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fd9bb17f-2898-446b-992b-dad3749829a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb9975641d0>]}
[0m22:17:25.505500 [info ] [MainThread]: 
[0m22:17:25.507807 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:17:25.509256 [info ] [MainThread]: 
[0m22:17:25.511510 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:17:25.514521 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:17:25.623726 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:17:25.625792 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:17:25.627244 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:17:25.647274 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.020 seconds
[0m22:17:25.650482 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:17:25.653572 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:17:25.663727 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:25.665637 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:17:25.667856 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:17:25.678565 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m22:17:25.680305 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:25.681763 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:17:25.688023 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.005 seconds
[0m22:17:25.690593 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:17:25.693068 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:17:25.701077 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:25.702920 [debug] [MainThread]: On master: BEGIN
[0m22:17:25.704573 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:17:25.714680 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m22:17:25.717620 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:25.719481 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:17:25.726666 [debug] [MainThread]: SQL status: SELECT 5 in 0.006 seconds
[0m22:17:25.730189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fd9bb17f-2898-446b-992b-dad3749829a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb99c33d290>]}
[0m22:17:25.731591 [debug] [MainThread]: On master: ROLLBACK
[0m22:17:25.734994 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:25.736662 [debug] [MainThread]: On master: BEGIN
[0m22:17:25.738215 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:17:25.739736 [debug] [MainThread]: On master: COMMIT
[0m22:17:25.742503 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:25.744614 [debug] [MainThread]: On master: COMMIT
[0m22:17:25.747381 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:17:25.750947 [debug] [MainThread]: On master: Close
[0m22:17:25.763251 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:17:25.769053 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:17:25.772035 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:17:25.775945 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:17:25.801065 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:25.836436 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:17:25.864228 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:25.918043 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:25.920456 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:17:25.923878 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:17:25.937504 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m22:17:25.942582 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:25.952804 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0;
  );
[0m22:17:25.960852 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 139: WHERE concentration_ug_m3 >= 0;
                                        ^

[0m22:17:25.963305 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: ROLLBACK
[0m22:17:25.966599 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:17:25.972001 [debug] [Thread-1 (]: Database Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  syntax error at or near ";"
  LINE 139: WHERE concentration_ug_m3 >= 0;
                                          ^
  compiled code at target/run/data_project_1/models/staging/stg_air_quality_valencia.sql
[0m22:17:25.976477 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fd9bb17f-2898-446b-992b-dad3749829a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb996735310>]}
[0m22:17:25.979246 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model public.stg_air_quality_valencia ........... [[31mERROR[0m in 0.20s]
[0m22:17:25.983901 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:17:25.987541 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.stg_air_quality_valencia' to be skipped because of status 'error'.  Reason: Database Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  syntax error at or near ";"
  LINE 139: WHERE concentration_ug_m3 >= 0;
                                          ^
  compiled code at target/run/data_project_1/models/staging/stg_air_quality_valencia.sql.
[0m22:17:25.994966 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:26.001803 [debug] [MainThread]: On master: BEGIN
[0m22:17:26.003898 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:17:26.017302 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m22:17:26.020188 [debug] [MainThread]: On master: COMMIT
[0m22:17:26.021759 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:26.023156 [debug] [MainThread]: On master: COMMIT
[0m22:17:26.024327 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:17:26.025426 [debug] [MainThread]: On master: Close
[0m22:17:26.027005 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:17:26.030242 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:17:26.031751 [info ] [MainThread]: 
[0m22:17:26.033265 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.52 seconds (0.52s).
[0m22:17:26.035808 [debug] [MainThread]: Command end result
[0m22:17:26.107453 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:26.115920 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:26.129154 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:17:26.130295 [info ] [MainThread]: 
[0m22:17:26.131615 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m22:17:26.133019 [info ] [MainThread]: 
[0m22:17:26.134224 [error] [MainThread]: [31mFailure in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)[0m
[0m22:17:26.136358 [error] [MainThread]:   Database Error in model stg_air_quality_valencia (models/staging/stg_air_quality_valencia.sql)
  syntax error at or near ";"
  LINE 139: WHERE concentration_ug_m3 >= 0;
                                          ^
  compiled code at target/run/data_project_1/models/staging/stg_air_quality_valencia.sql
[0m22:17:26.138037 [info ] [MainThread]: 
[0m22:17:26.139703 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/staging/stg_air_quality_valencia.sql
[0m22:17:26.141312 [info ] [MainThread]: 
[0m22:17:26.142863 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=1
[0m22:17:26.145702 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 4.713255, "process_in_blocks": "0", "process_kernel_time": 0.435694, "process_mem_max_rss": "127488", "process_out_blocks": "0", "process_user_time": 1.942637}
[0m22:17:26.149077 [debug] [MainThread]: Command `dbt run` failed at 22:17:26.148814 after 4.72 seconds
[0m22:17:26.150659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb999988c90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb999ddb450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bb99b948810>]}
[0m22:17:26.152240 [debug] [MainThread]: Flushing usage events
[0m22:17:26.908267 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:17:29.828702 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76c500d997d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76c500d99fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76c500d9ac10>]}


============================== 22:17:29.837295 | 43eb7c5d-b5f4-47c7-a8d3-fa1b07c48460 ==============================
[0m22:17:29.837295 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:17:29.839325 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'partial_parse': 'True', 'warn_error': 'None', 'cache_selected_only': 'False', 'empty': 'False', 'log_cache_events': 'False', 'send_anonymous_usage_stats': 'True', 'target_path': 'None', 'indirect_selection': 'eager', 'profiles_dir': '/usr/app/dbt/dbt', 'version_check': 'True', 'use_colors': 'True', 'fail_fast': 'False', 'debug': 'False', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/app/dbt/dbt/logs', 'write_json': 'True', 'introspect': 'True', 'invocation_command': 'dbt run', 'log_format': 'default', 'static_parser': 'True', 'use_experimental_parser': 'False', 'no_print': 'None'}
[0m22:17:30.020916 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '43eb7c5d-b5f4-47c7-a8d3-fa1b07c48460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76c50057e2d0>]}
[0m22:17:30.065764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '43eb7c5d-b5f4-47c7-a8d3-fa1b07c48460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76c503b08810>]}
[0m22:17:30.069767 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:17:30.354140 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:17:32.681103 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:17:32.682853 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/staging/stg_air_quality_valencia.sql
[0m22:17:33.070947 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '43eb7c5d-b5f4-47c7-a8d3-fa1b07c48460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76c4ff50c090>]}
[0m22:17:33.217654 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:33.228494 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:33.271289 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '43eb7c5d-b5f4-47c7-a8d3-fa1b07c48460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76c4ff594510>]}
[0m22:17:33.272792 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:17:33.274449 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43eb7c5d-b5f4-47c7-a8d3-fa1b07c48460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76c500131150>]}
[0m22:17:33.279391 [info ] [MainThread]: 
[0m22:17:33.280635 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:17:33.281808 [info ] [MainThread]: 
[0m22:17:33.283169 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:17:33.285348 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:17:33.332324 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:17:33.334600 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:17:33.335919 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:17:33.377557 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.041 seconds
[0m22:17:33.381799 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:17:33.389817 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:17:33.403538 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:33.405623 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:17:33.407714 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:17:33.421246 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m22:17:33.423872 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:33.425046 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:17:33.432747 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.006 seconds
[0m22:17:33.434965 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:17:33.436334 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:17:33.443586 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:33.444790 [debug] [MainThread]: On master: BEGIN
[0m22:17:33.445655 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:17:33.456294 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m22:17:33.457655 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:33.459393 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:17:33.465576 [debug] [MainThread]: SQL status: SELECT 5 in 0.005 seconds
[0m22:17:33.467665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43eb7c5d-b5f4-47c7-a8d3-fa1b07c48460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76c4fe91e710>]}
[0m22:17:33.468916 [debug] [MainThread]: On master: ROLLBACK
[0m22:17:33.470084 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:33.470808 [debug] [MainThread]: On master: BEGIN
[0m22:17:33.471872 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:17:33.473151 [debug] [MainThread]: On master: COMMIT
[0m22:17:33.473923 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:33.474637 [debug] [MainThread]: On master: COMMIT
[0m22:17:33.475667 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:17:33.476348 [debug] [MainThread]: On master: Close
[0m22:17:33.480913 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:17:33.481944 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:17:33.483158 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:17:33.484144 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:17:33.490442 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:33.499077 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:17:33.526544 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:33.535155 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:33.536010 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:17:33.536942 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:17:33.546950 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m22:17:33.548257 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:33.549253 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:17:33.596530 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.046 seconds
[0m22:17:33.624073 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:33.627796 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:17:33.645981 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.008 seconds
[0m22:17:33.653105 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:33.684798 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:17:33.688403 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:17:33.709108 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:17:33.710671 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:33.712204 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:17:33.715655 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:17:33.724553 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:17:33.731623 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:33.733923 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:17:33.764261 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.029 seconds
[0m22:17:33.767677 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:17:33.770054 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43eb7c5d-b5f4-47c7-a8d3-fa1b07c48460', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76c4fdaa3690>]}
[0m22:17:33.771644 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.29s]
[0m22:17:33.773061 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:17:33.776297 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:33.777353 [debug] [MainThread]: On master: BEGIN
[0m22:17:33.778322 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:17:33.787866 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m22:17:33.789006 [debug] [MainThread]: On master: COMMIT
[0m22:17:33.789971 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:33.791201 [debug] [MainThread]: On master: COMMIT
[0m22:17:33.792636 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:17:33.793525 [debug] [MainThread]: On master: Close
[0m22:17:33.794595 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:17:33.795772 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:17:33.796791 [info ] [MainThread]: 
[0m22:17:33.798088 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.51 seconds (0.51s).
[0m22:17:33.799575 [debug] [MainThread]: Command end result
[0m22:17:33.851001 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:33.860225 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:33.868089 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:17:33.868912 [info ] [MainThread]: 
[0m22:17:33.874169 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:17:33.878286 [info ] [MainThread]: 
[0m22:17:33.882538 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:17:33.887785 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 4.1217484, "process_in_blocks": "0", "process_kernel_time": 0.494044, "process_mem_max_rss": "130680", "process_out_blocks": "0", "process_user_time": 2.15008}
[0m22:17:33.893919 [debug] [MainThread]: Command `dbt run` succeeded at 22:17:33.893785 after 4.13 seconds
[0m22:17:33.899825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76c505903910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76c5056ba9d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76c5056bb690>]}
[0m22:17:33.905425 [debug] [MainThread]: Flushing usage events
[0m22:17:34.690841 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:17:38.164881 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70669d6b5e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70669d6b6650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70669d6b6750>]}


============================== 22:17:38.174377 | 157dfb5f-e605-4097-aeaf-b050ec19019d ==============================
[0m22:17:38.174377 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:17:38.177161 [debug] [MainThread]: running dbt with arguments {'fail_fast': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'static_parser': 'True', 'log_cache_events': 'False', 'use_colors': 'True', 'target_path': 'None', 'use_experimental_parser': 'False', 'quiet': 'False', 'printer_width': '80', 'write_json': 'True', 'no_print': 'None', 'send_anonymous_usage_stats': 'True', 'partial_parse': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'warn_error': 'None', 'indirect_selection': 'eager', 'invocation_command': 'dbt run', 'version_check': 'True', 'log_format': 'default', 'introspect': 'True', 'debug': 'False', 'cache_selected_only': 'False', 'profiles_dir': '/usr/app/dbt/dbt'}
[0m22:17:38.309058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '157dfb5f-e605-4097-aeaf-b050ec19019d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70669c365950>]}
[0m22:17:38.365065 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '157dfb5f-e605-4097-aeaf-b050ec19019d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7066a03d27d0>]}
[0m22:17:38.367267 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:17:38.562477 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:17:40.719774 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:17:40.721099 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:17:40.757334 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '157dfb5f-e605-4097-aeaf-b050ec19019d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70669b7959d0>]}
[0m22:17:40.894174 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:40.928768 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:40.994459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '157dfb5f-e605-4097-aeaf-b050ec19019d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70669b7c7e90>]}
[0m22:17:40.995895 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:17:40.997141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '157dfb5f-e605-4097-aeaf-b050ec19019d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70669af38250>]}
[0m22:17:41.000095 [info ] [MainThread]: 
[0m22:17:41.001576 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:17:41.002950 [info ] [MainThread]: 
[0m22:17:41.004082 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:17:41.005876 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:17:41.105505 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:17:41.113032 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:17:41.121903 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:17:41.150141 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.028 seconds
[0m22:17:41.156661 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:17:41.160869 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:17:41.174674 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:41.176182 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:17:41.177196 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:17:41.185825 [debug] [ThreadPool]: SQL status: BEGIN in 0.009 seconds
[0m22:17:41.187224 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:41.188295 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:17:41.193999 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.004 seconds
[0m22:17:41.196614 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:17:41.198274 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:17:41.203364 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:41.204636 [debug] [MainThread]: On master: BEGIN
[0m22:17:41.206098 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:17:41.215953 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m22:17:41.218546 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:41.221508 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:17:41.227837 [debug] [MainThread]: SQL status: SELECT 1 in 0.005 seconds
[0m22:17:41.230026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '157dfb5f-e605-4097-aeaf-b050ec19019d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70669b7783d0>]}
[0m22:17:41.231178 [debug] [MainThread]: On master: ROLLBACK
[0m22:17:41.232564 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:41.234158 [debug] [MainThread]: On master: BEGIN
[0m22:17:41.235650 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:17:41.236738 [debug] [MainThread]: On master: COMMIT
[0m22:17:41.238034 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:41.239104 [debug] [MainThread]: On master: COMMIT
[0m22:17:41.240289 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:17:41.241366 [debug] [MainThread]: On master: Close
[0m22:17:41.250149 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:17:41.251733 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:17:41.253432 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:17:41.254707 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:17:41.271738 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:41.283036 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:17:41.307422 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:41.332528 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:41.341514 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:17:41.349365 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:17:41.363355 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m22:17:41.370983 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:41.378016 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:17:41.392841 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.013 seconds
[0m22:17:41.404002 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:41.405584 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:17:41.407877 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:17:41.413421 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:41.414748 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:17:41.416808 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:17:41.431249 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:17:41.435532 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:41.438435 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:17:41.445483 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:17:41.455345 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:17:41.461785 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:41.463484 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:17:41.469288 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m22:17:41.481116 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:17:41.484617 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '157dfb5f-e605-4097-aeaf-b050ec19019d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70669bff4850>]}
[0m22:17:41.486988 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.23s]
[0m22:17:41.488842 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:17:41.492344 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:41.494000 [debug] [MainThread]: On master: BEGIN
[0m22:17:41.495283 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:17:41.506675 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m22:17:41.509149 [debug] [MainThread]: On master: COMMIT
[0m22:17:41.515364 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:41.518078 [debug] [MainThread]: On master: COMMIT
[0m22:17:41.520071 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:17:41.521796 [debug] [MainThread]: On master: Close
[0m22:17:41.523504 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:17:41.524857 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:17:41.526325 [info ] [MainThread]: 
[0m22:17:41.531467 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.52 seconds (0.52s).
[0m22:17:41.535156 [debug] [MainThread]: Command end result
[0m22:17:41.636611 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:41.644946 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:41.658644 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:17:41.659643 [info ] [MainThread]: 
[0m22:17:41.661171 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:17:41.662300 [info ] [MainThread]: 
[0m22:17:41.663937 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:17:41.666423 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.5819883, "process_in_blocks": "0", "process_kernel_time": 0.356289, "process_mem_max_rss": "127268", "process_out_blocks": "0", "process_user_time": 1.809471}
[0m22:17:41.671227 [debug] [MainThread]: Command `dbt run` succeeded at 22:17:41.671133 after 3.59 seconds
[0m22:17:41.680391 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70669d656e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70669d6566d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7066a1f5f8d0>]}
[0m22:17:41.684864 [debug] [MainThread]: Flushing usage events
[0m22:17:42.476877 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:17:48.473636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7effef5dc910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7effef5de750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7effef5deb90>]}


============================== 22:17:48.486607 | 51ca4ebe-3230-443e-87a6-13eec62fb1a5 ==============================
[0m22:17:48.486607 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:17:48.496565 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'invocation_command': 'dbt run', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'empty': 'False', 'use_experimental_parser': 'False', 'log_format': 'default', 'log_path': '/usr/app/dbt/dbt/logs', 'profiles_dir': '/usr/app/dbt/dbt', 'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'no_print': 'None', 'write_json': 'True', 'version_check': 'True', 'target_path': 'None', 'use_colors': 'True', 'indirect_selection': 'eager', 'warn_error': 'None', 'fail_fast': 'False', 'printer_width': '80', 'log_cache_events': 'False', 'quiet': 'False', 'static_parser': 'True', 'cache_selected_only': 'False'}
[0m22:17:48.666194 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '51ca4ebe-3230-443e-87a6-13eec62fb1a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7effefa68310>]}
[0m22:17:48.714540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '51ca4ebe-3230-443e-87a6-13eec62fb1a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7efff23388d0>]}
[0m22:17:48.716790 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:17:48.859432 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:17:50.917801 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:17:50.919400 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:17:50.960838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '51ca4ebe-3230-443e-87a6-13eec62fb1a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7effef4a39d0>]}
[0m22:17:56.529848 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2be8215650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2be8217250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2be8271ed0>]}


============================== 22:17:56.540026 | f3a2ce68-ee7f-4f1f-b3fb-92dbfe9edc8e ==============================
[0m22:17:56.540026 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:17:56.541557 [debug] [MainThread]: running dbt with arguments {'invocation_command': 'dbt run', 'target_path': 'None', 'partial_parse': 'True', 'cache_selected_only': 'False', 'printer_width': '80', 'warn_error': 'None', 'version_check': 'True', 'introspect': 'True', 'log_format': 'default', 'log_path': '/usr/app/dbt/dbt/logs', 'write_json': 'True', 'log_cache_events': 'False', 'quiet': 'False', 'no_print': 'None', 'empty': 'False', 'indirect_selection': 'eager', 'debug': 'False', 'fail_fast': 'False', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'profiles_dir': '/usr/app/dbt/dbt', 'use_colors': 'True', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True'}
[0m22:17:56.679550 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f3a2ce68-ee7f-4f1f-b3fb-92dbfe9edc8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2be6f68d10>]}
[0m22:17:56.730313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f3a2ce68-ee7f-4f1f-b3fb-92dbfe9edc8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2beaf8a8d0>]}
[0m22:17:56.733532 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:17:56.893094 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:17:58.656185 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:17:58.657860 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:17:58.692323 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f3a2ce68-ee7f-4f1f-b3fb-92dbfe9edc8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2be63f0650>]}
[0m22:17:58.819150 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:58.828531 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:58.856341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f3a2ce68-ee7f-4f1f-b3fb-92dbfe9edc8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2be63ae4d0>]}
[0m22:17:58.857690 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:17:58.859376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f3a2ce68-ee7f-4f1f-b3fb-92dbfe9edc8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2be5b28690>]}
[0m22:17:58.863899 [info ] [MainThread]: 
[0m22:17:58.865165 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:17:58.866466 [info ] [MainThread]: 
[0m22:17:58.867672 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:17:58.870370 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:17:58.977737 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:17:58.979086 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:17:58.980709 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:17:58.996784 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.016 seconds
[0m22:17:58.999760 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:17:59.003518 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:17:59.011745 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:59.013127 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:17:59.014075 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:17:59.025361 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m22:17:59.026876 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:17:59.028690 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:17:59.039182 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.009 seconds
[0m22:17:59.041976 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:17:59.043596 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:17:59.051506 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:59.052868 [debug] [MainThread]: On master: BEGIN
[0m22:17:59.054024 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:17:59.066534 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m22:17:59.068464 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:59.069986 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:17:59.081399 [debug] [MainThread]: SQL status: SELECT 1 in 0.010 seconds
[0m22:17:59.084698 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f3a2ce68-ee7f-4f1f-b3fb-92dbfe9edc8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2be6f17490>]}
[0m22:17:59.086429 [debug] [MainThread]: On master: ROLLBACK
[0m22:17:59.088353 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:59.089474 [debug] [MainThread]: On master: BEGIN
[0m22:17:59.091576 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:17:59.092805 [debug] [MainThread]: On master: COMMIT
[0m22:17:59.094695 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:59.096410 [debug] [MainThread]: On master: COMMIT
[0m22:17:59.097819 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:17:59.099742 [debug] [MainThread]: On master: Close
[0m22:17:59.108506 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:17:59.111520 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:17:59.113706 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:17:59.114847 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:17:59.132084 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:59.147290 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:17:59.178179 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:17:59.192650 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:59.198438 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:17:59.202132 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:17:59.211603 [debug] [Thread-1 (]: SQL status: BEGIN in 0.009 seconds
[0m22:17:59.213061 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:59.214303 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:17:59.222920 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.007 seconds
[0m22:17:59.229459 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:59.230693 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:17:59.233540 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:17:59.236717 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:59.237884 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:17:59.239982 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:17:59.252033 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:17:59.253245 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:59.254237 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:17:59.256753 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:17:59.261986 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:17:59.266204 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:17:59.267462 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:17:59.272931 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m22:17:59.275675 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:17:59.277841 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3a2ce68-ee7f-4f1f-b3fb-92dbfe9edc8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2be6bab850>]}
[0m22:17:59.279609 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.16s]
[0m22:17:59.281698 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:17:59.285856 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:59.287776 [debug] [MainThread]: On master: BEGIN
[0m22:17:59.289281 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:17:59.300195 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m22:17:59.302154 [debug] [MainThread]: On master: COMMIT
[0m22:17:59.303720 [debug] [MainThread]: Using postgres connection "master"
[0m22:17:59.305037 [debug] [MainThread]: On master: COMMIT
[0m22:17:59.306467 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:17:59.307789 [debug] [MainThread]: On master: Close
[0m22:17:59.309266 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:17:59.310511 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:17:59.312320 [info ] [MainThread]: 
[0m22:17:59.314133 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.44 seconds (0.44s).
[0m22:17:59.315897 [debug] [MainThread]: Command end result
[0m22:17:59.376230 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:17:59.385113 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:17:59.397336 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:17:59.398412 [info ] [MainThread]: 
[0m22:17:59.399555 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:17:59.400586 [info ] [MainThread]: 
[0m22:17:59.401889 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:17:59.403872 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.9361203, "process_in_blocks": "0", "process_kernel_time": 0.432866, "process_mem_max_rss": "127028", "process_out_blocks": "0", "process_user_time": 1.839681}
[0m22:17:59.405368 [debug] [MainThread]: Command `dbt run` succeeded at 22:17:59.405236 after 2.94 seconds
[0m22:17:59.407148 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2be8578b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2becb2f810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e2beca7edd0>]}
[0m22:17:59.408536 [debug] [MainThread]: Flushing usage events
[0m22:18:00.046369 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:18:02.252854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x759049b26250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x759049e32bd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x759049b32450>]}


============================== 22:18:02.260599 | 072d5a9d-4427-45f7-b964-5b4d244ed2e5 ==============================
[0m22:18:02.260599 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:18:02.262394 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'target_path': 'None', 'empty': 'False', 'warn_error': 'None', 'use_colors': 'True', 'write_json': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'version_check': 'True', 'cache_selected_only': 'False', 'no_print': 'None', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'use_experimental_parser': 'False', 'quiet': 'False', 'indirect_selection': 'eager', 'printer_width': '80', 'log_cache_events': 'False', 'log_format': 'default', 'introspect': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'fail_fast': 'False'}
[0m22:18:02.418831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '072d5a9d-4427-45f7-b964-5b4d244ed2e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x759049b47790>]}
[0m22:18:02.463728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '072d5a9d-4427-45f7-b964-5b4d244ed2e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x759048bbdd50>]}
[0m22:18:02.466300 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:18:02.625260 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:18:04.375527 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:18:04.377200 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:18:04.413432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '072d5a9d-4427-45f7-b964-5b4d244ed2e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x759047f82810>]}
[0m22:18:04.521460 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:04.530821 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:04.564607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '072d5a9d-4427-45f7-b964-5b4d244ed2e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x759047fcc4d0>]}
[0m22:18:04.565936 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:18:04.567380 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '072d5a9d-4427-45f7-b964-5b4d244ed2e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x759049ad1590>]}
[0m22:18:04.571014 [info ] [MainThread]: 
[0m22:18:04.572617 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:18:04.574314 [info ] [MainThread]: 
[0m22:18:04.575925 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:18:04.578469 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:18:04.686077 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:18:04.689475 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:18:04.691810 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:18:04.705936 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.014 seconds
[0m22:18:04.709493 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:18:04.712298 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:18:04.718281 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:04.719847 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:18:04.720679 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:18:04.728845 [debug] [ThreadPool]: SQL status: BEGIN in 0.008 seconds
[0m22:18:04.729727 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:04.731133 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:18:04.737897 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m22:18:04.741356 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:18:04.743039 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:18:04.750002 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:04.751482 [debug] [MainThread]: On master: BEGIN
[0m22:18:04.753881 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:18:04.763944 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m22:18:04.765861 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:04.767949 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:18:04.775048 [debug] [MainThread]: SQL status: SELECT 1 in 0.005 seconds
[0m22:18:04.777766 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '072d5a9d-4427-45f7-b964-5b4d244ed2e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x759048fc7710>]}
[0m22:18:04.779201 [debug] [MainThread]: On master: ROLLBACK
[0m22:18:04.781591 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:04.784582 [debug] [MainThread]: On master: BEGIN
[0m22:18:04.786432 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:18:04.787725 [debug] [MainThread]: On master: COMMIT
[0m22:18:04.788986 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:04.789995 [debug] [MainThread]: On master: COMMIT
[0m22:18:04.791669 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:04.793119 [debug] [MainThread]: On master: Close
[0m22:18:04.801459 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:18:04.803465 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:18:04.805310 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:18:04.807305 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:18:04.829417 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:04.841053 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:18:04.873330 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:04.886660 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:04.888166 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:18:04.889666 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:18:04.901720 [debug] [Thread-1 (]: SQL status: BEGIN in 0.012 seconds
[0m22:18:04.903532 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:04.905139 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:18:04.919816 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.013 seconds
[0m22:18:04.928146 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:04.930099 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:18:04.933756 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:18:04.937818 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:04.939049 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:18:04.941784 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:18:04.953763 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:04.955371 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:04.956437 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:04.959846 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:18:04.966154 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:18:04.971058 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:04.972128 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:18:04.977253 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m22:18:04.980224 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:18:04.982724 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '072d5a9d-4427-45f7-b964-5b4d244ed2e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75904b97e190>]}
[0m22:18:04.984021 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.18s]
[0m22:18:04.985602 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:18:04.988367 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:04.989628 [debug] [MainThread]: On master: BEGIN
[0m22:18:04.990977 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:18:05.001687 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m22:18:05.003248 [debug] [MainThread]: On master: COMMIT
[0m22:18:05.004405 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:05.005817 [debug] [MainThread]: On master: COMMIT
[0m22:18:05.007034 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:05.008112 [debug] [MainThread]: On master: Close
[0m22:18:05.009349 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:18:05.010099 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:18:05.011218 [info ] [MainThread]: 
[0m22:18:05.012468 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.44 seconds (0.44s).
[0m22:18:05.014524 [debug] [MainThread]: Command end result
[0m22:18:05.078886 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:05.087781 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:05.098907 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:18:05.100425 [info ] [MainThread]: 
[0m22:18:05.102123 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:18:05.103554 [info ] [MainThread]: 
[0m22:18:05.105369 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:18:05.107383 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.925155, "process_in_blocks": "0", "process_kernel_time": 0.39157, "process_mem_max_rss": "126728", "process_out_blocks": "0", "process_user_time": 1.925559}
[0m22:18:05.108543 [debug] [MainThread]: Command `dbt run` succeeded at 22:18:05.108443 after 2.93 seconds
[0m22:18:05.109749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75904e3eb810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75904e406a50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x75904e406910>]}
[0m22:18:05.111103 [debug] [MainThread]: Flushing usage events
[0m22:18:05.751316 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:18:07.952295 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889652c3150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889652e0d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788967ffb9d0>]}


============================== 22:18:07.957815 | bcd5da31-808c-4480-847a-04a6db6d7753 ==============================
[0m22:18:07.957815 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:18:07.959466 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'debug': 'False', 'log_cache_events': 'False', 'invocation_command': 'dbt run', 'no_print': 'None', 'use_colors': 'True', 'static_parser': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'target_path': 'None', 'write_json': 'True', 'indirect_selection': 'eager', 'send_anonymous_usage_stats': 'True', 'warn_error': 'None', 'printer_width': '80', 'fail_fast': 'False', 'introspect': 'True', 'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_experimental_parser': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'log_format': 'default', 'quiet': 'False', 'version_check': 'True', 'partial_parse': 'True'}
[0m22:18:08.094852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bcd5da31-808c-4480-847a-04a6db6d7753', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788965433790>]}
[0m22:18:08.143405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bcd5da31-808c-4480-847a-04a6db6d7753', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788968022910>]}
[0m22:18:08.145935 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:18:08.269915 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:18:09.736488 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:18:09.738234 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:18:09.774725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bcd5da31-808c-4480-847a-04a6db6d7753', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78896374c150>]}
[0m22:18:09.879003 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:09.887083 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:09.915157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bcd5da31-808c-4480-847a-04a6db6d7753', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78896374cf90>]}
[0m22:18:09.916794 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:18:09.918353 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bcd5da31-808c-4480-847a-04a6db6d7753', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788962f1a650>]}
[0m22:18:09.920641 [info ] [MainThread]: 
[0m22:18:09.921883 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:18:09.925111 [info ] [MainThread]: 
[0m22:18:09.927022 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:18:09.929930 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:18:10.052007 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:18:10.053733 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:18:10.057151 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:18:10.074005 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m22:18:10.076569 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:18:10.079038 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:18:10.084258 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:10.086788 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:18:10.091296 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:18:10.100575 [debug] [ThreadPool]: SQL status: BEGIN in 0.009 seconds
[0m22:18:10.102895 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:10.103809 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:18:10.110709 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m22:18:10.113041 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:18:10.114435 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:18:10.121141 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:10.125711 [debug] [MainThread]: On master: BEGIN
[0m22:18:10.127212 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:18:10.135055 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m22:18:10.136118 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:10.136924 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:18:10.144344 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m22:18:10.146237 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bcd5da31-808c-4480-847a-04a6db6d7753', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788962146250>]}
[0m22:18:10.147116 [debug] [MainThread]: On master: ROLLBACK
[0m22:18:10.148188 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:10.148812 [debug] [MainThread]: On master: BEGIN
[0m22:18:10.149719 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:18:10.150461 [debug] [MainThread]: On master: COMMIT
[0m22:18:10.151199 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:10.151919 [debug] [MainThread]: On master: COMMIT
[0m22:18:10.152787 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:10.153602 [debug] [MainThread]: On master: Close
[0m22:18:10.162123 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:18:10.177818 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:18:10.180703 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:18:10.183287 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:18:10.199196 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:10.241423 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:18:10.278423 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:10.300222 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:10.302467 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:18:10.303767 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:18:10.315492 [debug] [Thread-1 (]: SQL status: BEGIN in 0.012 seconds
[0m22:18:10.317355 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:10.318800 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:18:10.330035 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.010 seconds
[0m22:18:10.337228 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:10.338412 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:18:10.341540 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:18:10.344896 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:10.346021 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:18:10.348259 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:18:10.362869 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:10.364182 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:10.365363 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:10.369037 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:18:10.377406 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:18:10.387333 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:10.394619 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:18:10.402611 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m22:18:10.409868 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:18:10.412883 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bcd5da31-808c-4480-847a-04a6db6d7753', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788963fddf90>]}
[0m22:18:10.414728 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.23s]
[0m22:18:10.416368 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:18:10.419919 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:10.423213 [debug] [MainThread]: On master: BEGIN
[0m22:18:10.425162 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:18:10.440367 [debug] [MainThread]: SQL status: BEGIN in 0.015 seconds
[0m22:18:10.442150 [debug] [MainThread]: On master: COMMIT
[0m22:18:10.443550 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:10.447999 [debug] [MainThread]: On master: COMMIT
[0m22:18:10.449391 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:10.450915 [debug] [MainThread]: On master: Close
[0m22:18:10.452325 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:18:10.454227 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:18:10.457275 [info ] [MainThread]: 
[0m22:18:10.459433 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.53 seconds (0.53s).
[0m22:18:10.461955 [debug] [MainThread]: Command end result
[0m22:18:10.539846 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:10.549688 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:10.566259 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:18:10.567910 [info ] [MainThread]: 
[0m22:18:10.569504 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:18:10.570975 [info ] [MainThread]: 
[0m22:18:10.572833 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:18:10.575023 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.6959617, "process_in_blocks": "0", "process_kernel_time": 0.366381, "process_mem_max_rss": "127172", "process_out_blocks": "0", "process_user_time": 1.880219}
[0m22:18:10.576811 [debug] [MainThread]: Command `dbt run` succeeded at 22:18:10.576643 after 2.70 seconds
[0m22:18:10.578162 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7889652b3c90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78896561ca90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788969b16dd0>]}
[0m22:18:10.579623 [debug] [MainThread]: Flushing usage events
[0m22:18:11.518038 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:18:13.984234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72310ebae950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72310a720490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72310a7225d0>]}


============================== 22:18:13.991208 | b505e766-b4ce-4241-b32a-0cf1fec46b63 ==============================
[0m22:18:13.991208 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:18:13.992323 [debug] [MainThread]: running dbt with arguments {'warn_error': 'None', 'target_path': 'None', 'printer_width': '80', 'partial_parse': 'True', 'send_anonymous_usage_stats': 'True', 'empty': 'False', 'indirect_selection': 'eager', 'use_colors': 'True', 'use_experimental_parser': 'False', 'invocation_command': 'dbt run', 'cache_selected_only': 'False', 'quiet': 'False', 'write_json': 'True', 'fail_fast': 'False', 'no_print': 'None', 'static_parser': 'True', 'introspect': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/app/dbt/dbt/logs', 'log_format': 'default', 'debug': 'False', 'version_check': 'True', 'log_cache_events': 'False'}
[0m22:18:14.139394 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b505e766-b4ce-4241-b32a-0cf1fec46b63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72310aaa8e10>]}
[0m22:18:14.190095 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b505e766-b4ce-4241-b32a-0cf1fec46b63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72310d48e190>]}
[0m22:18:14.191617 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:18:14.404502 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:18:16.713890 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:18:16.715226 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:18:16.755222 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b505e766-b4ce-4241-b32a-0cf1fec46b63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x723108b87190>]}
[0m22:18:16.881946 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:16.892367 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:16.923042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b505e766-b4ce-4241-b32a-0cf1fec46b63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x723108ba6010>]}
[0m22:18:16.924206 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:18:16.925612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b505e766-b4ce-4241-b32a-0cf1fec46b63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72310834a110>]}
[0m22:18:16.928695 [info ] [MainThread]: 
[0m22:18:16.930058 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:18:16.932265 [info ] [MainThread]: 
[0m22:18:16.934371 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:18:16.936285 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:18:17.033944 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:18:17.035935 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:18:17.037827 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:18:17.055360 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m22:18:17.058960 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:18:17.063480 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:18:17.069810 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:17.070914 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:18:17.071792 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:18:17.084826 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m22:18:17.086103 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:17.087192 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:18:17.093459 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m22:18:17.096794 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:18:17.098912 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:18:17.105672 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:17.106817 [debug] [MainThread]: On master: BEGIN
[0m22:18:17.107881 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:18:17.117212 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m22:18:17.118251 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:17.119441 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:18:17.126358 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m22:18:17.129060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b505e766-b4ce-4241-b32a-0cf1fec46b63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x723109bca490>]}
[0m22:18:17.131976 [debug] [MainThread]: On master: ROLLBACK
[0m22:18:17.145458 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:17.147844 [debug] [MainThread]: On master: BEGIN
[0m22:18:17.157664 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:18:17.161823 [debug] [MainThread]: On master: COMMIT
[0m22:18:17.162715 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:17.164006 [debug] [MainThread]: On master: COMMIT
[0m22:18:17.165139 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:17.165940 [debug] [MainThread]: On master: Close
[0m22:18:17.174918 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:18:17.176653 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:18:17.178207 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:18:17.179883 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:18:17.195919 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:17.208240 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:18:17.236866 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:17.255049 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:17.256132 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:18:17.257341 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:18:17.267647 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m22:18:17.269824 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:17.271962 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:18:17.285819 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.012 seconds
[0m22:18:17.293815 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:17.295406 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:18:17.298728 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:18:17.303869 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:17.310468 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:18:17.315598 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:18:17.332691 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:17.336003 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:17.338771 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:17.343470 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:18:17.349168 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:18:17.356642 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:17.358423 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:18:17.366555 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.006 seconds
[0m22:18:17.373336 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:18:17.376857 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b505e766-b4ce-4241-b32a-0cf1fec46b63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72310b879790>]}
[0m22:18:17.379424 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.20s]
[0m22:18:17.382007 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:18:17.388673 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:17.390839 [debug] [MainThread]: On master: BEGIN
[0m22:18:17.392603 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:18:17.405805 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m22:18:17.408092 [debug] [MainThread]: On master: COMMIT
[0m22:18:17.410025 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:17.411774 [debug] [MainThread]: On master: COMMIT
[0m22:18:17.413790 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:17.415832 [debug] [MainThread]: On master: Close
[0m22:18:17.419810 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:18:17.421527 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:18:17.422855 [info ] [MainThread]: 
[0m22:18:17.424625 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.49 seconds (0.49s).
[0m22:18:17.426488 [debug] [MainThread]: Command end result
[0m22:18:17.495830 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:17.512795 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:17.529174 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:18:17.530478 [info ] [MainThread]: 
[0m22:18:17.531881 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:18:17.536345 [info ] [MainThread]: 
[0m22:18:17.540277 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:18:17.542690 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.624657, "process_in_blocks": "0", "process_kernel_time": 0.448237, "process_mem_max_rss": "126780", "process_out_blocks": "0", "process_user_time": 1.890748}
[0m22:18:17.544240 [debug] [MainThread]: Command `dbt run` succeeded at 22:18:17.544063 after 3.63 seconds
[0m22:18:17.545479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72310a781dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72310b5e5950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72310f287910>]}
[0m22:18:17.546703 [debug] [MainThread]: Flushing usage events
[0m22:18:18.436868 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:18:21.249332 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe325526890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe325525990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3258a0490>]}


============================== 22:18:21.255732 | 4805495d-ed86-4d48-8fcc-714975e47289 ==============================
[0m22:18:21.255732 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:18:21.256811 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'target_path': 'None', 'use_colors': 'True', 'invocation_command': 'dbt run', 'write_json': 'True', 'no_print': 'None', 'partial_parse': 'True', 'empty': 'False', 'introspect': 'True', 'static_parser': 'True', 'cache_selected_only': 'False', 'use_experimental_parser': 'False', 'log_format': 'default', 'warn_error': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/app/dbt/dbt/logs', 'version_check': 'True', 'debug': 'False', 'indirect_selection': 'eager', 'printer_width': '80', 'fail_fast': 'False', 'log_cache_events': 'False', 'quiet': 'False'}
[0m22:18:21.380936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4805495d-ed86-4d48-8fcc-714975e47289', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe325524c50>]}
[0m22:18:21.427546 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4805495d-ed86-4d48-8fcc-714975e47289', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3282a66d0>]}
[0m22:18:21.429132 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:18:21.671904 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:18:23.001634 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:18:23.002733 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:18:23.035351 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4805495d-ed86-4d48-8fcc-714975e47289', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe323505090>]}
[0m22:18:23.125396 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:23.130822 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:23.154830 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4805495d-ed86-4d48-8fcc-714975e47289', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3239c8490>]}
[0m22:18:23.155960 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:18:23.157153 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4805495d-ed86-4d48-8fcc-714975e47289', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe32313c650>]}
[0m22:18:23.159007 [info ] [MainThread]: 
[0m22:18:23.159978 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:18:23.160829 [info ] [MainThread]: 
[0m22:18:23.161986 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:18:23.163402 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:18:23.254942 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:18:23.257043 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:18:23.259082 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:18:23.274948 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.016 seconds
[0m22:18:23.278466 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:18:23.282243 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:18:23.290533 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:23.292278 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:18:23.293513 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:18:23.303711 [debug] [ThreadPool]: SQL status: BEGIN in 0.010 seconds
[0m22:18:23.304996 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:23.306034 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:18:23.312270 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m22:18:23.314994 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:18:23.316376 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:18:23.322952 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:23.323973 [debug] [MainThread]: On master: BEGIN
[0m22:18:23.325055 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:18:23.335117 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m22:18:23.336970 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:23.338609 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:18:23.346857 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m22:18:23.349772 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4805495d-ed86-4d48-8fcc-714975e47289', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe32231e350>]}
[0m22:18:23.351644 [debug] [MainThread]: On master: ROLLBACK
[0m22:18:23.353097 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:23.354358 [debug] [MainThread]: On master: BEGIN
[0m22:18:23.355744 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:18:23.356945 [debug] [MainThread]: On master: COMMIT
[0m22:18:23.357907 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:23.358905 [debug] [MainThread]: On master: COMMIT
[0m22:18:23.360709 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:23.361715 [debug] [MainThread]: On master: Close
[0m22:18:23.368734 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:18:23.370224 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:18:23.371764 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:18:23.372991 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:18:23.393561 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:23.403659 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:18:23.429524 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:23.439970 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:23.441042 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:18:23.442182 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:18:23.452440 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m22:18:23.454400 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:23.455751 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:18:23.467523 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.010 seconds
[0m22:18:23.474707 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:23.476022 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:18:23.478524 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:18:23.481977 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:23.483064 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:18:23.486470 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:18:23.502469 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:23.503716 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:23.504715 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:23.508020 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m22:18:23.513052 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:18:23.519850 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:23.520963 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:18:23.526900 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m22:18:23.530200 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:18:23.532559 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4805495d-ed86-4d48-8fcc-714975e47289', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe3239c8710>]}
[0m22:18:23.535479 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.16s]
[0m22:18:23.536716 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:18:23.539054 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:23.539854 [debug] [MainThread]: On master: BEGIN
[0m22:18:23.540593 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:18:23.547664 [debug] [MainThread]: SQL status: BEGIN in 0.007 seconds
[0m22:18:23.549167 [debug] [MainThread]: On master: COMMIT
[0m22:18:23.549969 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:23.551536 [debug] [MainThread]: On master: COMMIT
[0m22:18:23.552425 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:23.553197 [debug] [MainThread]: On master: Close
[0m22:18:23.554033 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:18:23.555075 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:18:23.555732 [info ] [MainThread]: 
[0m22:18:23.556538 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.39 seconds (0.39s).
[0m22:18:23.557572 [debug] [MainThread]: Command end result
[0m22:18:23.606925 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:23.612898 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:23.621283 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:18:23.622252 [info ] [MainThread]: 
[0m22:18:23.623269 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:18:23.624176 [info ] [MainThread]: 
[0m22:18:23.625054 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:18:23.626380 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.4349785, "process_in_blocks": "0", "process_kernel_time": 0.355445, "process_mem_max_rss": "127056", "process_out_blocks": "0", "process_user_time": 1.813577}
[0m22:18:23.628573 [debug] [MainThread]: Command `dbt run` succeeded at 22:18:23.628482 after 2.44 seconds
[0m22:18:23.630043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe329d82d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe329d82dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe329e2f8d0>]}
[0m22:18:23.630914 [debug] [MainThread]: Flushing usage events
[0m22:18:24.354984 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:18:27.773132 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a339016b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a338fe0990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a338fc2ad0>]}


============================== 22:18:27.779220 | b78f214e-1f13-487d-8970-8b0c8b11c148 ==============================
[0m22:18:27.779220 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:18:27.780781 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'indirect_selection': 'eager', 'use_experimental_parser': 'False', 'warn_error': 'None', 'use_colors': 'True', 'introspect': 'True', 'quiet': 'False', 'send_anonymous_usage_stats': 'True', 'invocation_command': 'dbt run', 'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'profiles_dir': '/usr/app/dbt/dbt', 'fail_fast': 'False', 'version_check': 'True', 'empty': 'False', 'log_cache_events': 'False', 'log_format': 'default', 'debug': 'False', 'cache_selected_only': 'False', 'static_parser': 'True', 'write_json': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'no_print': 'None', 'printer_width': '80'}
[0m22:18:27.919807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b78f214e-1f13-487d-8970-8b0c8b11c148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a338fb0390>]}
[0m22:18:27.961360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b78f214e-1f13-487d-8970-8b0c8b11c148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a33bd2e510>]}
[0m22:18:27.967503 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:18:28.132965 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:18:30.244866 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:18:30.246484 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:18:30.293588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b78f214e-1f13-487d-8970-8b0c8b11c148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a3377d0cd0>]}
[0m22:18:30.410843 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:30.419362 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:30.445779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b78f214e-1f13-487d-8970-8b0c8b11c148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a3377c4c50>]}
[0m22:18:30.447876 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:18:30.449354 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b78f214e-1f13-487d-8970-8b0c8b11c148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a336f149d0>]}
[0m22:18:30.452397 [info ] [MainThread]: 
[0m22:18:30.453734 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:18:30.454912 [info ] [MainThread]: 
[0m22:18:30.456203 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:18:30.458190 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:18:30.558063 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:18:30.559535 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:18:30.562248 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:18:30.580534 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m22:18:30.583344 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:18:30.585865 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:18:30.594882 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:30.596190 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:18:30.597078 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:18:30.609550 [debug] [ThreadPool]: SQL status: BEGIN in 0.012 seconds
[0m22:18:30.611159 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:30.612256 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:18:30.627903 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.015 seconds
[0m22:18:30.630329 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:18:30.631760 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:18:30.638342 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:30.639340 [debug] [MainThread]: On master: BEGIN
[0m22:18:30.640261 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:18:30.649206 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m22:18:30.650227 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:30.651218 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:18:30.660666 [debug] [MainThread]: SQL status: SELECT 1 in 0.008 seconds
[0m22:18:30.662962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b78f214e-1f13-487d-8970-8b0c8b11c148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a3383a3fd0>]}
[0m22:18:30.664976 [debug] [MainThread]: On master: ROLLBACK
[0m22:18:30.666643 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:30.668221 [debug] [MainThread]: On master: BEGIN
[0m22:18:30.669776 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:18:30.671274 [debug] [MainThread]: On master: COMMIT
[0m22:18:30.672643 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:30.673745 [debug] [MainThread]: On master: COMMIT
[0m22:18:30.674940 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:30.675933 [debug] [MainThread]: On master: Close
[0m22:18:30.681999 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:18:30.683188 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:18:30.684371 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:18:30.685454 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:18:30.698722 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:30.709838 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:18:30.741661 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:30.753740 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:30.755215 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:18:30.756400 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:18:30.766975 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m22:18:30.769075 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:30.770737 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:18:30.783861 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.012 seconds
[0m22:18:30.789892 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:30.791163 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:18:30.793760 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:18:30.797717 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:30.798823 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:18:30.801464 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:18:30.815062 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:30.816342 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:30.817216 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:30.819523 [debug] [Thread-1 (]: SQL status: COMMIT in 0.001 seconds
[0m22:18:30.824337 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:18:30.831071 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:30.832557 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:18:30.837713 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m22:18:30.840797 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:18:30.843403 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b78f214e-1f13-487d-8970-8b0c8b11c148', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a337fdf850>]}
[0m22:18:30.845086 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.16s]
[0m22:18:30.847171 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:18:30.849972 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:30.851284 [debug] [MainThread]: On master: BEGIN
[0m22:18:30.852321 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:18:30.860349 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m22:18:30.861494 [debug] [MainThread]: On master: COMMIT
[0m22:18:30.863204 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:30.864051 [debug] [MainThread]: On master: COMMIT
[0m22:18:30.865075 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:30.866546 [debug] [MainThread]: On master: Close
[0m22:18:30.867915 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:18:30.868914 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:18:30.870423 [info ] [MainThread]: 
[0m22:18:30.871776 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.41 seconds (0.41s).
[0m22:18:30.873869 [debug] [MainThread]: Command end result
[0m22:18:30.928858 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:30.936821 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:30.946949 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:18:30.948341 [info ] [MainThread]: 
[0m22:18:30.949912 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:18:30.951151 [info ] [MainThread]: 
[0m22:18:30.953793 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:18:30.955590 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.2588336, "process_in_blocks": "0", "process_kernel_time": 0.349012, "process_mem_max_rss": "127388", "process_out_blocks": "0", "process_user_time": 1.822171}
[0m22:18:30.956709 [debug] [MainThread]: Command `dbt run` succeeded at 22:18:30.956570 after 3.26 seconds
[0m22:18:30.957662 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a339022090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a33d81ae50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a33d8cb810>]}
[0m22:18:30.958804 [debug] [MainThread]: Flushing usage events
[0m22:18:31.861189 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:18:37.057158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfe6e88e190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfe6e8ee890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfe6e88df50>]}


============================== 22:18:37.071008 | ab6793a8-207b-4314-a960-a97a4978df4c ==============================
[0m22:18:37.071008 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:18:37.074856 [debug] [MainThread]: running dbt with arguments {'use_experimental_parser': 'False', 'introspect': 'True', 'printer_width': '80', 'static_parser': 'True', 'version_check': 'True', 'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_format': 'default', 'use_colors': 'True', 'quiet': 'False', 'indirect_selection': 'eager', 'debug': 'False', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'log_cache_events': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'target_path': 'None', 'cache_selected_only': 'False', 'write_json': 'True', 'no_print': 'None', 'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error': 'None'}
[0m22:18:37.243476 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ab6793a8-207b-4314-a960-a97a4978df4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfe6e88cd10>]}
[0m22:18:37.301234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ab6793a8-207b-4314-a960-a97a4978df4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfe715eea10>]}
[0m22:18:37.310441 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:18:37.498455 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:18:39.901465 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:18:39.907000 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:18:39.958972 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ab6793a8-207b-4314-a960-a97a4978df4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfe6cd6ba10>]}
[0m22:18:40.090279 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:40.112931 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:40.149988 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ab6793a8-207b-4314-a960-a97a4978df4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfe6cdce110>]}
[0m22:18:40.151362 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:18:40.153229 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ab6793a8-207b-4314-a960-a97a4978df4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfe6c5445d0>]}
[0m22:18:40.161684 [info ] [MainThread]: 
[0m22:18:40.163135 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:18:40.164441 [info ] [MainThread]: 
[0m22:18:40.169444 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:18:40.172140 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:18:40.295937 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:18:40.298866 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:18:40.310653 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:18:40.334872 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.024 seconds
[0m22:18:40.341915 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:18:40.347773 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:18:40.361839 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:40.365162 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:18:40.368180 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:18:40.382831 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m22:18:40.386349 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:40.391784 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:18:40.404145 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.010 seconds
[0m22:18:40.408863 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:18:40.411215 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:18:40.418974 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:40.420630 [debug] [MainThread]: On master: BEGIN
[0m22:18:40.422377 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:18:40.433604 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m22:18:40.435675 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:40.438676 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:18:40.448638 [debug] [MainThread]: SQL status: SELECT 1 in 0.008 seconds
[0m22:18:40.451770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ab6793a8-207b-4314-a960-a97a4978df4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfe6e87df50>]}
[0m22:18:40.454670 [debug] [MainThread]: On master: ROLLBACK
[0m22:18:40.456806 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:40.458311 [debug] [MainThread]: On master: BEGIN
[0m22:18:40.460099 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:18:40.461499 [debug] [MainThread]: On master: COMMIT
[0m22:18:40.462857 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:40.464063 [debug] [MainThread]: On master: COMMIT
[0m22:18:40.465659 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:40.466999 [debug] [MainThread]: On master: Close
[0m22:18:40.478194 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:18:40.480160 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:18:40.482258 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:18:40.483458 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:18:40.508129 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:40.522469 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:18:40.550653 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:40.567658 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:40.569543 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:18:40.570696 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:18:40.583042 [debug] [Thread-1 (]: SQL status: BEGIN in 0.012 seconds
[0m22:18:40.584607 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:40.586503 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:18:40.600068 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.012 seconds
[0m22:18:40.637751 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:40.640267 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:18:40.644349 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:18:40.650035 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:40.651375 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:18:40.655350 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:18:40.669271 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:40.670539 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:40.671512 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:40.677118 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m22:18:40.682352 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:18:40.686886 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:40.688849 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:18:40.696328 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.006 seconds
[0m22:18:40.698866 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:18:40.700761 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab6793a8-207b-4314-a960-a97a4978df4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfe6b772850>]}
[0m22:18:40.701768 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.22s]
[0m22:18:40.709566 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:18:40.712357 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:40.713477 [debug] [MainThread]: On master: BEGIN
[0m22:18:40.714322 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:18:40.722654 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m22:18:40.723655 [debug] [MainThread]: On master: COMMIT
[0m22:18:40.724451 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:40.725234 [debug] [MainThread]: On master: COMMIT
[0m22:18:40.726019 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:40.726704 [debug] [MainThread]: On master: Close
[0m22:18:40.727597 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:18:40.728290 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:18:40.729143 [info ] [MainThread]: 
[0m22:18:40.730085 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.56 seconds (0.56s).
[0m22:18:40.731101 [debug] [MainThread]: Command end result
[0m22:18:40.830480 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:40.841374 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:40.856069 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:18:40.857210 [info ] [MainThread]: 
[0m22:18:40.858611 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:18:40.859819 [info ] [MainThread]: 
[0m22:18:40.861193 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:18:40.863453 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.881072, "process_in_blocks": "0", "process_kernel_time": 0.384005, "process_mem_max_rss": "127148", "process_out_blocks": "0", "process_user_time": 1.895775}
[0m22:18:40.864684 [debug] [MainThread]: Command `dbt run` succeeded at 22:18:40.864530 after 3.88 seconds
[0m22:18:40.865720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfe733f3910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfe731aab90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfe731aaa50>]}
[0m22:18:40.866723 [debug] [MainThread]: Flushing usage events
[0m22:18:41.573482 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:18:50.018088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7619d68decd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7619d68e6610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7619d68a90d0>]}


============================== 22:18:50.023714 | b974ba05-b0e3-4328-9dfa-ac8ba84f639c ==============================
[0m22:18:50.023714 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:18:50.024889 [debug] [MainThread]: running dbt with arguments {'log_path': '/usr/app/dbt/dbt/logs', 'fail_fast': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'write_json': 'True', 'debug': 'False', 'version_check': 'True', 'cache_selected_only': 'False', 'use_experimental_parser': 'False', 'empty': 'False', 'static_parser': 'True', 'invocation_command': 'dbt run', 'no_print': 'None', 'indirect_selection': 'eager', 'use_colors': 'True', 'target_path': 'None', 'printer_width': '80', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'introspect': 'True', 'warn_error': 'None', 'partial_parse': 'True', 'log_format': 'default', 'quiet': 'False', 'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False'}
[0m22:18:50.147185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b974ba05-b0e3-4328-9dfa-ac8ba84f639c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7619d6bf0bd0>]}
[0m22:18:50.188336 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b974ba05-b0e3-4328-9dfa-ac8ba84f639c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7619d9606690>]}
[0m22:18:50.198788 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:18:50.365389 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:18:51.555597 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:18:51.558030 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:18:51.591053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b974ba05-b0e3-4328-9dfa-ac8ba84f639c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7619d4d88150>]}
[0m22:18:51.695266 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:51.704858 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:51.735006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b974ba05-b0e3-4328-9dfa-ac8ba84f639c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7619d4d88750>]}
[0m22:18:51.736335 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:18:51.737857 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b974ba05-b0e3-4328-9dfa-ac8ba84f639c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7619d45242d0>]}
[0m22:18:51.741045 [info ] [MainThread]: 
[0m22:18:51.742510 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:18:51.743904 [info ] [MainThread]: 
[0m22:18:51.745616 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:18:51.748190 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:18:51.878694 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:18:51.880631 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:18:51.882233 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:18:51.898318 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.016 seconds
[0m22:18:51.901064 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:18:51.904140 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:18:51.911807 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:51.913500 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:18:51.914764 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:18:51.925727 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m22:18:51.927228 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:18:51.928589 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:18:51.936642 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m22:18:51.938978 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:18:51.940448 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:18:51.946347 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:51.947757 [debug] [MainThread]: On master: BEGIN
[0m22:18:51.949347 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:18:51.960026 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m22:18:51.961331 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:51.962471 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:18:51.970282 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m22:18:51.972192 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b974ba05-b0e3-4328-9dfa-ac8ba84f639c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7619d5197350>]}
[0m22:18:51.973428 [debug] [MainThread]: On master: ROLLBACK
[0m22:18:51.974530 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:51.975384 [debug] [MainThread]: On master: BEGIN
[0m22:18:51.977872 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:18:51.978692 [debug] [MainThread]: On master: COMMIT
[0m22:18:51.979805 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:51.980658 [debug] [MainThread]: On master: COMMIT
[0m22:18:51.982016 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:51.982899 [debug] [MainThread]: On master: Close
[0m22:18:51.992270 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:18:51.993594 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:18:51.994780 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:18:51.995707 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:18:52.012304 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:52.031378 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:18:52.062995 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:18:52.073450 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:52.074402 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:18:52.076153 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:18:52.084270 [debug] [Thread-1 (]: SQL status: BEGIN in 0.008 seconds
[0m22:18:52.085519 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:52.086707 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:18:52.100602 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.012 seconds
[0m22:18:52.106995 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:52.122305 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:18:52.126707 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:18:52.131349 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:52.132846 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:18:52.135490 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:18:52.152628 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:52.157182 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:52.159423 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:18:52.163520 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:18:52.172930 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:18:52.179428 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:18:52.180981 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:18:52.188402 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m22:18:52.195217 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:18:52.203649 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b974ba05-b0e3-4328-9dfa-ac8ba84f639c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7619d51a9e50>]}
[0m22:18:52.222101 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.20s]
[0m22:18:52.224659 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:18:52.229690 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:52.231238 [debug] [MainThread]: On master: BEGIN
[0m22:18:52.232518 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:18:52.246641 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m22:18:52.248203 [debug] [MainThread]: On master: COMMIT
[0m22:18:52.249998 [debug] [MainThread]: Using postgres connection "master"
[0m22:18:52.251382 [debug] [MainThread]: On master: COMMIT
[0m22:18:52.252968 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:18:52.254331 [debug] [MainThread]: On master: Close
[0m22:18:52.255607 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:18:52.258508 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:18:52.260755 [info ] [MainThread]: 
[0m22:18:52.262072 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.52 seconds (0.52s).
[0m22:18:52.263711 [debug] [MainThread]: Command end result
[0m22:18:52.320536 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:18:52.327514 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:18:52.340368 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:18:52.341472 [info ] [MainThread]: 
[0m22:18:52.343490 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:18:52.345536 [info ] [MainThread]: 
[0m22:18:52.347037 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:18:52.349546 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.409421, "process_in_blocks": "0", "process_kernel_time": 0.397413, "process_mem_max_rss": "126428", "process_out_blocks": "0", "process_user_time": 1.826497}
[0m22:18:52.350770 [debug] [MainThread]: Command `dbt run` succeeded at 22:18:52.350590 after 2.41 seconds
[0m22:18:52.351980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7619d6885210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7619db1a3810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7619db1bea50>]}
[0m22:18:52.353103 [debug] [MainThread]: Flushing usage events
[0m22:18:53.162407 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:19:07.814124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x763b8631aa10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x763b86319ad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x763b8631a250>]}


============================== 22:19:07.819458 | e7480395-a8dd-45bb-96f2-957d2d49c012 ==============================
[0m22:19:07.819458 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:19:07.821226 [debug] [MainThread]: running dbt with arguments {'warn_error': 'None', 'log_cache_events': 'False', 'quiet': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'version_check': 'True', 'send_anonymous_usage_stats': 'True', 'partial_parse': 'True', 'no_print': 'None', 'log_format': 'default', 'profiles_dir': '/usr/app/dbt/dbt', 'introspect': 'True', 'static_parser': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'printer_width': '80', 'indirect_selection': 'eager', 'target_path': 'None', 'debug': 'False', 'cache_selected_only': 'False', 'write_json': 'True', 'fail_fast': 'False'}
[0m22:19:07.942524 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e7480395-a8dd-45bb-96f2-957d2d49c012', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x763b857e0b10>]}
[0m22:19:07.986425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e7480395-a8dd-45bb-96f2-957d2d49c012', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x763b8907ea50>]}
[0m22:19:07.989344 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:19:08.132800 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:19:09.817902 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:19:09.819992 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:19:09.857864 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e7480395-a8dd-45bb-96f2-957d2d49c012', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x763b84780150>]}
[0m22:19:10.083608 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:19:10.101270 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:19:10.142340 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e7480395-a8dd-45bb-96f2-957d2d49c012', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x763b847a8bd0>]}
[0m22:19:10.143975 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:19:10.145597 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7480395-a8dd-45bb-96f2-957d2d49c012', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x763b83f149d0>]}
[0m22:19:10.149899 [info ] [MainThread]: 
[0m22:19:10.151309 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:19:10.152593 [info ] [MainThread]: 
[0m22:19:10.154084 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:19:10.156244 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:19:10.264897 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:19:10.266632 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:19:10.267814 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:19:10.281174 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.013 seconds
[0m22:19:10.283329 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:19:10.286086 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:19:10.292259 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:19:10.293685 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:19:10.295086 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:19:10.305301 [debug] [ThreadPool]: SQL status: BEGIN in 0.010 seconds
[0m22:19:10.306615 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:19:10.308268 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:19:10.313720 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.004 seconds
[0m22:19:10.316406 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:19:10.317763 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:19:10.327210 [debug] [MainThread]: Using postgres connection "master"
[0m22:19:10.343017 [debug] [MainThread]: On master: BEGIN
[0m22:19:10.345560 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:19:10.364395 [debug] [MainThread]: SQL status: BEGIN in 0.019 seconds
[0m22:19:10.366266 [debug] [MainThread]: Using postgres connection "master"
[0m22:19:10.368003 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:19:10.377259 [debug] [MainThread]: SQL status: SELECT 1 in 0.008 seconds
[0m22:19:10.379652 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7480395-a8dd-45bb-96f2-957d2d49c012', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x763b88273d10>]}
[0m22:19:10.381031 [debug] [MainThread]: On master: ROLLBACK
[0m22:19:10.382741 [debug] [MainThread]: Using postgres connection "master"
[0m22:19:10.383907 [debug] [MainThread]: On master: BEGIN
[0m22:19:10.385708 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:19:10.386868 [debug] [MainThread]: On master: COMMIT
[0m22:19:10.387965 [debug] [MainThread]: Using postgres connection "master"
[0m22:19:10.388821 [debug] [MainThread]: On master: COMMIT
[0m22:19:10.389806 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:19:10.391512 [debug] [MainThread]: On master: Close
[0m22:19:10.401084 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:19:10.402676 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:19:10.403970 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:19:10.404917 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:19:10.422579 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:19:10.439056 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:19:10.464217 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:19:10.476174 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:19:10.477857 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:19:10.479222 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:19:10.489743 [debug] [Thread-1 (]: SQL status: BEGIN in 0.011 seconds
[0m22:19:10.491376 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:19:10.492548 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:19:10.505111 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.011 seconds
[0m22:19:10.511655 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:19:10.512937 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:19:10.516875 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:19:10.520757 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:19:10.521829 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:19:10.524951 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:19:10.536911 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:19:10.538073 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:19:10.539099 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:19:10.543923 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:19:10.551998 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:19:10.558260 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:19:10.559587 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:19:10.565777 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m22:19:10.568948 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:19:10.571252 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7480395-a8dd-45bb-96f2-957d2d49c012', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x763b8530dd10>]}
[0m22:19:10.574015 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.17s]
[0m22:19:10.575796 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:19:10.578390 [debug] [MainThread]: Using postgres connection "master"
[0m22:19:10.579321 [debug] [MainThread]: On master: BEGIN
[0m22:19:10.580184 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:19:10.589153 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m22:19:10.629815 [debug] [MainThread]: On master: COMMIT
[0m22:19:10.632605 [debug] [MainThread]: Using postgres connection "master"
[0m22:19:10.636641 [debug] [MainThread]: On master: COMMIT
[0m22:19:10.640264 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:19:10.643213 [debug] [MainThread]: On master: Close
[0m22:19:10.645793 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:19:10.647597 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:19:10.649320 [info ] [MainThread]: 
[0m22:19:10.652013 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.50 seconds (0.50s).
[0m22:19:10.653976 [debug] [MainThread]: Command end result
[0m22:19:10.724730 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:19:10.733630 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:19:10.744350 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:19:10.745597 [info ] [MainThread]: 
[0m22:19:10.746845 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:19:10.747980 [info ] [MainThread]: 
[0m22:19:10.749282 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:19:10.750820 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.014014, "process_in_blocks": "0", "process_kernel_time": 0.307143, "process_mem_max_rss": "127296", "process_out_blocks": "0", "process_user_time": 1.777338}
[0m22:19:10.751689 [debug] [MainThread]: Command `dbt run` succeeded at 22:19:10.751608 after 3.01 seconds
[0m22:19:10.752548 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x763b8ac23810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x763b8ac3e890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x763b8ac3f550>]}
[0m22:19:10.753326 [debug] [MainThread]: Flushing usage events
[0m22:19:11.352553 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:19:38.930026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74543b545210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74543b8cce90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74543b5a61d0>]}


============================== 22:19:38.936795 | 12dc2c8a-dedb-4f7c-b039-9bc7662ed693 ==============================
[0m22:19:38.936795 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:19:38.938109 [debug] [MainThread]: running dbt with arguments {'partial_parse': 'True', 'quiet': 'False', 'version_check': 'True', 'introspect': 'True', 'warn_error': 'None', 'write_json': 'True', 'send_anonymous_usage_stats': 'True', 'printer_width': '80', 'log_format': 'default', 'log_path': '/usr/app/dbt/dbt/logs', 'empty': 'False', 'use_experimental_parser': 'False', 'invocation_command': 'dbt run', 'cache_selected_only': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'indirect_selection': 'eager', 'static_parser': 'True', 'no_print': 'None', 'debug': 'False', 'use_colors': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'target_path': 'None', 'log_cache_events': 'False', 'fail_fast': 'False'}
[0m22:19:39.071361 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '12dc2c8a-dedb-4f7c-b039-9bc7662ed693', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74543a9c95d0>]}
[0m22:19:39.112790 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '12dc2c8a-dedb-4f7c-b039-9bc7662ed693', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74543e2a69d0>]}
[0m22:19:39.115335 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:19:39.332402 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:19:41.764914 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:19:41.772660 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:19:41.832235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '12dc2c8a-dedb-4f7c-b039-9bc7662ed693', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74543950cb10>]}
[0m22:19:42.037009 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:19:42.051222 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:19:42.085543 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '12dc2c8a-dedb-4f7c-b039-9bc7662ed693', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7454399c8290>]}
[0m22:19:42.087335 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:19:42.088646 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '12dc2c8a-dedb-4f7c-b039-9bc7662ed693', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x745439148290>]}
[0m22:19:42.091389 [info ] [MainThread]: 
[0m22:19:42.092562 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:19:42.093604 [info ] [MainThread]: 
[0m22:19:42.095508 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:19:42.097806 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:19:42.210578 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:19:42.215955 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:19:42.222007 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:19:42.251810 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.030 seconds
[0m22:19:42.260554 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:19:42.267956 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:19:42.278754 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:19:42.280889 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:19:42.282593 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:19:42.296462 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m22:19:42.298432 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:19:42.299808 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:19:42.309956 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.008 seconds
[0m22:19:42.313968 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:19:42.315765 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:19:42.322854 [debug] [MainThread]: Using postgres connection "master"
[0m22:19:42.324889 [debug] [MainThread]: On master: BEGIN
[0m22:19:42.326864 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:19:42.338836 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m22:19:42.342674 [debug] [MainThread]: Using postgres connection "master"
[0m22:19:42.344068 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:19:42.352554 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m22:19:42.355230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '12dc2c8a-dedb-4f7c-b039-9bc7662ed693', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74543a517190>]}
[0m22:19:42.356864 [debug] [MainThread]: On master: ROLLBACK
[0m22:19:42.358289 [debug] [MainThread]: Using postgres connection "master"
[0m22:19:42.359543 [debug] [MainThread]: On master: BEGIN
[0m22:19:42.361230 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:19:42.362463 [debug] [MainThread]: On master: COMMIT
[0m22:19:42.363393 [debug] [MainThread]: Using postgres connection "master"
[0m22:19:42.364218 [debug] [MainThread]: On master: COMMIT
[0m22:19:42.365414 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:19:42.366435 [debug] [MainThread]: On master: Close
[0m22:19:42.373742 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:19:42.375150 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:19:42.376559 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:19:42.381213 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:19:42.400909 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:19:42.414343 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:19:42.456828 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:19:42.511188 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:19:42.513473 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:19:42.515700 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:19:42.530377 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m22:19:42.532636 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:19:42.534491 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:19:42.547126 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.011 seconds
[0m22:19:42.557404 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:19:42.559127 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:19:42.562674 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:19:42.569448 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:19:42.571302 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:19:42.574370 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:19:42.589316 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:19:42.594895 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:19:42.599725 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:19:42.604474 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m22:19:42.613007 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:19:42.621505 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:19:42.626629 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:19:42.637422 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.007 seconds
[0m22:19:42.643962 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:19:42.652661 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '12dc2c8a-dedb-4f7c-b039-9bc7662ed693', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74543a9f3d90>]}
[0m22:19:42.657503 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.27s]
[0m22:19:42.661560 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:19:42.667982 [debug] [MainThread]: Using postgres connection "master"
[0m22:19:42.672700 [debug] [MainThread]: On master: BEGIN
[0m22:19:42.677975 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:19:42.697956 [debug] [MainThread]: SQL status: BEGIN in 0.020 seconds
[0m22:19:42.702050 [debug] [MainThread]: On master: COMMIT
[0m22:19:42.705052 [debug] [MainThread]: Using postgres connection "master"
[0m22:19:42.709064 [debug] [MainThread]: On master: COMMIT
[0m22:19:42.712394 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:19:42.714974 [debug] [MainThread]: On master: Close
[0m22:19:42.721217 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:19:42.726472 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:19:42.733932 [info ] [MainThread]: 
[0m22:19:42.737284 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.64 seconds (0.64s).
[0m22:19:42.743506 [debug] [MainThread]: Command end result
[0m22:19:42.890045 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:19:42.900876 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:19:42.916958 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:19:42.918454 [info ] [MainThread]: 
[0m22:19:42.920008 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:19:42.921258 [info ] [MainThread]: 
[0m22:19:42.922367 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:19:42.924563 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 4.0999255, "process_in_blocks": "0", "process_kernel_time": 0.395444, "process_mem_max_rss": "126764", "process_out_blocks": "0", "process_user_time": 1.815089}
[0m22:19:42.926235 [debug] [MainThread]: Command `dbt run` succeeded at 22:19:42.926109 after 4.10 seconds
[0m22:19:42.928178 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74543b536590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74543b534410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7454400ab910>]}
[0m22:19:42.929479 [debug] [MainThread]: Flushing usage events
[0m22:19:44.101944 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:20:37.340783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79e205123f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79e2050cf110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79e205853ad0>]}


============================== 22:20:37.346625 | a5ea53d1-7a30-46ae-ada6-9424590ec503 ==============================
[0m22:20:37.346625 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:20:37.348272 [debug] [MainThread]: running dbt with arguments {'quiet': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'write_json': 'True', 'warn_error': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'indirect_selection': 'eager', 'log_path': '/usr/app/dbt/dbt/logs', 'static_parser': 'True', 'fail_fast': 'False', 'debug': 'False', 'printer_width': '80', 'partial_parse': 'True', 'log_format': 'default', 'use_colors': 'True', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'invocation_command': 'dbt run', 'empty': 'False', 'target_path': 'None', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'no_print': 'None', 'version_check': 'True'}
[0m22:20:37.476716 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a5ea53d1-7a30-46ae-ada6-9424590ec503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79e2060f8850>]}
[0m22:20:37.528995 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a5ea53d1-7a30-46ae-ada6-9424590ec503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79e204794790>]}
[0m22:20:37.531478 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:20:37.690764 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:20:39.586694 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:20:39.588238 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:20:39.627938 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a5ea53d1-7a30-46ae-ada6-9424590ec503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79e205458590>]}
[0m22:20:39.733917 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:20:39.742144 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:20:39.772164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a5ea53d1-7a30-46ae-ada6-9424590ec503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79e203baa590>]}
[0m22:20:39.773447 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:20:39.774568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a5ea53d1-7a30-46ae-ada6-9424590ec503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79e20336c5d0>]}
[0m22:20:39.777601 [info ] [MainThread]: 
[0m22:20:39.778766 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:20:39.779804 [info ] [MainThread]: 
[0m22:20:39.781034 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:20:39.782663 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:20:39.883220 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:20:39.885549 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:20:39.887588 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:20:39.904874 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m22:20:39.910104 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:20:39.914491 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:20:39.924239 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:20:39.928118 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:20:39.930256 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:20:39.943010 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m22:20:39.945865 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:20:39.947222 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:20:39.957566 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.009 seconds
[0m22:20:39.975886 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:20:39.981786 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:20:39.991316 [debug] [MainThread]: Using postgres connection "master"
[0m22:20:39.993637 [debug] [MainThread]: On master: BEGIN
[0m22:20:39.995233 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:20:40.015338 [debug] [MainThread]: SQL status: BEGIN in 0.020 seconds
[0m22:20:40.017690 [debug] [MainThread]: Using postgres connection "master"
[0m22:20:40.019379 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:20:40.029030 [debug] [MainThread]: SQL status: SELECT 1 in 0.008 seconds
[0m22:20:40.031944 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a5ea53d1-7a30-46ae-ada6-9424590ec503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79e205073550>]}
[0m22:20:40.033795 [debug] [MainThread]: On master: ROLLBACK
[0m22:20:40.034884 [debug] [MainThread]: Using postgres connection "master"
[0m22:20:40.036250 [debug] [MainThread]: On master: BEGIN
[0m22:20:40.037958 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:20:40.039055 [debug] [MainThread]: On master: COMMIT
[0m22:20:40.039952 [debug] [MainThread]: Using postgres connection "master"
[0m22:20:40.040912 [debug] [MainThread]: On master: COMMIT
[0m22:20:40.041997 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:20:40.043038 [debug] [MainThread]: On master: Close
[0m22:20:40.051770 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:20:40.053263 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:20:40.054771 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:20:40.055647 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:20:40.071350 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:20:40.079041 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:20:40.105402 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:20:40.114787 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:20:40.115773 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:20:40.116632 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:20:40.127023 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m22:20:40.127993 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:20:40.129199 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:20:40.136362 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.006 seconds
[0m22:20:40.141622 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:20:40.142817 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:20:40.144756 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:20:40.147484 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:20:40.148307 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:20:40.150104 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:20:40.160936 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:20:40.163637 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:20:40.164958 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:20:40.167612 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:20:40.172343 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:20:40.177563 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:20:40.178574 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:20:40.184379 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m22:20:40.186575 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:20:40.189936 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a5ea53d1-7a30-46ae-ada6-9424590ec503', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79e20475c090>]}
[0m22:20:40.194576 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.13s]
[0m22:20:40.195746 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:20:40.198119 [debug] [MainThread]: Using postgres connection "master"
[0m22:20:40.199058 [debug] [MainThread]: On master: BEGIN
[0m22:20:40.199863 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:20:40.210130 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m22:20:40.227243 [debug] [MainThread]: On master: COMMIT
[0m22:20:40.232861 [debug] [MainThread]: Using postgres connection "master"
[0m22:20:40.234292 [debug] [MainThread]: On master: COMMIT
[0m22:20:40.235957 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:20:40.237245 [debug] [MainThread]: On master: Close
[0m22:20:40.238580 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:20:40.244980 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:20:40.247124 [info ] [MainThread]: 
[0m22:20:40.249257 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.47 seconds (0.47s).
[0m22:20:40.251542 [debug] [MainThread]: Command end result
[0m22:20:40.330375 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:20:40.340522 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:20:40.349948 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:20:40.350953 [info ] [MainThread]: 
[0m22:20:40.351952 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:20:40.352831 [info ] [MainThread]: 
[0m22:20:40.353887 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:20:40.355444 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.06922, "process_in_blocks": "0", "process_kernel_time": 0.414465, "process_mem_max_rss": "127020", "process_out_blocks": "0", "process_user_time": 1.828524}
[0m22:20:40.356328 [debug] [MainThread]: Command `dbt run` succeeded at 22:20:40.356208 after 3.07 seconds
[0m22:20:40.357184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79e20512e5d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79e2099b3890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79e2099ce950>]}
[0m22:20:40.357945 [debug] [MainThread]: Flushing usage events
[0m22:20:41.204719 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:21:43.350309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77a875786a90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77a87578df50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77a8757863d0>]}


============================== 22:21:43.356427 | 2a7ec32e-1aad-473a-b517-e7f87951472c ==============================
[0m22:21:43.356427 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:21:43.357940 [debug] [MainThread]: running dbt with arguments {'write_json': 'True', 'invocation_command': 'dbt run', 'debug': 'False', 'introspect': 'True', 'cache_selected_only': 'False', 'no_print': 'None', 'static_parser': 'True', 'indirect_selection': 'eager', 'printer_width': '80', 'warn_error': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_format': 'default', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'target_path': 'None', 'partial_parse': 'True', 'log_cache_events': 'False', 'use_colors': 'True', 'fail_fast': 'False', 'quiet': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'version_check': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'empty': 'False'}
[0m22:21:43.497686 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2a7ec32e-1aad-473a-b517-e7f87951472c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77a875ba0450>]}
[0m22:21:43.549920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2a7ec32e-1aad-473a-b517-e7f87951472c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77a8784ac910>]}
[0m22:21:43.552190 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:21:43.711164 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:21:45.549232 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:21:45.551098 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:21:45.584829 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2a7ec32e-1aad-473a-b517-e7f87951472c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77a873bf52d0>]}
[0m22:21:45.714351 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:21:45.722849 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:21:45.747750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2a7ec32e-1aad-473a-b517-e7f87951472c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77a873bc92d0>]}
[0m22:21:45.749023 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:21:45.750241 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2a7ec32e-1aad-473a-b517-e7f87951472c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77a87333c550>]}
[0m22:21:45.752563 [info ] [MainThread]: 
[0m22:21:45.753483 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:21:45.754315 [info ] [MainThread]: 
[0m22:21:45.755353 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:21:45.757243 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:21:45.860438 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:21:45.862342 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:21:45.863749 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:21:45.879245 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.015 seconds
[0m22:21:45.881957 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:21:45.884465 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:21:45.891512 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:21:45.892982 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:21:45.894808 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:21:45.908519 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m22:21:45.911480 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:21:45.913693 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:21:45.922403 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.007 seconds
[0m22:21:45.926506 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:21:45.927933 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:21:45.934096 [debug] [MainThread]: Using postgres connection "master"
[0m22:21:45.935507 [debug] [MainThread]: On master: BEGIN
[0m22:21:45.936848 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:21:45.946537 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m22:21:45.948220 [debug] [MainThread]: Using postgres connection "master"
[0m22:21:45.949650 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:21:45.958625 [debug] [MainThread]: SQL status: SELECT 1 in 0.008 seconds
[0m22:21:45.961661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2a7ec32e-1aad-473a-b517-e7f87951472c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77a87573eb50>]}
[0m22:21:45.963228 [debug] [MainThread]: On master: ROLLBACK
[0m22:21:45.964977 [debug] [MainThread]: Using postgres connection "master"
[0m22:21:45.966328 [debug] [MainThread]: On master: BEGIN
[0m22:21:45.968026 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:21:45.969420 [debug] [MainThread]: On master: COMMIT
[0m22:21:45.970832 [debug] [MainThread]: Using postgres connection "master"
[0m22:21:45.972218 [debug] [MainThread]: On master: COMMIT
[0m22:21:45.974484 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:21:45.976028 [debug] [MainThread]: On master: Close
[0m22:21:45.986288 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:21:45.988259 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:21:45.990019 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:21:45.991803 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:21:46.013499 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:21:46.039389 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:21:46.077370 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:21:46.093994 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:21:46.095498 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:21:46.096894 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:21:46.109863 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m22:21:46.111858 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:21:46.114207 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:21:46.132413 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.016 seconds
[0m22:21:46.142027 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:21:46.144458 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:21:46.148757 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:21:46.153735 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:21:46.155745 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:21:46.158955 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:21:46.172757 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:21:46.174385 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:21:46.176156 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:21:46.180810 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m22:21:46.187133 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:21:46.195341 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:21:46.197220 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:21:46.203028 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m22:21:46.207450 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:21:46.211429 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2a7ec32e-1aad-473a-b517-e7f87951472c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77a87766ded0>]}
[0m22:21:46.213617 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.22s]
[0m22:21:46.215787 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:21:46.219174 [debug] [MainThread]: Using postgres connection "master"
[0m22:21:46.221096 [debug] [MainThread]: On master: BEGIN
[0m22:21:46.223553 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:21:46.231942 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m22:21:46.234524 [debug] [MainThread]: On master: COMMIT
[0m22:21:46.236023 [debug] [MainThread]: Using postgres connection "master"
[0m22:21:46.237673 [debug] [MainThread]: On master: COMMIT
[0m22:21:46.239221 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:21:46.240694 [debug] [MainThread]: On master: Close
[0m22:21:46.242510 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:21:46.243943 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:21:46.245768 [info ] [MainThread]: 
[0m22:21:46.247379 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.49 seconds (0.49s).
[0m22:21:46.249378 [debug] [MainThread]: Command end result
[0m22:21:46.318797 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:21:46.327973 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:21:46.343512 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:21:46.345018 [info ] [MainThread]: 
[0m22:21:46.346582 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:21:46.347943 [info ] [MainThread]: 
[0m22:21:46.349323 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:21:46.351677 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.0784204, "process_in_blocks": "0", "process_kernel_time": 0.460082, "process_mem_max_rss": "126528", "process_out_blocks": "0", "process_user_time": 1.884722}
[0m22:21:46.353162 [debug] [MainThread]: Command `dbt run` succeeded at 22:21:46.352982 after 3.08 seconds
[0m22:21:46.354585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77a879f8ad90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77a875720990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77a8773cc810>]}
[0m22:21:46.356815 [debug] [MainThread]: Flushing usage events
[0m22:21:47.211143 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:22:49.343227 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7deccd19c650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7decca46cc50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7deccd19fad0>]}


============================== 22:22:49.348602 | 52f73a23-12e1-47c7-add7-8b6be477beff ==============================
[0m22:22:49.348602 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:22:49.349767 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'invocation_command': 'dbt run', 'write_json': 'True', 'printer_width': '80', 'log_cache_events': 'False', 'version_check': 'True', 'static_parser': 'True', 'quiet': 'False', 'indirect_selection': 'eager', 'profiles_dir': '/usr/app/dbt/dbt', 'send_anonymous_usage_stats': 'True', 'log_format': 'default', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'use_colors': 'True', 'no_print': 'None', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'empty': 'False', 'introspect': 'True', 'fail_fast': 'False', 'debug': 'False', 'target_path': 'None'}
[0m22:22:49.483509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '52f73a23-12e1-47c7-add7-8b6be477beff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7decc95b9d90>]}
[0m22:22:49.530020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '52f73a23-12e1-47c7-add7-8b6be477beff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7deccd1c6a50>]}
[0m22:22:49.559965 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:22:49.685741 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:22:50.962629 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:22:50.963731 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:22:50.997378 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '52f73a23-12e1-47c7-add7-8b6be477beff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7decc8596150>]}
[0m22:22:51.112277 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:22:51.118098 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:22:51.137754 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '52f73a23-12e1-47c7-add7-8b6be477beff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7decc85dd090>]}
[0m22:22:51.138572 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:22:51.139376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '52f73a23-12e1-47c7-add7-8b6be477beff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7decc7d30f50>]}
[0m22:22:51.141001 [info ] [MainThread]: 
[0m22:22:51.141870 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:22:51.142593 [info ] [MainThread]: 
[0m22:22:51.143632 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:22:51.144875 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:22:51.237272 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:22:51.239106 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:22:51.240724 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:22:51.255992 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.015 seconds
[0m22:22:51.259166 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:22:51.262470 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:22:51.268158 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:22:51.269408 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:22:51.270472 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:22:51.280265 [debug] [ThreadPool]: SQL status: BEGIN in 0.009 seconds
[0m22:22:51.282564 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:22:51.284078 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:22:51.294774 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.009 seconds
[0m22:22:51.297661 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:22:51.299350 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:22:51.305332 [debug] [MainThread]: Using postgres connection "master"
[0m22:22:51.306657 [debug] [MainThread]: On master: BEGIN
[0m22:22:51.307789 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:22:51.318585 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m22:22:51.321106 [debug] [MainThread]: Using postgres connection "master"
[0m22:22:51.322783 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:22:51.331577 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m22:22:51.334509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '52f73a23-12e1-47c7-add7-8b6be477beff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7decc8dfe650>]}
[0m22:22:51.338360 [debug] [MainThread]: On master: ROLLBACK
[0m22:22:51.340885 [debug] [MainThread]: Using postgres connection "master"
[0m22:22:51.342167 [debug] [MainThread]: On master: BEGIN
[0m22:22:51.345243 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m22:22:51.346716 [debug] [MainThread]: On master: COMMIT
[0m22:22:51.348025 [debug] [MainThread]: Using postgres connection "master"
[0m22:22:51.348997 [debug] [MainThread]: On master: COMMIT
[0m22:22:51.350278 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:22:51.351403 [debug] [MainThread]: On master: Close
[0m22:22:51.365062 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:22:51.379862 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:22:51.382984 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:22:51.391797 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:22:51.411631 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:22:51.427917 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:22:51.456421 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:22:51.469857 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:22:51.471794 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:22:51.473114 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:22:51.490317 [debug] [Thread-1 (]: SQL status: BEGIN in 0.017 seconds
[0m22:22:51.492153 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:22:51.494134 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:22:51.510357 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.015 seconds
[0m22:22:51.518666 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:22:51.519927 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:22:51.522585 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:22:51.528520 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:22:51.529864 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:22:51.532438 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:22:51.544867 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:22:51.546398 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:22:51.547924 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:22:51.552281 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m22:22:51.557642 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:22:51.563094 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:22:51.564542 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:22:51.570935 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m22:22:51.574360 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:22:51.576848 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '52f73a23-12e1-47c7-add7-8b6be477beff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7decc917a010>]}
[0m22:22:51.578617 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.19s]
[0m22:22:51.580463 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:22:51.584893 [debug] [MainThread]: Using postgres connection "master"
[0m22:22:51.586179 [debug] [MainThread]: On master: BEGIN
[0m22:22:51.591686 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:22:51.605094 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m22:22:51.606520 [debug] [MainThread]: On master: COMMIT
[0m22:22:51.607523 [debug] [MainThread]: Using postgres connection "master"
[0m22:22:51.608521 [debug] [MainThread]: On master: COMMIT
[0m22:22:51.610758 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:22:51.611856 [debug] [MainThread]: On master: Close
[0m22:22:51.613393 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:22:51.614587 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:22:51.615620 [info ] [MainThread]: 
[0m22:22:51.616622 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.47 seconds (0.47s).
[0m22:22:51.618265 [debug] [MainThread]: Command end result
[0m22:22:51.679347 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:22:51.687910 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:22:51.703245 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:22:51.704736 [info ] [MainThread]: 
[0m22:22:51.706307 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:22:51.707737 [info ] [MainThread]: 
[0m22:22:51.710133 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:22:51.712254 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.4829433, "process_in_blocks": "0", "process_kernel_time": 0.383618, "process_mem_max_rss": "127036", "process_out_blocks": "0", "process_user_time": 1.821179}
[0m22:22:51.713321 [debug] [MainThread]: Command `dbt run` succeeded at 22:22:51.713165 after 2.48 seconds
[0m22:22:51.714553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7decceca6d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7decceca6d10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7decced538d0>]}
[0m22:22:51.715788 [debug] [MainThread]: Flushing usage events
[0m22:22:52.448554 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m22:23:54.766423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e60464aab10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e6048ea3110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e60461520d0>]}


============================== 22:23:54.774323 | 3573b48e-d66e-4dec-81f9-fcae2029f46e ==============================
[0m22:23:54.774323 [info ] [MainThread]: Running with dbt=1.10.15
[0m22:23:54.775967 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'quiet': 'False', 'introspect': 'True', 'version_check': 'True', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error': 'None', 'invocation_command': 'dbt run', 'no_print': 'None', 'empty': 'False', 'printer_width': '80', 'log_format': 'default', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'fail_fast': 'False', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'use_colors': 'True', 'partial_parse': 'True', 'log_cache_events': 'False', 'write_json': 'True', 'debug': 'False'}
[0m22:23:54.914356 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3573b48e-d66e-4dec-81f9-fcae2029f46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e604515b7d0>]}
[0m22:23:54.967647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3573b48e-d66e-4dec-81f9-fcae2029f46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e6048eb6950>]}
[0m22:23:54.970618 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m22:23:55.119674 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m22:23:57.310375 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:23:57.312270 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:23:57.355264 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3573b48e-d66e-4dec-81f9-fcae2029f46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e6044550150>]}
[0m22:23:57.472345 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:23:57.481618 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:23:57.515726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3573b48e-d66e-4dec-81f9-fcae2029f46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e60445c9950>]}
[0m22:23:57.517442 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m22:23:57.518819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3573b48e-d66e-4dec-81f9-fcae2029f46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e6043d14cd0>]}
[0m22:23:57.522669 [info ] [MainThread]: 
[0m22:23:57.525178 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m22:23:57.527326 [info ] [MainThread]: 
[0m22:23:57.529242 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:23:57.532401 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m22:23:57.649736 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m22:23:57.653968 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m22:23:57.656949 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:23:57.673680 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m22:23:57.676582 [debug] [ThreadPool]: On list_data_project_1: Close
[0m22:23:57.692798 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m22:23:57.703279 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:23:57.707034 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m22:23:57.708522 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:23:57.718440 [debug] [ThreadPool]: SQL status: BEGIN in 0.010 seconds
[0m22:23:57.726703 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m22:23:57.728924 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:23:57.738993 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m22:23:57.743429 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m22:23:57.745421 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m22:23:57.752228 [debug] [MainThread]: Using postgres connection "master"
[0m22:23:57.755129 [debug] [MainThread]: On master: BEGIN
[0m22:23:57.758219 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:23:57.770958 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m22:23:57.773202 [debug] [MainThread]: Using postgres connection "master"
[0m22:23:57.775237 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m22:23:57.784724 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m22:23:57.788433 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3573b48e-d66e-4dec-81f9-fcae2029f46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e60480abc50>]}
[0m22:23:57.790360 [debug] [MainThread]: On master: ROLLBACK
[0m22:23:57.792189 [debug] [MainThread]: Using postgres connection "master"
[0m22:23:57.793820 [debug] [MainThread]: On master: BEGIN
[0m22:23:57.796009 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:23:57.797442 [debug] [MainThread]: On master: COMMIT
[0m22:23:57.798517 [debug] [MainThread]: Using postgres connection "master"
[0m22:23:57.799662 [debug] [MainThread]: On master: COMMIT
[0m22:23:57.801155 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:23:57.802357 [debug] [MainThread]: On master: Close
[0m22:23:57.810182 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m22:23:57.811761 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m22:23:57.813132 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m22:23:57.814171 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m22:23:57.830398 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m22:23:57.842282 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m22:23:57.872673 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m22:23:57.886121 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:23:57.888103 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m22:23:57.889671 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:23:57.903625 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m22:23:57.905325 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:23:57.907261 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m22:23:57.916623 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.008 seconds
[0m22:23:57.924275 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:23:57.925750 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m22:23:57.928137 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:23:57.931954 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:23:57.932993 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m22:23:57.935112 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:23:57.951784 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:23:57.953428 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:23:57.954792 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m22:23:57.959030 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m22:23:57.966282 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m22:23:57.971947 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m22:23:57.973413 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m22:23:57.979624 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m22:23:57.983495 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m22:23:57.986497 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3573b48e-d66e-4dec-81f9-fcae2029f46e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e6042f19f50>]}
[0m22:23:57.988497 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.17s]
[0m22:23:57.991078 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m22:23:57.994288 [debug] [MainThread]: Using postgres connection "master"
[0m22:23:57.995324 [debug] [MainThread]: On master: BEGIN
[0m22:23:57.996281 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:23:58.006864 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m22:23:58.008355 [debug] [MainThread]: On master: COMMIT
[0m22:23:58.009636 [debug] [MainThread]: Using postgres connection "master"
[0m22:23:58.010985 [debug] [MainThread]: On master: COMMIT
[0m22:23:58.012913 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m22:23:58.014291 [debug] [MainThread]: On master: Close
[0m22:23:58.015711 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:23:58.017297 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m22:23:58.019117 [info ] [MainThread]: 
[0m22:23:58.020477 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.49 seconds (0.49s).
[0m22:23:58.022952 [debug] [MainThread]: Command end result
[0m22:23:58.089888 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m22:23:58.099163 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m22:23:58.110513 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m22:23:58.111719 [info ] [MainThread]: 
[0m22:23:58.113011 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:23:58.114028 [info ] [MainThread]: 
[0m22:23:58.115614 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m22:23:58.117857 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.4557703, "process_in_blocks": "0", "process_kernel_time": 0.493024, "process_mem_max_rss": "126932", "process_out_blocks": "0", "process_user_time": 2.067523}
[0m22:23:58.119835 [debug] [MainThread]: Command `dbt run` succeeded at 22:23:58.119428 after 3.46 seconds
[0m22:23:58.122240 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e6046151610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e6046151fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e604a9aadd0>]}
[0m22:23:58.123697 [debug] [MainThread]: Flushing usage events
[0m22:23:58.667235 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:09:59.829211 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ae8c08aa7d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ae8c08aa390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ae8c0849190>]}


============================== 23:09:59.835268 | 9f4959a4-01b3-4069-ae6b-a999b098efef ==============================
[0m23:09:59.835268 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:09:59.837842 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'log_format': 'default', 'debug': 'False', 'use_experimental_parser': 'False', 'invocation_command': 'dbt run', 'indirect_selection': 'eager', 'quiet': 'False', 'no_print': 'None', 'partial_parse': 'True', 'printer_width': '80', 'send_anonymous_usage_stats': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'log_cache_events': 'False', 'fail_fast': 'False', 'write_json': 'True', 'empty': 'False', 'static_parser': 'True', 'version_check': 'True', 'introspect': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'use_colors': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None', 'target_path': 'None'}
[0m23:10:00.018994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9f4959a4-01b3-4069-ae6b-a999b098efef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ae8c1864790>]}
[0m23:10:00.069935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9f4959a4-01b3-4069-ae6b-a999b098efef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ae8c35a4850>]}
[0m23:10:00.074206 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:10:00.236367 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:10:00.580557 [error] [MainThread]: Encountered an error:
Parsing Error
  Error reading data_project_1: staging/sources.yml - Runtime Error
    Syntax error near line 11
    ------------------------------
    8  | tables:
    9  | - name: estaciones
    10 | description: "InformaciÃ³n de las estaciones de mediciÃ³n"
    11 | - name: air_quality
    12 | description: "Mediciones de calidad del aire por estaciÃ³n y contaminante"
    
    Raw Error:
    ------------------------------
    while parsing a block mapping
      in "<unicode string>", line 1, column 1
    did not find expected key
      in "<unicode string>", line 11, column 1
[0m23:10:00.584358 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.8839717, "process_in_blocks": "0", "process_kernel_time": 0.383822, "process_mem_max_rss": "115272", "process_out_blocks": "0", "process_user_time": 1.618386}
[0m23:10:00.588102 [debug] [MainThread]: Command `dbt run` failed at 23:10:00.587737 after 0.89 seconds
[0m23:10:00.590708 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ae8c0bac450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ae8bed8d990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ae8bed8de90>]}
[0m23:10:00.592353 [debug] [MainThread]: Flushing usage events
[0m23:10:01.186063 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:11:03.767147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a948b2adad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a948b30eb10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a948b30e450>]}


============================== 23:11:03.775452 | 3cd15883-03c9-4b0f-b4ed-006f7b86a8da ==============================
[0m23:11:03.775452 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:11:03.777238 [debug] [MainThread]: running dbt with arguments {'use_colors': 'True', 'printer_width': '80', 'warn_error': 'None', 'indirect_selection': 'eager', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'partial_parse': 'True', 'empty': 'False', 'target_path': 'None', 'log_cache_events': 'False', 'write_json': 'True', 'send_anonymous_usage_stats': 'True', 'introspect': 'True', 'cache_selected_only': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'log_format': 'default', 'no_print': 'None', 'static_parser': 'True', 'use_experimental_parser': 'False', 'quiet': 'False', 'version_check': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'debug': 'False', 'invocation_command': 'dbt run', 'fail_fast': 'False'}
[0m23:11:03.933741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3cd15883-03c9-4b0f-b4ed-006f7b86a8da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a948b30e810>]}
[0m23:11:03.993526 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3cd15883-03c9-4b0f-b4ed-006f7b86a8da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a948e012810>]}
[0m23:11:03.996344 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:11:04.147032 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:11:04.420285 [error] [MainThread]: Encountered an error:
Parsing Error
  Error reading data_project_1: staging/sources.yml - Runtime Error
    Syntax error near line 11
    ------------------------------
    8  | tables:
    9  | - name: estaciones
    10 | description: "InformaciÃ³n de las estaciones de mediciÃ³n"
    11 | - name: air_quality
    12 | description: "Mediciones de calidad del aire por estaciÃ³n y contaminante"
    
    Raw Error:
    ------------------------------
    while parsing a block mapping
      in "<unicode string>", line 1, column 1
    did not find expected key
      in "<unicode string>", line 11, column 1
[0m23:11:04.424426 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 0.7370256, "process_in_blocks": "0", "process_kernel_time": 0.592097, "process_mem_max_rss": "116084", "process_out_blocks": "0", "process_user_time": 1.580259}
[0m23:11:04.427025 [debug] [MainThread]: Command `dbt run` failed at 23:11:04.426736 after 0.74 seconds
[0m23:11:04.428435 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a948b29c610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a948fb06e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a948fb06e90>]}
[0m23:11:04.429890 [debug] [MainThread]: Flushing usage events
[0m23:11:05.012300 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:12:07.346203 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ec3d603bf90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ec3d603a8d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ec3d603a550>]}


============================== 23:12:07.354663 | fb63c58e-e41c-4229-9948-89a4deba3135 ==============================
[0m23:12:07.354663 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:12:07.356031 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'target_path': 'None', 'invocation_command': 'dbt run', 'log_format': 'default', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'quiet': 'False', 'write_json': 'True', 'no_print': 'None', 'introspect': 'True', 'warn_error': 'None', 'empty': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'partial_parse': 'True', 'fail_fast': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'version_check': 'True', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'log_cache_events': 'False', 'use_colors': 'True', 'debug': 'False', 'use_experimental_parser': 'False', 'cache_selected_only': 'False', 'indirect_selection': 'eager'}
[0m23:12:07.504834 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fb63c58e-e41c-4229-9948-89a4deba3135', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ec3d5fe5650>]}
[0m23:12:07.552895 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fb63c58e-e41c-4229-9948-89a4deba3135', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ec3d8d628d0>]}
[0m23:12:07.579317 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:12:07.765328 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:12:10.578620 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m23:12:10.580292 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/staging/sources.yml
[0m23:12:10.680354 [error] [MainThread]: Encountered an error:
Compilation Error
  dbt found two sources with the name "raw_data_estaciones".
  
  Since these resources have the same name, dbt will be unable to find the correct resource
  when looking for source("raw_data", "estaciones").
  
  To fix this, change the name of one of these resources:
  - source.data_project_1.raw_data.estaciones (models/staging/sources.yml)
  - source.data_project_1.raw_data.estaciones (models/sources.yml)
[0m23:12:10.683580 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.4024155, "process_in_blocks": "0", "process_kernel_time": 0.748105, "process_mem_max_rss": "117808", "process_out_blocks": "0", "process_user_time": 1.580223}
[0m23:12:10.685919 [debug] [MainThread]: Command `dbt run` failed at 23:12:10.685579 after 3.40 seconds
[0m23:12:10.687246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ec3d60422d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ec3d6042190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ec3d6360f90>]}
[0m23:12:10.688404 [debug] [MainThread]: Flushing usage events
[0m23:12:11.427100 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:13:13.611797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c58a9918350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c58a95bb610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c58a95ba650>]}


============================== 23:13:13.617937 | 5090d238-b79b-4064-9637-297f02269a6a ==============================
[0m23:13:13.617937 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:13:13.619798 [debug] [MainThread]: running dbt with arguments {'use_experimental_parser': 'False', 'target_path': 'None', 'empty': 'False', 'printer_width': '80', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'no_print': 'None', 'static_parser': 'True', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run', 'profiles_dir': '/usr/app/dbt/dbt', 'send_anonymous_usage_stats': 'True', 'warn_error': 'None', 'write_json': 'True', 'partial_parse': 'True', 'use_colors': 'True', 'log_cache_events': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'introspect': 'True', 'fail_fast': 'False', 'debug': 'False', 'version_check': 'True'}
[0m23:13:13.759798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5090d238-b79b-4064-9637-297f02269a6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c58a8d68250>]}
[0m23:13:13.808442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5090d238-b79b-4064-9637-297f02269a6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c58ac3287d0>]}
[0m23:13:13.810671 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:13:13.943141 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:13:16.517001 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m23:13:16.518810 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/staging/sources.yml
[0m23:13:16.594509 [error] [MainThread]: Encountered an error:
Compilation Error
  dbt found two sources with the name "raw_data_estaciones".
  
  Since these resources have the same name, dbt will be unable to find the correct resource
  when looking for source("raw_data", "estaciones").
  
  To fix this, change the name of one of these resources:
  - source.data_project_1.raw_data.estaciones (models/staging/sources.yml)
  - source.data_project_1.raw_data.estaciones (models/sources.yml)
[0m23:13:16.597545 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.0525296, "process_in_blocks": "0", "process_kernel_time": 0.554162, "process_mem_max_rss": "117340", "process_out_blocks": "0", "process_user_time": 1.560301}
[0m23:13:16.599114 [debug] [MainThread]: Command `dbt run` failed at 23:13:16.598919 after 3.05 seconds
[0m23:13:16.600240 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c58ade12e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c58a75e7850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c58ade12e90>]}
[0m23:13:16.601264 [debug] [MainThread]: Flushing usage events
[0m23:13:17.497593 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:14:12.214720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76e7bd56cad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76e7bd591210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76e7bd56c2d0>]}


============================== 23:14:12.222984 | dde7178e-867a-478d-a427-adcb1fdcc086 ==============================
[0m23:14:12.222984 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:14:12.224898 [debug] [MainThread]: running dbt with arguments {'fail_fast': 'False', 'quiet': 'False', 'partial_parse': 'True', 'debug': 'False', 'static_parser': 'True', 'log_format': 'default', 'printer_width': '80', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'send_anonymous_usage_stats': 'True', 'write_json': 'True', 'empty': 'False', 'no_print': 'None', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'version_check': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'use_colors': 'True', 'introspect': 'True', 'cache_selected_only': 'False', 'target_path': 'None', 'use_experimental_parser': 'False', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'invocation_command': 'dbt run'}
[0m23:14:12.381705 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dde7178e-867a-478d-a427-adcb1fdcc086', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76e7bd609650>]}
[0m23:14:12.429362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dde7178e-867a-478d-a427-adcb1fdcc086', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76e7bc101d50>]}
[0m23:14:12.432218 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:14:12.578864 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:14:14.599551 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m23:14:14.601584 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/staging/sources.yml
[0m23:14:14.680596 [error] [MainThread]: Encountered an error:
Compilation Error
  dbt found two sources with the name "raw_data_estaciones".
  
  Since these resources have the same name, dbt will be unable to find the correct resource
  when looking for source("raw_data", "estaciones").
  
  To fix this, change the name of one of these resources:
  - source.data_project_1.raw_data.estaciones (models/staging/sources.yml)
  - source.data_project_1.raw_data.estaciones (models/sources.yml)
[0m23:14:14.685082 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.541882, "process_in_blocks": "0", "process_kernel_time": 0.564802, "process_mem_max_rss": "117312", "process_out_blocks": "0", "process_user_time": 1.601619}
[0m23:14:14.687502 [debug] [MainThread]: Command `dbt run` failed at 23:14:14.687211 after 2.54 seconds
[0m23:14:14.689532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76e7bd55e9d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76e7c1da6e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76e7c1da6dd0>]}
[0m23:14:14.690726 [debug] [MainThread]: Flushing usage events
[0m23:14:15.558691 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:14:17.929368 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4832c7b0d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a482ff134d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a483036cad0>]}


============================== 23:14:17.940895 | 6f9526a8-2bd3-4cb6-a42a-57b6d06432b5 ==============================
[0m23:14:17.940895 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:14:17.945162 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'partial_parse': 'True', 'printer_width': '80', 'log_cache_events': 'False', 'invocation_command': 'dbt run', 'use_colors': 'True', 'indirect_selection': 'eager', 'quiet': 'False', 'introspect': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'profiles_dir': '/usr/app/dbt/dbt', 'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'cache_selected_only': 'False', 'target_path': 'None', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'write_json': 'True', 'log_format': 'default', 'static_parser': 'True'}
[0m23:14:18.094612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6f9526a8-2bd3-4cb6-a42a-57b6d06432b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4830f448d0>]}
[0m23:14:18.142560 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6f9526a8-2bd3-4cb6-a42a-57b6d06432b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a4832c92710>]}
[0m23:14:18.145810 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:14:18.310881 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:14:20.442783 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m23:14:20.444737 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/staging/sources.yml
[0m23:14:20.518023 [error] [MainThread]: Encountered an error:
Compilation Error
  dbt found two sources with the name "raw_data_estaciones".
  
  Since these resources have the same name, dbt will be unable to find the correct resource
  when looking for source("raw_data", "estaciones").
  
  To fix this, change the name of one of these resources:
  - source.data_project_1.raw_data.estaciones (models/staging/sources.yml)
  - source.data_project_1.raw_data.estaciones (models/sources.yml)
[0m23:14:20.521000 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.6663733, "process_in_blocks": "0", "process_kernel_time": 0.566085, "process_mem_max_rss": "117644", "process_out_blocks": "0", "process_user_time": 1.570687}
[0m23:14:20.522846 [debug] [MainThread]: Command `dbt run` failed at 23:14:20.522630 after 2.67 seconds
[0m23:14:20.524141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a482ff02310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a482d702990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7a483476ed10>]}
[0m23:14:20.525261 [debug] [MainThread]: Flushing usage events
[0m23:14:21.215177 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:14:23.674053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c92051b1d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c91d7d4e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c91d8124d0>]}


============================== 23:14:23.683705 | 01877fa8-eaee-43d2-ab0a-35721602f87d ==============================
[0m23:14:23.683705 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:14:23.685744 [debug] [MainThread]: running dbt with arguments {'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None', 'profiles_dir': '/usr/app/dbt/dbt', 'write_json': 'True', 'partial_parse': 'True', 'use_colors': 'True', 'log_format': 'default', 'indirect_selection': 'eager', 'printer_width': '80', 'fail_fast': 'False', 'no_print': 'None', 'static_parser': 'True', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'empty': 'False', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'invocation_command': 'dbt run', 'log_path': '/usr/app/dbt/dbt/logs', 'introspect': 'True', 'use_experimental_parser': 'False', 'debug': 'False', 'version_check': 'True', 'quiet': 'False'}
[0m23:14:23.836774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '01877fa8-eaee-43d2-ab0a-35721602f87d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c91d80af50>]}
[0m23:14:23.892300 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '01877fa8-eaee-43d2-ab0a-35721602f87d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c91cb1a990>]}
[0m23:14:23.894842 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:14:24.043148 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:14:26.219793 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m23:14:26.221804 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/staging/sources.yml
[0m23:14:26.311154 [error] [MainThread]: Encountered an error:
Compilation Error
  dbt found two sources with the name "raw_data_estaciones".
  
  Since these resources have the same name, dbt will be unable to find the correct resource
  when looking for source("raw_data", "estaciones").
  
  To fix this, change the name of one of these resources:
  - source.data_project_1.raw_data.estaciones (models/staging/sources.yml)
  - source.data_project_1.raw_data.estaciones (models/sources.yml)
[0m23:14:26.313577 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.7125905, "process_in_blocks": "0", "process_kernel_time": 0.394292, "process_mem_max_rss": "117356", "process_out_blocks": "0", "process_user_time": 1.798958}
[0m23:14:26.315263 [debug] [MainThread]: Command `dbt run` failed at 23:14:26.315151 after 2.71 seconds
[0m23:14:26.316734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c91b3061d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c9220d69d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73c9220d6990>]}
[0m23:14:26.318047 [debug] [MainThread]: Flushing usage events
[0m23:14:27.008270 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:14:29.627160 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7023ac4a3b10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7023ac4adf10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7023ac4a02d0>]}


============================== 23:14:29.631944 | da20a032-9297-4575-a54a-b5e0b332a408 ==============================
[0m23:14:29.631944 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:14:29.635755 [debug] [MainThread]: running dbt with arguments {'profiles_dir': '/usr/app/dbt/dbt', 'quiet': 'False', 'debug': 'False', 'static_parser': 'True', 'printer_width': '80', 'write_json': 'True', 'empty': 'False', 'partial_parse': 'True', 'warn_error': 'None', 'version_check': 'True', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'fail_fast': 'False', 'indirect_selection': 'eager', 'no_print': 'None', 'use_colors': 'True', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_experimental_parser': 'False'}
[0m23:14:29.778254 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'da20a032-9297-4575-a54a-b5e0b332a408', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7023ab169950>]}
[0m23:14:29.832695 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'da20a032-9297-4575-a54a-b5e0b332a408', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7023ab1bdd50>]}
[0m23:14:29.835601 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:14:29.964058 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:14:31.932340 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m23:14:31.933671 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/staging/sources.yml
[0m23:14:31.998869 [error] [MainThread]: Encountered an error:
Compilation Error
  dbt found two sources with the name "raw_data_estaciones".
  
  Since these resources have the same name, dbt will be unable to find the correct resource
  when looking for source("raw_data", "estaciones").
  
  To fix this, change the name of one of these resources:
  - source.data_project_1.raw_data.estaciones (models/staging/sources.yml)
  - source.data_project_1.raw_data.estaciones (models/sources.yml)
[0m23:14:32.001462 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.4504461, "process_in_blocks": "0", "process_kernel_time": 0.45873, "process_mem_max_rss": "116868", "process_out_blocks": "0", "process_user_time": 1.627495}
[0m23:14:32.003035 [debug] [MainThread]: Command `dbt run` failed at 23:14:32.002821 after 2.45 seconds
[0m23:14:32.004322 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7023b0d729d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7023b0d72950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7023ab176a10>]}
[0m23:14:32.005463 [debug] [MainThread]: Flushing usage events
[0m23:14:32.980339 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:14:35.852677 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7771ba5acc90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7771ba27e890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7771ba27e950>]}


============================== 23:14:35.860091 | c41ee8f8-3e36-4125-9b92-806957dbed14 ==============================
[0m23:14:35.860091 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:14:35.862394 [debug] [MainThread]: running dbt with arguments {'empty': 'False', 'static_parser': 'True', 'partial_parse': 'True', 'use_experimental_parser': 'False', 'printer_width': '80', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'quiet': 'False', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run', 'use_colors': 'True', 'no_print': 'None', 'introspect': 'True', 'version_check': 'True', 'indirect_selection': 'eager', 'write_json': 'True', 'cache_selected_only': 'False', 'fail_fast': 'False', 'debug': 'False', 'log_cache_events': 'False'}
[0m23:14:36.018257 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c41ee8f8-3e36-4125-9b92-806957dbed14', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7771ba1b9b50>]}
[0m23:14:36.070320 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c41ee8f8-3e36-4125-9b92-806957dbed14', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7771bcf7a7d0>]}
[0m23:14:36.072349 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:14:36.246147 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:14:37.749720 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m23:14:37.750782 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/staging/sources.yml
[0m23:14:37.814428 [error] [MainThread]: Encountered an error:
Compilation Error
  dbt found two sources with the name "raw_data_estaciones".
  
  Since these resources have the same name, dbt will be unable to find the correct resource
  when looking for source("raw_data", "estaciones").
  
  To fix this, change the name of one of these resources:
  - source.data_project_1.raw_data.estaciones (models/staging/sources.yml)
  - source.data_project_1.raw_data.estaciones (models/sources.yml)
[0m23:14:37.831074 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.0637143, "process_in_blocks": "0", "process_kernel_time": 0.453463, "process_mem_max_rss": "117520", "process_out_blocks": "0", "process_user_time": 1.569065}
[0m23:14:37.832872 [debug] [MainThread]: Command `dbt run` failed at 23:14:37.832717 after 2.07 seconds
[0m23:14:37.834002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7771ba20e5d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7771b8d41290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7771bea5ad10>]}
[0m23:14:37.835157 [debug] [MainThread]: Flushing usage events
[0m23:14:38.717197 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:14:42.318231 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d786fe54d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d786fb0910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d7872f8290>]}


============================== 23:14:42.338143 | 887517be-0b91-4b44-a95a-5c29381c5a50 ==============================
[0m23:14:42.338143 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:14:42.343155 [debug] [MainThread]: running dbt with arguments {'partial_parse': 'True', 'indirect_selection': 'eager', 'debug': 'False', 'introspect': 'True', 'fail_fast': 'False', 'invocation_command': 'dbt run', 'version_check': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'use_experimental_parser': 'False', 'quiet': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'empty': 'False', 'static_parser': 'True', 'warn_error': 'None', 'printer_width': '80', 'log_cache_events': 'False', 'send_anonymous_usage_stats': 'True', 'target_path': 'None', 'use_colors': 'True', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'cache_selected_only': 'False', 'log_format': 'default', 'write_json': 'True'}
[0m23:14:42.514213 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '887517be-0b91-4b44-a95a-5c29381c5a50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d786f91310>]}
[0m23:14:42.560959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '887517be-0b91-4b44-a95a-5c29381c5a50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d789cf6410>]}
[0m23:14:42.564351 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:14:42.727061 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:14:44.500127 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 1 files added, 0 files changed.
[0m23:14:44.501221 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/staging/sources.yml
[0m23:14:44.987448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '887517be-0b91-4b44-a95a-5c29381c5a50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d78677dc90>]}
[0m23:14:45.142779 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:14:45.151321 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:14:45.200771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '887517be-0b91-4b44-a95a-5c29381c5a50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d78479b7d0>]}
[0m23:14:45.202445 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:14:45.203673 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '887517be-0b91-4b44-a95a-5c29381c5a50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d785b82250>]}
[0m23:14:45.206532 [info ] [MainThread]: 
[0m23:14:45.207769 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:14:45.208902 [info ] [MainThread]: 
[0m23:14:45.210452 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:14:45.212509 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:14:45.284869 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:14:45.286485 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:14:45.287639 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:14:45.312797 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.025 seconds
[0m23:14:45.315575 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:14:45.318365 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:14:45.326677 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:14:45.328047 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:14:45.329221 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:14:45.341074 [debug] [ThreadPool]: SQL status: BEGIN in 0.012 seconds
[0m23:14:45.343052 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:14:45.344545 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:14:45.366370 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.021 seconds
[0m23:14:45.370618 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:14:45.374638 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:14:45.383655 [debug] [MainThread]: Using postgres connection "master"
[0m23:14:45.387202 [debug] [MainThread]: On master: BEGIN
[0m23:14:45.389047 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:14:45.404000 [debug] [MainThread]: SQL status: BEGIN in 0.015 seconds
[0m23:14:45.406484 [debug] [MainThread]: Using postgres connection "master"
[0m23:14:45.408464 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:14:45.424181 [debug] [MainThread]: SQL status: SELECT 1 in 0.014 seconds
[0m23:14:45.429008 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '887517be-0b91-4b44-a95a-5c29381c5a50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d783b5a710>]}
[0m23:14:45.431704 [debug] [MainThread]: On master: ROLLBACK
[0m23:14:45.434459 [debug] [MainThread]: Using postgres connection "master"
[0m23:14:45.436726 [debug] [MainThread]: On master: BEGIN
[0m23:14:45.440056 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m23:14:45.441907 [debug] [MainThread]: On master: COMMIT
[0m23:14:45.443698 [debug] [MainThread]: Using postgres connection "master"
[0m23:14:45.445114 [debug] [MainThread]: On master: COMMIT
[0m23:14:45.447060 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:14:45.448390 [debug] [MainThread]: On master: Close
[0m23:14:45.459865 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:14:45.461977 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:14:45.463942 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:14:45.465689 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:14:45.479634 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:14:45.494922 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:14:45.525445 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:14:45.541763 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:14:45.543561 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:14:45.545227 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:14:45.558000 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m23:14:45.560217 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:14:45.561825 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:14:45.590177 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.027 seconds
[0m23:14:45.597388 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:14:45.599731 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:14:45.604371 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.003 seconds
[0m23:14:45.609762 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:14:45.610933 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:14:45.613717 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:14:45.626210 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:14:45.628061 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:14:45.629367 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:14:45.635091 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m23:14:45.643170 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:14:45.649986 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:14:45.651497 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:14:45.663370 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.010 seconds
[0m23:14:45.667263 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:14:45.671976 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '887517be-0b91-4b44-a95a-5c29381c5a50', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d784f1db50>]}
[0m23:14:45.675215 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.21s]
[0m23:14:45.677778 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:14:45.682798 [debug] [MainThread]: Using postgres connection "master"
[0m23:14:45.684289 [debug] [MainThread]: On master: BEGIN
[0m23:14:45.685820 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:14:45.698457 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m23:14:45.699896 [debug] [MainThread]: On master: COMMIT
[0m23:14:45.701210 [debug] [MainThread]: Using postgres connection "master"
[0m23:14:45.702504 [debug] [MainThread]: On master: COMMIT
[0m23:14:45.704318 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:14:45.705816 [debug] [MainThread]: On master: Close
[0m23:14:45.707447 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:14:45.708820 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:14:45.710207 [info ] [MainThread]: 
[0m23:14:45.711388 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.50 seconds (0.50s).
[0m23:14:45.713017 [debug] [MainThread]: Command end result
[0m23:14:45.778100 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:14:45.789357 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:14:45.807488 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:14:45.809343 [info ] [MainThread]: 
[0m23:14:45.810934 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:14:45.812795 [info ] [MainThread]: 
[0m23:14:45.813949 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:14:45.816661 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.578174, "process_in_blocks": "0", "process_kernel_time": 0.444467, "process_mem_max_rss": "132648", "process_out_blocks": "0", "process_user_time": 2.295735}
[0m23:14:45.818571 [debug] [MainThread]: Command `dbt run` succeeded at 23:14:45.818443 after 3.58 seconds
[0m23:14:45.820045 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d786f82350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d786f825d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x79d78baef910>]}
[0m23:14:45.821408 [debug] [MainThread]: Flushing usage events
[0m23:14:46.397397 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:14:51.742064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73590c262410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73590c261ed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73590c262090>]}


============================== 23:14:51.752534 | cba78809-ab86-4b91-a8e7-6775144b552d ==============================
[0m23:14:51.752534 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:14:51.754747 [debug] [MainThread]: running dbt with arguments {'partial_parse': 'True', 'write_json': 'True', 'quiet': 'False', 'use_colors': 'True', 'version_check': 'True', 'target_path': 'None', 'cache_selected_only': 'False', 'warn_error': 'None', 'static_parser': 'True', 'introspect': 'True', 'no_print': 'None', 'debug': 'False', 'log_cache_events': 'False', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/app/dbt/dbt/logs', 'empty': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'send_anonymous_usage_stats': 'True', 'indirect_selection': 'eager', 'log_format': 'default', 'printer_width': '80', 'fail_fast': 'False', 'use_experimental_parser': 'False'}
[0m23:14:51.937290 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cba78809-ab86-4b91-a8e7-6775144b552d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73590c20fed0>]}
[0m23:14:51.985092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cba78809-ab86-4b91-a8e7-6775144b552d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73590afa1d50>]}
[0m23:14:51.997359 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:14:52.145865 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:14:54.104049 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:14:54.104902 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:14:54.137850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cba78809-ab86-4b91-a8e7-6775144b552d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73590b3bed90>]}
[0m23:14:54.225512 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:14:54.231364 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:14:54.254210 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cba78809-ab86-4b91-a8e7-6775144b552d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x735909b03cd0>]}
[0m23:14:54.255278 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:14:54.256363 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cba78809-ab86-4b91-a8e7-6775144b552d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x735909b76850>]}
[0m23:14:54.258237 [info ] [MainThread]: 
[0m23:14:54.259291 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:14:54.261359 [info ] [MainThread]: 
[0m23:14:54.265248 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:14:54.271999 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:14:54.386153 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:14:54.387814 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:14:54.389123 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:14:54.405064 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.016 seconds
[0m23:14:54.408323 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:14:54.411371 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:14:54.422496 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:14:54.424185 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:14:54.425397 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:14:54.437917 [debug] [ThreadPool]: SQL status: BEGIN in 0.012 seconds
[0m23:14:54.439683 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:14:54.441270 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:14:54.448655 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m23:14:54.451340 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:14:54.452963 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:14:54.460625 [debug] [MainThread]: Using postgres connection "master"
[0m23:14:54.463262 [debug] [MainThread]: On master: BEGIN
[0m23:14:54.465180 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:14:54.475911 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m23:14:54.477474 [debug] [MainThread]: Using postgres connection "master"
[0m23:14:54.479837 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:14:54.488424 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m23:14:54.490630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cba78809-ab86-4b91-a8e7-6775144b552d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x735909b79310>]}
[0m23:14:54.491854 [debug] [MainThread]: On master: ROLLBACK
[0m23:14:54.493148 [debug] [MainThread]: Using postgres connection "master"
[0m23:14:54.494047 [debug] [MainThread]: On master: BEGIN
[0m23:14:54.495477 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:14:54.498738 [debug] [MainThread]: On master: COMMIT
[0m23:14:54.499821 [debug] [MainThread]: Using postgres connection "master"
[0m23:14:54.500826 [debug] [MainThread]: On master: COMMIT
[0m23:14:54.502056 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:14:54.502995 [debug] [MainThread]: On master: Close
[0m23:14:54.508474 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:14:54.509619 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:14:54.510771 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:14:54.512837 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:14:54.532234 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:14:54.600818 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:14:54.644059 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:14:54.687275 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:14:54.689924 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:14:54.697434 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:14:54.726794 [debug] [Thread-1 (]: SQL status: BEGIN in 0.029 seconds
[0m23:14:54.732348 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:14:54.734247 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:14:54.749044 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.013 seconds
[0m23:14:54.757524 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:14:54.759392 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:14:54.764591 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.003 seconds
[0m23:14:54.769933 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:14:54.771816 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:14:54.775659 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:14:54.791614 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:14:54.793839 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:14:54.796295 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:14:54.800721 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m23:14:54.806339 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:14:54.810671 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:14:54.813464 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:14:54.819232 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m23:14:54.821882 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:14:54.824152 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cba78809-ab86-4b91-a8e7-6775144b552d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x735908f7e810>]}
[0m23:14:54.825924 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.31s]
[0m23:14:54.829941 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:14:54.833034 [debug] [MainThread]: Using postgres connection "master"
[0m23:14:54.834082 [debug] [MainThread]: On master: BEGIN
[0m23:14:54.835058 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:14:54.857304 [debug] [MainThread]: SQL status: BEGIN in 0.022 seconds
[0m23:14:54.865714 [debug] [MainThread]: On master: COMMIT
[0m23:14:54.870066 [debug] [MainThread]: Using postgres connection "master"
[0m23:14:54.873501 [debug] [MainThread]: On master: COMMIT
[0m23:14:54.877443 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m23:14:54.881589 [debug] [MainThread]: On master: Close
[0m23:14:54.884930 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:14:54.887613 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:14:54.890611 [info ] [MainThread]: 
[0m23:14:54.892737 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.63 seconds (0.63s).
[0m23:14:54.894543 [debug] [MainThread]: Command end result
[0m23:14:54.971117 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:14:54.979370 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:14:54.991573 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:14:54.992870 [info ] [MainThread]: 
[0m23:14:54.995600 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:14:54.996925 [info ] [MainThread]: 
[0m23:14:54.998571 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:14:55.000925 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.3222008, "process_in_blocks": "0", "process_kernel_time": 0.454843, "process_mem_max_rss": "127644", "process_out_blocks": "0", "process_user_time": 1.896532}
[0m23:14:55.002074 [debug] [MainThread]: Command `dbt run` succeeded at 23:14:55.001947 after 3.32 seconds
[0m23:14:55.003036 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73590c568b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x735910b17810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x735910b328d0>]}
[0m23:14:55.004011 [debug] [MainThread]: Flushing usage events
[0m23:14:55.621148 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:15:04.064263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797fe38ddf10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797fe393e510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797fe38df5d0>]}


============================== 23:15:04.071964 | d4911c70-64db-4b51-931d-082fdfa56162 ==============================
[0m23:15:04.071964 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:15:04.074314 [debug] [MainThread]: running dbt with arguments {'partial_parse': 'True', 'indirect_selection': 'eager', 'static_parser': 'True', 'write_json': 'True', 'send_anonymous_usage_stats': 'True', 'version_check': 'True', 'quiet': 'False', 'introspect': 'True', 'log_cache_events': 'False', 'invocation_command': 'dbt run', 'empty': 'False', 'warn_error': 'None', 'log_format': 'default', 'use_colors': 'True', 'printer_width': '80', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'profiles_dir': '/usr/app/dbt/dbt', 'use_experimental_parser': 'False', 'no_print': 'None', 'cache_selected_only': 'False'}
[0m23:15:04.217240 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd4911c70-64db-4b51-931d-082fdfa56162', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797fe38cdf90>]}
[0m23:15:04.265346 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd4911c70-64db-4b51-931d-082fdfa56162', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797fe6668710>]}
[0m23:15:04.267385 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:15:04.433838 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:15:06.314984 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:15:06.316654 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:15:06.356002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd4911c70-64db-4b51-931d-082fdfa56162', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797fe21555d0>]}
[0m23:15:06.475039 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:15:06.485237 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:15:06.514650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd4911c70-64db-4b51-931d-082fdfa56162', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797fe15983d0>]}
[0m23:15:06.516131 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:15:06.517568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd4911c70-64db-4b51-931d-082fdfa56162', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797fe1582210>]}
[0m23:15:06.520388 [info ] [MainThread]: 
[0m23:15:06.522633 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:15:06.524585 [info ] [MainThread]: 
[0m23:15:06.526668 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:15:06.528982 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:15:06.653045 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:15:06.655067 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:15:06.658106 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:15:06.682450 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.024 seconds
[0m23:15:06.686420 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:15:06.691350 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:15:06.701598 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:15:06.703407 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:15:06.705535 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:15:06.718482 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m23:15:06.720546 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:15:06.722562 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:15:06.731682 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m23:15:06.734384 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:15:06.736022 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:15:06.743389 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:06.745019 [debug] [MainThread]: On master: BEGIN
[0m23:15:06.746671 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:15:06.758683 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m23:15:06.761421 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:06.763257 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:15:06.771762 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m23:15:06.775434 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd4911c70-64db-4b51-931d-082fdfa56162', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797fe296a3d0>]}
[0m23:15:06.777803 [debug] [MainThread]: On master: ROLLBACK
[0m23:15:06.779667 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:06.781440 [debug] [MainThread]: On master: BEGIN
[0m23:15:06.783673 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:15:06.785690 [debug] [MainThread]: On master: COMMIT
[0m23:15:06.787567 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:06.789054 [debug] [MainThread]: On master: COMMIT
[0m23:15:06.790576 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:15:06.792999 [debug] [MainThread]: On master: Close
[0m23:15:06.801951 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:15:06.803877 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:15:06.805919 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:15:06.808545 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:15:06.831396 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:15:06.849238 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:15:06.875467 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:15:06.888124 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:06.889397 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:15:06.891349 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:15:06.904070 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m23:15:06.906793 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:06.908622 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:15:06.924380 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.014 seconds
[0m23:15:06.934955 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:06.936352 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:15:06.939660 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:15:06.948995 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:06.951194 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:15:06.955082 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:15:06.973368 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:15:06.976021 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:06.977576 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:15:06.981537 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m23:15:06.991305 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:15:06.997950 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:06.999209 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:15:07.007641 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.007 seconds
[0m23:15:07.011801 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:15:07.014662 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4911c70-64db-4b51-931d-082fdfa56162', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797fe08a08d0>]}
[0m23:15:07.017100 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.21s]
[0m23:15:07.019033 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:15:07.023032 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:07.024626 [debug] [MainThread]: On master: BEGIN
[0m23:15:07.026110 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:15:07.037470 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m23:15:07.039687 [debug] [MainThread]: On master: COMMIT
[0m23:15:07.041760 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:07.043455 [debug] [MainThread]: On master: COMMIT
[0m23:15:07.045545 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:15:07.047414 [debug] [MainThread]: On master: Close
[0m23:15:07.049212 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:15:07.050628 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:15:07.052023 [info ] [MainThread]: 
[0m23:15:07.053344 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.53 seconds (0.53s).
[0m23:15:07.055920 [debug] [MainThread]: Command end result
[0m23:15:07.128881 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:15:07.136692 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:15:07.150607 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:15:07.151882 [info ] [MainThread]: 
[0m23:15:07.153369 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:15:07.155037 [info ] [MainThread]: 
[0m23:15:07.156684 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:15:07.159067 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.1596315, "process_in_blocks": "0", "process_kernel_time": 0.395479, "process_mem_max_rss": "127492", "process_out_blocks": "0", "process_user_time": 1.924934}
[0m23:15:07.160649 [debug] [MainThread]: Command `dbt run` succeeded at 23:15:07.160444 after 3.16 seconds
[0m23:15:07.162058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797fe393dcd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797fe813ee50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797fe81eb890>]}
[0m23:15:07.163371 [debug] [MainThread]: Flushing usage events
[0m23:15:07.787502 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:15:22.558264 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b27b6ee1910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b27b6ee7fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b27b6ee0cd0>]}


============================== 23:15:22.564726 | 5d223acb-b865-4376-8c9e-4fdc1f178a48 ==============================
[0m23:15:22.564726 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:15:22.565998 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'log_format': 'default', 'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'write_json': 'True', 'partial_parse': 'True', 'no_print': 'None', 'warn_error': 'None', 'use_colors': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'log_cache_events': 'False', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'version_check': 'True', 'invocation_command': 'dbt run', 'cache_selected_only': 'False', 'use_experimental_parser': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'quiet': 'False', 'introspect': 'True', 'printer_width': '80', 'debug': 'False', 'static_parser': 'True', 'fail_fast': 'False'}
[0m23:15:22.719969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5d223acb-b865-4376-8c9e-4fdc1f178a48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b27b63cabd0>]}
[0m23:15:22.765661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5d223acb-b865-4376-8c9e-4fdc1f178a48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b27b634f990>]}
[0m23:15:22.769482 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:15:23.170113 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:15:25.280082 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:15:25.281949 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:15:25.317417 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5d223acb-b865-4376-8c9e-4fdc1f178a48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b27b5718750>]}
[0m23:15:25.438632 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:15:25.450552 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:15:25.492090 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5d223acb-b865-4376-8c9e-4fdc1f178a48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b27b4b31e50>]}
[0m23:15:25.493811 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:15:25.495399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5d223acb-b865-4376-8c9e-4fdc1f178a48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b27b4ba05d0>]}
[0m23:15:25.499806 [info ] [MainThread]: 
[0m23:15:25.501737 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:15:25.503446 [info ] [MainThread]: 
[0m23:15:25.505594 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:15:25.508384 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:15:25.645740 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:15:25.647162 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:15:25.648351 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:15:25.665220 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m23:15:25.669340 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:15:25.673340 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:15:25.679550 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:15:25.681086 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:15:25.682289 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:15:25.693163 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m23:15:25.695141 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:15:25.696320 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:15:25.704667 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.007 seconds
[0m23:15:25.707396 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:15:25.708465 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:15:25.713825 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:25.715379 [debug] [MainThread]: On master: BEGIN
[0m23:15:25.716900 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:15:25.726868 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m23:15:25.729844 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:25.732583 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:15:25.739916 [debug] [MainThread]: SQL status: SELECT 1 in 0.005 seconds
[0m23:15:25.742526 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5d223acb-b865-4376-8c9e-4fdc1f178a48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b27b572ca50>]}
[0m23:15:25.744146 [debug] [MainThread]: On master: ROLLBACK
[0m23:15:25.745450 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:25.746592 [debug] [MainThread]: On master: BEGIN
[0m23:15:25.747779 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:15:25.748984 [debug] [MainThread]: On master: COMMIT
[0m23:15:25.750036 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:25.751389 [debug] [MainThread]: On master: COMMIT
[0m23:15:25.753042 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:15:25.754268 [debug] [MainThread]: On master: Close
[0m23:15:25.762579 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:15:25.764424 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:15:25.766049 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:15:25.767464 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:15:25.790321 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:15:25.803241 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:15:25.837887 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:15:25.852398 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:25.853811 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:15:25.855165 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:15:25.870202 [debug] [Thread-1 (]: SQL status: BEGIN in 0.015 seconds
[0m23:15:25.872414 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:25.876724 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:15:25.895180 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.014 seconds
[0m23:15:25.903971 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:25.906085 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:15:25.908811 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:15:25.916109 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:25.918076 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:15:25.921773 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:15:25.937649 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:15:25.939765 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:25.941025 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:15:25.945488 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m23:15:25.955488 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:15:25.963377 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:25.965696 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:15:25.972977 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m23:15:25.976971 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:15:25.980215 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5d223acb-b865-4376-8c9e-4fdc1f178a48', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b27b3de7f90>]}
[0m23:15:25.982245 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.21s]
[0m23:15:25.984353 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:15:25.988256 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:25.989755 [debug] [MainThread]: On master: BEGIN
[0m23:15:25.990917 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:15:26.003052 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m23:15:26.005238 [debug] [MainThread]: On master: COMMIT
[0m23:15:26.007113 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:26.008383 [debug] [MainThread]: On master: COMMIT
[0m23:15:26.009931 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:15:26.011085 [debug] [MainThread]: On master: Close
[0m23:15:26.012401 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:15:26.013793 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:15:26.015755 [info ] [MainThread]: 
[0m23:15:26.017491 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.51 seconds (0.51s).
[0m23:15:26.019718 [debug] [MainThread]: Command end result
[0m23:15:26.114164 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:15:26.126008 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:15:26.146329 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:15:26.148318 [info ] [MainThread]: 
[0m23:15:26.150966 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:15:26.153097 [info ] [MainThread]: 
[0m23:15:26.155503 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:15:26.158700 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.6673439, "process_in_blocks": "0", "process_kernel_time": 0.489712, "process_mem_max_rss": "127400", "process_out_blocks": "0", "process_user_time": 1.860907}
[0m23:15:26.160708 [debug] [MainThread]: Command `dbt run` succeeded at 23:15:26.160507 after 3.67 seconds
[0m23:15:26.162606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b27bba47910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b27bb7feb90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b27bb7fe990>]}
[0m23:15:26.164498 [debug] [MainThread]: Flushing usage events
[0m23:15:26.925571 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:15:54.522407 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfffec63290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfffc13b750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bffffe91110>]}


============================== 23:15:54.531944 | 123f66e0-a451-4926-b169-68fd47d1823c ==============================
[0m23:15:54.531944 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:15:54.533785 [debug] [MainThread]: running dbt with arguments {'write_json': 'True', 'static_parser': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'invocation_command': 'dbt run', 'log_format': 'default', 'version_check': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'no_print': 'None', 'log_cache_events': 'False', 'empty': 'False', 'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'partial_parse': 'True', 'warn_error': 'None', 'indirect_selection': 'eager', 'quiet': 'False', 'target_path': 'None', 'use_colors': 'True', 'introspect': 'True', 'use_experimental_parser': 'False', 'cache_selected_only': 'False', 'printer_width': '80', 'debug': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])'}
[0m23:15:54.677537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '123f66e0-a451-4926-b169-68fd47d1823c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfffc084290>]}
[0m23:15:54.732310 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '123f66e0-a451-4926-b169-68fd47d1823c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfffec767d0>]}
[0m23:15:54.735996 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:15:54.881848 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:15:56.799289 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:15:56.800262 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:15:56.835033 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '123f66e0-a451-4926-b169-68fd47d1823c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfffa70d190>]}
[0m23:15:56.921825 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:15:56.927104 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:15:56.955974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '123f66e0-a451-4926-b169-68fd47d1823c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfff9b9af50>]}
[0m23:15:56.956980 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:15:56.958211 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '123f66e0-a451-4926-b169-68fd47d1823c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfffabf8f50>]}
[0m23:15:56.960125 [info ] [MainThread]: 
[0m23:15:56.961326 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:15:56.962378 [info ] [MainThread]: 
[0m23:15:56.963686 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:15:56.964958 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:15:57.068930 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:15:57.071699 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:15:57.073358 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:15:57.091574 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m23:15:57.093857 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:15:57.096524 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:15:57.102271 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:15:57.104260 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:15:57.105423 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:15:57.113247 [debug] [ThreadPool]: SQL status: BEGIN in 0.008 seconds
[0m23:15:57.114822 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:15:57.117347 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:15:57.123642 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m23:15:57.125435 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:15:57.126543 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:15:57.130936 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:57.134208 [debug] [MainThread]: On master: BEGIN
[0m23:15:57.155150 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:15:57.172837 [debug] [MainThread]: SQL status: BEGIN in 0.018 seconds
[0m23:15:57.175186 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:57.177090 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:15:57.185037 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m23:15:57.190783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '123f66e0-a451-4926-b169-68fd47d1823c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfff8ee2850>]}
[0m23:15:57.192450 [debug] [MainThread]: On master: ROLLBACK
[0m23:15:57.194757 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:57.195978 [debug] [MainThread]: On master: BEGIN
[0m23:15:57.197798 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:15:57.199404 [debug] [MainThread]: On master: COMMIT
[0m23:15:57.200624 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:57.201798 [debug] [MainThread]: On master: COMMIT
[0m23:15:57.203243 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:15:57.205561 [debug] [MainThread]: On master: Close
[0m23:15:57.217518 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:15:57.219116 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:15:57.226105 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:15:57.227927 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:15:57.248527 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:15:57.260453 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:15:57.284859 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:15:57.295830 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:57.296791 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:15:57.297564 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:15:57.307251 [debug] [Thread-1 (]: SQL status: BEGIN in 0.009 seconds
[0m23:15:57.308545 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:57.309654 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:15:57.326436 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.015 seconds
[0m23:15:57.332487 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:57.333510 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:15:57.336390 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:15:57.348803 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:57.350089 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:15:57.352754 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:15:57.365810 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:15:57.367150 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:57.368586 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:15:57.372998 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m23:15:57.380657 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:15:57.387967 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:15:57.389499 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:15:57.396425 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.006 seconds
[0m23:15:57.399608 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:15:57.402621 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '123f66e0-a451-4926-b169-68fd47d1823c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfff9ba8b90>]}
[0m23:15:57.405607 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.18s]
[0m23:15:57.407092 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:15:57.409907 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:57.410799 [debug] [MainThread]: On master: BEGIN
[0m23:15:57.411793 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:15:57.420618 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m23:15:57.422618 [debug] [MainThread]: On master: COMMIT
[0m23:15:57.423500 [debug] [MainThread]: Using postgres connection "master"
[0m23:15:57.424754 [debug] [MainThread]: On master: COMMIT
[0m23:15:57.426613 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m23:15:57.427598 [debug] [MainThread]: On master: Close
[0m23:15:57.428639 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:15:57.429495 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:15:57.430548 [info ] [MainThread]: 
[0m23:15:57.431495 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.47 seconds (0.47s).
[0m23:15:57.432675 [debug] [MainThread]: Command end result
[0m23:15:57.485265 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:15:57.494128 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:15:57.504630 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:15:57.505520 [info ] [MainThread]: 
[0m23:15:57.506825 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:15:57.509085 [info ] [MainThread]: 
[0m23:15:57.510420 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:15:57.511950 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.0714788, "process_in_blocks": "0", "process_kernel_time": 0.405132, "process_mem_max_rss": "128112", "process_out_blocks": "0", "process_user_time": 1.816957}
[0m23:15:57.513078 [debug] [MainThread]: Command `dbt run` succeeded at 23:15:57.512949 after 3.07 seconds
[0m23:15:57.513964 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfffbeeac90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7bfffbef9e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c0000752d10>]}
[0m23:15:57.514816 [debug] [MainThread]: Flushing usage events
[0m23:15:58.364225 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:18:09.764741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca4167e9750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca41684a1d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca41684aa10>]}


============================== 23:18:09.783094 | 0d1bcfbb-270c-4cf3-aff3-cc6ab5e26b5c ==============================
[0m23:18:09.783094 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:18:09.786880 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'empty': 'False', 'fail_fast': 'False', 'write_json': 'True', 'log_cache_events': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'debug': 'False', 'quiet': 'False', 'introspect': 'True', 'printer_width': '80', 'send_anonymous_usage_stats': 'True', 'version_check': 'True', 'invocation_command': 'dbt run', 'log_format': 'default', 'use_colors': 'True', 'partial_parse': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'indirect_selection': 'eager', 'static_parser': 'True', 'warn_error': 'None', 'target_path': 'None', 'use_experimental_parser': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])'}
[0m23:18:10.083600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0d1bcfbb-270c-4cf3-aff3-cc6ab5e26b5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca415569450>]}
[0m23:18:10.185455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0d1bcfbb-270c-4cf3-aff3-cc6ab5e26b5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca4155cd890>]}
[0m23:18:10.189887 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:18:10.491457 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:18:12.540546 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:18:12.542544 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:18:12.601664 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0d1bcfbb-270c-4cf3-aff3-cc6ab5e26b5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca416881e10>]}
[0m23:18:12.750951 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:18:12.763203 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:18:12.815642 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0d1bcfbb-270c-4cf3-aff3-cc6ab5e26b5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca41410c850>]}
[0m23:18:12.817374 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:18:12.818575 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0d1bcfbb-270c-4cf3-aff3-cc6ab5e26b5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca418d7f290>]}
[0m23:18:12.821750 [info ] [MainThread]: 
[0m23:18:12.824235 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:18:12.825853 [info ] [MainThread]: 
[0m23:18:12.827862 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:18:12.830116 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:18:12.959279 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:18:12.961237 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:18:12.962875 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:18:12.981170 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m23:18:12.985699 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:18:12.988387 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:18:12.997326 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:18:12.999924 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:18:13.001158 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:18:13.011194 [debug] [ThreadPool]: SQL status: BEGIN in 0.010 seconds
[0m23:18:13.012641 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:18:13.013799 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:18:13.027478 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.012 seconds
[0m23:18:13.029974 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:18:13.031487 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:18:13.036430 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:13.038352 [debug] [MainThread]: On master: BEGIN
[0m23:18:13.039928 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:18:13.049366 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m23:18:13.051049 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:13.052695 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:18:13.064617 [debug] [MainThread]: SQL status: SELECT 1 in 0.010 seconds
[0m23:18:13.066924 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0d1bcfbb-270c-4cf3-aff3-cc6ab5e26b5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca4149e2c50>]}
[0m23:18:13.068075 [debug] [MainThread]: On master: ROLLBACK
[0m23:18:13.069029 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:13.069758 [debug] [MainThread]: On master: BEGIN
[0m23:18:13.070713 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:18:13.071946 [debug] [MainThread]: On master: COMMIT
[0m23:18:13.073379 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:13.074562 [debug] [MainThread]: On master: COMMIT
[0m23:18:13.076192 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:18:13.077406 [debug] [MainThread]: On master: Close
[0m23:18:13.083798 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:18:13.085326 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:18:13.086452 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:18:13.087418 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:18:13.103080 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:18:13.115500 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:18:13.152092 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:18:13.163997 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:13.165092 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:18:13.166210 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:18:13.174254 [debug] [Thread-1 (]: SQL status: BEGIN in 0.008 seconds
[0m23:18:13.175834 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:13.176968 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:18:13.188849 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.011 seconds
[0m23:18:13.195026 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:13.196514 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:18:13.198597 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:18:13.204226 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:13.205860 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:18:13.208308 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:18:13.219499 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:18:13.221047 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:13.222435 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:18:13.226712 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m23:18:13.232688 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:18:13.237913 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:13.239460 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:18:13.246367 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.006 seconds
[0m23:18:13.249500 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:18:13.252096 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d1bcfbb-270c-4cf3-aff3-cc6ab5e26b5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca413683a10>]}
[0m23:18:13.253972 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.16s]
[0m23:18:13.255933 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:18:13.259025 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:13.260475 [debug] [MainThread]: On master: BEGIN
[0m23:18:13.261684 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:18:13.270541 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m23:18:13.272160 [debug] [MainThread]: On master: COMMIT
[0m23:18:13.273676 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:13.275309 [debug] [MainThread]: On master: COMMIT
[0m23:18:13.276789 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:18:13.279241 [debug] [MainThread]: On master: Close
[0m23:18:13.280628 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:18:13.281678 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:18:13.282732 [info ] [MainThread]: 
[0m23:18:13.283812 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.46 seconds (0.46s).
[0m23:18:13.285279 [debug] [MainThread]: Command end result
[0m23:18:13.340119 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:18:13.347247 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:18:13.359844 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:18:13.361356 [info ] [MainThread]: 
[0m23:18:13.363145 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:18:13.364668 [info ] [MainThread]: 
[0m23:18:13.365958 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:18:13.368027 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.7112052, "process_in_blocks": "0", "process_kernel_time": 0.989917, "process_mem_max_rss": "127256", "process_out_blocks": "0", "process_user_time": 2.796717}
[0m23:18:13.369266 [debug] [MainThread]: Command `dbt run` succeeded at 23:18:13.369161 after 3.71 seconds
[0m23:18:13.370430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca41b03acd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca41b03ac50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ca41b347910>]}
[0m23:18:13.371733 [debug] [MainThread]: Flushing usage events
[0m23:18:14.143387 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:18:16.447163 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cbb81ece950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cbb81ed5ed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cbb81ecea10>]}


============================== 23:18:16.453247 | 3ec824f9-9319-43ac-abfd-0186520f4c03 ==============================
[0m23:18:16.453247 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:18:16.455892 [debug] [MainThread]: running dbt with arguments {'introspect': 'True', 'empty': 'False', 'use_experimental_parser': 'False', 'target_path': 'None', 'version_check': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None', 'indirect_selection': 'eager', 'fail_fast': 'False', 'no_print': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'log_format': 'default', 'printer_width': '80', 'partial_parse': 'True', 'use_colors': 'True', 'cache_selected_only': 'False', 'debug': 'False', 'quiet': 'False', 'log_cache_events': 'False', 'write_json': 'True', 'log_path': '/usr/app/dbt/dbt/logs'}
[0m23:18:16.602373 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3ec824f9-9319-43ac-abfd-0186520f4c03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cbb80f15250>]}
[0m23:18:16.650280 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3ec824f9-9319-43ac-abfd-0186520f4c03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cbb81322190>]}
[0m23:18:16.655113 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:18:16.799917 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:18:18.670164 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:18:18.671404 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:18:18.706940 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3ec824f9-9319-43ac-abfd-0186520f4c03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cbb80ba2550>]}
[0m23:18:18.839512 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:18:18.860081 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:18:18.902230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3ec824f9-9319-43ac-abfd-0186520f4c03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cbb7fb01a90>]}
[0m23:18:18.904410 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:18:18.906723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3ec824f9-9319-43ac-abfd-0186520f4c03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cbb7fb76210>]}
[0m23:18:18.910553 [info ] [MainThread]: 
[0m23:18:18.912124 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:18:18.914101 [info ] [MainThread]: 
[0m23:18:18.917077 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:18:18.921195 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:18:19.038799 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:18:19.040159 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:18:19.041246 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:18:19.056738 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.015 seconds
[0m23:18:19.059555 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:18:19.062889 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:18:19.070094 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:18:19.071199 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:18:19.072357 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:18:19.081888 [debug] [ThreadPool]: SQL status: BEGIN in 0.009 seconds
[0m23:18:19.083917 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:18:19.084876 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:18:19.090732 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m23:18:19.092557 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:18:19.093696 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:18:19.099506 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:19.101768 [debug] [MainThread]: On master: BEGIN
[0m23:18:19.103421 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:18:19.113332 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m23:18:19.118094 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:19.120296 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:18:19.127479 [debug] [MainThread]: SQL status: SELECT 1 in 0.005 seconds
[0m23:18:19.129875 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3ec824f9-9319-43ac-abfd-0186520f4c03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cbb7fbca210>]}
[0m23:18:19.131612 [debug] [MainThread]: On master: ROLLBACK
[0m23:18:19.135867 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:19.136926 [debug] [MainThread]: On master: BEGIN
[0m23:18:19.138309 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:18:19.139538 [debug] [MainThread]: On master: COMMIT
[0m23:18:19.140468 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:19.141408 [debug] [MainThread]: On master: COMMIT
[0m23:18:19.142779 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:18:19.144072 [debug] [MainThread]: On master: Close
[0m23:18:19.152500 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:18:19.154338 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:18:19.155875 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:18:19.157310 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:18:19.171201 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:18:19.189637 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:18:19.215887 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:18:19.231602 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:19.234847 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:18:19.236657 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:18:19.249578 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m23:18:19.251798 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:19.253925 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:18:19.261980 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.006 seconds
[0m23:18:19.270753 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:19.272203 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:18:19.274445 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:18:19.279290 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:19.280737 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:18:19.284724 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:18:19.296774 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:18:19.298934 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:19.302344 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:18:19.308424 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m23:18:19.314430 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:18:19.322704 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:19.324780 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:18:19.329453 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.003 seconds
[0m23:18:19.333316 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:18:19.338573 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3ec824f9-9319-43ac-abfd-0186520f4c03', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cbb80fa4450>]}
[0m23:18:19.340970 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.18s]
[0m23:18:19.342612 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:18:19.345826 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:19.347431 [debug] [MainThread]: On master: BEGIN
[0m23:18:19.348648 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:18:19.359776 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m23:18:19.362073 [debug] [MainThread]: On master: COMMIT
[0m23:18:19.363529 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:19.364931 [debug] [MainThread]: On master: COMMIT
[0m23:18:19.368260 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m23:18:19.369996 [debug] [MainThread]: On master: Close
[0m23:18:19.372048 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:18:19.373599 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:18:19.374908 [info ] [MainThread]: 
[0m23:18:19.376100 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.46 seconds (0.46s).
[0m23:18:19.378245 [debug] [MainThread]: Command end result
[0m23:18:19.455843 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:18:19.464649 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:18:19.478364 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:18:19.480449 [info ] [MainThread]: 
[0m23:18:19.484566 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:18:19.485668 [info ] [MainThread]: 
[0m23:18:19.487284 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:18:19.489618 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.1212366, "process_in_blocks": "0", "process_kernel_time": 0.471218, "process_mem_max_rss": "126732", "process_out_blocks": "0", "process_user_time": 2.029863}
[0m23:18:19.491000 [debug] [MainThread]: Command `dbt run` succeeded at 23:18:19.490821 after 3.12 seconds
[0m23:18:19.492196 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cbb81ed6050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cbb86783810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7cbb8679e8d0>]}
[0m23:18:19.493410 [debug] [MainThread]: Flushing usage events
[0m23:18:20.284212 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:18:22.449383 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d356e87da50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d356f6cddd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d356e87e890>]}


============================== 23:18:22.456727 | 91a90fb1-4f4e-4fa2-88e3-ec509b67a134 ==============================
[0m23:18:22.456727 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:18:22.458769 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'use_colors': 'True', 'warn_error': 'None', 'static_parser': 'True', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'log_format': 'default', 'indirect_selection': 'eager', 'fail_fast': 'False', 'quiet': 'False', 'log_cache_events': 'False', 'write_json': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'printer_width': '80', 'use_experimental_parser': 'False', 'introspect': 'True', 'empty': 'False', 'debug': 'False', 'version_check': 'True', 'no_print': 'None', 'log_path': '/usr/app/dbt/dbt/logs'}
[0m23:18:22.602525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '91a90fb1-4f4e-4fa2-88e3-ec509b67a134', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d356d9ae310>]}
[0m23:18:22.663825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '91a90fb1-4f4e-4fa2-88e3-ec509b67a134', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d35715a27d0>]}
[0m23:18:22.665925 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:18:22.793006 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:18:24.858317 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:18:24.859751 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:18:24.892394 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '91a90fb1-4f4e-4fa2-88e3-ec509b67a134', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d356cd28150>]}
[0m23:18:25.022128 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:18:25.033479 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:18:25.081802 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '91a90fb1-4f4e-4fa2-88e3-ec509b67a134', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d356c10d510>]}
[0m23:18:25.083483 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:18:25.085130 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '91a90fb1-4f4e-4fa2-88e3-ec509b67a134', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d356d9f0ed0>]}
[0m23:18:25.088691 [info ] [MainThread]: 
[0m23:18:25.090114 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:18:25.091831 [info ] [MainThread]: 
[0m23:18:25.093664 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:18:25.096226 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:18:25.210235 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:18:25.214790 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:18:25.217198 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:18:25.239692 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.022 seconds
[0m23:18:25.243005 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:18:25.249876 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:18:25.259722 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:18:25.263172 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:18:25.268283 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:18:25.282442 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m23:18:25.284971 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:18:25.287029 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:18:25.302578 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.010 seconds
[0m23:18:25.306664 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:18:25.310000 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:18:25.318712 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:25.321414 [debug] [MainThread]: On master: BEGIN
[0m23:18:25.324561 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:18:25.337350 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m23:18:25.339672 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:25.341302 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:18:25.350220 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m23:18:25.353159 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '91a90fb1-4f4e-4fa2-88e3-ec509b67a134', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d356e89f190>]}
[0m23:18:25.354609 [debug] [MainThread]: On master: ROLLBACK
[0m23:18:25.356130 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:25.357289 [debug] [MainThread]: On master: BEGIN
[0m23:18:25.358571 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:18:25.359961 [debug] [MainThread]: On master: COMMIT
[0m23:18:25.361921 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:25.363793 [debug] [MainThread]: On master: COMMIT
[0m23:18:25.365549 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:18:25.367199 [debug] [MainThread]: On master: Close
[0m23:18:25.375171 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:18:25.376912 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:18:25.378968 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:18:25.380760 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:18:25.398361 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:18:25.411009 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:18:25.439268 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:18:25.454125 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:25.455247 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:18:25.456397 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:18:25.468146 [debug] [Thread-1 (]: SQL status: BEGIN in 0.012 seconds
[0m23:18:25.470287 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:25.471903 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:18:25.483186 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.010 seconds
[0m23:18:25.490721 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:25.493005 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:18:25.498166 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:18:25.503683 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:25.511943 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:18:25.515750 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:18:25.536222 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:18:25.537901 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:25.539148 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:18:25.543679 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m23:18:25.552105 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:18:25.557008 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:25.558199 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:18:25.565030 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.006 seconds
[0m23:18:25.568249 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:18:25.571737 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '91a90fb1-4f4e-4fa2-88e3-ec509b67a134', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d356f961750>]}
[0m23:18:25.573964 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.19s]
[0m23:18:25.576392 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:18:25.581317 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:25.584045 [debug] [MainThread]: On master: BEGIN
[0m23:18:25.585930 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:18:25.599875 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m23:18:25.601916 [debug] [MainThread]: On master: COMMIT
[0m23:18:25.603934 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:25.605569 [debug] [MainThread]: On master: COMMIT
[0m23:18:25.607162 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:18:25.608814 [debug] [MainThread]: On master: Close
[0m23:18:25.611326 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:18:25.613040 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:18:25.614198 [info ] [MainThread]: 
[0m23:18:25.615891 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.52 seconds (0.52s).
[0m23:18:25.618704 [debug] [MainThread]: Command end result
[0m23:18:25.700016 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:18:25.709881 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:18:25.729169 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:18:25.731099 [info ] [MainThread]: 
[0m23:18:25.733411 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:18:25.735291 [info ] [MainThread]: 
[0m23:18:25.737539 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:18:25.747195 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.3622887, "process_in_blocks": "0", "process_kernel_time": 0.502233, "process_mem_max_rss": "127932", "process_out_blocks": "0", "process_user_time": 1.903627}
[0m23:18:25.749860 [debug] [MainThread]: Command `dbt run` succeeded at 23:18:25.749555 after 3.36 seconds
[0m23:18:25.752123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d3573143810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d3573092e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d3573092e90>]}
[0m23:18:25.754163 [debug] [MainThread]: Flushing usage events
[0m23:18:26.346496 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:18:28.825422 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e4b26f48ad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e4b26faa010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e4b272d8ad0>]}


============================== 23:18:28.830268 | 7f2d1b60-292a-4899-a1ef-8cb94b7669c6 ==============================
[0m23:18:28.830268 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:18:28.831727 [debug] [MainThread]: running dbt with arguments {'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/app/dbt/dbt/logs', 'indirect_selection': 'eager', 'log_format': 'default', 'static_parser': 'True', 'use_experimental_parser': 'False', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'printer_width': '80', 'log_cache_events': 'False', 'write_json': 'True', 'cache_selected_only': 'False', 'version_check': 'True', 'partial_parse': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'empty': 'False', 'no_print': 'None', 'target_path': 'None', 'quiet': 'False', 'warn_error': 'None', 'introspect': 'True', 'use_colors': 'True', 'fail_fast': 'False', 'invocation_command': 'dbt run'}
[0m23:18:28.964252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7f2d1b60-292a-4899-a1ef-8cb94b7669c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e4b2990b9d0>]}
[0m23:18:29.031264 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7f2d1b60-292a-4899-a1ef-8cb94b7669c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e4b29cae110>]}
[0m23:18:29.033803 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:18:29.166689 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:18:31.188215 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:18:31.191780 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:18:31.226656 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7f2d1b60-292a-4899-a1ef-8cb94b7669c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e4b25739390>]}
[0m23:18:31.357721 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:18:31.371142 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:18:31.411468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7f2d1b60-292a-4899-a1ef-8cb94b7669c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e4b24bc7d10>]}
[0m23:18:31.413120 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:18:31.414452 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7f2d1b60-292a-4899-a1ef-8cb94b7669c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e4b24bc2790>]}
[0m23:18:31.417615 [info ] [MainThread]: 
[0m23:18:31.418982 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:18:31.420270 [info ] [MainThread]: 
[0m23:18:31.421944 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:18:31.428787 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:18:31.563043 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:18:31.564570 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:18:31.565607 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:18:31.580468 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.015 seconds
[0m23:18:31.582663 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:18:31.585125 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:18:31.593883 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:18:31.594996 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:18:31.595916 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:18:31.604940 [debug] [ThreadPool]: SQL status: BEGIN in 0.009 seconds
[0m23:18:31.607903 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:18:31.609405 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:18:31.616876 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m23:18:31.618793 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:18:31.619917 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:18:31.626647 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:31.628102 [debug] [MainThread]: On master: BEGIN
[0m23:18:31.629214 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:18:31.637596 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m23:18:31.640291 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:31.641597 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:18:31.648714 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m23:18:31.650516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7f2d1b60-292a-4899-a1ef-8cb94b7669c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e4b26f4a950>]}
[0m23:18:31.651602 [debug] [MainThread]: On master: ROLLBACK
[0m23:18:31.652595 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:31.653560 [debug] [MainThread]: On master: BEGIN
[0m23:18:31.654575 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:18:31.658043 [debug] [MainThread]: On master: COMMIT
[0m23:18:31.670676 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:31.675428 [debug] [MainThread]: On master: COMMIT
[0m23:18:31.677973 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:18:31.679364 [debug] [MainThread]: On master: Close
[0m23:18:31.685631 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:18:31.686864 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:18:31.699935 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:18:31.702272 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:18:31.719944 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:18:31.743951 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:18:31.770797 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:18:31.785226 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:31.786240 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:18:31.787083 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:18:31.798254 [debug] [Thread-1 (]: SQL status: BEGIN in 0.011 seconds
[0m23:18:31.809534 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:31.812138 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:18:31.827705 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.013 seconds
[0m23:18:31.834773 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:31.835910 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:18:31.839111 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:18:31.846578 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:31.848220 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:18:31.851134 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:18:31.866326 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:18:31.867830 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:31.869137 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:18:31.874618 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m23:18:31.882525 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:18:31.887403 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:18:31.889018 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:18:31.895228 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m23:18:31.898302 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:18:31.901012 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7f2d1b60-292a-4899-a1ef-8cb94b7669c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e4b23da4b90>]}
[0m23:18:31.903022 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.20s]
[0m23:18:31.906900 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:18:31.910179 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:31.911192 [debug] [MainThread]: On master: BEGIN
[0m23:18:31.912576 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:18:31.921457 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m23:18:31.924170 [debug] [MainThread]: On master: COMMIT
[0m23:18:31.928748 [debug] [MainThread]: Using postgres connection "master"
[0m23:18:31.929703 [debug] [MainThread]: On master: COMMIT
[0m23:18:31.931007 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:18:31.932018 [debug] [MainThread]: On master: Close
[0m23:18:31.933299 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:18:31.934717 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:18:31.935838 [info ] [MainThread]: 
[0m23:18:31.936993 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.51 seconds (0.51s).
[0m23:18:31.939543 [debug] [MainThread]: Command end result
[0m23:18:32.027394 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:18:32.036852 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:18:32.052547 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:18:32.053884 [info ] [MainThread]: 
[0m23:18:32.056909 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:18:32.059246 [info ] [MainThread]: 
[0m23:18:32.061300 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:18:32.064487 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.3009844, "process_in_blocks": "0", "process_kernel_time": 0.452778, "process_mem_max_rss": "127988", "process_out_blocks": "0", "process_user_time": 1.887926}
[0m23:18:32.066213 [debug] [MainThread]: Command `dbt run` succeeded at 23:18:32.066062 after 3.30 seconds
[0m23:18:32.067436 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e4b2b82f890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e4b2b84a950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e4b2b84b610>]}
[0m23:18:32.068563 [debug] [MainThread]: Flushing usage events
[0m23:18:32.855662 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:18:35.698896 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f59d4db7710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f59d52175d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f59d4db42d0>]}


============================== 23:18:35.707236 | efd2f5df-dd62-41e5-9341-aaf0fe49dbe7 ==============================
[0m23:18:35.707236 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:18:35.708930 [debug] [MainThread]: running dbt with arguments {'quiet': 'False', 'indirect_selection': 'eager', 'profiles_dir': '/usr/app/dbt/dbt', 'printer_width': '80', 'debug': 'False', 'partial_parse': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None', 'log_cache_events': 'False', 'version_check': 'True', 'fail_fast': 'False', 'target_path': 'None', 'use_colors': 'True', 'introspect': 'True', 'cache_selected_only': 'False', 'log_format': 'default', 'empty': 'False', 'write_json': 'True', 'no_print': 'None', 'use_experimental_parser': 'False', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m23:18:35.860296 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'efd2f5df-dd62-41e5-9341-aaf0fe49dbe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f59d7c425d0>]}
[0m23:18:35.913102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'efd2f5df-dd62-41e5-9341-aaf0fe49dbe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f59d41c6610>]}
[0m23:18:35.915670 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:18:36.069749 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:18:37.798517 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:18:37.799796 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:18:37.844283 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'efd2f5df-dd62-41e5-9341-aaf0fe49dbe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f59d3900610>]}
[0m23:18:37.940556 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:18:37.948258 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:18:38.002918 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'efd2f5df-dd62-41e5-9341-aaf0fe49dbe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f59d2d17d90>]}
[0m23:18:38.004619 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:18:38.006025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'efd2f5df-dd62-41e5-9341-aaf0fe49dbe7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f59d35f9190>]}
[0m23:18:38.008253 [info ] [MainThread]: 
[0m23:18:38.009303 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:18:38.010811 [info ] [MainThread]: 
[0m23:18:38.013360 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:18:38.015869 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:18:38.128494 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:18:38.130649 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:18:38.131791 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:21:09.621865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7854f85c13d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7854f8928e90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7854f85c25d0>]}


============================== 23:21:09.628631 | 61c1cc83-3843-4971-bc86-d713947dced0 ==============================
[0m23:21:09.628631 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:21:09.629888 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'target_path': 'None', 'log_cache_events': 'False', 'static_parser': 'True', 'quiet': 'False', 'log_format': 'default', 'no_print': 'None', 'introspect': 'True', 'invocation_command': 'dbt run', 'warn_error': 'None', 'use_experimental_parser': 'False', 'printer_width': '80', 'write_json': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'partial_parse': 'True', 'empty': 'False', 'indirect_selection': 'eager', 'fail_fast': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'send_anonymous_usage_stats': 'True', 'cache_selected_only': 'False', 'use_colors': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'version_check': 'True'}
[0m23:21:09.795820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '61c1cc83-3843-4971-bc86-d713947dced0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7854f962edd0>]}
[0m23:21:09.859590 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '61c1cc83-3843-4971-bc86-d713947dced0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7854f7d67b90>]}
[0m23:21:09.862880 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:21:10.065775 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:21:11.974777 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:21:11.976864 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:21:12.019478 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '61c1cc83-3843-4971-bc86-d713947dced0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7854f715b3d0>]}
[0m23:21:12.324788 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:12.357200 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:12.449830 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '61c1cc83-3843-4971-bc86-d713947dced0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7854f658b290>]}
[0m23:21:12.452160 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:21:12.454441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '61c1cc83-3843-4971-bc86-d713947dced0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7854f6586850>]}
[0m23:21:12.459698 [info ] [MainThread]: 
[0m23:21:12.462430 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:21:12.470886 [info ] [MainThread]: 
[0m23:21:12.474954 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:21:12.484142 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:21:12.596269 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:21:12.598081 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:21:12.603728 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:21:12.618228 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.014 seconds
[0m23:21:12.622148 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:21:12.630552 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:21:12.644548 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:12.648006 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:21:12.652589 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:21:12.671400 [debug] [ThreadPool]: SQL status: BEGIN in 0.019 seconds
[0m23:21:12.674812 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:12.683399 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:21:12.692711 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.007 seconds
[0m23:21:12.696783 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:21:12.698667 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:21:12.707098 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:12.709246 [debug] [MainThread]: On master: BEGIN
[0m23:21:12.711545 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:21:12.723224 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m23:21:12.727169 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:12.728613 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:21:12.742804 [debug] [MainThread]: SQL status: SELECT 1 in 0.010 seconds
[0m23:21:12.746930 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '61c1cc83-3843-4971-bc86-d713947dced0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7854f659ad10>]}
[0m23:21:12.750262 [debug] [MainThread]: On master: ROLLBACK
[0m23:21:12.756619 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:12.757794 [debug] [MainThread]: On master: BEGIN
[0m23:21:12.762719 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m23:21:12.764173 [debug] [MainThread]: On master: COMMIT
[0m23:21:12.765677 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:12.770160 [debug] [MainThread]: On master: COMMIT
[0m23:21:12.772863 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:12.776113 [debug] [MainThread]: On master: Close
[0m23:21:12.785924 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:21:12.790731 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:21:12.792146 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:21:12.793225 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:21:12.808780 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:12.821051 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:21:12.848240 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:12.864126 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:12.865320 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:21:12.866485 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:21:12.876782 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m23:21:12.879112 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:12.880638 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:21:12.892457 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.010 seconds
[0m23:21:12.898826 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:12.900192 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:21:12.903379 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:21:12.911436 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:12.913592 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:21:12.916147 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:21:12.933187 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:12.934919 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:12.936604 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:12.940192 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m23:21:12.946277 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:21:12.956789 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:12.958853 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:21:12.963965 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m23:21:12.966974 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:21:12.969555 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61c1cc83-3843-4971-bc86-d713947dced0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7854f53ae0d0>]}
[0m23:21:12.971039 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.18s]
[0m23:21:12.972498 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:21:12.974925 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:12.975966 [debug] [MainThread]: On master: BEGIN
[0m23:21:12.977090 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:21:12.984635 [debug] [MainThread]: SQL status: BEGIN in 0.007 seconds
[0m23:21:12.985920 [debug] [MainThread]: On master: COMMIT
[0m23:21:12.987167 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:12.987957 [debug] [MainThread]: On master: COMMIT
[0m23:21:12.989019 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:12.990449 [debug] [MainThread]: On master: Close
[0m23:21:12.991785 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:21:12.992911 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:21:12.994246 [info ] [MainThread]: 
[0m23:21:12.995609 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.52 seconds (0.52s).
[0m23:21:12.996892 [debug] [MainThread]: Command end result
[0m23:21:13.061819 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:13.072582 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:13.086780 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:21:13.089458 [info ] [MainThread]: 
[0m23:21:13.091096 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:21:13.092413 [info ] [MainThread]: 
[0m23:21:13.093496 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:21:13.094969 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.5350964, "process_in_blocks": "0", "process_kernel_time": 0.965089, "process_mem_max_rss": "127500", "process_out_blocks": "0", "process_user_time": 2.752602}
[0m23:21:13.097317 [debug] [MainThread]: Command `dbt run` succeeded at 23:21:13.097216 after 3.54 seconds
[0m23:21:13.098268 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7854fd11f910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7854fced6b90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7854fced6a50>]}
[0m23:21:13.099133 [debug] [MainThread]: Flushing usage events
[0m23:21:13.883248 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:21:16.074598 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c8f6b30ac90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c8f6b2bbfd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c8f6b3161d0>]}


============================== 23:21:16.080742 | 8b3a969e-471b-41db-9db3-761df5633e7a ==============================
[0m23:21:16.080742 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:21:16.082600 [debug] [MainThread]: running dbt with arguments {'write_json': 'True', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'debug': 'False', 'target_path': 'None', 'warn_error': 'None', 'printer_width': '80', 'indirect_selection': 'eager', 'no_print': 'None', 'version_check': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'cache_selected_only': 'False', 'partial_parse': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_format': 'default', 'introspect': 'True', 'use_experimental_parser': 'False', 'use_colors': 'True', 'quiet': 'False', 'empty': 'False', 'log_cache_events': 'False', 'fail_fast': 'False', 'invocation_command': 'dbt run'}
[0m23:21:16.228770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8b3a969e-471b-41db-9db3-761df5633e7a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c8f6b34a610>]}
[0m23:21:16.275281 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8b3a969e-471b-41db-9db3-761df5633e7a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c8f6e020790>]}
[0m23:21:16.277683 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:21:16.421825 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:21:18.761436 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:21:18.763077 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:21:18.802342 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8b3a969e-471b-41db-9db3-761df5633e7a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c8f6a7f1210>]}
[0m23:21:18.917748 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:18.927286 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:18.961576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8b3a969e-471b-41db-9db3-761df5633e7a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c8f69b2f590>]}
[0m23:21:18.964743 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:21:18.966926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8b3a969e-471b-41db-9db3-761df5633e7a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c8f68fa2250>]}
[0m23:21:18.970607 [info ] [MainThread]: 
[0m23:21:18.972008 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:21:18.973735 [info ] [MainThread]: 
[0m23:21:18.975688 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:21:18.979908 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:21:19.093535 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:21:19.095902 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:21:19.097754 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:21:19.114073 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.016 seconds
[0m23:21:19.118260 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:21:19.122168 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:21:19.129766 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:19.131489 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:21:19.133146 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:21:19.146370 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m23:21:19.148457 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:19.150043 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:21:19.158397 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.007 seconds
[0m23:21:19.162126 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:21:19.164152 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:21:19.171381 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:19.172992 [debug] [MainThread]: On master: BEGIN
[0m23:21:19.174374 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:21:19.187454 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m23:21:19.189433 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:19.191533 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:21:19.200985 [debug] [MainThread]: SQL status: SELECT 1 in 0.008 seconds
[0m23:21:19.204382 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8b3a969e-471b-41db-9db3-761df5633e7a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c8f68b4a750>]}
[0m23:21:19.206428 [debug] [MainThread]: On master: ROLLBACK
[0m23:21:19.208502 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:19.209895 [debug] [MainThread]: On master: BEGIN
[0m23:21:19.211832 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:21:19.213908 [debug] [MainThread]: On master: COMMIT
[0m23:21:19.215338 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:19.216559 [debug] [MainThread]: On master: COMMIT
[0m23:21:19.217856 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:19.219028 [debug] [MainThread]: On master: Close
[0m23:21:19.227841 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:21:19.230516 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:21:19.232491 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:21:19.234355 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:21:19.255235 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:19.271637 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:21:19.303590 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:19.317673 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:19.319173 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:21:19.320737 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:21:19.334474 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m23:21:19.336252 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:19.337950 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:21:19.346779 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.007 seconds
[0m23:21:19.354533 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:19.355870 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:21:19.358449 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:21:19.366232 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:19.367931 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:21:19.370573 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:21:19.384156 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:19.385621 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:19.386841 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:19.390798 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m23:21:19.398187 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:21:19.404951 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:19.406550 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:21:19.412822 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m23:21:19.417563 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:21:19.421183 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b3a969e-471b-41db-9db3-761df5633e7a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c8f63fc9bd0>]}
[0m23:21:19.423039 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.19s]
[0m23:21:19.425235 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:21:19.428687 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:19.430579 [debug] [MainThread]: On master: BEGIN
[0m23:21:19.431826 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:21:19.442955 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m23:21:19.444819 [debug] [MainThread]: On master: COMMIT
[0m23:21:19.446261 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:19.448089 [debug] [MainThread]: On master: COMMIT
[0m23:21:19.450057 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:19.451424 [debug] [MainThread]: On master: Close
[0m23:21:19.452936 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:21:19.454290 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:21:19.455884 [info ] [MainThread]: 
[0m23:21:19.459047 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.48 seconds (0.48s).
[0m23:21:19.464423 [debug] [MainThread]: Command end result
[0m23:21:19.541403 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:19.551617 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:19.568549 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:21:19.570017 [info ] [MainThread]: 
[0m23:21:19.572403 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:21:19.574304 [info ] [MainThread]: 
[0m23:21:19.576845 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:21:19.580045 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.5837197, "process_in_blocks": "0", "process_kernel_time": 0.416054, "process_mem_max_rss": "127896", "process_out_blocks": "0", "process_user_time": 1.978298}
[0m23:21:19.582384 [debug] [MainThread]: Command `dbt run` succeeded at 23:21:19.582205 after 3.59 seconds
[0m23:21:19.584049 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c8f6b63cd50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c8f6c179950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c8f6fe1b910>]}
[0m23:21:19.585752 [debug] [MainThread]: Flushing usage events
[0m23:21:20.405515 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:21:22.652152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b502d105ed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b502d4e47d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b502d1061d0>]}


============================== 23:21:22.659635 | c9bc1669-5e82-46e9-a484-9039dbee3f99 ==============================
[0m23:21:22.659635 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:21:22.661411 [debug] [MainThread]: running dbt with arguments {'introspect': 'True', 'fail_fast': 'False', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'use_experimental_parser': 'False', 'quiet': 'False', 'partial_parse': 'True', 'log_format': 'default', 'cache_selected_only': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_colors': 'True', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'indirect_selection': 'eager', 'empty': 'False', 'static_parser': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'no_print': 'None', 'write_json': 'True', 'printer_width': '80', 'log_cache_events': 'False', 'target_path': 'None', 'invocation_command': 'dbt run'}
[0m23:21:22.810842 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c9bc1669-5e82-46e9-a484-9039dbee3f99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b502d21b790>]}
[0m23:21:22.864541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c9bc1669-5e82-46e9-a484-9039dbee3f99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b502fe0ac50>]}
[0m23:21:22.867751 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:21:22.995141 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:21:24.871015 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:21:24.873001 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:21:24.907608 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c9bc1669-5e82-46e9-a484-9039dbee3f99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b502b5d5950>]}
[0m23:21:25.015690 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:25.023084 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:25.057698 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c9bc1669-5e82-46e9-a484-9039dbee3f99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b502bde93d0>]}
[0m23:21:25.059484 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:21:25.061473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c9bc1669-5e82-46e9-a484-9039dbee3f99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b502ad764d0>]}
[0m23:21:25.065343 [info ] [MainThread]: 
[0m23:21:25.066877 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:21:25.068325 [info ] [MainThread]: 
[0m23:21:25.069956 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:21:25.073089 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:21:25.196005 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:21:25.198062 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:21:25.199158 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:21:25.215723 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.016 seconds
[0m23:21:25.218092 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:21:25.220842 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:21:25.229247 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:25.237468 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:21:25.244057 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:21:25.259220 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m23:21:25.261849 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:25.263553 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:21:25.275187 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.010 seconds
[0m23:21:25.278445 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:21:25.280199 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:21:25.287605 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:25.288887 [debug] [MainThread]: On master: BEGIN
[0m23:21:25.290059 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:21:25.302619 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m23:21:25.304267 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:25.305847 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:21:25.316008 [debug] [MainThread]: SQL status: SELECT 1 in 0.009 seconds
[0m23:21:25.319216 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c9bc1669-5e82-46e9-a484-9039dbee3f99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b502bdedbd0>]}
[0m23:21:25.320895 [debug] [MainThread]: On master: ROLLBACK
[0m23:21:25.322604 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:25.324064 [debug] [MainThread]: On master: BEGIN
[0m23:21:25.326931 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m23:21:25.328333 [debug] [MainThread]: On master: COMMIT
[0m23:21:25.329433 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:25.330508 [debug] [MainThread]: On master: COMMIT
[0m23:21:25.332009 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:25.333071 [debug] [MainThread]: On master: Close
[0m23:21:25.341017 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:21:25.342990 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:21:25.344508 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:21:25.345707 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:21:25.361817 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:25.374271 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:21:25.401259 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:25.413528 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:25.414765 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:21:25.415746 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:21:25.427321 [debug] [Thread-1 (]: SQL status: BEGIN in 0.012 seconds
[0m23:21:25.429378 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:25.432610 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:21:25.442005 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.008 seconds
[0m23:21:25.450022 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:25.451076 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:21:25.452915 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:21:25.457861 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:25.459321 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:21:25.461494 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:21:25.471932 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:25.474327 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:25.476064 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:25.480937 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m23:21:25.485957 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:21:25.490316 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:25.497066 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:21:25.506829 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m23:21:25.513295 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:21:25.517076 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c9bc1669-5e82-46e9-a484-9039dbee3f99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b502d400950>]}
[0m23:21:25.519530 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.17s]
[0m23:21:25.522392 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:21:25.527895 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:25.530472 [debug] [MainThread]: On master: BEGIN
[0m23:21:25.532848 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:21:25.548886 [debug] [MainThread]: SQL status: BEGIN in 0.016 seconds
[0m23:21:25.551554 [debug] [MainThread]: On master: COMMIT
[0m23:21:25.553646 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:25.555611 [debug] [MainThread]: On master: COMMIT
[0m23:21:25.557946 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:25.561061 [debug] [MainThread]: On master: Close
[0m23:21:25.565167 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:21:25.567391 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:21:25.569636 [info ] [MainThread]: 
[0m23:21:25.572288 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.50 seconds (0.50s).
[0m23:21:25.574770 [debug] [MainThread]: Command end result
[0m23:21:25.660112 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:25.669376 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:25.683994 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:21:25.685265 [info ] [MainThread]: 
[0m23:21:25.687288 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:21:25.689104 [info ] [MainThread]: 
[0m23:21:25.690930 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:21:25.693279 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.123558, "process_in_blocks": "0", "process_kernel_time": 0.487546, "process_mem_max_rss": "127812", "process_out_blocks": "0", "process_user_time": 1.783608}
[0m23:21:25.695408 [debug] [MainThread]: Command `dbt run` succeeded at 23:21:25.695112 after 3.13 seconds
[0m23:21:25.696923 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b502d094390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b502d096610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b50319af810>]}
[0m23:21:25.698266 [debug] [MainThread]: Flushing usage events
[0m23:21:26.437636 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:21:28.873947 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788e6c7f25d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788e6c7f2810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788e6c7f1e50>]}


============================== 23:21:28.884745 | 23b7b3ff-2735-4842-9b7c-b6d4a81a9a00 ==============================
[0m23:21:28.884745 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:21:28.886573 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'log_format': 'default', 'printer_width': '80', 'invocation_command': 'dbt run', 'static_parser': 'True', 'introspect': 'True', 'quiet': 'False', 'indirect_selection': 'eager', 'profiles_dir': '/usr/app/dbt/dbt', 'fail_fast': 'False', 'log_cache_events': 'False', 'write_json': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_colors': 'True', 'partial_parse': 'True', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'cache_selected_only': 'False', 'no_print': 'None', 'empty': 'False'}
[0m23:21:29.033146 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '23b7b3ff-2735-4842-9b7c-b6d4a81a9a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788e6c969910>]}
[0m23:21:29.082402 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '23b7b3ff-2735-4842-9b7c-b6d4a81a9a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788e6f508310>]}
[0m23:21:29.084697 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:21:29.192250 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:21:30.679897 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:21:30.680807 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:21:30.712230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '23b7b3ff-2735-4842-9b7c-b6d4a81a9a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788e6b307950>]}
[0m23:21:30.803311 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:30.810177 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:30.852675 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '23b7b3ff-2735-4842-9b7c-b6d4a81a9a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788e6bb75410>]}
[0m23:21:30.855405 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:21:30.856840 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '23b7b3ff-2735-4842-9b7c-b6d4a81a9a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788e6a7a6590>]}
[0m23:21:30.859152 [info ] [MainThread]: 
[0m23:21:30.860155 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:21:30.861228 [info ] [MainThread]: 
[0m23:21:30.862360 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:21:30.864093 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:21:30.961711 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:21:30.969620 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:21:30.972239 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:21:31.002940 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.030 seconds
[0m23:21:31.008327 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:21:31.012935 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:21:31.023002 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:31.025118 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:21:31.027185 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:21:31.041926 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m23:21:31.045005 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:31.046576 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:21:31.056034 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.008 seconds
[0m23:21:31.060009 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:21:31.061903 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:21:31.071170 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:31.073273 [debug] [MainThread]: On master: BEGIN
[0m23:21:31.075730 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:21:31.087889 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m23:21:31.089805 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:31.091748 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:21:31.099716 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m23:21:31.102765 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '23b7b3ff-2735-4842-9b7c-b6d4a81a9a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788e6bb46310>]}
[0m23:21:31.104581 [debug] [MainThread]: On master: ROLLBACK
[0m23:21:31.106463 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:31.108365 [debug] [MainThread]: On master: BEGIN
[0m23:21:31.109928 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:21:31.111086 [debug] [MainThread]: On master: COMMIT
[0m23:21:31.112149 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:31.113305 [debug] [MainThread]: On master: COMMIT
[0m23:21:31.114824 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:31.116059 [debug] [MainThread]: On master: Close
[0m23:21:31.139406 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:21:31.156535 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:21:31.172211 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:21:31.174616 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:21:31.203605 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:31.230508 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:21:31.271664 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:31.294934 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:31.297392 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:21:31.298736 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:21:31.311765 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m23:21:31.313585 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:31.315129 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:21:31.328226 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.012 seconds
[0m23:21:31.336709 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:31.338695 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:21:31.341400 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:21:31.348971 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:31.350366 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:21:31.353012 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:21:31.372206 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:31.373891 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:31.377715 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:31.396845 [debug] [Thread-1 (]: SQL status: COMMIT in 0.016 seconds
[0m23:21:31.404027 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:21:31.413412 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:31.418001 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:21:31.436893 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.015 seconds
[0m23:21:31.442278 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:21:31.445790 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '23b7b3ff-2735-4842-9b7c-b6d4a81a9a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788e6950cb10>]}
[0m23:21:31.447868 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.27s]
[0m23:21:31.449912 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:21:31.453706 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:31.454944 [debug] [MainThread]: On master: BEGIN
[0m23:21:31.455968 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:21:31.466230 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m23:21:31.492315 [debug] [MainThread]: On master: COMMIT
[0m23:21:31.494971 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:31.496561 [debug] [MainThread]: On master: COMMIT
[0m23:21:31.498824 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:31.500484 [debug] [MainThread]: On master: Close
[0m23:21:31.502525 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:21:31.506355 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:21:31.507891 [info ] [MainThread]: 
[0m23:21:31.509543 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.65 seconds (0.65s).
[0m23:21:31.511521 [debug] [MainThread]: Command end result
[0m23:21:31.574488 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:31.581842 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:31.592014 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:21:31.593254 [info ] [MainThread]: 
[0m23:21:31.594581 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:21:31.595806 [info ] [MainThread]: 
[0m23:21:31.596918 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:21:31.598567 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.7895212, "process_in_blocks": "0", "process_kernel_time": 0.427992, "process_mem_max_rss": "127204", "process_out_blocks": "0", "process_user_time": 1.860121}
[0m23:21:31.599599 [debug] [MainThread]: Command `dbt run` succeeded at 23:21:31.599491 after 2.79 seconds
[0m23:21:31.600539 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788e71303910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788e710bacd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x788e710bab90>]}
[0m23:21:31.601575 [debug] [MainThread]: Flushing usage events
[0m23:21:32.185311 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:21:35.286081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c82d8e47310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c82d8e2f790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c82d8e46f90>]}


============================== 23:21:35.298150 | 21a582a0-7583-49d8-8d33-3b33bc65ce45 ==============================
[0m23:21:35.298150 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:21:35.300381 [debug] [MainThread]: running dbt with arguments {'warn_error': 'None', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'use_colors': 'True', 'log_cache_events': 'False', 'version_check': 'True', 'write_json': 'True', 'debug': 'False', 'log_format': 'default', 'indirect_selection': 'eager', 'send_anonymous_usage_stats': 'True', 'no_print': 'None', 'empty': 'False', 'fail_fast': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'profiles_dir': '/usr/app/dbt/dbt', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'quiet': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'printer_width': '80', 'cache_selected_only': 'False', 'use_experimental_parser': 'False'}
[0m23:21:35.508370 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '21a582a0-7583-49d8-8d33-3b33bc65ce45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c82d6162250>]}
[0m23:21:35.565040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '21a582a0-7583-49d8-8d33-3b33bc65ce45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c82d8e568d0>]}
[0m23:21:35.569009 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:21:35.743762 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:21:37.544838 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:21:37.546029 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:21:37.580458 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '21a582a0-7583-49d8-8d33-3b33bc65ce45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c82d552f950>]}
[0m23:21:37.692365 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:37.699751 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:37.732389 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '21a582a0-7583-49d8-8d33-3b33bc65ce45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c82d3d22790>]}
[0m23:21:37.733569 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:21:37.735226 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '21a582a0-7583-49d8-8d33-3b33bc65ce45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c82d55d8d50>]}
[0m23:21:37.737768 [info ] [MainThread]: 
[0m23:21:37.738802 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:21:37.739699 [info ] [MainThread]: 
[0m23:21:37.740832 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:21:37.742473 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:21:37.869711 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:21:37.872081 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:21:37.874435 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:21:37.893673 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m23:21:37.915365 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:21:37.924380 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:21:37.938460 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:37.941146 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:21:37.944010 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:21:37.959682 [debug] [ThreadPool]: SQL status: BEGIN in 0.016 seconds
[0m23:21:37.963180 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:37.965751 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:21:37.978728 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.010 seconds
[0m23:21:37.983365 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:21:37.985618 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:21:37.994392 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:37.997012 [debug] [MainThread]: On master: BEGIN
[0m23:21:37.999409 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:21:38.013032 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m23:21:38.014684 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:38.016271 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:21:38.026534 [debug] [MainThread]: SQL status: SELECT 1 in 0.008 seconds
[0m23:21:38.030077 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '21a582a0-7583-49d8-8d33-3b33bc65ce45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c82d3db6650>]}
[0m23:21:38.031863 [debug] [MainThread]: On master: ROLLBACK
[0m23:21:38.033591 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:38.034893 [debug] [MainThread]: On master: BEGIN
[0m23:21:38.036830 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m23:21:38.038362 [debug] [MainThread]: On master: COMMIT
[0m23:21:38.039443 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:38.040486 [debug] [MainThread]: On master: COMMIT
[0m23:21:38.041762 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:38.042809 [debug] [MainThread]: On master: Close
[0m23:21:38.051037 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:21:38.052610 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:21:38.054433 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:21:38.055466 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:21:38.077030 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:38.109611 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:21:38.162079 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:38.183805 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:38.185140 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:21:38.186391 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:21:38.199217 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m23:21:38.200712 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:38.202164 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:21:38.215267 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.012 seconds
[0m23:21:38.225079 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:38.226456 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:21:38.231254 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:21:38.237050 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:38.238514 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:21:38.241717 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:21:38.262451 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:38.264666 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:38.266118 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:38.279620 [debug] [Thread-1 (]: SQL status: COMMIT in 0.012 seconds
[0m23:21:38.288096 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:21:38.297098 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:38.298662 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:21:38.307062 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.007 seconds
[0m23:21:38.320223 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:21:38.323202 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a582a0-7583-49d8-8d33-3b33bc65ce45', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c82d552f910>]}
[0m23:21:38.325285 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.27s]
[0m23:21:38.327527 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:21:38.333654 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:38.334766 [debug] [MainThread]: On master: BEGIN
[0m23:21:38.335788 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:21:38.349672 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m23:21:38.355935 [debug] [MainThread]: On master: COMMIT
[0m23:21:38.360033 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:38.365280 [debug] [MainThread]: On master: COMMIT
[0m23:21:38.371087 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:38.372735 [debug] [MainThread]: On master: Close
[0m23:21:38.374642 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:21:38.376035 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:21:38.377341 [info ] [MainThread]: 
[0m23:21:38.379139 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.64 seconds (0.64s).
[0m23:21:38.381266 [debug] [MainThread]: Command end result
[0m23:21:38.515857 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:38.523857 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:38.535293 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:21:38.536206 [info ] [MainThread]: 
[0m23:21:38.537487 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:21:38.538545 [info ] [MainThread]: 
[0m23:21:38.539596 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:21:38.541173 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.3495486, "process_in_blocks": "0", "process_kernel_time": 0.527825, "process_mem_max_rss": "127564", "process_out_blocks": "0", "process_user_time": 2.053116}
[0m23:21:38.542257 [debug] [MainThread]: Command `dbt run` succeeded at 23:21:38.542072 after 3.35 seconds
[0m23:21:38.543288 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c82d6454c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c82da936d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c82da9e38d0>]}
[0m23:21:38.545006 [debug] [MainThread]: Flushing usage events
[0m23:21:39.584887 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:21:43.545700 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d797cd50090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d797d0789d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d797ccffb10>]}


============================== 23:21:43.552315 | 93659782-90cc-439b-833a-32d647c8196e ==============================
[0m23:21:43.552315 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:21:43.553683 [debug] [MainThread]: running dbt with arguments {'profiles_dir': '/usr/app/dbt/dbt', 'warn_error': 'None', 'cache_selected_only': 'False', 'debug': 'False', 'indirect_selection': 'eager', 'introspect': 'True', 'version_check': 'True', 'log_cache_events': 'False', 'static_parser': 'True', 'invocation_command': 'dbt run', 'write_json': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'send_anonymous_usage_stats': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'partial_parse': 'True', 'log_format': 'default', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'fail_fast': 'False', 'quiet': 'False', 'printer_width': '80', 'target_path': 'None'}
[0m23:21:43.706194 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '93659782-90cc-439b-833a-32d647c8196e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d797cd861d0>]}
[0m23:21:43.760881 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '93659782-90cc-439b-833a-32d647c8196e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d797fa7a8d0>]}
[0m23:21:43.765314 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:21:43.921308 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:21:46.280615 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:21:46.282246 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:21:46.320237 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '93659782-90cc-439b-833a-32d647c8196e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d797c15a990>]}
[0m23:21:46.413113 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:46.422344 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:46.469587 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '93659782-90cc-439b-833a-32d647c8196e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d797b540890>]}
[0m23:21:46.471865 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:21:46.474210 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '93659782-90cc-439b-833a-32d647c8196e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d797a990850>]}
[0m23:21:46.478203 [info ] [MainThread]: 
[0m23:21:46.481777 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:21:46.483749 [info ] [MainThread]: 
[0m23:21:46.486725 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:21:46.490512 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:21:46.655766 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:21:46.658927 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:21:46.661421 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:21:46.680419 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m23:21:46.682965 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:21:46.685708 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:21:46.692867 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:46.693989 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:21:46.694974 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:21:46.703270 [debug] [ThreadPool]: SQL status: BEGIN in 0.008 seconds
[0m23:21:46.704441 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:46.705575 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:21:46.711491 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m23:21:46.713363 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:21:46.714460 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:21:46.721447 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:46.722538 [debug] [MainThread]: On master: BEGIN
[0m23:21:46.723377 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:21:46.732179 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m23:21:46.733228 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:46.734194 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:21:46.742075 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m23:21:46.746144 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '93659782-90cc-439b-833a-32d647c8196e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d7979cded50>]}
[0m23:21:46.747017 [debug] [MainThread]: On master: ROLLBACK
[0m23:21:46.747885 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:46.748573 [debug] [MainThread]: On master: BEGIN
[0m23:21:46.749656 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:21:46.750622 [debug] [MainThread]: On master: COMMIT
[0m23:21:46.751250 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:46.751799 [debug] [MainThread]: On master: COMMIT
[0m23:21:46.752534 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:46.753309 [debug] [MainThread]: On master: Close
[0m23:21:46.763050 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:21:46.765903 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:21:46.770501 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:21:46.772361 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:21:46.787772 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:46.797608 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:21:46.827571 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:46.890942 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:46.893242 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:21:46.895307 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:21:46.914058 [debug] [Thread-1 (]: SQL status: BEGIN in 0.019 seconds
[0m23:21:46.915657 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:46.917109 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:21:46.937985 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.019 seconds
[0m23:21:46.952112 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:46.957425 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:21:46.963676 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:21:46.973464 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:46.974869 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:21:46.977790 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:21:46.997414 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:46.999017 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:47.000582 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:47.003738 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m23:21:47.011093 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:21:47.016183 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:47.017961 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:21:47.032996 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.012 seconds
[0m23:21:47.037410 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:21:47.041921 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93659782-90cc-439b-833a-32d647c8196e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d797c12e5d0>]}
[0m23:21:47.044970 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.27s]
[0m23:21:47.047346 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:21:47.051643 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:47.053788 [debug] [MainThread]: On master: BEGIN
[0m23:21:47.055422 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:21:47.067715 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m23:21:47.070572 [debug] [MainThread]: On master: COMMIT
[0m23:21:47.071792 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:47.072956 [debug] [MainThread]: On master: COMMIT
[0m23:21:47.080015 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:47.082869 [debug] [MainThread]: On master: Close
[0m23:21:47.087430 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:21:47.089257 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:21:47.090944 [info ] [MainThread]: 
[0m23:21:47.092362 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.60 seconds (0.60s).
[0m23:21:47.094320 [debug] [MainThread]: Command end result
[0m23:21:47.197447 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:47.206162 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:47.215477 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:21:47.216380 [info ] [MainThread]: 
[0m23:21:47.217665 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:21:47.218664 [info ] [MainThread]: 
[0m23:21:47.220573 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:21:47.222188 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.7727127, "process_in_blocks": "0", "process_kernel_time": 0.585902, "process_mem_max_rss": "127552", "process_out_blocks": "0", "process_user_time": 1.97486}
[0m23:21:47.223095 [debug] [MainThread]: Command `dbt run` succeeded at 23:21:47.223003 after 3.77 seconds
[0m23:21:47.223963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d79816078d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d798155ad90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d798155add0>]}
[0m23:21:47.224797 [debug] [MainThread]: Flushing usage events
[0m23:21:47.876861 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:21:53.284345 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77857fdac910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77857fdaf1d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77857fdae490>]}


============================== 23:21:53.299097 | e7826d65-b91a-4208-81be-b2aa8d7bffc8 ==============================
[0m23:21:53.299097 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:21:53.300381 [debug] [MainThread]: running dbt with arguments {'log_cache_events': 'False', 'empty': 'False', 'debug': 'False', 'target_path': 'None', 'no_print': 'None', 'partial_parse': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'fail_fast': 'False', 'warn_error': 'None', 'quiet': 'False', 'indirect_selection': 'eager', 'send_anonymous_usage_stats': 'True', 'write_json': 'True', 'version_check': 'True', 'introspect': 'True', 'use_colors': 'True', 'invocation_command': 'dbt run', 'use_experimental_parser': 'False', 'log_format': 'default', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'cache_selected_only': 'False', 'static_parser': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'printer_width': '80'}
[0m23:21:53.474898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e7826d65-b91a-4208-81be-b2aa8d7bffc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77857f16e690>]}
[0m23:21:53.530631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e7826d65-b91a-4208-81be-b2aa8d7bffc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77857f4ee810>]}
[0m23:21:53.532213 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:21:53.719081 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:21:55.292732 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:21:55.295334 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:21:55.349257 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e7826d65-b91a-4208-81be-b2aa8d7bffc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77857e93c0d0>]}
[0m23:21:55.447241 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:55.453474 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:55.503636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e7826d65-b91a-4208-81be-b2aa8d7bffc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77857dd140d0>]}
[0m23:21:55.505895 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:21:55.507835 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7826d65-b91a-4208-81be-b2aa8d7bffc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77857dd86c90>]}
[0m23:21:55.510864 [info ] [MainThread]: 
[0m23:21:55.515374 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:21:55.517441 [info ] [MainThread]: 
[0m23:21:55.519624 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:21:55.523321 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:21:55.671461 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:21:55.673614 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:21:55.675374 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:21:55.694176 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m23:21:55.699215 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:21:55.702897 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:21:55.711521 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:55.713345 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:21:55.715584 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:21:55.724850 [debug] [ThreadPool]: SQL status: BEGIN in 0.009 seconds
[0m23:21:55.726926 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:21:55.728388 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:21:55.735997 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m23:21:55.740206 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:21:55.743246 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:21:55.752811 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:55.754809 [debug] [MainThread]: On master: BEGIN
[0m23:21:55.756381 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:21:55.768646 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m23:21:55.770862 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:55.772940 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:21:55.784058 [debug] [MainThread]: SQL status: SELECT 1 in 0.009 seconds
[0m23:21:55.788010 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7826d65-b91a-4208-81be-b2aa8d7bffc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77857d930490>]}
[0m23:21:55.790117 [debug] [MainThread]: On master: ROLLBACK
[0m23:21:55.792256 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:55.794047 [debug] [MainThread]: On master: BEGIN
[0m23:21:55.798478 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:21:55.800305 [debug] [MainThread]: On master: COMMIT
[0m23:21:55.801974 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:55.803405 [debug] [MainThread]: On master: COMMIT
[0m23:21:55.805034 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:55.806512 [debug] [MainThread]: On master: Close
[0m23:21:55.812959 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:21:55.815317 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:21:55.817527 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:21:55.819166 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:21:55.834602 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:55.845228 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:21:55.870385 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:21:55.887807 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:55.890537 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:21:55.892781 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:21:55.903102 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m23:21:55.904620 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:55.906246 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:21:55.926554 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.019 seconds
[0m23:21:55.935433 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:55.937082 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:21:55.940404 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:21:55.946081 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:55.947431 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:21:55.950494 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:21:55.963430 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:55.965218 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:55.966571 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:21:55.980079 [debug] [Thread-1 (]: SQL status: COMMIT in 0.012 seconds
[0m23:21:55.988056 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:21:55.993960 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:21:55.996051 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:21:56.011489 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.013 seconds
[0m23:21:56.019472 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:21:56.022688 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7826d65-b91a-4208-81be-b2aa8d7bffc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77857cc61b10>]}
[0m23:21:56.025352 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.20s]
[0m23:21:56.027101 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:21:56.031819 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:56.033227 [debug] [MainThread]: On master: BEGIN
[0m23:21:56.034103 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:21:56.057340 [debug] [MainThread]: SQL status: BEGIN in 0.023 seconds
[0m23:21:56.059777 [debug] [MainThread]: On master: COMMIT
[0m23:21:56.061927 [debug] [MainThread]: Using postgres connection "master"
[0m23:21:56.063992 [debug] [MainThread]: On master: COMMIT
[0m23:21:56.065792 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:21:56.067554 [debug] [MainThread]: On master: Close
[0m23:21:56.069504 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:21:56.071308 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:21:56.073813 [info ] [MainThread]: 
[0m23:21:56.076156 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.55 seconds (0.55s).
[0m23:21:56.078684 [debug] [MainThread]: Command end result
[0m23:21:56.160494 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:21:56.171715 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:21:56.188766 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:21:56.189998 [info ] [MainThread]: 
[0m23:21:56.191298 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:21:56.192607 [info ] [MainThread]: 
[0m23:21:56.194147 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:21:56.197007 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.980447, "process_in_blocks": "0", "process_kernel_time": 0.48502, "process_mem_max_rss": "127484", "process_out_blocks": "0", "process_user_time": 2.044016}
[0m23:21:56.198957 [debug] [MainThread]: Command `dbt run` succeeded at 23:21:56.198781 after 2.98 seconds
[0m23:21:56.200377 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77857fdc8950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7785846bb890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77857cbd6a90>]}
[0m23:21:56.202046 [debug] [MainThread]: Flushing usage events
[0m23:21:56.832313 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:22:05.434831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78d4cc96ee50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78d4cc9761d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78d4cc91ac10>]}


============================== 23:22:05.442781 | 97f453d4-ba0b-4343-b0db-637cd88e34bf ==============================
[0m23:22:05.442781 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:22:05.444031 [debug] [MainThread]: running dbt with arguments {'partial_parse': 'True', 'write_json': 'True', 'debug': 'False', 'quiet': 'False', 'use_colors': 'True', 'target_path': 'None', 'printer_width': '80', 'profiles_dir': '/usr/app/dbt/dbt', 'fail_fast': 'False', 'no_print': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'log_cache_events': 'False', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'indirect_selection': 'eager', 'version_check': 'True', 'send_anonymous_usage_stats': 'True', 'log_format': 'default', 'introspect': 'True', 'cache_selected_only': 'False', 'static_parser': 'True', 'warn_error': 'None', 'invocation_command': 'dbt run', 'empty': 'False'}
[0m23:22:05.599048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '97f453d4-ba0b-4343-b0db-637cd88e34bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78d4cf1bbdd0>]}
[0m23:22:05.644515 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '97f453d4-ba0b-4343-b0db-637cd88e34bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78d4cf67cb10>]}
[0m23:22:05.648408 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:22:05.881081 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:22:08.170799 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:22:08.172243 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:22:08.207893 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '97f453d4-ba0b-4343-b0db-637cd88e34bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78d4cb10b9d0>]}
[0m23:22:08.330248 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:22:08.337631 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:22:08.372256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '97f453d4-ba0b-4343-b0db-637cd88e34bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78d4cb124c90>]}
[0m23:22:08.373755 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:22:08.374935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '97f453d4-ba0b-4343-b0db-637cd88e34bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78d4ca59ecd0>]}
[0m23:22:08.377870 [info ] [MainThread]: 
[0m23:22:08.379575 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:22:08.380760 [info ] [MainThread]: 
[0m23:22:08.382149 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:22:08.384194 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:22:08.533046 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:22:08.534517 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:22:08.536334 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:22:08.547813 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.011 seconds
[0m23:22:08.550241 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:22:08.552887 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:22:08.560916 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:22:08.563145 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:22:08.564283 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:22:08.573552 [debug] [ThreadPool]: SQL status: BEGIN in 0.009 seconds
[0m23:22:08.575001 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:22:08.576051 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:22:08.582639 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m23:22:08.585205 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:22:08.587336 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:22:08.594968 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:08.597056 [debug] [MainThread]: On master: BEGIN
[0m23:22:08.598949 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:22:08.608167 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m23:22:08.609857 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:08.611841 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:22:08.618505 [debug] [MainThread]: SQL status: SELECT 1 in 0.005 seconds
[0m23:22:08.621682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '97f453d4-ba0b-4343-b0db-637cd88e34bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78d4ca14a790>]}
[0m23:22:08.622819 [debug] [MainThread]: On master: ROLLBACK
[0m23:22:08.624333 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:08.625540 [debug] [MainThread]: On master: BEGIN
[0m23:22:08.627710 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m23:22:08.629147 [debug] [MainThread]: On master: COMMIT
[0m23:22:08.630232 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:08.632148 [debug] [MainThread]: On master: COMMIT
[0m23:22:08.633525 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:22:08.634887 [debug] [MainThread]: On master: Close
[0m23:22:08.641766 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:22:08.644524 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:22:08.646365 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:22:08.648725 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:22:08.668402 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:22:08.681193 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:22:08.717714 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:22:08.733570 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:08.735022 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:22:08.736724 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:22:08.749849 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m23:22:08.751565 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:08.752871 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:22:08.763148 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.009 seconds
[0m23:22:08.773033 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:08.774241 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:22:08.777026 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:22:08.784629 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:08.786292 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:22:08.789209 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:22:08.806538 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:22:08.808380 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:08.809997 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:22:08.815179 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m23:22:08.826056 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:22:08.833887 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:08.835956 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:22:08.843927 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.006 seconds
[0m23:22:08.849293 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:22:08.853425 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '97f453d4-ba0b-4343-b0db-637cd88e34bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78d4c96c8890>]}
[0m23:22:08.855872 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.21s]
[0m23:22:08.857843 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:22:08.862434 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:08.864618 [debug] [MainThread]: On master: BEGIN
[0m23:22:08.867001 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:22:08.883321 [debug] [MainThread]: SQL status: BEGIN in 0.016 seconds
[0m23:22:08.887347 [debug] [MainThread]: On master: COMMIT
[0m23:22:08.889228 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:08.891033 [debug] [MainThread]: On master: COMMIT
[0m23:22:08.893623 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:22:08.896083 [debug] [MainThread]: On master: Close
[0m23:22:08.898669 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:22:08.900624 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:22:08.902486 [info ] [MainThread]: 
[0m23:22:08.904658 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.52 seconds (0.52s).
[0m23:22:08.914457 [debug] [MainThread]: Command end result
[0m23:22:08.994451 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:22:09.004724 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:22:09.022313 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:22:09.024072 [info ] [MainThread]: 
[0m23:22:09.025982 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:22:09.027738 [info ] [MainThread]: 
[0m23:22:09.030818 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:22:09.033604 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.6764722, "process_in_blocks": "0", "process_kernel_time": 0.540809, "process_mem_max_rss": "128016", "process_out_blocks": "0", "process_user_time": 1.989848}
[0m23:22:09.035364 [debug] [MainThread]: Command `dbt run` succeeded at 23:22:09.035178 after 3.68 seconds
[0m23:22:09.037054 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78d4cc91a650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78d4cc91af10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78d4d1483910>]}
[0m23:22:09.038663 [debug] [MainThread]: Flushing usage events
[0m23:22:09.613998 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:22:24.487065 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed0917ac150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed0917af090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed09180e490>]}


============================== 23:22:24.497177 | 57fd97bd-b604-460c-9c68-cdfaf7e91a58 ==============================
[0m23:22:24.497177 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:22:24.498813 [debug] [MainThread]: running dbt with arguments {'introspect': 'True', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_format': 'default', 'fail_fast': 'False', 'static_parser': 'True', 'quiet': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'send_anonymous_usage_stats': 'True', 'indirect_selection': 'eager', 'target_path': 'None', 'debug': 'False', 'printer_width': '80', 'use_experimental_parser': 'False', 'version_check': 'True', 'no_print': 'None', 'invocation_command': 'dbt run', 'empty': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'partial_parse': 'True', 'warn_error': 'None', 'log_cache_events': 'False', 'use_colors': 'True', 'cache_selected_only': 'False'}
[0m23:22:24.630074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '57fd97bd-b604-460c-9c68-cdfaf7e91a58', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed090b230d0>]}
[0m23:22:24.670753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '57fd97bd-b604-460c-9c68-cdfaf7e91a58', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed09453a690>]}
[0m23:22:24.673395 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:22:24.865956 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:22:26.868316 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:22:26.873696 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:22:26.914677 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '57fd97bd-b604-460c-9c68-cdfaf7e91a58', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed0907ee350>]}
[0m23:22:27.009200 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:22:27.016439 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:22:27.051739 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '57fd97bd-b604-460c-9c68-cdfaf7e91a58', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed08f714410>]}
[0m23:22:27.054928 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:22:27.056024 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '57fd97bd-b604-460c-9c68-cdfaf7e91a58', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed08f784810>]}
[0m23:22:27.058339 [info ] [MainThread]: 
[0m23:22:27.059506 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:22:27.060545 [info ] [MainThread]: 
[0m23:22:27.061782 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:22:27.063865 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:22:27.173288 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:22:27.176282 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:22:27.178169 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:22:27.195248 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m23:22:27.198500 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:22:27.207219 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:22:27.217412 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:22:27.221887 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:22:27.226284 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:22:27.245214 [debug] [ThreadPool]: SQL status: BEGIN in 0.019 seconds
[0m23:22:27.247072 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:22:27.249506 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:22:27.259060 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.008 seconds
[0m23:22:27.262977 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:22:27.265384 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:22:27.274268 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:27.279184 [debug] [MainThread]: On master: BEGIN
[0m23:22:27.280820 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:22:27.295290 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m23:22:27.299690 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:27.301559 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:22:27.312046 [debug] [MainThread]: SQL status: SELECT 1 in 0.009 seconds
[0m23:22:27.314776 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '57fd97bd-b604-460c-9c68-cdfaf7e91a58', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed08e7d3950>]}
[0m23:22:27.316517 [debug] [MainThread]: On master: ROLLBACK
[0m23:22:27.317953 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:27.319140 [debug] [MainThread]: On master: BEGIN
[0m23:22:27.320628 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:22:27.321800 [debug] [MainThread]: On master: COMMIT
[0m23:22:27.322830 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:27.323782 [debug] [MainThread]: On master: COMMIT
[0m23:22:27.325137 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:22:27.326153 [debug] [MainThread]: On master: Close
[0m23:22:27.335685 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:22:27.337496 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:22:27.339084 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:22:27.343570 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:22:27.361737 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:22:27.379351 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:22:27.404930 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:22:27.460741 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:27.463627 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:22:27.467287 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:22:27.479964 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m23:22:27.483904 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:27.488024 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:22:27.503611 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.010 seconds
[0m23:22:27.518045 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:27.521645 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:22:27.526882 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:22:27.532003 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:27.536462 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:22:27.543865 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:22:27.564802 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:22:27.570295 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:27.575297 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:22:27.584169 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m23:22:27.598892 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:22:27.610900 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:27.617239 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:22:27.635528 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.007 seconds
[0m23:22:27.643978 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:22:27.650803 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57fd97bd-b604-460c-9c68-cdfaf7e91a58', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed08e6a8bd0>]}
[0m23:22:27.658114 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.31s]
[0m23:22:27.662687 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:22:27.668051 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:27.671558 [debug] [MainThread]: On master: BEGIN
[0m23:22:27.672983 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:22:27.688116 [debug] [MainThread]: SQL status: BEGIN in 0.015 seconds
[0m23:22:27.689710 [debug] [MainThread]: On master: COMMIT
[0m23:22:27.690987 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:27.692032 [debug] [MainThread]: On master: COMMIT
[0m23:22:27.693360 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:22:27.696139 [debug] [MainThread]: On master: Close
[0m23:22:27.698239 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:22:27.700019 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:22:27.701662 [info ] [MainThread]: 
[0m23:22:27.707169 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.64 seconds (0.64s).
[0m23:22:27.708936 [debug] [MainThread]: Command end result
[0m23:22:27.874077 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:22:27.884616 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:22:27.901328 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:22:27.902833 [info ] [MainThread]: 
[0m23:22:27.904759 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:22:27.906534 [info ] [MainThread]: 
[0m23:22:27.908428 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:22:27.910941 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.5394034, "process_in_blocks": "0", "process_kernel_time": 0.515096, "process_mem_max_rss": "127524", "process_out_blocks": "0", "process_user_time": 1.798812}
[0m23:22:27.913632 [debug] [MainThread]: Command `dbt run` succeeded at 23:22:27.913458 after 3.54 seconds
[0m23:22:27.915813 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed0960bb890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed0960d6750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ed0960d7610>]}
[0m23:22:27.917782 [debug] [MainThread]: Flushing usage events
[0m23:22:28.808987 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:22:56.454538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765cefc10350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765cefc10990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765cef8aa650>]}


============================== 23:22:56.463003 | 87dde556-782a-4980-8194-842d7ddb7f4b ==============================
[0m23:22:56.463003 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:22:56.465118 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'profiles_dir': '/usr/app/dbt/dbt', 'static_parser': 'True', 'log_format': 'default', 'debug': 'False', 'quiet': 'False', 'use_experimental_parser': 'False', 'log_cache_events': 'False', 'send_anonymous_usage_stats': 'True', 'cache_selected_only': 'False', 'write_json': 'True', 'introspect': 'True', 'indirect_selection': 'eager', 'printer_width': '80', 'use_colors': 'True', 'partial_parse': 'True', 'empty': 'False', 'invocation_command': 'dbt run', 'log_path': '/usr/app/dbt/dbt/logs', 'no_print': 'None'}
[0m23:22:56.617068 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '87dde556-782a-4980-8194-842d7ddb7f4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765cee9649d0>]}
[0m23:22:56.667055 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '87dde556-782a-4980-8194-842d7ddb7f4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765cf260e390>]}
[0m23:22:56.673385 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:22:56.831716 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:22:57.867328 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:22:57.868892 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:22:57.902011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '87dde556-782a-4980-8194-842d7ddb7f4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765cef8aac10>]}
[0m23:22:58.049007 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:22:58.056201 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:22:58.101087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '87dde556-782a-4980-8194-842d7ddb7f4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765ced591410>]}
[0m23:22:58.103420 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:22:58.104720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '87dde556-782a-4980-8194-842d7ddb7f4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765cee96fb50>]}
[0m23:22:58.107066 [info ] [MainThread]: 
[0m23:22:58.108383 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:22:58.109450 [info ] [MainThread]: 
[0m23:22:58.110658 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:22:58.112393 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:22:58.222789 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:22:58.228422 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:22:58.230742 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:22:58.257170 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.026 seconds
[0m23:22:58.263096 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:22:58.267416 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:22:58.303541 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:22:58.306149 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:22:58.308394 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:22:58.323817 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m23:22:58.329321 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:22:58.333099 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:22:58.345977 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.009 seconds
[0m23:22:58.350273 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:22:58.354911 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:22:58.364047 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:58.368436 [debug] [MainThread]: On master: BEGIN
[0m23:22:58.370646 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:22:58.385290 [debug] [MainThread]: SQL status: BEGIN in 0.015 seconds
[0m23:22:58.390245 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:58.392389 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:22:58.404443 [debug] [MainThread]: SQL status: SELECT 1 in 0.010 seconds
[0m23:22:58.407158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '87dde556-782a-4980-8194-842d7ddb7f4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765cee5fadd0>]}
[0m23:22:58.408536 [debug] [MainThread]: On master: ROLLBACK
[0m23:22:58.410052 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:58.411331 [debug] [MainThread]: On master: BEGIN
[0m23:22:58.412733 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:22:58.413733 [debug] [MainThread]: On master: COMMIT
[0m23:22:58.414624 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:58.415720 [debug] [MainThread]: On master: COMMIT
[0m23:22:58.417009 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:22:58.418418 [debug] [MainThread]: On master: Close
[0m23:22:58.425604 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:22:58.426889 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:22:58.428013 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:22:58.428960 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:22:58.449155 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:22:58.461793 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:22:58.486000 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:22:58.497527 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:58.498351 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:22:58.499309 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:22:58.510941 [debug] [Thread-1 (]: SQL status: BEGIN in 0.012 seconds
[0m23:22:58.512089 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:58.512921 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:22:58.521513 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.007 seconds
[0m23:22:58.526853 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:58.527741 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:22:58.529464 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:22:58.533355 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:58.534503 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:22:58.538609 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:22:58.553098 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:22:58.555038 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:58.556971 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:22:58.560330 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m23:22:58.568686 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:22:58.573947 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:22:58.574873 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:22:58.580276 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m23:22:58.583968 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:22:58.587552 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '87dde556-782a-4980-8194-842d7ddb7f4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765cec72b590>]}
[0m23:22:58.588833 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.16s]
[0m23:22:58.590019 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:22:58.592421 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:58.593314 [debug] [MainThread]: On master: BEGIN
[0m23:22:58.594256 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:22:58.602995 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m23:22:58.604219 [debug] [MainThread]: On master: COMMIT
[0m23:22:58.605033 [debug] [MainThread]: Using postgres connection "master"
[0m23:22:58.605771 [debug] [MainThread]: On master: COMMIT
[0m23:22:58.606708 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:22:58.607517 [debug] [MainThread]: On master: Close
[0m23:22:58.608473 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:22:58.609272 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:22:58.610110 [info ] [MainThread]: 
[0m23:22:58.611034 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.50 seconds (0.50s).
[0m23:22:58.612708 [debug] [MainThread]: Command end result
[0m23:22:58.664492 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:22:58.671178 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:22:58.679850 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:22:58.680807 [info ] [MainThread]: 
[0m23:22:58.681954 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:22:58.683285 [info ] [MainThread]: 
[0m23:22:58.685117 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:22:58.686429 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.3117805, "process_in_blocks": "0", "process_kernel_time": 0.393111, "process_mem_max_rss": "127652", "process_out_blocks": "0", "process_user_time": 1.809113}
[0m23:22:58.687400 [debug] [MainThread]: Command `dbt run` succeeded at 23:22:58.687313 after 2.31 seconds
[0m23:22:58.688201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765cf4407910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765cf41beb90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x765cf41bea50>]}
[0m23:22:58.689013 [debug] [MainThread]: Flushing usage events
[0m23:22:59.526024 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:23:52.623682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e48f6cc910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e48f72e490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e48fa5c4d0>]}


============================== 23:23:52.630201 | 37b3658d-631d-40c1-951d-0666018ca1e1 ==============================
[0m23:23:52.630201 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:23:52.632952 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'fail_fast': 'False', 'log_format': 'default', 'version_check': 'True', 'debug': 'False', 'static_parser': 'True', 'write_json': 'True', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'profiles_dir': '/usr/app/dbt/dbt', 'printer_width': '80', 'send_anonymous_usage_stats': 'True', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_colors': 'True', 'empty': 'False', 'use_experimental_parser': 'False', 'introspect': 'True', 'log_cache_events': 'False', 'quiet': 'False', 'target_path': 'None'}
[0m23:23:52.797655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '37b3658d-631d-40c1-951d-0666018ca1e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e48ed39d50>]}
[0m23:23:52.850023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '37b3658d-631d-40c1-951d-0666018ca1e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e49242e750>]}
[0m23:23:52.855360 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:23:53.148137 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:23:54.861235 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:23:54.866904 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:23:54.905484 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '37b3658d-631d-40c1-951d-0666018ca1e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e48e5740d0>]}
[0m23:23:54.995791 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:23:55.001872 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:23:55.027726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '37b3658d-631d-40c1-951d-0666018ca1e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e48d9557d0>]}
[0m23:23:55.028782 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:23:55.029765 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '37b3658d-631d-40c1-951d-0666018ca1e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e491c63e50>]}
[0m23:23:55.031745 [info ] [MainThread]: 
[0m23:23:55.034823 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:23:55.035654 [info ] [MainThread]: 
[0m23:23:55.036752 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:23:55.038174 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:23:55.157472 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:23:55.173660 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:23:55.176268 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:23:55.216376 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.040 seconds
[0m23:23:55.220276 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:23:55.223465 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:23:55.232786 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:23:55.234755 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:23:55.236279 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:23:55.247157 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m23:23:55.249365 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:23:55.251138 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:23:55.260029 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.007 seconds
[0m23:23:55.262355 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:23:55.263641 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:23:55.271422 [debug] [MainThread]: Using postgres connection "master"
[0m23:23:55.272963 [debug] [MainThread]: On master: BEGIN
[0m23:23:55.274185 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:23:55.284995 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m23:23:55.286492 [debug] [MainThread]: Using postgres connection "master"
[0m23:23:55.288012 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:23:55.299044 [debug] [MainThread]: SQL status: SELECT 1 in 0.010 seconds
[0m23:23:55.303488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '37b3658d-631d-40c1-951d-0666018ca1e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e48d95a250>]}
[0m23:23:55.304988 [debug] [MainThread]: On master: ROLLBACK
[0m23:23:55.306375 [debug] [MainThread]: Using postgres connection "master"
[0m23:23:55.307460 [debug] [MainThread]: On master: BEGIN
[0m23:23:55.309133 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:23:55.310277 [debug] [MainThread]: On master: COMMIT
[0m23:23:55.311180 [debug] [MainThread]: Using postgres connection "master"
[0m23:23:55.312345 [debug] [MainThread]: On master: COMMIT
[0m23:23:55.313597 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:23:55.314478 [debug] [MainThread]: On master: Close
[0m23:23:55.324140 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:23:55.325490 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:23:55.326765 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:23:55.327846 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:23:55.346670 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:23:55.356128 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:23:55.382686 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:23:55.392556 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:23:55.393436 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:23:55.394138 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:23:55.403465 [debug] [Thread-1 (]: SQL status: BEGIN in 0.009 seconds
[0m23:23:55.404523 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:23:55.405440 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:23:55.412297 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.006 seconds
[0m23:23:55.420159 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:23:55.421284 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:23:55.423820 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:23:55.428021 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:23:55.428789 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:23:55.430945 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:23:55.442147 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:23:55.443130 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:23:55.444125 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:23:55.446954 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m23:23:55.454450 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:23:55.458730 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:23:55.459549 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:23:55.464001 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m23:23:55.467014 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:23:55.470886 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '37b3658d-631d-40c1-951d-0666018ca1e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e48eccc3d0>]}
[0m23:23:55.472541 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.14s]
[0m23:23:55.474037 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:23:55.477426 [debug] [MainThread]: Using postgres connection "master"
[0m23:23:55.479396 [debug] [MainThread]: On master: BEGIN
[0m23:23:55.481094 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:23:55.491562 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m23:23:55.493554 [debug] [MainThread]: On master: COMMIT
[0m23:23:55.494992 [debug] [MainThread]: Using postgres connection "master"
[0m23:23:55.496328 [debug] [MainThread]: On master: COMMIT
[0m23:23:55.498064 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:23:55.500311 [debug] [MainThread]: On master: Close
[0m23:23:55.503112 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:23:55.505052 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:23:55.506712 [info ] [MainThread]: 
[0m23:23:55.508525 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.47 seconds (0.47s).
[0m23:23:55.510660 [debug] [MainThread]: Command end result
[0m23:23:55.619646 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:23:55.626995 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:23:55.641882 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:23:55.643858 [info ] [MainThread]: 
[0m23:23:55.645506 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:23:55.646945 [info ] [MainThread]: 
[0m23:23:55.648914 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:23:55.650959 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.0960512, "process_in_blocks": "0", "process_kernel_time": 0.437612, "process_mem_max_rss": "128020", "process_out_blocks": "0", "process_user_time": 1.754538}
[0m23:23:55.652157 [debug] [MainThread]: Command `dbt run` succeeded at 23:23:55.652015 after 3.10 seconds
[0m23:23:55.653235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e48fb58410>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e493fb3890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e493fce990>]}
[0m23:23:55.654299 [debug] [MainThread]: Flushing usage events
[0m23:23:56.485952 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:24:58.546655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71e028c0e1d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71e028c1a590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71e028bbaa90>]}


============================== 23:24:58.557323 | bc35f19b-6214-4078-9430-e27dfe88516a ==============================
[0m23:24:58.557323 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:24:58.560777 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'invocation_command': 'dbt run', 'cache_selected_only': 'False', 'printer_width': '80', 'partial_parse': 'True', 'introspect': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'write_json': 'True', 'send_anonymous_usage_stats': 'True', 'use_colors': 'True', 'empty': 'False', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_experimental_parser': 'False', 'indirect_selection': 'eager', 'fail_fast': 'False', 'debug': 'False', 'log_cache_events': 'False', 'static_parser': 'True', 'log_format': 'default', 'version_check': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'no_print': 'None', 'warn_error': 'None'}
[0m23:24:58.703346 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bc35f19b-6214-4078-9430-e27dfe88516a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71e028c19f50>]}
[0m23:24:58.749974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bc35f19b-6214-4078-9430-e27dfe88516a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71e02b934c50>]}
[0m23:24:58.752790 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:24:58.951379 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:25:00.727312 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:25:00.730445 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:25:00.765910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bc35f19b-6214-4078-9430-e27dfe88516a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71e027f8aa90>]}
[0m23:25:00.891813 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:25:00.898799 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:25:00.930036 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bc35f19b-6214-4078-9430-e27dfe88516a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71e02ab1cb90>]}
[0m23:25:00.931128 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:25:00.932067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bc35f19b-6214-4078-9430-e27dfe88516a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71e026b94190>]}
[0m23:25:00.934237 [info ] [MainThread]: 
[0m23:25:00.935225 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:25:00.935952 [info ] [MainThread]: 
[0m23:25:00.937192 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:25:00.939353 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:25:01.050202 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:25:01.053817 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:25:01.059866 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:25:01.084874 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.025 seconds
[0m23:25:01.090351 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:25:01.096488 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:25:01.106695 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:25:01.110480 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:25:01.112446 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:25:01.126980 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m23:25:01.129302 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:25:01.131634 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:25:01.139867 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.007 seconds
[0m23:25:01.141812 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:25:01.143115 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:25:01.148169 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:01.149345 [debug] [MainThread]: On master: BEGIN
[0m23:25:01.150254 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:25:01.159559 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m23:25:01.160644 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:01.161606 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:25:01.168138 [debug] [MainThread]: SQL status: SELECT 1 in 0.005 seconds
[0m23:25:01.169895 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bc35f19b-6214-4078-9430-e27dfe88516a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71e026bc2410>]}
[0m23:25:01.171007 [debug] [MainThread]: On master: ROLLBACK
[0m23:25:01.172220 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:01.173437 [debug] [MainThread]: On master: BEGIN
[0m23:25:01.174728 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m23:25:01.175938 [debug] [MainThread]: On master: COMMIT
[0m23:25:01.176884 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:01.177721 [debug] [MainThread]: On master: COMMIT
[0m23:25:01.178566 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:25:01.179419 [debug] [MainThread]: On master: Close
[0m23:25:01.184702 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:25:01.185759 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:25:01.186773 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:25:01.188003 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:25:01.203472 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:25:01.214636 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:25:01.245359 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:25:01.253949 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:25:01.254855 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:25:01.256032 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:25:01.263514 [debug] [Thread-1 (]: SQL status: BEGIN in 0.007 seconds
[0m23:25:01.264616 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:25:01.265571 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:25:01.271896 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.005 seconds
[0m23:25:01.278798 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:25:01.279865 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:25:01.281626 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:25:01.295711 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:25:01.303977 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:25:01.306463 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:25:01.318608 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:25:01.328315 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:25:01.337073 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:25:01.343969 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m23:25:01.355643 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:25:01.368168 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:25:01.380701 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:25:01.389246 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.006 seconds
[0m23:25:01.394849 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:25:01.399489 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bc35f19b-6214-4078-9430-e27dfe88516a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71e027f68150>]}
[0m23:25:01.403251 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.21s]
[0m23:25:01.407382 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:25:01.412296 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:01.415282 [debug] [MainThread]: On master: BEGIN
[0m23:25:01.417989 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:25:01.434175 [debug] [MainThread]: SQL status: BEGIN in 0.016 seconds
[0m23:25:01.436711 [debug] [MainThread]: On master: COMMIT
[0m23:25:01.438492 [debug] [MainThread]: Using postgres connection "master"
[0m23:25:01.440310 [debug] [MainThread]: On master: COMMIT
[0m23:25:01.442187 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:25:01.443507 [debug] [MainThread]: On master: Close
[0m23:25:01.444760 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:25:01.445878 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:25:01.446897 [info ] [MainThread]: 
[0m23:25:01.448387 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.51 seconds (0.51s).
[0m23:25:01.450271 [debug] [MainThread]: Command end result
[0m23:25:01.538252 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:25:01.550416 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:25:01.584375 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:25:01.590061 [info ] [MainThread]: 
[0m23:25:01.592141 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:25:01.596724 [info ] [MainThread]: 
[0m23:25:01.599327 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:25:01.601798 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.1629922, "process_in_blocks": "0", "process_kernel_time": 0.465286, "process_mem_max_rss": "127224", "process_out_blocks": "0", "process_user_time": 1.841092}
[0m23:25:01.603986 [debug] [MainThread]: Command `dbt run` succeeded at 23:25:01.603788 after 3.17 seconds
[0m23:25:01.607016 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71e02d6f15d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71e02d4c38d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71e02d416d10>]}
[0m23:25:01.609678 [debug] [MainThread]: Flushing usage events
[0m23:25:02.508301 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m23:26:04.373507 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e393b211d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e393e88b90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e393b7e3d0>]}


============================== 23:26:04.379225 | 0eaeb8e3-b969-4ca9-a3da-95bdb60d6e9c ==============================
[0m23:26:04.379225 [info ] [MainThread]: Running with dbt=1.10.15
[0m23:26:04.381277 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'indirect_selection': 'eager', 'introspect': 'True', 'printer_width': '80', 'target_path': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'cache_selected_only': 'False', 'warn_error': 'None', 'empty': 'False', 'invocation_command': 'dbt run', 'use_colors': 'True', 'use_experimental_parser': 'False', 'debug': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'log_format': 'default', 'log_cache_events': 'False', 'no_print': 'None', 'write_json': 'True', 'quiet': 'False', 'partial_parse': 'True', 'version_check': 'True', 'fail_fast': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])'}
[0m23:26:04.525730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0eaeb8e3-b969-4ca9-a3da-95bdb60d6e9c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e393b22e10>]}
[0m23:26:04.581607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0eaeb8e3-b969-4ca9-a3da-95bdb60d6e9c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e396884610>]}
[0m23:26:04.585155 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m23:26:04.708595 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m23:26:06.322911 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:26:06.324468 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:26:06.362230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0eaeb8e3-b969-4ca9-a3da-95bdb60d6e9c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e391be9ad0>]}
[0m23:26:06.471397 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:26:06.479748 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:26:06.507237 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0eaeb8e3-b969-4ca9-a3da-95bdb60d6e9c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e391708cd0>]}
[0m23:26:06.508427 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m23:26:06.509500 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0eaeb8e3-b969-4ca9-a3da-95bdb60d6e9c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e39177e7d0>]}
[0m23:26:06.512155 [info ] [MainThread]: 
[0m23:26:06.513723 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m23:26:06.515044 [info ] [MainThread]: 
[0m23:26:06.516488 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m23:26:06.518617 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m23:26:06.660428 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m23:26:06.662757 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m23:26:06.664857 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:26:06.685577 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.021 seconds
[0m23:26:06.688979 [debug] [ThreadPool]: On list_data_project_1: Close
[0m23:26:06.692606 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m23:26:06.702947 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:26:06.705864 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m23:26:06.710134 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:26:06.722889 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m23:26:06.724633 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m23:26:06.726125 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m23:26:06.736992 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.009 seconds
[0m23:26:06.740477 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m23:26:06.742420 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m23:26:06.751778 [debug] [MainThread]: Using postgres connection "master"
[0m23:26:06.753616 [debug] [MainThread]: On master: BEGIN
[0m23:26:06.755405 [debug] [MainThread]: Opening a new connection, currently in state init
[0m23:26:06.768992 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m23:26:06.771674 [debug] [MainThread]: Using postgres connection "master"
[0m23:26:06.774763 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m23:26:06.787512 [debug] [MainThread]: SQL status: SELECT 1 in 0.010 seconds
[0m23:26:06.791515 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0eaeb8e3-b969-4ca9-a3da-95bdb60d6e9c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e39170ee50>]}
[0m23:26:06.793925 [debug] [MainThread]: On master: ROLLBACK
[0m23:26:06.796666 [debug] [MainThread]: Using postgres connection "master"
[0m23:26:06.798665 [debug] [MainThread]: On master: BEGIN
[0m23:26:06.801481 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m23:26:06.804225 [debug] [MainThread]: On master: COMMIT
[0m23:26:06.807073 [debug] [MainThread]: Using postgres connection "master"
[0m23:26:06.809289 [debug] [MainThread]: On master: COMMIT
[0m23:26:06.812517 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:26:06.814476 [debug] [MainThread]: On master: Close
[0m23:26:06.824459 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m23:26:06.827346 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m23:26:06.828769 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m23:26:06.830340 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m23:26:06.847886 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m23:26:06.858827 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m23:26:06.883447 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m23:26:06.897252 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:26:06.898664 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m23:26:06.900077 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m23:26:06.910265 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m23:26:06.911936 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:26:06.913667 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m23:26:06.920679 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.005 seconds
[0m23:26:06.927107 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:26:06.928431 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m23:26:06.931593 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m23:26:06.935442 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:26:06.936396 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m23:26:06.939252 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m23:26:06.950029 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:26:06.951250 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:26:06.952563 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m23:26:06.955919 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m23:26:06.960865 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m23:26:06.965016 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m23:26:06.966239 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m23:26:06.972886 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.006 seconds
[0m23:26:06.975380 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m23:26:06.978680 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0eaeb8e3-b969-4ca9-a3da-95bdb60d6e9c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e39092f650>]}
[0m23:26:06.980728 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.15s]
[0m23:26:06.982419 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m23:26:06.985748 [debug] [MainThread]: Using postgres connection "master"
[0m23:26:06.987292 [debug] [MainThread]: On master: BEGIN
[0m23:26:06.988493 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m23:26:06.999842 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m23:26:07.001739 [debug] [MainThread]: On master: COMMIT
[0m23:26:07.003020 [debug] [MainThread]: Using postgres connection "master"
[0m23:26:07.004189 [debug] [MainThread]: On master: COMMIT
[0m23:26:07.005506 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m23:26:07.006667 [debug] [MainThread]: On master: Close
[0m23:26:07.007967 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:26:07.009416 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m23:26:07.011123 [info ] [MainThread]: 
[0m23:26:07.012749 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.49 seconds (0.49s).
[0m23:26:07.014432 [debug] [MainThread]: Command end result
[0m23:26:07.088016 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m23:26:07.097573 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m23:26:07.112840 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m23:26:07.114272 [info ] [MainThread]: 
[0m23:26:07.115752 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:26:07.117040 [info ] [MainThread]: 
[0m23:26:07.118284 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m23:26:07.120263 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.8116224, "process_in_blocks": "0", "process_kernel_time": 0.456813, "process_mem_max_rss": "127612", "process_out_blocks": "0", "process_user_time": 1.787872}
[0m23:26:07.121542 [debug] [MainThread]: Command `dbt run` succeeded at 23:26:07.121407 after 2.81 seconds
[0m23:26:07.122687 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e39867f910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e3984369d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73e398437690>]}
[0m23:26:07.123822 [debug] [MainThread]: Flushing usage events
[0m23:26:08.044527 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:33:55.129160 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d900a856e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d900a820cd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d900a85e1d0>]}


============================== 09:33:55.136423 | 45d4bac0-e65a-4ea2-8c91-388579a97b38 ==============================
[0m09:33:55.136423 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:33:55.140766 [debug] [MainThread]: running dbt with arguments {'version_check': 'True', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'use_colors': 'True', 'invocation_command': 'dbt run', 'quiet': 'False', 'fail_fast': 'False', 'indirect_selection': 'eager', 'log_format': 'default', 'debug': 'False', 'warn_error': 'None', 'profiles_dir': '/usr/app/dbt/dbt', 'cache_selected_only': 'False', 'empty': 'False', 'static_parser': 'True', 'printer_width': '80', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'write_json': 'True', 'introspect': 'True', 'no_print': 'None', 'partial_parse': 'True', 'log_path': '/usr/app/dbt/dbt/logs'}
[0m09:33:55.291853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '45d4bac0-e65a-4ea2-8c91-388579a97b38', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d900a801690>]}
[0m09:33:55.338421 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '45d4bac0-e65a-4ea2-8c91-388579a97b38', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d900d57ad50>]}
[0m09:33:55.341107 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:33:55.467936 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:33:56.717156 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:33:56.718249 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:33:56.751279 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '45d4bac0-e65a-4ea2-8c91-388579a97b38', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d90091ba410>]}
[0m09:33:56.837861 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:33:56.843490 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:33:56.870954 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '45d4bac0-e65a-4ea2-8c91-388579a97b38', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d9008121f90>]}
[0m09:33:56.871986 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m09:33:56.872780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '45d4bac0-e65a-4ea2-8c91-388579a97b38', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d9008d0f590>]}
[0m09:33:56.875247 [info ] [MainThread]: 
[0m09:33:56.876545 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:33:56.877991 [info ] [MainThread]: 
[0m09:33:56.879740 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:33:56.881367 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:33:57.025258 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:33:57.026476 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:33:57.027237 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:33:57.042274 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.015 seconds
[0m09:33:57.044619 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:33:57.046838 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:33:57.053330 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:33:57.055347 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:33:57.057147 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:33:57.066400 [debug] [ThreadPool]: SQL status: BEGIN in 0.009 seconds
[0m09:33:57.067430 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:33:57.068421 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:33:57.076181 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m09:33:57.079869 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:33:57.080968 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:33:57.085288 [debug] [MainThread]: Using postgres connection "master"
[0m09:33:57.087396 [debug] [MainThread]: On master: BEGIN
[0m09:33:57.089284 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:33:57.098380 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m09:33:57.099711 [debug] [MainThread]: Using postgres connection "master"
[0m09:33:57.100588 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:33:57.107930 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m09:33:57.109825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '45d4bac0-e65a-4ea2-8c91-388579a97b38', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d90099c34d0>]}
[0m09:33:57.110777 [debug] [MainThread]: On master: ROLLBACK
[0m09:33:57.111648 [debug] [MainThread]: Using postgres connection "master"
[0m09:33:57.112565 [debug] [MainThread]: On master: BEGIN
[0m09:33:57.113557 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:33:57.114339 [debug] [MainThread]: On master: COMMIT
[0m09:33:57.114964 [debug] [MainThread]: Using postgres connection "master"
[0m09:33:57.115518 [debug] [MainThread]: On master: COMMIT
[0m09:33:57.116213 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:33:57.116829 [debug] [MainThread]: On master: Close
[0m09:33:57.122447 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:33:57.123934 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:33:57.125150 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:33:57.125961 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:33:57.139345 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:33:57.152978 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:33:57.177861 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:33:57.186373 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:33:57.187362 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:33:57.188331 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:33:57.197007 [debug] [Thread-1 (]: SQL status: BEGIN in 0.009 seconds
[0m09:33:57.197960 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:33:57.198802 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:33:57.207735 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.008 seconds
[0m09:33:57.213787 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:33:57.214705 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:33:57.216782 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:33:57.221747 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:33:57.223278 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:33:57.225704 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:33:57.237189 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:33:57.238580 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:33:57.239690 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:33:57.243015 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m09:33:57.249063 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:33:57.253274 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:33:57.254219 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:33:57.261899 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.007 seconds
[0m09:33:57.265096 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:33:57.267708 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '45d4bac0-e65a-4ea2-8c91-388579a97b38', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d90099c3410>]}
[0m09:33:57.269507 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.14s]
[0m09:33:57.271006 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:33:57.273175 [debug] [MainThread]: Using postgres connection "master"
[0m09:33:57.273885 [debug] [MainThread]: On master: BEGIN
[0m09:33:57.274473 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:33:57.281724 [debug] [MainThread]: SQL status: BEGIN in 0.007 seconds
[0m09:33:57.282845 [debug] [MainThread]: On master: COMMIT
[0m09:33:57.283575 [debug] [MainThread]: Using postgres connection "master"
[0m09:33:57.284220 [debug] [MainThread]: On master: COMMIT
[0m09:33:57.285036 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:33:57.286318 [debug] [MainThread]: On master: Close
[0m09:33:57.287341 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:33:57.288312 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:33:57.288975 [info ] [MainThread]: 
[0m09:33:57.290156 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.41 seconds (0.41s).
[0m09:33:57.291176 [debug] [MainThread]: Command end result
[0m09:33:57.339591 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:33:57.347912 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:33:57.356729 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:33:57.357577 [info ] [MainThread]: 
[0m09:33:57.358536 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:33:57.359359 [info ] [MainThread]: 
[0m09:33:57.360260 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m09:33:57.361806 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.3023283, "process_in_blocks": "0", "process_kernel_time": 0.887931, "process_mem_max_rss": "127652", "process_out_blocks": "0", "process_user_time": 1.783863}
[0m09:33:57.362683 [debug] [MainThread]: Command `dbt run` succeeded at 09:33:57.362585 after 2.30 seconds
[0m09:33:57.363409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d900a820c90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d900f1078d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d900f05ad10>]}
[0m09:33:57.364120 [debug] [MainThread]: Flushing usage events
[0m09:33:58.262043 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:35:00.913725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ee667ccc90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ee6649df90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ee664588d0>]}


============================== 09:35:00.925715 | e57ee664-07da-4fd2-b094-f27892fc0b78 ==============================
[0m09:35:00.925715 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:35:00.928859 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'indirect_selection': 'eager', 'printer_width': '80', 'partial_parse': 'True', 'warn_error': 'None', 'write_json': 'True', 'quiet': 'False', 'log_format': 'default', 'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'version_check': 'True', 'log_cache_events': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'use_experimental_parser': 'False', 'target_path': 'None', 'invocation_command': 'dbt run', 'use_colors': 'True', 'no_print': 'None', 'fail_fast': 'False', 'debug': 'False', 'introspect': 'True', 'profiles_dir': '/usr/app/dbt/dbt'}
[0m09:35:01.116669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e57ee664-07da-4fd2-b094-f27892fc0b78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ee6643d790>]}
[0m09:35:01.165209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e57ee664-07da-4fd2-b094-f27892fc0b78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ee6919c550>]}
[0m09:35:01.168511 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:35:01.325893 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:35:03.627512 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:35:03.628603 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:35:03.664665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e57ee664-07da-4fd2-b094-f27892fc0b78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ee64f23010>]}
[0m09:35:03.832636 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:35:03.853377 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:35:03.920362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e57ee664-07da-4fd2-b094-f27892fc0b78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ee6432da90>]}
[0m09:35:03.928262 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m09:35:03.931500 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e57ee664-07da-4fd2-b094-f27892fc0b78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ee653eaf90>]}
[0m09:35:03.938295 [info ] [MainThread]: 
[0m09:35:03.940000 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:35:03.941930 [info ] [MainThread]: 
[0m09:35:03.954432 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:35:03.961159 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:35:04.132290 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:35:04.135766 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:35:04.139200 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:35:04.160917 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.022 seconds
[0m09:35:04.164143 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:35:04.167544 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:35:04.174605 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:35:04.176322 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:35:04.178656 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:35:04.193828 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m09:35:04.198184 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:35:04.200565 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:35:04.207923 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m09:35:04.210088 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:35:04.214488 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:35:04.226821 [debug] [MainThread]: Using postgres connection "master"
[0m09:35:04.228366 [debug] [MainThread]: On master: BEGIN
[0m09:35:04.229755 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:35:04.259099 [debug] [MainThread]: SQL status: BEGIN in 0.029 seconds
[0m09:35:04.260470 [debug] [MainThread]: Using postgres connection "master"
[0m09:35:04.261590 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:35:04.269394 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m09:35:04.272646 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e57ee664-07da-4fd2-b094-f27892fc0b78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ee6634f990>]}
[0m09:35:04.274073 [debug] [MainThread]: On master: ROLLBACK
[0m09:35:04.275631 [debug] [MainThread]: Using postgres connection "master"
[0m09:35:04.277291 [debug] [MainThread]: On master: BEGIN
[0m09:35:04.279134 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:35:04.280271 [debug] [MainThread]: On master: COMMIT
[0m09:35:04.281824 [debug] [MainThread]: Using postgres connection "master"
[0m09:35:04.283451 [debug] [MainThread]: On master: COMMIT
[0m09:35:04.285342 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:35:04.286907 [debug] [MainThread]: On master: Close
[0m09:35:04.296576 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:35:04.299760 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:35:04.305568 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:35:04.309836 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:35:04.329708 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:35:04.394156 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:35:04.444241 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:35:04.540293 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:35:04.542001 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:35:04.543374 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:35:04.553689 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m09:35:04.556640 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:35:04.558190 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:35:04.568500 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.008 seconds
[0m09:35:04.576970 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:35:04.578154 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:35:04.580388 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:35:04.585708 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:35:04.586682 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:35:04.589362 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:35:04.600927 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:35:04.602139 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:35:04.603198 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:35:04.606160 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m09:35:04.611072 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:35:04.616711 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:35:04.617870 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:35:04.623622 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m09:35:04.626279 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:35:04.628248 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e57ee664-07da-4fd2-b094-f27892fc0b78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ee657ab590>]}
[0m09:35:04.629838 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.32s]
[0m09:35:04.631543 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:35:04.634436 [debug] [MainThread]: Using postgres connection "master"
[0m09:35:04.635267 [debug] [MainThread]: On master: BEGIN
[0m09:35:04.636036 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:35:04.651463 [debug] [MainThread]: SQL status: BEGIN in 0.015 seconds
[0m09:35:04.652681 [debug] [MainThread]: On master: COMMIT
[0m09:35:04.653619 [debug] [MainThread]: Using postgres connection "master"
[0m09:35:04.654560 [debug] [MainThread]: On master: COMMIT
[0m09:35:04.655808 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:35:04.656578 [debug] [MainThread]: On master: Close
[0m09:35:04.657424 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:35:04.658287 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:35:04.659183 [info ] [MainThread]: 
[0m09:35:04.660272 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.71 seconds (0.71s).
[0m09:35:04.662071 [debug] [MainThread]: Command end result
[0m09:35:04.718747 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:35:04.726395 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:35:04.737289 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:35:04.738489 [info ] [MainThread]: 
[0m09:35:04.744323 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:35:04.746835 [info ] [MainThread]: 
[0m09:35:04.748466 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m09:35:04.751038 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.9229944, "process_in_blocks": "0", "process_kernel_time": 1.027334, "process_mem_max_rss": "127384", "process_out_blocks": "0", "process_user_time": 2.075465}
[0m09:35:04.752122 [debug] [MainThread]: Command `dbt run` succeeded at 09:35:04.752024 after 3.92 seconds
[0m09:35:04.753095 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ee66443e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ee66458950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x72ee675a9e50>]}
[0m09:35:04.754041 [debug] [MainThread]: Flushing usage events
[0m09:35:05.377801 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:36:07.697848 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x762fc50d0a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x762fc5132750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x762fc50d35d0>]}


============================== 09:36:07.705264 | c7f29517-e224-4c51-bc63-74c9484da7ee ==============================
[0m09:36:07.705264 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:36:07.707201 [debug] [MainThread]: running dbt with arguments {'quiet': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'log_cache_events': 'False', 'invocation_command': 'dbt run', 'introspect': 'True', 'target_path': 'None', 'fail_fast': 'False', 'debug': 'False', 'static_parser': 'True', 'empty': 'False', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_colors': 'True', 'indirect_selection': 'eager', 'version_check': 'True', 'no_print': 'None', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error': 'None', 'cache_selected_only': 'False', 'printer_width': '80'}
[0m09:36:07.861397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c7f29517-e224-4c51-bc63-74c9484da7ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x762fc46d1ad0>]}
[0m09:36:07.917190 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c7f29517-e224-4c51-bc63-74c9484da7ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x762fc7e347d0>]}
[0m09:36:07.921594 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:36:08.035565 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:36:09.859949 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:36:09.861302 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:36:09.897388 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c7f29517-e224-4c51-bc63-74c9484da7ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x762fc3f50890>]}
[0m09:36:10.111642 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:36:10.124487 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:36:10.152292 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c7f29517-e224-4c51-bc63-74c9484da7ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x762fc3351190>]}
[0m09:36:10.153396 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m09:36:10.154441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c7f29517-e224-4c51-bc63-74c9484da7ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x762fc33c4710>]}
[0m09:36:10.156445 [info ] [MainThread]: 
[0m09:36:10.157784 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:36:10.159022 [info ] [MainThread]: 
[0m09:36:10.160045 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:36:10.161728 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:36:10.312063 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:36:10.314040 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:36:10.315952 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:36:10.335302 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m09:36:10.338105 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:36:10.341961 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:36:10.349230 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:36:10.350546 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:36:10.351853 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:36:10.364248 [debug] [ThreadPool]: SQL status: BEGIN in 0.012 seconds
[0m09:36:10.365887 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:36:10.367291 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:36:10.374207 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m09:36:10.377132 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:36:10.378831 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:36:10.385075 [debug] [MainThread]: Using postgres connection "master"
[0m09:36:10.386389 [debug] [MainThread]: On master: BEGIN
[0m09:36:10.388211 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:36:10.400713 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m09:36:10.402021 [debug] [MainThread]: Using postgres connection "master"
[0m09:36:10.403165 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:36:10.410850 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m09:36:10.413950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c7f29517-e224-4c51-bc63-74c9484da7ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x762fc2f70850>]}
[0m09:36:10.415311 [debug] [MainThread]: On master: ROLLBACK
[0m09:36:10.416918 [debug] [MainThread]: Using postgres connection "master"
[0m09:36:10.417926 [debug] [MainThread]: On master: BEGIN
[0m09:36:10.419359 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:36:10.420999 [debug] [MainThread]: On master: COMMIT
[0m09:36:10.422074 [debug] [MainThread]: Using postgres connection "master"
[0m09:36:10.423214 [debug] [MainThread]: On master: COMMIT
[0m09:36:10.424480 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:36:10.425468 [debug] [MainThread]: On master: Close
[0m09:36:10.434939 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:36:10.457850 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:36:10.461273 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:36:10.463132 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:36:10.491955 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:36:10.504603 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:36:10.541615 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:36:10.553674 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:36:10.555295 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:36:10.557332 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:36:10.567261 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m09:36:10.568568 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:36:10.569576 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:36:10.588165 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.018 seconds
[0m09:36:10.594930 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:36:10.596071 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:36:10.597899 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:36:10.602798 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:36:10.603867 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:36:10.606324 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:36:10.617609 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:36:10.618496 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:36:10.619648 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:36:10.622074 [debug] [Thread-1 (]: SQL status: COMMIT in 0.001 seconds
[0m09:36:10.627774 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:36:10.633498 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:36:10.634459 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:36:10.639794 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m09:36:10.643016 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:36:10.645555 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c7f29517-e224-4c51-bc63-74c9484da7ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x762fc46d0350>]}
[0m09:36:10.647062 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.18s]
[0m09:36:10.648526 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:36:10.651057 [debug] [MainThread]: Using postgres connection "master"
[0m09:36:10.651884 [debug] [MainThread]: On master: BEGIN
[0m09:36:10.652673 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:36:10.661747 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m09:36:10.663208 [debug] [MainThread]: On master: COMMIT
[0m09:36:10.664143 [debug] [MainThread]: Using postgres connection "master"
[0m09:36:10.664879 [debug] [MainThread]: On master: COMMIT
[0m09:36:10.665762 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:36:10.666651 [debug] [MainThread]: On master: Close
[0m09:36:10.667737 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:36:10.668582 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:36:10.670108 [info ] [MainThread]: 
[0m09:36:10.671100 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.51 seconds (0.51s).
[0m09:36:10.672406 [debug] [MainThread]: Command end result
[0m09:36:10.746671 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:36:10.758548 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:36:10.774719 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:36:10.778316 [info ] [MainThread]: 
[0m09:36:10.780150 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:36:10.782348 [info ] [MainThread]: 
[0m09:36:10.783962 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m09:36:10.787455 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.1650448, "process_in_blocks": "0", "process_kernel_time": 0.855282, "process_mem_max_rss": "127556", "process_out_blocks": "0", "process_user_time": 1.79932}
[0m09:36:10.789079 [debug] [MainThread]: Command `dbt run` succeeded at 09:36:10.788886 after 3.17 seconds
[0m09:36:10.790414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x762fc50c20d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x762fc5460510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x762fc99b7890>]}
[0m09:36:10.792143 [debug] [MainThread]: Flushing usage events
[0m09:36:11.448326 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:37:13.474911 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70b5f89d23d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70b5f89d2350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70b5f89d2a50>]}


============================== 09:37:13.480142 | 65e76ccc-417b-4401-9bc1-1313445a1436 ==============================
[0m09:37:13.480142 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:37:13.481295 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'introspect': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'use_experimental_parser': 'False', 'warn_error': 'None', 'partial_parse': 'True', 'indirect_selection': 'eager', 'target_path': 'None', 'write_json': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'printer_width': '80', 'use_colors': 'True', 'invocation_command': 'dbt run', 'empty': 'False', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'debug': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'fail_fast': 'False', 'quiet': 'False', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True', 'version_check': 'True', 'no_print': 'None'}
[0m09:37:13.615852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '65e76ccc-417b-4401-9bc1-1313445a1436', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70b5f7d21910>]}
[0m09:37:13.659246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '65e76ccc-417b-4401-9bc1-1313445a1436', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70b5fb6da890>]}
[0m09:37:13.662193 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:37:13.783336 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:37:15.493288 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:37:15.494169 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:37:15.524808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '65e76ccc-417b-4401-9bc1-1313445a1436', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70b5f75c8c90>]}
[0m09:37:15.641378 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:37:15.647044 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:37:15.767921 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '65e76ccc-417b-4401-9bc1-1313445a1436', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70b5f694ccd0>]}
[0m09:37:15.769263 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m09:37:15.770380 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '65e76ccc-417b-4401-9bc1-1313445a1436', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70b5f69be590>]}
[0m09:37:15.772658 [info ] [MainThread]: 
[0m09:37:15.773827 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:37:15.774897 [info ] [MainThread]: 
[0m09:37:15.775965 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:37:15.777722 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:37:15.917276 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:37:15.918954 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:37:15.920090 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:37:15.935129 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.015 seconds
[0m09:37:15.938077 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:37:15.940366 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:37:15.946684 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:37:15.947700 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:37:15.949769 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:37:15.957688 [debug] [ThreadPool]: SQL status: BEGIN in 0.008 seconds
[0m09:37:15.958999 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:37:15.959957 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:37:15.965410 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.004 seconds
[0m09:37:15.967601 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:37:15.968923 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:37:15.974315 [debug] [MainThread]: Using postgres connection "master"
[0m09:37:15.975291 [debug] [MainThread]: On master: BEGIN
[0m09:37:15.975958 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:37:15.983217 [debug] [MainThread]: SQL status: BEGIN in 0.007 seconds
[0m09:37:15.984103 [debug] [MainThread]: Using postgres connection "master"
[0m09:37:15.984964 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:37:15.990331 [debug] [MainThread]: SQL status: SELECT 1 in 0.005 seconds
[0m09:37:15.992010 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '65e76ccc-417b-4401-9bc1-1313445a1436', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70b5f6568b10>]}
[0m09:37:15.992883 [debug] [MainThread]: On master: ROLLBACK
[0m09:37:15.993719 [debug] [MainThread]: Using postgres connection "master"
[0m09:37:15.994404 [debug] [MainThread]: On master: BEGIN
[0m09:37:15.995586 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:37:15.996628 [debug] [MainThread]: On master: COMMIT
[0m09:37:15.997424 [debug] [MainThread]: Using postgres connection "master"
[0m09:37:15.999062 [debug] [MainThread]: On master: COMMIT
[0m09:37:15.999925 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:37:16.000808 [debug] [MainThread]: On master: Close
[0m09:37:16.006358 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:37:16.007390 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:37:16.008406 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:37:16.009401 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:37:16.023195 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:37:16.032065 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:37:16.054471 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:37:16.064006 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:37:16.065455 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:37:16.066343 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:37:16.075740 [debug] [Thread-1 (]: SQL status: BEGIN in 0.009 seconds
[0m09:37:16.076750 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:37:16.077832 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:37:16.088937 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.010 seconds
[0m09:37:16.096743 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:37:16.097929 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:37:16.100700 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:37:16.105176 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:37:16.106050 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:37:16.107972 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:37:16.118154 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:37:16.119068 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:37:16.119902 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:37:16.123280 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m09:37:16.127722 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:37:16.131623 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:37:16.133226 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:37:16.138650 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m09:37:16.140827 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:37:16.142514 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '65e76ccc-417b-4401-9bc1-1313445a1436', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70b5f7db20d0>]}
[0m09:37:16.143568 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.13s]
[0m09:37:16.145063 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:37:16.160346 [debug] [MainThread]: Using postgres connection "master"
[0m09:37:16.169106 [debug] [MainThread]: On master: BEGIN
[0m09:37:16.170809 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:37:16.182285 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m09:37:16.185405 [debug] [MainThread]: On master: COMMIT
[0m09:37:16.186856 [debug] [MainThread]: Using postgres connection "master"
[0m09:37:16.188168 [debug] [MainThread]: On master: COMMIT
[0m09:37:16.190363 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:37:16.192153 [debug] [MainThread]: On master: Close
[0m09:37:16.194237 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:37:16.195398 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:37:16.196637 [info ] [MainThread]: 
[0m09:37:16.197874 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.42 seconds (0.42s).
[0m09:37:16.199800 [debug] [MainThread]: Command end result
[0m09:37:16.249673 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:37:16.255078 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:37:16.265842 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:37:16.266934 [info ] [MainThread]: 
[0m09:37:16.268549 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:37:16.269693 [info ] [MainThread]: 
[0m09:37:16.270557 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m09:37:16.272166 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.8633027, "process_in_blocks": "0", "process_kernel_time": 0.688627, "process_mem_max_rss": "127084", "process_out_blocks": "0", "process_user_time": 1.694765}
[0m09:37:16.273074 [debug] [MainThread]: Command `dbt run` succeeded at 09:37:16.272955 after 2.86 seconds
[0m09:37:16.273979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70b5f896ea50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70b5f896c590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70b5fd1badd0>]}
[0m09:37:16.274734 [debug] [MainThread]: Flushing usage events
[0m09:37:16.882205 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:38:18.956665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a9f5c36710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a9f5c01050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a9f5c36e50>]}


============================== 09:38:18.968375 | a4c55814-ca57-4601-a031-c02ea173784f ==============================
[0m09:38:18.968375 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:38:18.971849 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'log_format': 'default', 'warn_error': 'None', 'introspect': 'True', 'use_experimental_parser': 'False', 'fail_fast': 'False', 'partial_parse': 'True', 'printer_width': '80', 'profiles_dir': '/usr/app/dbt/dbt', 'debug': 'False', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_cache_events': 'False', 'quiet': 'False', 'no_print': 'None', 'use_colors': 'True', 'version_check': 'True', 'static_parser': 'True', 'empty': 'False', 'cache_selected_only': 'False', 'write_json': 'True'}
[0m09:38:19.206733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a4c55814-ca57-4601-a031-c02ea173784f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a9f5c77850>]}
[0m09:38:19.251184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a4c55814-ca57-4601-a031-c02ea173784f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a9f8936b50>]}
[0m09:38:19.253840 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:38:19.404693 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:38:21.388783 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:38:21.389677 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:38:21.420458 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a4c55814-ca57-4601-a031-c02ea173784f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a9f4748f50>]}
[0m09:38:21.548085 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:38:21.557751 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:38:21.595531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a4c55814-ca57-4601-a031-c02ea173784f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a9f4bfa210>]}
[0m09:38:21.597189 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m09:38:21.598571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a4c55814-ca57-4601-a031-c02ea173784f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a9f3bbaa50>]}
[0m09:38:21.601233 [info ] [MainThread]: 
[0m09:38:21.602641 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:38:21.603973 [info ] [MainThread]: 
[0m09:38:21.605495 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:38:21.607648 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:38:21.735169 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:38:21.736513 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:38:21.739338 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:38:21.757456 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m09:38:21.759915 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:38:21.762994 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:38:21.769283 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:38:21.770894 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:38:21.772184 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:38:21.781134 [debug] [ThreadPool]: SQL status: BEGIN in 0.009 seconds
[0m09:38:21.782298 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:38:21.783210 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:38:21.790717 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m09:38:21.792499 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:38:21.793497 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:38:21.797438 [debug] [MainThread]: Using postgres connection "master"
[0m09:38:21.798361 [debug] [MainThread]: On master: BEGIN
[0m09:38:21.799023 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:38:21.806805 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m09:38:21.807618 [debug] [MainThread]: Using postgres connection "master"
[0m09:38:21.808363 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:38:21.814307 [debug] [MainThread]: SQL status: SELECT 1 in 0.005 seconds
[0m09:38:21.815917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a4c55814-ca57-4601-a031-c02ea173784f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a9f2a0ec10>]}
[0m09:38:21.817405 [debug] [MainThread]: On master: ROLLBACK
[0m09:38:21.818348 [debug] [MainThread]: Using postgres connection "master"
[0m09:38:21.819015 [debug] [MainThread]: On master: BEGIN
[0m09:38:21.820008 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:38:21.820738 [debug] [MainThread]: On master: COMMIT
[0m09:38:21.821537 [debug] [MainThread]: Using postgres connection "master"
[0m09:38:21.822271 [debug] [MainThread]: On master: COMMIT
[0m09:38:21.823065 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:38:21.823752 [debug] [MainThread]: On master: Close
[0m09:38:21.828137 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:38:21.829144 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:38:21.830014 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:38:21.830737 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:38:21.843767 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:38:21.853277 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:38:21.877025 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:38:21.885543 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:38:21.886337 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:38:21.887196 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:38:21.895292 [debug] [Thread-1 (]: SQL status: BEGIN in 0.008 seconds
[0m09:38:21.896572 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:38:21.897566 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:38:21.905483 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.007 seconds
[0m09:38:21.910821 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:38:21.911704 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:38:21.913732 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:38:21.917483 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:38:21.919294 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:38:21.920897 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:38:21.930939 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:38:21.931861 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:38:21.932627 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:38:21.937862 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m09:38:21.944172 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:38:21.972194 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:38:21.973919 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:38:21.982571 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.007 seconds
[0m09:38:21.985790 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:38:21.988527 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4c55814-ca57-4601-a031-c02ea173784f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a9f471e0d0>]}
[0m09:38:21.997209 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.16s]
[0m09:38:21.998772 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:38:22.001254 [debug] [MainThread]: Using postgres connection "master"
[0m09:38:22.001973 [debug] [MainThread]: On master: BEGIN
[0m09:38:22.002769 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:38:22.010107 [debug] [MainThread]: SQL status: BEGIN in 0.007 seconds
[0m09:38:22.011072 [debug] [MainThread]: On master: COMMIT
[0m09:38:22.011904 [debug] [MainThread]: Using postgres connection "master"
[0m09:38:22.012781 [debug] [MainThread]: On master: COMMIT
[0m09:38:22.013952 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:38:22.014685 [debug] [MainThread]: On master: Close
[0m09:38:22.015623 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:38:22.017791 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:38:22.018569 [info ] [MainThread]: 
[0m09:38:22.019934 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.41 seconds (0.41s).
[0m09:38:22.026148 [debug] [MainThread]: Command end result
[0m09:38:22.144546 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:38:22.163363 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:38:22.178976 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:38:22.182423 [info ] [MainThread]: 
[0m09:38:22.184807 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:38:22.186898 [info ] [MainThread]: 
[0m09:38:22.188584 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m09:38:22.191924 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.3354712, "process_in_blocks": "0", "process_kernel_time": 0.577026, "process_mem_max_rss": "128172", "process_out_blocks": "0", "process_user_time": 1.711044}
[0m09:38:22.194656 [debug] [MainThread]: Command `dbt run` succeeded at 09:38:22.194404 after 3.34 seconds
[0m09:38:22.198447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a9f5bd2810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a9f5c42950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78a9fa4c38d0>]}
[0m09:38:22.201498 [debug] [MainThread]: Flushing usage events
[0m09:38:22.743141 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:42:28.635940 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c93d136310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c93d13e890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c93d13ded0>]}


============================== 09:42:28.642320 | 14eec1f3-ba1e-4c27-9abc-d626002c7aa0 ==============================
[0m09:42:28.642320 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:42:28.643957 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'warn_error': 'None', 'indirect_selection': 'eager', 'write_json': 'True', 'target_path': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'version_check': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'empty': 'False', 'invocation_command': 'dbt run', 'log_format': 'default', 'debug': 'False', 'fail_fast': 'False', 'send_anonymous_usage_stats': 'True', 'use_colors': 'True', 'introspect': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'printer_width': '80', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'quiet': 'False', 'log_cache_events': 'False', 'static_parser': 'True', 'cache_selected_only': 'False'}
[0m09:42:28.806726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '14eec1f3-ba1e-4c27-9abc-d626002c7aa0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c93c5cf650>]}
[0m09:42:28.861758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '14eec1f3-ba1e-4c27-9abc-d626002c7aa0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c93fe5a750>]}
[0m09:42:28.864434 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:42:28.994120 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:42:31.073856 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:42:31.078073 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:42:31.116313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '14eec1f3-ba1e-4c27-9abc-d626002c7aa0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c93b5ec650>]}
[0m09:42:31.228972 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:42:31.237593 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:42:31.281170 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '14eec1f3-ba1e-4c27-9abc-d626002c7aa0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c93ad956d0>]}
[0m09:42:31.283181 [info ] [MainThread]: Found 1 model, 2 data tests, 1 source, 738 macros
[0m09:42:31.284933 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '14eec1f3-ba1e-4c27-9abc-d626002c7aa0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c93bdf8d90>]}
[0m09:42:31.289154 [info ] [MainThread]: 
[0m09:42:31.291773 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:42:31.293915 [info ] [MainThread]: 
[0m09:42:31.296116 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:42:31.298596 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:42:31.455224 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:42:31.457668 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:42:31.460505 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:42:31.481119 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.021 seconds
[0m09:42:31.484752 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:42:31.488199 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:42:31.497289 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:42:31.499154 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:42:31.505327 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:42:31.515188 [debug] [ThreadPool]: SQL status: BEGIN in 0.010 seconds
[0m09:42:31.517425 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:42:31.518582 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:42:31.525035 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m09:42:31.528696 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:42:31.530676 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:42:31.537182 [debug] [MainThread]: Using postgres connection "master"
[0m09:42:31.538481 [debug] [MainThread]: On master: BEGIN
[0m09:42:31.539520 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:42:31.548871 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m09:42:31.550381 [debug] [MainThread]: Using postgres connection "master"
[0m09:42:31.551508 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:42:31.560928 [debug] [MainThread]: SQL status: SELECT 1 in 0.008 seconds
[0m09:42:31.563492 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '14eec1f3-ba1e-4c27-9abc-d626002c7aa0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c93a0c8850>]}
[0m09:42:31.564785 [debug] [MainThread]: On master: ROLLBACK
[0m09:42:31.565988 [debug] [MainThread]: Using postgres connection "master"
[0m09:42:31.566943 [debug] [MainThread]: On master: BEGIN
[0m09:42:31.568590 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m09:42:31.569736 [debug] [MainThread]: On master: COMMIT
[0m09:42:31.570719 [debug] [MainThread]: Using postgres connection "master"
[0m09:42:31.571629 [debug] [MainThread]: On master: COMMIT
[0m09:42:31.572732 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:42:31.573682 [debug] [MainThread]: On master: Close
[0m09:42:31.584000 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:42:31.586367 [info ] [Thread-1 (]: 1 of 1 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:42:31.588450 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:42:31.590294 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:42:31.607445 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:42:31.619606 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:42:31.657354 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:42:31.670085 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:42:31.671571 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:42:31.673008 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:42:31.688241 [debug] [Thread-1 (]: SQL status: BEGIN in 0.015 seconds
[0m09:42:31.690313 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:42:31.693778 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:42:31.702857 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.007 seconds
[0m09:42:31.713343 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:42:31.715031 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:42:31.718129 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:42:31.724370 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:42:31.728612 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:42:31.731773 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:42:31.752136 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:42:31.754354 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:42:31.756254 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:42:31.764688 [debug] [Thread-1 (]: SQL status: COMMIT in 0.005 seconds
[0m09:42:31.777421 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:42:31.783315 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:42:31.784342 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:42:31.788776 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.003 seconds
[0m09:42:31.792009 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:42:31.794867 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '14eec1f3-ba1e-4c27-9abc-d626002c7aa0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c939f6c6d0>]}
[0m09:42:31.796020 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.21s]
[0m09:42:31.797364 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:42:31.799546 [debug] [MainThread]: Using postgres connection "master"
[0m09:42:31.800594 [debug] [MainThread]: On master: BEGIN
[0m09:42:31.801360 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:42:31.812961 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m09:42:31.814343 [debug] [MainThread]: On master: COMMIT
[0m09:42:31.815368 [debug] [MainThread]: Using postgres connection "master"
[0m09:42:31.816262 [debug] [MainThread]: On master: COMMIT
[0m09:42:31.817473 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:42:31.818327 [debug] [MainThread]: On master: Close
[0m09:42:31.819213 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:42:31.819994 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:42:31.820798 [info ] [MainThread]: 
[0m09:42:31.821913 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.53 seconds (0.53s).
[0m09:42:31.822858 [debug] [MainThread]: Command end result
[0m09:42:31.871516 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:42:31.879257 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:42:31.890601 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:42:31.892132 [info ] [MainThread]: 
[0m09:42:31.893254 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:42:31.894158 [info ] [MainThread]: 
[0m09:42:31.895287 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=1
[0m09:42:31.896848 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.3333101, "process_in_blocks": "0", "process_kernel_time": 0.757298, "process_mem_max_rss": "127928", "process_out_blocks": "0", "process_user_time": 1.957019}
[0m09:42:31.897705 [debug] [MainThread]: Command `dbt run` succeeded at 09:42:31.897620 after 3.33 seconds
[0m09:42:31.898532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c94194ae50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c94194ae90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77c93df85c10>]}
[0m09:42:31.899353 [debug] [MainThread]: Flushing usage events
[0m09:42:32.442338 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:43:34.815944 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aa589a3d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aa5858d50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aa5899f90>]}


============================== 09:43:34.821788 | 0a77c166-5f83-4fa9-8434-24ffbbb5f673 ==============================
[0m09:43:34.821788 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:43:34.822788 [debug] [MainThread]: running dbt with arguments {'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'printer_width': '80', 'warn_error': 'None', 'use_experimental_parser': 'False', 'fail_fast': 'False', 'target_path': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'quiet': 'False', 'cache_selected_only': 'False', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'partial_parse': 'True', 'log_format': 'default', 'profiles_dir': '/usr/app/dbt/dbt', 'version_check': 'True', 'debug': 'False', 'log_cache_events': 'False', 'write_json': 'True', 'use_colors': 'True', 'indirect_selection': 'eager', 'introspect': 'True', 'no_print': 'None'}
[0m09:43:34.964803 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0a77c166-5f83-4fa9-8434-24ffbbb5f673', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aa49c2ad0>]}
[0m09:43:35.019131 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0a77c166-5f83-4fa9-8434-24ffbbb5f673', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aa85bab50>]}
[0m09:43:35.022127 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:43:35.143442 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:43:36.846087 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m09:43:36.848445 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m09:43:37.183819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0a77c166-5f83-4fa9-8434-24ffbbb5f673', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aa3057410>]}
[0m09:43:37.318731 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:43:37.348124 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:43:37.425203 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0a77c166-5f83-4fa9-8434-24ffbbb5f673', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aa3d7cbd0>]}
[0m09:43:37.428903 [info ] [MainThread]: Found 2 models, 2 data tests, 1 source, 738 macros
[0m09:43:37.431273 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a77c166-5f83-4fa9-8434-24ffbbb5f673', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aa454e710>]}
[0m09:43:37.438284 [info ] [MainThread]: 
[0m09:43:37.441103 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:43:37.443643 [info ] [MainThread]: 
[0m09:43:37.446503 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:43:37.452815 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:43:37.541226 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:43:37.543124 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:43:37.544274 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:43:37.557746 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.013 seconds
[0m09:43:37.560199 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:43:37.564617 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:43:37.573682 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:43:37.574833 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:43:37.575696 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:43:37.585834 [debug] [ThreadPool]: SQL status: BEGIN in 0.010 seconds
[0m09:43:37.587172 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:43:37.588264 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:43:37.594108 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m09:43:37.596431 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:43:37.597793 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:43:37.602813 [debug] [MainThread]: Using postgres connection "master"
[0m09:43:37.603930 [debug] [MainThread]: On master: BEGIN
[0m09:43:37.604717 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:43:37.612592 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m09:43:37.613839 [debug] [MainThread]: Using postgres connection "master"
[0m09:43:37.614745 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:43:37.620614 [debug] [MainThread]: SQL status: SELECT 1 in 0.005 seconds
[0m09:43:37.622801 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a77c166-5f83-4fa9-8434-24ffbbb5f673', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aa02a0290>]}
[0m09:43:37.624083 [debug] [MainThread]: On master: ROLLBACK
[0m09:43:37.625307 [debug] [MainThread]: Using postgres connection "master"
[0m09:43:37.626422 [debug] [MainThread]: On master: BEGIN
[0m09:43:37.627754 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:43:37.629173 [debug] [MainThread]: On master: COMMIT
[0m09:43:37.630414 [debug] [MainThread]: Using postgres connection "master"
[0m09:43:37.631464 [debug] [MainThread]: On master: COMMIT
[0m09:43:37.632567 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:43:37.633633 [debug] [MainThread]: On master: Close
[0m09:43:37.640625 [debug] [Thread-1 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:43:37.641130 [debug] [Thread-2 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:43:37.642177 [info ] [Thread-1 (]: 1 of 2 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:43:37.643296 [info ] [Thread-2 (]: 2 of 2 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:43:37.644225 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.int_air_quality_hourly)
[0m09:43:37.645844 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.data_project_1.stg_air_quality_valencia'
[0m09:43:37.647075 [debug] [Thread-1 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:43:37.648970 [debug] [Thread-2 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:43:37.655737 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:43:37.667241 [debug] [Thread-2 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:43:37.667916 [debug] [Thread-1 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:43:37.692065 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:43:37.694496 [debug] [Thread-2 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:43:37.708367 [debug] [Thread-2 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:43:37.718840 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:43:37.720123 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:43:37.720597 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:43:37.721455 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:43:37.722680 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:43:37.724757 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m09:43:37.734279 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m09:43:37.735649 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:43:37.736047 [debug] [Thread-2 (]: SQL status: BEGIN in 0.011 seconds
[0m09:43:37.736965 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    
  );
  
[0m09:43:37.738004 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:43:37.740017 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:43:37.741037 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ")"
LINE 13:   );
           ^

[0m09:43:37.742135 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:43:37.745372 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:43:37.749376 [debug] [Thread-2 (]: SQL status: CREATE VIEW in 0.008 seconds
[0m09:43:37.755608 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:43:37.757014 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:43:37.759756 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:43:37.763733 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:43:37.765622 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:43:37.766737 [debug] [Thread-1 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ")"
  LINE 13:   );
             ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:43:37.774706 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:43:37.778434 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a77c166-5f83-4fa9-8434-24ffbbb5f673', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aa41fb550>]}
[0m09:43:37.790020 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:43:37.791113 [error] [Thread-1 (]: 1 of 2 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.13s]
[0m09:43:37.792230 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:43:37.793678 [debug] [Thread-1 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:43:37.794952 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:43:37.797679 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ")"
  LINE 13:   );
             ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:43:37.801848 [debug] [Thread-2 (]: SQL status: COMMIT in 0.003 seconds
[0m09:43:37.809857 [debug] [Thread-2 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:43:37.817858 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:43:37.827307 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:43:37.836087 [debug] [Thread-2 (]: SQL status: DROP VIEW in 0.007 seconds
[0m09:43:37.840976 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:43:37.843421 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a77c166-5f83-4fa9-8434-24ffbbb5f673', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aa01219d0>]}
[0m09:43:37.847438 [info ] [Thread-2 (]: 2 of 2 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.20s]
[0m09:43:37.849380 [debug] [Thread-2 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:43:37.855346 [debug] [MainThread]: Using postgres connection "master"
[0m09:43:37.858332 [debug] [MainThread]: On master: BEGIN
[0m09:43:37.860330 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:43:37.873566 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m09:43:37.875360 [debug] [MainThread]: On master: COMMIT
[0m09:43:37.876802 [debug] [MainThread]: Using postgres connection "master"
[0m09:43:37.878476 [debug] [MainThread]: On master: COMMIT
[0m09:43:37.881339 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:43:37.883501 [debug] [MainThread]: On master: Close
[0m09:43:37.885243 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:43:37.886491 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:43:37.887346 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:43:37.888394 [info ] [MainThread]: 
[0m09:43:37.889251 [info ] [MainThread]: Finished running 1 table model, 1 view model in 0 hours 0 minutes and 0.44 seconds (0.44s).
[0m09:43:37.891298 [debug] [MainThread]: Command end result
[0m09:43:37.937008 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:43:37.942417 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:43:37.952170 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:43:37.953474 [info ] [MainThread]: 
[0m09:43:37.954796 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m09:43:37.955875 [info ] [MainThread]: 
[0m09:43:37.957361 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:43:37.958689 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ")"
  LINE 13:   );
             ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:43:37.959552 [info ] [MainThread]: 
[0m09:43:37.960517 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=2
[0m09:43:37.962313 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.2297273, "process_in_blocks": "0", "process_kernel_time": 0.809919, "process_mem_max_rss": "131320", "process_out_blocks": "0", "process_user_time": 2.135609}
[0m09:43:37.963386 [debug] [MainThread]: Command `dbt run` failed at 09:43:37.963259 after 3.23 seconds
[0m09:43:37.964640 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aaa09ad90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aaa09ad10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x733aa45a7a10>]}
[0m09:43:37.965952 [debug] [MainThread]: Flushing usage events
[0m09:43:38.481567 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:44:40.613203 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x787813213090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78781063b810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78781050a690>]}


============================== 09:44:40.618702 | 00b94678-a2f0-4740-8579-79835deb66dc ==============================
[0m09:44:40.618702 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:44:40.619930 [debug] [MainThread]: running dbt with arguments {'quiet': 'False', 'introspect': 'True', 'static_parser': 'True', 'write_json': 'True', 'cache_selected_only': 'False', 'log_format': 'default', 'warn_error': 'None', 'log_cache_events': 'False', 'target_path': 'None', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/app/dbt/dbt/logs', 'indirect_selection': 'eager', 'debug': 'False', 'empty': 'False', 'printer_width': '80', 'send_anonymous_usage_stats': 'True', 'no_print': 'None', 'profiles_dir': '/usr/app/dbt/dbt', 'use_experimental_parser': 'False', 'use_colors': 'True', 'version_check': 'True', 'fail_fast': 'False'}
[0m09:44:40.770728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '00b94678-a2f0-4740-8579-79835deb66dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78780f9fccd0>]}
[0m09:44:40.823806 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '00b94678-a2f0-4740-8579-79835deb66dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x787813226850>]}
[0m09:44:40.826297 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:44:40.936280 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:44:42.951004 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m09:44:42.953094 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m09:44:43.251418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '00b94678-a2f0-4740-8579-79835deb66dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78780dd1dfd0>]}
[0m09:44:43.348710 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:44:43.357986 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:44:43.403234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '00b94678-a2f0-4740-8579-79835deb66dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78780f59a4d0>]}
[0m09:44:43.405861 [info ] [MainThread]: Found 2 models, 2 data tests, 1 source, 738 macros
[0m09:44:43.407547 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '00b94678-a2f0-4740-8579-79835deb66dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78780f9c2450>]}
[0m09:44:43.410599 [info ] [MainThread]: 
[0m09:44:43.411860 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:44:43.413073 [info ] [MainThread]: 
[0m09:44:43.414444 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:44:43.419109 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:44:43.487858 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:44:43.490881 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:44:43.493167 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:44:43.513734 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.021 seconds
[0m09:44:43.517166 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:44:43.523109 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:44:43.530896 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:44:43.532053 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:44:43.533196 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:44:43.546348 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m09:44:43.547957 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:44:43.549383 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:44:43.559610 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.009 seconds
[0m09:44:43.562611 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:44:43.564263 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:44:43.571332 [debug] [MainThread]: Using postgres connection "master"
[0m09:44:43.572665 [debug] [MainThread]: On master: BEGIN
[0m09:44:43.574292 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:44:43.583410 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m09:44:43.584592 [debug] [MainThread]: Using postgres connection "master"
[0m09:44:43.585904 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:44:43.594090 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m09:44:43.596770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '00b94678-a2f0-4740-8579-79835deb66dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x78780f531110>]}
[0m09:44:43.599726 [debug] [MainThread]: On master: ROLLBACK
[0m09:44:43.601180 [debug] [MainThread]: Using postgres connection "master"
[0m09:44:43.602256 [debug] [MainThread]: On master: BEGIN
[0m09:44:43.603894 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:44:43.604939 [debug] [MainThread]: On master: COMMIT
[0m09:44:43.606100 [debug] [MainThread]: Using postgres connection "master"
[0m09:44:43.606934 [debug] [MainThread]: On master: COMMIT
[0m09:44:43.607914 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:44:43.608779 [debug] [MainThread]: On master: Close
[0m09:44:43.616081 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:44:43.617727 [info ] [Thread-1 (]: 1 of 2 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:44:43.618961 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:44:43.620085 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:44:43.632651 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:44:43.642768 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:44:43.674824 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:44:43.687731 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:44:43.688791 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:44:43.689760 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:44:43.699942 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m09:44:43.701205 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:44:43.702236 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:44:43.709963 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.006 seconds
[0m09:44:43.716225 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:44:43.717370 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:44:43.720273 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:44:43.725875 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:44:43.727064 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:44:43.729424 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:44:43.740701 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:44:43.741775 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:44:43.742578 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:44:43.745851 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m09:44:43.750793 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:44:43.758940 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:44:43.760132 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:44:43.764863 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m09:44:43.767565 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:44:43.771806 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '00b94678-a2f0-4740-8579-79835deb66dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7878104de610>]}
[0m09:44:43.773790 [info ] [Thread-1 (]: 1 of 2 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.15s]
[0m09:44:43.775387 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:44:43.776885 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:44:43.778165 [info ] [Thread-3 (]: 2 of 2 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:44:43.779570 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:44:43.780353 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:44:43.784630 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:44:43.798443 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:44:43.812831 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:44:43.865535 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:44:43.868728 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:44:43.874445 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m09:44:43.894251 [debug] [Thread-3 (]: SQL status: BEGIN in 0.020 seconds
[0m09:44:43.896597 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:44:43.898800 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT*
    FROM "data_project_1"."public"."stg_air_quality_valencia"
)

hourly AS (
    SELECT
        location_id
)
  );
  
[0m09:44:43.901896 [debug] [Thread-3 (]: Postgres adapter: Postgres error: syntax error at or near "hourly"
LINE 19: hourly AS (
         ^

[0m09:44:43.905272 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:44:43.907335 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:44:43.913099 [debug] [Thread-3 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:44:43.914861 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '00b94678-a2f0-4740-8579-79835deb66dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7878108244d0>]}
[0m09:44:43.916627 [error] [Thread-3 (]: 2 of 2 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.14s]
[0m09:44:43.918650 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:44:43.921137 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:44:43.925163 [debug] [MainThread]: Using postgres connection "master"
[0m09:44:43.926368 [debug] [MainThread]: On master: BEGIN
[0m09:44:43.927319 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:44:43.937851 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m09:44:43.939688 [debug] [MainThread]: On master: COMMIT
[0m09:44:43.940848 [debug] [MainThread]: Using postgres connection "master"
[0m09:44:43.941914 [debug] [MainThread]: On master: COMMIT
[0m09:44:43.942887 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:44:43.943791 [debug] [MainThread]: On master: Close
[0m09:44:43.944764 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:44:43.945772 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:44:43.946613 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:44:43.947401 [info ] [MainThread]: 
[0m09:44:43.948435 [info ] [MainThread]: Finished running 1 table model, 1 view model in 0 hours 0 minutes and 0.53 seconds (0.53s).
[0m09:44:43.949617 [debug] [MainThread]: Command end result
[0m09:44:43.997873 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:44:44.004189 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:44:44.012923 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:44:44.013870 [info ] [MainThread]: 
[0m09:44:44.015004 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m09:44:44.015902 [info ] [MainThread]: 
[0m09:44:44.016860 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:44:44.017957 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:44:44.018902 [info ] [MainThread]: 
[0m09:44:44.020596 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:44:44.021591 [info ] [MainThread]: 
[0m09:44:44.022521 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=2
[0m09:44:44.023923 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.476724, "process_in_blocks": "0", "process_kernel_time": 0.628287, "process_mem_max_rss": "131628", "process_out_blocks": "0", "process_user_time": 1.965412}
[0m09:44:44.024799 [debug] [MainThread]: Command `dbt run` failed at 09:44:44.024721 after 3.48 seconds
[0m09:44:44.025614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x787814d06d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x787814d06d10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x787810509dd0>]}
[0m09:44:44.026411 [debug] [MainThread]: Flushing usage events
[0m09:44:44.573550 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:45:46.776650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7646fdf66a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7646fe373190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7646fdf102d0>]}


============================== 09:45:46.783659 | 483bbf1c-f335-462d-a793-33f51751eac0 ==============================
[0m09:45:46.783659 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:45:46.785708 [debug] [MainThread]: running dbt with arguments {'use_colors': 'True', 'indirect_selection': 'eager', 'write_json': 'True', 'fail_fast': 'False', 'cache_selected_only': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'target_path': 'None', 'warn_error': 'None', 'log_format': 'default', 'log_path': '/usr/app/dbt/dbt/logs', 'empty': 'False', 'static_parser': 'True', 'use_experimental_parser': 'False', 'printer_width': '80', 'profiles_dir': '/usr/app/dbt/dbt', 'send_anonymous_usage_stats': 'True', 'version_check': 'True', 'partial_parse': 'True', 'introspect': 'True', 'quiet': 'False', 'debug': 'False', 'invocation_command': 'dbt run', 'no_print': 'None', 'log_cache_events': 'False'}
[0m09:45:46.964102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '483bbf1c-f335-462d-a793-33f51751eac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7646fdfb2d50>]}
[0m09:45:47.020560 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '483bbf1c-f335-462d-a793-33f51751eac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x764700c909d0>]}
[0m09:45:47.023243 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:45:47.143563 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:45:49.550422 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m09:45:49.556482 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m09:45:49.862913 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '483bbf1c-f335-462d-a793-33f51751eac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7646fbbdf2d0>]}
[0m09:45:49.959284 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:45:49.965893 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:45:50.001788 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '483bbf1c-f335-462d-a793-33f51751eac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7646fc76f810>]}
[0m09:45:50.002868 [info ] [MainThread]: Found 2 models, 2 data tests, 1 source, 738 macros
[0m09:45:50.003990 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '483bbf1c-f335-462d-a793-33f51751eac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7646fbbe9390>]}
[0m09:45:50.006180 [info ] [MainThread]: 
[0m09:45:50.007114 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:45:50.009438 [info ] [MainThread]: 
[0m09:45:50.010739 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:45:50.014424 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:45:50.070476 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:45:50.081584 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:45:50.089208 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:45:50.109279 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.020 seconds
[0m09:45:50.113390 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:45:50.116905 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:45:50.123830 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:45:50.126164 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:45:50.127429 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:45:50.138127 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m09:45:50.140133 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:45:50.142159 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:45:50.148010 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m09:45:50.150369 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:45:50.151623 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:45:50.156839 [debug] [MainThread]: Using postgres connection "master"
[0m09:45:50.158125 [debug] [MainThread]: On master: BEGIN
[0m09:45:50.158884 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:45:50.169176 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m09:45:50.170228 [debug] [MainThread]: Using postgres connection "master"
[0m09:45:50.173061 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:45:50.180967 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m09:45:50.183032 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '483bbf1c-f335-462d-a793-33f51751eac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7646fe69a2d0>]}
[0m09:45:50.184383 [debug] [MainThread]: On master: ROLLBACK
[0m09:45:50.185451 [debug] [MainThread]: Using postgres connection "master"
[0m09:45:50.186498 [debug] [MainThread]: On master: BEGIN
[0m09:45:50.188642 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m09:45:50.189685 [debug] [MainThread]: On master: COMMIT
[0m09:45:50.190376 [debug] [MainThread]: Using postgres connection "master"
[0m09:45:50.191199 [debug] [MainThread]: On master: COMMIT
[0m09:45:50.192254 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:45:50.193377 [debug] [MainThread]: On master: Close
[0m09:45:50.201715 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:45:50.204429 [info ] [Thread-1 (]: 1 of 2 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:45:50.208813 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:45:50.210233 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:45:50.224277 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:45:50.259247 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:45:50.289201 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:45:50.313516 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:45:50.315343 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:45:50.317920 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:45:50.331024 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m09:45:50.333462 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:45:50.335705 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:45:50.350544 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.012 seconds
[0m09:45:50.364220 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:45:50.367610 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:45:50.371917 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:45:50.378248 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:45:50.379980 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:45:50.382561 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:45:50.398352 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:45:50.400200 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:45:50.401942 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:45:50.405247 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m09:45:50.414314 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:45:50.423506 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:45:50.425816 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:45:50.431549 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m09:45:50.434943 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:45:50.438445 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '483bbf1c-f335-462d-a793-33f51751eac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76469be49e90>]}
[0m09:45:50.440053 [info ] [Thread-1 (]: 1 of 2 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.23s]
[0m09:45:50.441733 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:45:50.444114 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:45:50.446235 [info ] [Thread-3 (]: 2 of 2 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:45:50.447935 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:45:50.449250 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:45:50.452852 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:45:50.465982 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:45:50.482385 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:45:50.494653 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:45:50.495625 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:45:50.496621 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m09:45:50.509069 [debug] [Thread-3 (]: SQL status: BEGIN in 0.012 seconds
[0m09:45:50.510707 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:45:50.511992 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT*
    FROM "data_project_1"."public"."stg_air_quality_valencia"
)

hourly AS (
    SELECT
        location_id,
        satation_name, 
        pollution_type,
        DATE_TRUNC('hour'))
  );
  
[0m09:45:50.513667 [debug] [Thread-3 (]: Postgres adapter: Postgres error: syntax error at or near "hourly"
LINE 19: hourly AS (
         ^

[0m09:45:50.514961 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:45:50.516330 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:45:50.522831 [debug] [Thread-3 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:45:50.526515 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '483bbf1c-f335-462d-a793-33f51751eac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76469bebf610>]}
[0m09:45:50.528640 [error] [Thread-3 (]: 2 of 2 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.08s]
[0m09:45:50.530571 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:45:50.532130 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:45:50.537842 [debug] [MainThread]: Using postgres connection "master"
[0m09:45:50.539928 [debug] [MainThread]: On master: BEGIN
[0m09:45:50.541759 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:45:50.552119 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m09:45:50.554286 [debug] [MainThread]: On master: COMMIT
[0m09:45:50.555566 [debug] [MainThread]: Using postgres connection "master"
[0m09:45:50.556647 [debug] [MainThread]: On master: COMMIT
[0m09:45:50.558970 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:45:50.560573 [debug] [MainThread]: On master: Close
[0m09:45:50.562153 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:45:50.563451 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:45:50.565081 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:45:50.566009 [info ] [MainThread]: 
[0m09:45:50.567212 [info ] [MainThread]: Finished running 1 table model, 1 view model in 0 hours 0 minutes and 0.56 seconds (0.56s).
[0m09:45:50.569009 [debug] [MainThread]: Command end result
[0m09:45:50.674026 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:45:50.684831 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:45:50.698087 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:45:50.699504 [info ] [MainThread]: 
[0m09:45:50.701110 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m09:45:50.704691 [info ] [MainThread]: 
[0m09:45:50.706373 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:45:50.716938 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:45:50.719658 [info ] [MainThread]: 
[0m09:45:50.721387 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:45:50.723077 [info ] [MainThread]: 
[0m09:45:50.725100 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=2
[0m09:45:50.727949 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 4.010325, "process_in_blocks": "0", "process_kernel_time": 0.660699, "process_mem_max_rss": "132084", "process_out_blocks": "0", "process_user_time": 2.110234}
[0m09:45:50.729508 [debug] [MainThread]: Command `dbt run` failed at 09:45:50.729363 after 4.01 seconds
[0m09:45:50.730748 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7646fef3c9d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76469bfeab50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76469bfe9fd0>]}
[0m09:45:50.732434 [debug] [MainThread]: Flushing usage events
[0m09:45:51.254652 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:46:53.479279 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e37eb2590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e37e788d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e37e78950>]}


============================== 09:46:53.484602 | 1c704909-f0dd-4c12-9283-37f4b517f58c ==============================
[0m09:46:53.484602 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:46:53.486460 [debug] [MainThread]: running dbt with arguments {'version_check': 'True', 'empty': 'False', 'quiet': 'False', 'log_format': 'default', 'profiles_dir': '/usr/app/dbt/dbt', 'write_json': 'True', 'debug': 'False', 'target_path': 'None', 'use_experimental_parser': 'False', 'indirect_selection': 'eager', 'partial_parse': 'True', 'use_colors': 'True', 'fail_fast': 'False', 'no_print': 'None', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'introspect': 'True', 'cache_selected_only': 'False', 'printer_width': '80', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs'}
[0m09:46:53.637124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1c704909-f0dd-4c12-9283-37f4b517f58c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e37e4e310>]}
[0m09:46:53.700595 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1c704909-f0dd-4c12-9283-37f4b517f58c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e3abcd810>]}
[0m09:46:53.703282 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:46:53.885400 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:46:55.318882 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m09:46:55.320032 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m09:46:55.611198 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1c704909-f0dd-4c12-9283-37f4b517f58c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e357e86d0>]}
[0m09:46:55.754618 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:46:55.767026 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:46:55.810912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1c704909-f0dd-4c12-9283-37f4b517f58c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e3638ca10>]}
[0m09:46:55.812468 [info ] [MainThread]: Found 2 models, 2 data tests, 1 source, 738 macros
[0m09:46:55.815039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1c704909-f0dd-4c12-9283-37f4b517f58c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e36b7aad0>]}
[0m09:46:55.817758 [info ] [MainThread]: 
[0m09:46:55.818951 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:46:55.821365 [info ] [MainThread]: 
[0m09:46:55.822512 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:46:55.826574 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:46:55.888587 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:46:55.890036 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:46:55.891452 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:46:55.909944 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m09:46:55.918973 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:46:55.934919 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:46:55.952239 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:46:55.954160 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:46:55.955895 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:46:55.969512 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m09:46:55.971074 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:46:55.972546 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:46:55.979919 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m09:46:55.984098 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:46:55.985401 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:46:55.990932 [debug] [MainThread]: Using postgres connection "master"
[0m09:46:55.992059 [debug] [MainThread]: On master: BEGIN
[0m09:46:55.993282 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:46:56.003619 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m09:46:56.005012 [debug] [MainThread]: Using postgres connection "master"
[0m09:46:56.006212 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:46:56.016802 [debug] [MainThread]: SQL status: SELECT 1 in 0.009 seconds
[0m09:46:56.019268 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1c704909-f0dd-4c12-9283-37f4b517f58c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e363544d0>]}
[0m09:46:56.020501 [debug] [MainThread]: On master: ROLLBACK
[0m09:46:56.021709 [debug] [MainThread]: Using postgres connection "master"
[0m09:46:56.022650 [debug] [MainThread]: On master: BEGIN
[0m09:46:56.024015 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:46:56.025163 [debug] [MainThread]: On master: COMMIT
[0m09:46:56.026131 [debug] [MainThread]: Using postgres connection "master"
[0m09:46:56.027035 [debug] [MainThread]: On master: COMMIT
[0m09:46:56.028216 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:46:56.030828 [debug] [MainThread]: On master: Close
[0m09:46:56.038413 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:46:56.039751 [info ] [Thread-1 (]: 1 of 2 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:46:56.041013 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:46:56.041953 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:46:56.059979 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:46:56.070879 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:46:56.102253 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:46:56.113821 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:46:56.115062 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:46:56.116078 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:46:56.126428 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m09:46:56.127732 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:46:56.129224 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:46:56.141324 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.010 seconds
[0m09:46:56.148783 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:46:56.171475 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:46:56.176346 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.003 seconds
[0m09:46:56.182746 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:46:56.184563 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:46:56.187704 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:46:56.202703 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:46:56.203994 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:46:56.205067 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:46:56.208756 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m09:46:56.214380 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:46:56.223659 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:46:56.225133 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:46:56.232543 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.006 seconds
[0m09:46:56.236271 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:46:56.238927 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c704909-f0dd-4c12-9283-37f4b517f58c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e36fcaa10>]}
[0m09:46:56.240551 [info ] [Thread-1 (]: 1 of 2 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.20s]
[0m09:46:56.242926 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:46:56.245140 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:46:56.247226 [info ] [Thread-3 (]: 2 of 2 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:46:56.248533 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:46:56.249626 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:46:56.253534 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:46:56.265201 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:46:56.286693 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:46:56.298172 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:46:56.299418 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:46:56.300465 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m09:46:56.310127 [debug] [Thread-3 (]: SQL status: BEGIN in 0.010 seconds
[0m09:46:56.311350 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:46:56.312278 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT*
    FROM "data_project_1"."public"."stg_air_quality_valencia"
)

hourly AS (
    SELECT
        location_id,
        satation_name, 
        pollution_type,
        DATE_TRUNC('hour', measurament_timestamp) AS measurament_hour,
        AVG (concentration_ug_m3) AS avg_concentration_hourly,)
  );
  
[0m09:46:56.314469 [debug] [Thread-3 (]: Postgres adapter: Postgres error: syntax error at or near "hourly"
LINE 19: hourly AS (
         ^

[0m09:46:56.315429 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:46:56.316615 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:46:56.320041 [debug] [Thread-3 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:46:56.321634 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1c704909-f0dd-4c12-9283-37f4b517f58c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e15cf68d0>]}
[0m09:46:56.322889 [error] [Thread-3 (]: 2 of 2 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.07s]
[0m09:46:56.324153 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:46:56.325242 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:46:56.328226 [debug] [MainThread]: Using postgres connection "master"
[0m09:46:56.329240 [debug] [MainThread]: On master: BEGIN
[0m09:46:56.330503 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:46:56.338708 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m09:46:56.340062 [debug] [MainThread]: On master: COMMIT
[0m09:46:56.340785 [debug] [MainThread]: Using postgres connection "master"
[0m09:46:56.341503 [debug] [MainThread]: On master: COMMIT
[0m09:46:56.342401 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:46:56.343356 [debug] [MainThread]: On master: Close
[0m09:46:56.344447 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:46:56.345468 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:46:56.347186 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:46:56.348150 [info ] [MainThread]: 
[0m09:46:56.349040 [info ] [MainThread]: Finished running 1 table model, 1 view model in 0 hours 0 minutes and 0.53 seconds (0.53s).
[0m09:46:56.350290 [debug] [MainThread]: Command end result
[0m09:46:56.405696 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:46:56.410777 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:46:56.418720 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:46:56.419416 [info ] [MainThread]: 
[0m09:46:56.420426 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m09:46:56.421300 [info ] [MainThread]: 
[0m09:46:56.422190 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:46:56.422984 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:46:56.423833 [info ] [MainThread]: 
[0m09:46:56.424600 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:46:56.425441 [info ] [MainThread]: 
[0m09:46:56.426227 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=2
[0m09:46:56.427587 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.009903, "process_in_blocks": "0", "process_kernel_time": 0.689187, "process_mem_max_rss": "131892", "process_out_blocks": "0", "process_user_time": 2.035692}
[0m09:46:56.428372 [debug] [MainThread]: Command `dbt run` failed at 09:46:56.428294 after 3.01 seconds
[0m09:46:56.429104 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e3c6bacd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e3c6bac50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c6e37e4e790>]}
[0m09:46:56.430606 [debug] [MainThread]: Flushing usage events
[0m09:46:57.015800 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:47:59.140622 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280e12426d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280e12a2490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280e16a35d0>]}


============================== 09:47:59.148298 | f06d9283-eb27-48ac-9b2a-d9932f7f924d ==============================
[0m09:47:59.148298 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:47:59.150736 [debug] [MainThread]: running dbt with arguments {'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'quiet': 'False', 'write_json': 'True', 'use_colors': 'True', 'static_parser': 'True', 'warn_error': 'None', 'partial_parse': 'True', 'cache_selected_only': 'False', 'fail_fast': 'False', 'debug': 'False', 'no_print': 'None', 'indirect_selection': 'eager', 'invocation_command': 'dbt run', 'version_check': 'True', 'target_path': 'None', 'profiles_dir': '/usr/app/dbt/dbt', 'log_format': 'default', 'log_path': '/usr/app/dbt/dbt/logs', 'introspect': 'True', 'use_experimental_parser': 'False', 'printer_width': '80', 'empty': 'False', 'send_anonymous_usage_stats': 'True'}
[0m09:47:59.310007 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f06d9283-eb27-48ac-9b2a-d9932f7f924d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280e03ab010>]}
[0m09:47:59.361236 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f06d9283-eb27-48ac-9b2a-d9932f7f924d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280e3fcc710>]}
[0m09:47:59.364374 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:47:59.507561 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:48:01.348314 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:48:01.349982 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:48:01.389205 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f06d9283-eb27-48ac-9b2a-d9932f7f924d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280dfbf8850>]}
[0m09:48:01.493830 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:48:01.505651 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:48:01.539717 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f06d9283-eb27-48ac-9b2a-d9932f7f924d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280dfbe7810>]}
[0m09:48:01.541349 [info ] [MainThread]: Found 2 models, 2 data tests, 1 source, 738 macros
[0m09:48:01.542926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f06d9283-eb27-48ac-9b2a-d9932f7f924d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280deb81bd0>]}
[0m09:48:01.545360 [info ] [MainThread]: 
[0m09:48:01.546537 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:48:01.547702 [info ] [MainThread]: 
[0m09:48:01.548836 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:48:01.553035 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:48:01.689014 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:48:01.691212 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:48:01.693423 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:48:01.714412 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.021 seconds
[0m09:48:01.717251 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:48:01.720628 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:48:01.731657 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:48:01.733227 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:48:01.734623 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:48:01.747302 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m09:48:01.749037 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:48:01.750397 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:48:01.759836 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.008 seconds
[0m09:48:01.762810 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:48:01.764543 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:48:01.772584 [debug] [MainThread]: Using postgres connection "master"
[0m09:48:01.774013 [debug] [MainThread]: On master: BEGIN
[0m09:48:01.775274 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:48:01.786791 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m09:48:01.788308 [debug] [MainThread]: Using postgres connection "master"
[0m09:48:01.789645 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:48:01.797241 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m09:48:01.799373 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f06d9283-eb27-48ac-9b2a-d9932f7f924d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280e40c8250>]}
[0m09:48:01.801806 [debug] [MainThread]: On master: ROLLBACK
[0m09:48:01.804263 [debug] [MainThread]: Using postgres connection "master"
[0m09:48:01.805596 [debug] [MainThread]: On master: BEGIN
[0m09:48:01.807551 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:48:01.808559 [debug] [MainThread]: On master: COMMIT
[0m09:48:01.809426 [debug] [MainThread]: Using postgres connection "master"
[0m09:48:01.810343 [debug] [MainThread]: On master: COMMIT
[0m09:48:01.811752 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:48:01.812716 [debug] [MainThread]: On master: Close
[0m09:48:01.820584 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:48:01.821981 [info ] [Thread-1 (]: 1 of 2 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:48:01.823180 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:48:01.824190 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:48:01.841629 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:48:01.852037 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:48:01.873608 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:48:01.884459 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:48:01.885576 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:48:01.887001 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:48:01.897015 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m09:48:01.898810 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:48:01.900228 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:48:01.916858 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.015 seconds
[0m09:48:01.925792 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:48:01.927275 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:48:01.929754 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:48:01.935495 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:48:01.937847 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:48:01.941887 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:48:01.960243 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:48:01.961618 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:48:01.962925 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:48:01.966788 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m09:48:01.975005 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:48:01.979934 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:48:01.981129 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:48:01.987859 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.006 seconds
[0m09:48:01.991003 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:48:01.993823 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f06d9283-eb27-48ac-9b2a-d9932f7f924d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280de0d1750>]}
[0m09:48:01.995296 [info ] [Thread-1 (]: 1 of 2 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.17s]
[0m09:48:01.996922 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:48:01.998534 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:48:01.999576 [info ] [Thread-3 (]: 2 of 2 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:48:02.000584 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:48:02.001333 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:48:02.004446 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:48:02.011490 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:48:02.025839 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:48:02.035374 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:48:02.037492 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:48:02.038454 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m09:48:02.046858 [debug] [Thread-3 (]: SQL status: BEGIN in 0.008 seconds
[0m09:48:02.047734 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:48:02.048522 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT*
    FROM "data_project_1"."public"."stg_air_quality_valencia"
)

hourly AS (
    SELECT
        location_id,
        satation_name, 
        pollution_type,
        DATE_TRUNC('hour', measurament_timestamp) AS measurament_hour,
        AVG (concentration_ug_m3) AS avg_concentration_hourly,)
  );
  
[0m09:48:02.049549 [debug] [Thread-3 (]: Postgres adapter: Postgres error: syntax error at or near "hourly"
LINE 19: hourly AS (
         ^

[0m09:48:02.050318 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:48:02.051364 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:48:02.055829 [debug] [Thread-3 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:48:02.057790 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f06d9283-eb27-48ac-9b2a-d9932f7f924d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280de055f50>]}
[0m09:48:02.058748 [error] [Thread-3 (]: 2 of 2 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.06s]
[0m09:48:02.060145 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:48:02.061165 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:48:02.066059 [debug] [MainThread]: Using postgres connection "master"
[0m09:48:02.067137 [debug] [MainThread]: On master: BEGIN
[0m09:48:02.067908 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:48:02.075171 [debug] [MainThread]: SQL status: BEGIN in 0.007 seconds
[0m09:48:02.076048 [debug] [MainThread]: On master: COMMIT
[0m09:48:02.076766 [debug] [MainThread]: Using postgres connection "master"
[0m09:48:02.078280 [debug] [MainThread]: On master: COMMIT
[0m09:48:02.079198 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:48:02.079992 [debug] [MainThread]: On master: Close
[0m09:48:02.080766 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:48:02.081349 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:48:02.082029 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:48:02.082835 [info ] [MainThread]: 
[0m09:48:02.083653 [info ] [MainThread]: Finished running 1 table model, 1 view model in 0 hours 0 minutes and 0.53 seconds (0.53s).
[0m09:48:02.084697 [debug] [MainThread]: Command end result
[0m09:48:02.124257 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:48:02.128812 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:48:02.136857 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:48:02.137598 [info ] [MainThread]: 
[0m09:48:02.138444 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m09:48:02.139272 [info ] [MainThread]: 
[0m09:48:02.140137 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:48:02.140946 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:48:02.141690 [info ] [MainThread]: 
[0m09:48:02.142517 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:48:02.143402 [info ] [MainThread]: 
[0m09:48:02.144390 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=2
[0m09:48:02.145627 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.0951822, "process_in_blocks": "0", "process_kernel_time": 0.594001, "process_mem_max_rss": "129308", "process_out_blocks": "0", "process_user_time": 1.893628}
[0m09:48:02.146527 [debug] [MainThread]: Command `dbt run` failed at 09:48:02.146436 after 3.10 seconds
[0m09:48:02.147460 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280e125d2d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280e125c950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7280e3f9b950>]}
[0m09:48:02.148252 [debug] [MainThread]: Flushing usage events
[0m09:48:02.713972 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:49:05.560360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x712750e6e490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x712752229e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x712750e76550>]}


============================== 09:49:05.568127 | 3752b236-2c37-4fb7-a7d2-c30f74b8b0d4 ==============================
[0m09:49:05.568127 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:49:05.569676 [debug] [MainThread]: running dbt with arguments {'use_experimental_parser': 'False', 'introspect': 'True', 'write_json': 'True', 'cache_selected_only': 'False', 'log_format': 'default', 'fail_fast': 'False', 'indirect_selection': 'eager', 'use_colors': 'True', 'printer_width': '80', 'invocation_command': 'dbt run', 'quiet': 'False', 'target_path': 'None', 'log_cache_events': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'no_print': 'None', 'debug': 'False', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'send_anonymous_usage_stats': 'True', 'empty': 'False', 'version_check': 'True', 'partial_parse': 'True'}
[0m09:49:05.737840 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3752b236-2c37-4fb7-a7d2-c30f74b8b0d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x712750e191d0>]}
[0m09:49:05.782135 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3752b236-2c37-4fb7-a7d2-c30f74b8b0d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x712753b76790>]}
[0m09:49:05.785096 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:49:05.986851 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:49:08.517663 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m09:49:08.519235 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m09:49:08.852227 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3752b236-2c37-4fb7-a7d2-c30f74b8b0d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71274ed62610>]}
[0m09:49:08.966776 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:49:08.997137 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:49:09.046272 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3752b236-2c37-4fb7-a7d2-c30f74b8b0d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71274f99fad0>]}
[0m09:49:09.048311 [info ] [MainThread]: Found 2 models, 2 data tests, 1 source, 738 macros
[0m09:49:09.049450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3752b236-2c37-4fb7-a7d2-c30f74b8b0d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71274e99b010>]}
[0m09:49:09.053041 [info ] [MainThread]: 
[0m09:49:09.054356 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:49:09.059407 [info ] [MainThread]: 
[0m09:49:09.060767 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:49:09.065153 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:49:09.145167 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:49:09.146771 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:49:09.147837 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:49:09.166967 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m09:49:09.170324 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:49:09.180717 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:49:09.205900 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:49:09.208695 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:49:09.210220 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:49:09.223676 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m09:49:09.225720 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:49:09.227120 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:49:09.238342 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.010 seconds
[0m09:49:09.240846 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:49:09.242460 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:49:09.248669 [debug] [MainThread]: Using postgres connection "master"
[0m09:49:09.250420 [debug] [MainThread]: On master: BEGIN
[0m09:49:09.251598 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:49:09.262266 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m09:49:09.263700 [debug] [MainThread]: Using postgres connection "master"
[0m09:49:09.265016 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:49:09.278010 [debug] [MainThread]: SQL status: SELECT 1 in 0.008 seconds
[0m09:49:09.280937 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3752b236-2c37-4fb7-a7d2-c30f74b8b0d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x712753c7c550>]}
[0m09:49:09.282982 [debug] [MainThread]: On master: ROLLBACK
[0m09:49:09.284906 [debug] [MainThread]: Using postgres connection "master"
[0m09:49:09.286690 [debug] [MainThread]: On master: BEGIN
[0m09:49:09.288690 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:49:09.290271 [debug] [MainThread]: On master: COMMIT
[0m09:49:09.292105 [debug] [MainThread]: Using postgres connection "master"
[0m09:49:09.293220 [debug] [MainThread]: On master: COMMIT
[0m09:49:09.294576 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:49:09.295652 [debug] [MainThread]: On master: Close
[0m09:49:09.301719 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:49:09.302894 [info ] [Thread-1 (]: 1 of 2 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:49:09.304186 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:49:09.305069 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:49:09.320773 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:49:09.335885 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:49:09.360222 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:49:09.370628 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:49:09.372146 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:49:09.373134 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:49:09.384834 [debug] [Thread-1 (]: SQL status: BEGIN in 0.012 seconds
[0m09:49:09.386291 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:49:09.388746 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:49:09.409796 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.020 seconds
[0m09:49:09.417093 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:49:09.420741 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:49:09.423218 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:49:09.427494 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:49:09.428627 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:49:09.430402 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:49:09.440764 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:49:09.449732 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:49:09.453821 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:49:09.468667 [debug] [Thread-1 (]: SQL status: COMMIT in 0.013 seconds
[0m09:49:09.481280 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:49:09.488465 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:49:09.489739 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:49:09.495849 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m09:49:09.500166 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:49:09.503873 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3752b236-2c37-4fb7-a7d2-c30f74b8b0d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x712736d8df50>]}
[0m09:49:09.505383 [info ] [Thread-1 (]: 1 of 2 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.20s]
[0m09:49:09.506856 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:49:09.508880 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:49:09.509678 [info ] [Thread-3 (]: 2 of 2 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:49:09.510696 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:49:09.511661 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:49:09.515175 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:49:09.526324 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:49:09.542292 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:49:09.562720 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:49:09.564669 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:49:09.566885 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m09:49:09.577819 [debug] [Thread-3 (]: SQL status: BEGIN in 0.011 seconds
[0m09:49:09.580189 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:49:09.582124 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT*
    FROM "data_project_1"."public"."stg_air_quality_valencia"
)

hourly AS (
    SELECT
        location_id,
        satation_name, 
        pollution_type,
        DATE_TRUNC('hour', measurament_timestamp) AS measurament_hour,
        AVG (concentration_ug_m3) AS avg_hourly,
        MIN ())
  );
  
[0m09:49:09.584254 [debug] [Thread-3 (]: Postgres adapter: Postgres error: syntax error at or near "hourly"
LINE 19: hourly AS (
         ^

[0m09:49:09.586096 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:49:09.588251 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:49:09.592922 [debug] [Thread-3 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:49:09.594924 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3752b236-2c37-4fb7-a7d2-c30f74b8b0d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x712736e489d0>]}
[0m09:49:09.596970 [error] [Thread-3 (]: 2 of 2 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.08s]
[0m09:49:09.599255 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:49:09.601245 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:49:09.605156 [debug] [MainThread]: Using postgres connection "master"
[0m09:49:09.607115 [debug] [MainThread]: On master: BEGIN
[0m09:49:09.609319 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:49:09.638810 [debug] [MainThread]: SQL status: BEGIN in 0.029 seconds
[0m09:49:09.644889 [debug] [MainThread]: On master: COMMIT
[0m09:49:09.647174 [debug] [MainThread]: Using postgres connection "master"
[0m09:49:09.649435 [debug] [MainThread]: On master: COMMIT
[0m09:49:09.651622 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:49:09.653458 [debug] [MainThread]: On master: Close
[0m09:49:09.654911 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:49:09.657889 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:49:09.661638 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:49:09.663345 [info ] [MainThread]: 
[0m09:49:09.665289 [info ] [MainThread]: Finished running 1 table model, 1 view model in 0 hours 0 minutes and 0.60 seconds (0.60s).
[0m09:49:09.666877 [debug] [MainThread]: Command end result
[0m09:49:09.756125 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:49:09.765016 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:49:09.778456 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:49:09.780243 [info ] [MainThread]: 
[0m09:49:09.782231 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m09:49:09.783236 [info ] [MainThread]: 
[0m09:49:09.784248 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:49:09.785089 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:49:09.785902 [info ] [MainThread]: 
[0m09:49:09.786971 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:49:09.787870 [info ] [MainThread]: 
[0m09:49:09.788791 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=2
[0m09:49:09.790660 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 4.2993426, "process_in_blocks": "0", "process_kernel_time": 0.977166, "process_mem_max_rss": "131640", "process_out_blocks": "0", "process_user_time": 2.430057}
[0m09:49:09.792477 [debug] [MainThread]: Command `dbt run` failed at 09:49:09.792232 after 4.30 seconds
[0m09:49:09.793891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x712755656dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x712736ecc1d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71275015d6d0>]}
[0m09:49:09.795296 [debug] [MainThread]: Flushing usage events
[0m09:49:10.328208 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:50:12.661405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x713250b4a790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x713250aea650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x713250b4a810>]}


============================== 09:50:12.667501 | 3914defc-b9b1-4fdf-862a-fd8c01dadf29 ==============================
[0m09:50:12.667501 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:50:12.669339 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'static_parser': 'True', 'quiet': 'False', 'debug': 'False', 'indirect_selection': 'eager', 'log_path': '/usr/app/dbt/dbt/logs', 'cache_selected_only': 'False', 'log_cache_events': 'False', 'target_path': 'None', 'profiles_dir': '/usr/app/dbt/dbt', 'fail_fast': 'False', 'no_print': 'None', 'send_anonymous_usage_stats': 'True', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None', 'use_experimental_parser': 'False', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'empty': 'False', 'use_colors': 'True', 'version_check': 'True', 'partial_parse': 'True'}
[0m09:50:12.826733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3914defc-b9b1-4fdf-862a-fd8c01dadf29', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x713250c5f790>]}
[0m09:50:12.876083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3914defc-b9b1-4fdf-862a-fd8c01dadf29', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71325385a750>]}
[0m09:50:12.879183 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:50:13.040073 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:50:15.064107 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m09:50:15.066424 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m09:50:15.407891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3914defc-b9b1-4fdf-862a-fd8c01dadf29', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71324e7e65d0>]}
[0m09:50:15.562634 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:50:15.578966 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:50:15.619116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3914defc-b9b1-4fdf-862a-fd8c01dadf29', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71324ebd37d0>]}
[0m09:50:15.621325 [info ] [MainThread]: Found 2 models, 2 data tests, 1 source, 738 macros
[0m09:50:15.622979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3914defc-b9b1-4fdf-862a-fd8c01dadf29', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71324f315510>]}
[0m09:50:15.627366 [info ] [MainThread]: 
[0m09:50:15.628907 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:50:15.630046 [info ] [MainThread]: 
[0m09:50:15.631452 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:50:15.638687 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:50:15.697872 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:50:15.699328 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:50:15.700474 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:50:15.714535 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.014 seconds
[0m09:50:15.717022 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:50:15.719910 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:50:15.727580 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:50:15.728754 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:50:15.730381 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:50:15.741399 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m09:50:15.745580 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:50:15.746917 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:50:15.754590 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m09:50:15.758975 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:50:15.760790 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:50:15.770046 [debug] [MainThread]: Using postgres connection "master"
[0m09:50:15.771904 [debug] [MainThread]: On master: BEGIN
[0m09:50:15.774092 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:50:15.788165 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m09:50:15.790209 [debug] [MainThread]: Using postgres connection "master"
[0m09:50:15.793238 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:50:15.804260 [debug] [MainThread]: SQL status: SELECT 1 in 0.010 seconds
[0m09:50:15.808167 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3914defc-b9b1-4fdf-862a-fd8c01dadf29', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71324f300150>]}
[0m09:50:15.809970 [debug] [MainThread]: On master: ROLLBACK
[0m09:50:15.813458 [debug] [MainThread]: Using postgres connection "master"
[0m09:50:15.815046 [debug] [MainThread]: On master: BEGIN
[0m09:50:15.817201 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:50:15.818536 [debug] [MainThread]: On master: COMMIT
[0m09:50:15.819688 [debug] [MainThread]: Using postgres connection "master"
[0m09:50:15.820950 [debug] [MainThread]: On master: COMMIT
[0m09:50:15.823243 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:50:15.825107 [debug] [MainThread]: On master: Close
[0m09:50:15.832672 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:50:15.834812 [info ] [Thread-1 (]: 1 of 2 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:50:15.837197 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:50:15.839088 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:50:15.855277 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:50:15.871649 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:50:15.906532 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:50:15.919738 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:50:15.921505 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:50:15.924750 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:50:15.936847 [debug] [Thread-1 (]: SQL status: BEGIN in 0.012 seconds
[0m09:50:15.938357 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:50:15.939693 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:50:15.954216 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.013 seconds
[0m09:50:15.961425 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:50:15.964144 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:50:15.967383 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:50:15.972453 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:50:15.973517 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:50:15.976928 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:50:15.995038 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:50:15.996678 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:50:15.998015 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:50:16.002273 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m09:50:16.009866 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:50:16.015502 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:50:16.016900 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:50:16.023591 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m09:50:16.027246 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:50:16.029385 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3914defc-b9b1-4fdf-862a-fd8c01dadf29', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71320ec81f10>]}
[0m09:50:16.030896 [info ] [Thread-1 (]: 1 of 2 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.19s]
[0m09:50:16.032321 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:50:16.035476 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:50:16.036763 [info ] [Thread-3 (]: 2 of 2 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:50:16.038112 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:50:16.038767 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:50:16.041762 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:50:16.047853 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:50:16.061909 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:50:16.070645 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:50:16.071994 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:50:16.076974 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m09:50:16.091768 [debug] [Thread-3 (]: SQL status: BEGIN in 0.015 seconds
[0m09:50:16.095817 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:50:16.098475 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT*
    FROM "data_project_1"."public"."stg_air_quality_valencia"
)

hourly AS (
    SELECT
        location_id,
        satation_name, 
        pollution_type,
        DATE_TRUNC('hour', measurament_timestamp) AS measurament_hour,
        AVG (concentration_ug_m3) AS avg_hourly,
        MIN (concentration_ug_m3) AS min_hourly,
        MAX (concentration_ug_m3) AS max_hourly,
        COUNT(*) AS num_measurements
        FROM  base
        GROUP NY 1,2,3,4
  );
  
[0m09:50:16.100319 [debug] [Thread-3 (]: Postgres adapter: Postgres error: syntax error at or near "hourly"
LINE 19: hourly AS (
         ^

[0m09:50:16.101612 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:50:16.104781 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:50:16.110713 [debug] [Thread-3 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:50:16.112140 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3914defc-b9b1-4fdf-862a-fd8c01dadf29', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71320ea6bfd0>]}
[0m09:50:16.113440 [error] [Thread-3 (]: 2 of 2 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.07s]
[0m09:50:16.114587 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:50:16.115775 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:50:16.119238 [debug] [MainThread]: Using postgres connection "master"
[0m09:50:16.123188 [debug] [MainThread]: On master: BEGIN
[0m09:50:16.125918 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:50:16.138797 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m09:50:16.140457 [debug] [MainThread]: On master: COMMIT
[0m09:50:16.141628 [debug] [MainThread]: Using postgres connection "master"
[0m09:50:16.142572 [debug] [MainThread]: On master: COMMIT
[0m09:50:16.143745 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:50:16.144893 [debug] [MainThread]: On master: Close
[0m09:50:16.146126 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:50:16.147153 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:50:16.148477 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:50:16.149651 [info ] [MainThread]: 
[0m09:50:16.151184 [info ] [MainThread]: Finished running 1 table model, 1 view model in 0 hours 0 minutes and 0.52 seconds (0.52s).
[0m09:50:16.153065 [debug] [MainThread]: Command end result
[0m09:50:16.222791 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:50:16.229940 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:50:16.240458 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:50:16.241402 [info ] [MainThread]: 
[0m09:50:16.242453 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m09:50:16.243476 [info ] [MainThread]: 
[0m09:50:16.244658 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:50:16.245995 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:50:16.247145 [info ] [MainThread]: 
[0m09:50:16.248382 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:50:16.249259 [info ] [MainThread]: 
[0m09:50:16.250225 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=2
[0m09:50:16.252641 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.6610992, "process_in_blocks": "0", "process_kernel_time": 0.668893, "process_mem_max_rss": "132172", "process_out_blocks": "0", "process_user_time": 2.157589}
[0m09:50:16.253742 [debug] [MainThread]: Command `dbt run` failed at 09:50:16.253652 after 3.66 seconds
[0m09:50:16.254732 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x713251c917d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71320ebabe10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x713250f28990>]}
[0m09:50:16.255580 [debug] [MainThread]: Flushing usage events
[0m09:50:16.878815 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:51:19.141392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a088e9f550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a088ea6890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a088e68b50>]}


============================== 09:51:19.147431 | 546095b6-50e3-4d3d-97f3-91e138d2682f ==============================
[0m09:51:19.147431 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:51:19.149136 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'static_parser': 'True', 'quiet': 'False', 'indirect_selection': 'eager', 'invocation_command': 'dbt run', 'printer_width': '80', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'no_print': 'None', 'introspect': 'True', 'version_check': 'True', 'log_cache_events': 'False', 'use_experimental_parser': 'False', 'empty': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'warn_error': 'None', 'log_format': 'default', 'partial_parse': 'True', 'target_path': 'None', 'write_json': 'True', 'fail_fast': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_colors': 'True'}
[0m09:51:19.304196 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '546095b6-50e3-4d3d-97f3-91e138d2682f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a08815e510>]}
[0m09:51:19.348586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '546095b6-50e3-4d3d-97f3-91e138d2682f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a08bb9ed10>]}
[0m09:51:19.351234 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:51:19.546496 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:51:21.577529 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m09:51:21.580069 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m09:51:21.876116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '546095b6-50e3-4d3d-97f3-91e138d2682f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a086912a10>]}
[0m09:51:21.986492 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:51:21.995746 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:51:22.033443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '546095b6-50e3-4d3d-97f3-91e138d2682f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a087980450>]}
[0m09:51:22.035833 [info ] [MainThread]: Found 2 models, 2 data tests, 1 source, 738 macros
[0m09:51:22.037822 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '546095b6-50e3-4d3d-97f3-91e138d2682f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a088187990>]}
[0m09:51:22.041403 [info ] [MainThread]: 
[0m09:51:22.042841 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:51:22.044050 [info ] [MainThread]: 
[0m09:51:22.045694 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:51:22.050442 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:51:22.136682 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:51:22.138533 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:51:22.140123 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:51:22.156384 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.016 seconds
[0m09:51:22.158914 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:51:22.161432 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:51:22.166420 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:51:22.168705 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:51:22.169809 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:51:22.177623 [debug] [ThreadPool]: SQL status: BEGIN in 0.008 seconds
[0m09:51:22.178853 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:51:22.179938 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:51:22.186922 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m09:51:22.189329 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:51:22.190697 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:51:22.195184 [debug] [MainThread]: Using postgres connection "master"
[0m09:51:22.195983 [debug] [MainThread]: On master: BEGIN
[0m09:51:22.196657 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:51:22.206329 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m09:51:22.221254 [debug] [MainThread]: Using postgres connection "master"
[0m09:51:22.223900 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:51:22.240361 [debug] [MainThread]: SQL status: SELECT 1 in 0.010 seconds
[0m09:51:22.243297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '546095b6-50e3-4d3d-97f3-91e138d2682f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a088ea6550>]}
[0m09:51:22.245035 [debug] [MainThread]: On master: ROLLBACK
[0m09:51:22.247208 [debug] [MainThread]: Using postgres connection "master"
[0m09:51:22.248892 [debug] [MainThread]: On master: BEGIN
[0m09:51:22.251238 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m09:51:22.252798 [debug] [MainThread]: On master: COMMIT
[0m09:51:22.254076 [debug] [MainThread]: Using postgres connection "master"
[0m09:51:22.255224 [debug] [MainThread]: On master: COMMIT
[0m09:51:22.256573 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:51:22.257698 [debug] [MainThread]: On master: Close
[0m09:51:22.265332 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:51:22.266507 [info ] [Thread-1 (]: 1 of 2 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:51:22.268322 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:51:22.269375 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:51:22.285989 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:51:22.296550 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:51:22.321514 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:51:22.331997 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:51:22.332927 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:51:22.337222 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:51:22.354196 [debug] [Thread-1 (]: SQL status: BEGIN in 0.017 seconds
[0m09:51:22.355943 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:51:22.357787 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:51:22.373110 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.011 seconds
[0m09:51:22.382542 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:51:22.385149 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:51:22.389957 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.003 seconds
[0m09:51:22.393828 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:51:22.395140 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:51:22.405583 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:51:22.420477 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:51:22.421970 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:51:22.423288 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:51:22.428134 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m09:51:22.436318 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:51:22.441456 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:51:22.442514 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:51:22.448019 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m09:51:22.450509 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:51:22.455286 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '546095b6-50e3-4d3d-97f3-91e138d2682f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a086de4810>]}
[0m09:51:22.457361 [info ] [Thread-1 (]: 1 of 2 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.19s]
[0m09:51:22.459190 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:51:22.461353 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:51:22.462792 [info ] [Thread-3 (]: 2 of 2 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:51:22.464095 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:51:22.465179 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:51:22.471099 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:51:22.481295 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:51:22.500177 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:51:22.510556 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:51:22.512331 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:51:22.513327 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m09:51:22.522588 [debug] [Thread-3 (]: SQL status: BEGIN in 0.009 seconds
[0m09:51:22.527941 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:51:22.529102 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT*
    FROM "data_project_1"."public"."stg_air_quality_valencia"
)

hourly AS (
    SELECT
        location_id,
        satation_name, 
        pollution_type,
        DATE_TRUNC('hour', measurament_timestamp) AS measurament_hour,
        AVG (concentration_ug_m3) AS avg_hourly,
        MIN (concentration_ug_m3) AS min_hourly,
        MAX (concentration_ug_m3) AS max_hourly,
        COUNT(*) AS num_measurements
        FROM  base
        GROUP NY 1,2,3,4

        variation AS (
            SELECT
                *, 
                avg_hourly-LAG (avg_hourly) OVER (
                    PARTITION BY location_id, pollutant_type
                    ORDER BY measurament_hour
                ) AS variation_vs_prev_hour
            FROM hourly
        )
  );
  
[0m09:51:22.530239 [debug] [Thread-3 (]: Postgres adapter: Postgres error: syntax error at or near "hourly"
LINE 19: hourly AS (
         ^

[0m09:51:22.531642 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:51:22.532770 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:51:22.536172 [debug] [Thread-3 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:51:22.537356 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '546095b6-50e3-4d3d-97f3-91e138d2682f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a064412b90>]}
[0m09:51:22.538675 [error] [Thread-3 (]: 2 of 2 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.07s]
[0m09:51:22.539749 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:51:22.540715 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:51:22.543333 [debug] [MainThread]: Using postgres connection "master"
[0m09:51:22.544089 [debug] [MainThread]: On master: BEGIN
[0m09:51:22.544989 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:51:22.552566 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m09:51:22.553614 [debug] [MainThread]: On master: COMMIT
[0m09:51:22.554391 [debug] [MainThread]: Using postgres connection "master"
[0m09:51:22.555192 [debug] [MainThread]: On master: COMMIT
[0m09:51:22.556120 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:51:22.557048 [debug] [MainThread]: On master: Close
[0m09:51:22.557860 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:51:22.558596 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:51:22.559214 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:51:22.559879 [info ] [MainThread]: 
[0m09:51:22.560758 [info ] [MainThread]: Finished running 1 table model, 1 view model in 0 hours 0 minutes and 0.51 seconds (0.51s).
[0m09:51:22.561987 [debug] [MainThread]: Command end result
[0m09:51:22.620256 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:51:22.626598 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:51:22.636292 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:51:22.637314 [info ] [MainThread]: 
[0m09:51:22.638521 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m09:51:22.639346 [info ] [MainThread]: 
[0m09:51:22.640152 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:51:22.641050 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:51:22.641803 [info ] [MainThread]: 
[0m09:51:22.642819 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:51:22.643618 [info ] [MainThread]: 
[0m09:51:22.644478 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=2
[0m09:51:22.645893 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.5745595, "process_in_blocks": "0", "process_kernel_time": 0.651281, "process_mem_max_rss": "132112", "process_out_blocks": "0", "process_user_time": 2.165509}
[0m09:51:22.646792 [debug] [MainThread]: Command `dbt run` failed at 09:51:22.646698 after 3.58 seconds
[0m09:51:22.647632 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a088e38610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a08d746950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x76a08abbd150>]}
[0m09:51:22.648489 [debug] [MainThread]: Flushing usage events
[0m09:51:23.193683 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:52:25.451156 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce2a4a3d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce2a560d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce2a49f50>]}


============================== 09:52:25.458879 | 8f56450b-c9da-451d-851e-bd3c2f7ba524 ==============================
[0m09:52:25.458879 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:52:25.460168 [debug] [MainThread]: running dbt with arguments {'fail_fast': 'False', 'debug': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'indirect_selection': 'eager', 'warn_error': 'None', 'quiet': 'False', 'cache_selected_only': 'False', 'empty': 'False', 'static_parser': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'printer_width': '80', 'no_print': 'None', 'target_path': 'None', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'introspect': 'True', 'use_colors': 'True', 'log_cache_events': 'False', 'version_check': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'write_json': 'True', 'log_format': 'default'}
[0m09:52:25.605803 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8f56450b-c9da-451d-851e-bd3c2f7ba524', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce1bee810>]}
[0m09:52:25.660426 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8f56450b-c9da-451d-851e-bd3c2f7ba524', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce575ab90>]}
[0m09:52:25.663950 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:52:25.829595 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:52:27.606138 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m09:52:27.607722 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m09:52:27.930188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8f56450b-c9da-451d-851e-bd3c2f7ba524', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce03aba90>]}
[0m09:52:28.040142 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:52:28.051019 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:52:28.102634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8f56450b-c9da-451d-851e-bd3c2f7ba524', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce03209d0>]}
[0m09:52:28.104555 [info ] [MainThread]: Found 2 models, 2 data tests, 1 source, 738 macros
[0m09:52:28.106709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f56450b-c9da-451d-851e-bd3c2f7ba524', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce17479d0>]}
[0m09:52:28.110810 [info ] [MainThread]: 
[0m09:52:28.114153 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:52:28.119316 [info ] [MainThread]: 
[0m09:52:28.123968 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:52:28.138017 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:52:28.215356 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:52:28.218760 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:52:28.222019 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:52:28.236408 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.014 seconds
[0m09:52:28.239298 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:52:28.242082 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:52:28.248847 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:52:28.250264 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:52:28.251263 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:52:28.259519 [debug] [ThreadPool]: SQL status: BEGIN in 0.008 seconds
[0m09:52:28.260715 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:52:28.261484 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:52:28.266723 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.004 seconds
[0m09:52:28.269402 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:52:28.270924 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:52:28.275398 [debug] [MainThread]: Using postgres connection "master"
[0m09:52:28.276491 [debug] [MainThread]: On master: BEGIN
[0m09:52:28.277342 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:52:28.285132 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m09:52:28.286181 [debug] [MainThread]: Using postgres connection "master"
[0m09:52:28.286996 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:52:28.292550 [debug] [MainThread]: SQL status: SELECT 1 in 0.005 seconds
[0m09:52:28.294653 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f56450b-c9da-451d-851e-bd3c2f7ba524', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce4c4a490>]}
[0m09:52:28.295552 [debug] [MainThread]: On master: ROLLBACK
[0m09:52:28.296649 [debug] [MainThread]: Using postgres connection "master"
[0m09:52:28.297610 [debug] [MainThread]: On master: BEGIN
[0m09:52:28.298712 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:52:28.299669 [debug] [MainThread]: On master: COMMIT
[0m09:52:28.300496 [debug] [MainThread]: Using postgres connection "master"
[0m09:52:28.301265 [debug] [MainThread]: On master: COMMIT
[0m09:52:28.302292 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:52:28.303049 [debug] [MainThread]: On master: Close
[0m09:52:28.308974 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:52:28.310871 [info ] [Thread-1 (]: 1 of 2 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:52:28.312383 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m09:52:28.313319 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:52:28.327015 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:52:28.343967 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:52:28.366148 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:52:28.385574 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:52:28.387008 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:52:28.388265 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:52:28.398735 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m09:52:28.400554 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:52:28.402658 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:52:28.412204 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.007 seconds
[0m09:52:28.424158 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:52:28.425684 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:52:28.430399 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:52:28.434193 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:52:28.435272 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:52:28.438698 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:52:28.453085 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:52:28.454631 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:52:28.457018 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:52:28.461620 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m09:52:28.467384 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:52:28.474238 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:52:28.477428 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:52:28.483504 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m09:52:28.487947 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:52:28.492584 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f56450b-c9da-451d-851e-bd3c2f7ba524', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce17bf650>]}
[0m09:52:28.494883 [info ] [Thread-1 (]: 1 of 2 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.18s]
[0m09:52:28.496666 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:52:28.498775 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:52:28.500679 [info ] [Thread-3 (]: 2 of 2 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:52:28.503364 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:52:28.505511 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:52:28.511152 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:52:28.524592 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:52:28.541987 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:52:28.555988 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:52:28.557086 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:52:28.558054 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m09:52:28.566325 [debug] [Thread-3 (]: SQL status: BEGIN in 0.008 seconds
[0m09:52:28.567581 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:52:28.568561 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT*
    FROM "data_project_1"."public"."stg_air_quality_valencia"
)

hourly AS (
    SELECT
        location_id,
        satation_name, 
        pollution_type,
        DATE_TRUNC('hour', measurament_timestamp) AS measurament_hour,
        AVG (concentration_ug_m3) AS avg_hourly,
        MIN (concentration_ug_m3) AS min_hourly,
        MAX (concentration_ug_m3) AS max_hourly,
        COUNT(*) AS num_measurements
        FROM  base
        GROUP NY 1,2,3,4

        variation AS (
            SELECT
                *, 
                avg_hourly-LAG (avg_hourly) OVER (
                    PARTITION BY location_id, pollutant_type
                    ORDER BY measurament_hour
                ) AS variation_vs_prev_hour
            FROM hourly
        )

SELECT * FROM variation
ORDER BY measurament_hour;
  );
  
[0m09:52:28.572389 [debug] [Thread-3 (]: Postgres adapter: Postgres error: syntax error at or near "hourly"
LINE 19: hourly AS (
         ^

[0m09:52:28.575189 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:52:28.576598 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:52:28.582326 [debug] [Thread-3 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:52:28.583845 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f56450b-c9da-451d-851e-bd3c2f7ba524', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce30d8f50>]}
[0m09:52:28.586020 [error] [Thread-3 (]: 2 of 2 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.08s]
[0m09:52:28.589747 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:52:28.591298 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:52:28.594887 [debug] [MainThread]: Using postgres connection "master"
[0m09:52:28.596752 [debug] [MainThread]: On master: BEGIN
[0m09:52:28.597861 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:52:28.607621 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m09:52:28.609059 [debug] [MainThread]: On master: COMMIT
[0m09:52:28.610084 [debug] [MainThread]: Using postgres connection "master"
[0m09:52:28.611049 [debug] [MainThread]: On master: COMMIT
[0m09:52:28.612351 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:52:28.613300 [debug] [MainThread]: On master: Close
[0m09:52:28.614136 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:52:28.615107 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:52:28.616014 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:52:28.616718 [info ] [MainThread]: 
[0m09:52:28.617454 [info ] [MainThread]: Finished running 1 table model, 1 view model in 0 hours 0 minutes and 0.49 seconds (0.49s).
[0m09:52:28.618765 [debug] [MainThread]: Command end result
[0m09:52:28.691415 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:52:28.699765 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:52:28.712261 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:52:28.713223 [info ] [MainThread]: 
[0m09:52:28.714167 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m09:52:28.715242 [info ] [MainThread]: 
[0m09:52:28.716789 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:52:28.717676 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near "hourly"
  LINE 19: hourly AS (
           ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:52:28.718603 [info ] [MainThread]: 
[0m09:52:28.719660 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:52:28.720578 [info ] [MainThread]: 
[0m09:52:28.721486 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=2
[0m09:52:28.722980 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.3470104, "process_in_blocks": "0", "process_kernel_time": 0.644165, "process_mem_max_rss": "131976", "process_out_blocks": "0", "process_user_time": 2.147217}
[0m09:52:28.723942 [debug] [MainThread]: Command `dbt run` failed at 09:52:28.723864 after 3.35 seconds
[0m09:52:28.724777 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce3b35f90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce724ee50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x714ce724edd0>]}
[0m09:52:28.725502 [debug] [MainThread]: Flushing usage events
[0m09:52:29.259560 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:53:31.582181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77380c52f910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77380c53a7d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77380c53a210>]}


============================== 09:53:31.587794 | c69db04d-eceb-4fc3-b9d6-df2796b5a018 ==============================
[0m09:53:31.587794 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:53:31.589408 [debug] [MainThread]: running dbt with arguments {'log_cache_events': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'introspect': 'True', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True', 'debug': 'False', 'indirect_selection': 'eager', 'quiet': 'False', 'use_experimental_parser': 'False', 'static_parser': 'True', 'empty': 'False', 'version_check': 'True', 'write_json': 'True', 'target_path': 'None', 'printer_width': '80', 'partial_parse': 'True', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'profiles_dir': '/usr/app/dbt/dbt', 'cache_selected_only': 'False', 'no_print': 'None', 'log_format': 'default'}
[0m09:53:31.737781 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c69db04d-eceb-4fc3-b9d6-df2796b5a018', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77380c586690>]}
[0m09:53:31.780987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c69db04d-eceb-4fc3-b9d6-df2796b5a018', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77380b5c1f10>]}
[0m09:53:31.783704 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:53:31.935353 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:53:33.297364 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m09:53:33.299456 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/intermediate/int_air_quality_daily.sql
[0m09:53:33.301288 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m09:53:33.588514 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c69db04d-eceb-4fc3-b9d6-df2796b5a018', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77380a10df10>]}
[0m09:53:33.691749 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:53:33.699374 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:53:33.727464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c69db04d-eceb-4fc3-b9d6-df2796b5a018', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77380a172bd0>]}
[0m09:53:33.728366 [info ] [MainThread]: Found 3 models, 2 data tests, 1 source, 738 macros
[0m09:53:33.729177 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c69db04d-eceb-4fc3-b9d6-df2796b5a018', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77380c71f690>]}
[0m09:53:33.731000 [info ] [MainThread]: 
[0m09:53:33.731819 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:53:33.732554 [info ] [MainThread]: 
[0m09:53:33.733506 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:53:33.740366 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:53:33.807956 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:53:33.809744 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:53:33.811218 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:53:33.827792 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m09:53:33.830378 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:53:33.833550 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:53:33.840805 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:53:33.842136 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:53:33.843442 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:53:33.854163 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m09:53:33.856709 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:53:33.858213 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:53:33.866190 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m09:53:33.896274 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:53:33.899255 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:53:33.909606 [debug] [MainThread]: Using postgres connection "master"
[0m09:53:33.911619 [debug] [MainThread]: On master: BEGIN
[0m09:53:33.912989 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:53:33.925549 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m09:53:33.927290 [debug] [MainThread]: Using postgres connection "master"
[0m09:53:33.928647 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:53:33.938454 [debug] [MainThread]: SQL status: SELECT 1 in 0.009 seconds
[0m09:53:33.941964 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c69db04d-eceb-4fc3-b9d6-df2796b5a018', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x773809d38ed0>]}
[0m09:53:33.943289 [debug] [MainThread]: On master: ROLLBACK
[0m09:53:33.944464 [debug] [MainThread]: Using postgres connection "master"
[0m09:53:33.945360 [debug] [MainThread]: On master: BEGIN
[0m09:53:33.946599 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:53:33.947860 [debug] [MainThread]: On master: COMMIT
[0m09:53:33.948914 [debug] [MainThread]: Using postgres connection "master"
[0m09:53:33.949883 [debug] [MainThread]: On master: COMMIT
[0m09:53:33.951120 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:53:33.952182 [debug] [MainThread]: On master: Close
[0m09:53:33.963829 [debug] [Thread-1 (]: Began running node model.data_project_1.int_air_quality_daily
[0m09:53:33.964427 [debug] [Thread-2 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:53:33.965738 [info ] [Thread-1 (]: 1 of 3 START sql view model public.int_air_quality_daily ....................... [RUN]
[0m09:53:33.967332 [info ] [Thread-2 (]: 2 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:53:33.968744 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.int_air_quality_daily)
[0m09:53:33.972523 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.data_project_1.stg_air_quality_valencia'
[0m09:53:33.973787 [debug] [Thread-1 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m09:53:33.974853 [debug] [Thread-2 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:53:33.980861 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m09:53:33.996614 [debug] [Thread-2 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:53:34.024461 [debug] [Thread-1 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m09:53:34.069974 [debug] [Thread-2 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:53:34.073131 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m09:53:34.078486 [debug] [Thread-2 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:53:34.087608 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:53:34.088202 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m09:53:34.089436 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:53:34.090356 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m09:53:34.091225 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m09:53:34.092067 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:53:34.101862 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m09:53:34.102154 [debug] [Thread-2 (]: SQL status: BEGIN in 0.011 seconds
[0m09:53:34.102869 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m09:53:34.103775 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:53:34.104508 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  create view "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
    
    
  as (
    
  );
[0m09:53:34.105801 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:53:34.107368 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ")"
LINE 8:   );
          ^

[0m09:53:34.108904 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: ROLLBACK
[0m09:53:34.109851 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: Close
[0m09:53:34.112898 [debug] [Thread-1 (]: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near ")"
  LINE 8:   );
            ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:53:34.114619 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c69db04d-eceb-4fc3-b9d6-df2796b5a018', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x773802572210>]}
[0m09:53:34.115191 [debug] [Thread-2 (]: SQL status: CREATE VIEW in 0.007 seconds
[0m09:53:34.116067 [error] [Thread-1 (]: 1 of 3 ERROR creating sql view model public.int_air_quality_daily .............. [[31mERROR[0m in 0.15s]
[0m09:53:34.121060 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:53:34.122468 [debug] [Thread-1 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m09:53:34.123372 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:53:34.124213 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_daily' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near ")"
  LINE 8:   );
            ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql.
[0m09:53:34.126146 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:53:34.128852 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:53:34.130571 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:53:34.133733 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:53:34.144527 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:53:34.145916 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:53:34.146996 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:53:34.149318 [debug] [Thread-2 (]: SQL status: COMMIT in 0.002 seconds
[0m09:53:34.153858 [debug] [Thread-2 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:53:34.160701 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:53:34.162111 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:53:34.166990 [debug] [Thread-2 (]: SQL status: DROP VIEW in 0.004 seconds
[0m09:53:34.169173 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:53:34.170285 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c69db04d-eceb-4fc3-b9d6-df2796b5a018', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x773802409010>]}
[0m09:53:34.173269 [info ] [Thread-2 (]: 2 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.20s]
[0m09:53:34.174854 [debug] [Thread-2 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:53:34.176183 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:53:34.177286 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:53:34.184032 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:53:34.184833 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:53:34.197805 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:53:34.237131 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:53:34.256159 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:53:34.286872 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:53:34.289523 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:53:34.295015 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m09:53:34.312300 [debug] [Thread-4 (]: SQL status: BEGIN in 0.017 seconds
[0m09:53:34.320249 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:53:34.325108 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT *
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 1,2,3,4
),

variation AS (
    SELECT
        *,
        avg_hourly - LAG(avg_hourly) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_hour
        ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT * FROM variation
ORDER BY measurement_hour;
--Este modelo intermedio calcula promedios horarios, mÃ¡ximos, mÃ­nimos y variaciones horarias para cada estaciÃ³n y contaminante. Proporciona una base sÃ³lida para anÃ¡lisis mÃ¡s detallados en modelos posteriores.
  );
  
[0m09:53:34.334949 [debug] [Thread-4 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 44: ORDER BY measurement_hour;
                                  ^

[0m09:53:34.336941 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:53:34.338938 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:53:34.352375 [debug] [Thread-4 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:53:34.359166 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c69db04d-eceb-4fc3-b9d6-df2796b5a018', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x773809d9cf90>]}
[0m09:53:34.367675 [error] [Thread-4 (]: 3 of 3 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.18s]
[0m09:53:34.372700 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:53:34.383906 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:53:34.392105 [debug] [MainThread]: Using postgres connection "master"
[0m09:53:34.395394 [debug] [MainThread]: On master: BEGIN
[0m09:53:34.402886 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:53:34.419505 [debug] [MainThread]: SQL status: BEGIN in 0.017 seconds
[0m09:53:34.423650 [debug] [MainThread]: On master: COMMIT
[0m09:53:34.431644 [debug] [MainThread]: Using postgres connection "master"
[0m09:53:34.439168 [debug] [MainThread]: On master: COMMIT
[0m09:53:34.442900 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:53:34.445905 [debug] [MainThread]: On master: Close
[0m09:53:34.453390 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:53:34.461558 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m09:53:34.470641 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:53:34.476573 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:53:34.480824 [info ] [MainThread]: 
[0m09:53:34.485799 [info ] [MainThread]: Finished running 1 table model, 2 view models in 0 hours 0 minutes and 0.75 seconds (0.75s).
[0m09:53:34.489245 [debug] [MainThread]: Command end result
[0m09:53:34.583628 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:53:34.593314 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:53:34.604967 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:53:34.606712 [info ] [MainThread]: 
[0m09:53:34.608264 [info ] [MainThread]: [31mCompleted with 2 errors, 0 partial successes, and 0 warnings:[0m
[0m09:53:34.610004 [info ] [MainThread]: 
[0m09:53:34.611952 [error] [MainThread]: [31mFailure in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)[0m
[0m09:53:34.618089 [error] [MainThread]:   Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near ")"
  LINE 8:   );
            ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:53:34.623541 [info ] [MainThread]: 
[0m09:53:34.626305 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:53:34.628041 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:53:34.630284 [info ] [MainThread]: 
[0m09:53:34.632380 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:53:34.634297 [info ] [MainThread]: 
[0m09:53:34.642259 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=2 SKIP=0 NO-OP=0 TOTAL=3
[0m09:53:34.645416 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.1337402, "process_in_blocks": "0", "process_kernel_time": 0.714621, "process_mem_max_rss": "131972", "process_out_blocks": "0", "process_user_time": 2.151717}
[0m09:53:34.652929 [debug] [MainThread]: Command `dbt run` failed at 09:53:34.652677 after 3.14 seconds
[0m09:53:34.656282 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x773802560850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77380252ead0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77380a122c90>]}
[0m09:53:34.658013 [debug] [MainThread]: Flushing usage events
[0m09:53:35.213391 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:54:37.406676 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742607bc26d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742607c22790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742607bc02d0>]}


============================== 09:54:37.412404 | 4a00d70b-5e41-43d6-80fe-a5a06d9db3dd ==============================
[0m09:54:37.412404 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:54:37.413584 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'send_anonymous_usage_stats': 'True', 'use_colors': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'indirect_selection': 'eager', 'version_check': 'True', 'write_json': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'fail_fast': 'False', 'static_parser': 'True', 'quiet': 'False', 'warn_error': 'None', 'log_format': 'default', 'introspect': 'True', 'empty': 'False', 'invocation_command': 'dbt run', 'printer_width': '80', 'partial_parse': 'True', 'log_cache_events': 'False', 'use_experimental_parser': 'False', 'no_print': 'None'}
[0m09:54:37.552629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4a00d70b-5e41-43d6-80fe-a5a06d9db3dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742606f131d0>]}
[0m09:54:37.619175 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4a00d70b-5e41-43d6-80fe-a5a06d9db3dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74260a924750>]}
[0m09:54:37.625685 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:54:37.833578 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:54:40.041518 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m09:54:40.043088 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_daily.sql
[0m09:54:40.345229 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4a00d70b-5e41-43d6-80fe-a5a06d9db3dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742605be9610>]}
[0m09:54:40.453472 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:54:40.463508 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:54:40.493391 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4a00d70b-5e41-43d6-80fe-a5a06d9db3dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742605bade10>]}
[0m09:54:40.494490 [info ] [MainThread]: Found 3 models, 2 data tests, 1 source, 738 macros
[0m09:54:40.495585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4a00d70b-5e41-43d6-80fe-a5a06d9db3dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742605783a90>]}
[0m09:54:40.497914 [info ] [MainThread]: 
[0m09:54:40.499382 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:54:40.500648 [info ] [MainThread]: 
[0m09:54:40.503608 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:54:40.515074 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:54:40.572690 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:54:40.574767 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:54:40.577973 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:54:40.596191 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m09:54:40.605170 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:54:40.609793 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:54:40.617606 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:54:40.620702 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:54:40.625969 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:54:40.636619 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m09:54:40.642085 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:54:40.647017 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:54:40.657923 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.008 seconds
[0m09:54:40.663174 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:54:40.665534 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:54:40.674153 [debug] [MainThread]: Using postgres connection "master"
[0m09:54:40.676724 [debug] [MainThread]: On master: BEGIN
[0m09:54:40.678289 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:54:40.692199 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m09:54:40.694847 [debug] [MainThread]: Using postgres connection "master"
[0m09:54:40.696336 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:54:40.705348 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m09:54:40.708147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4a00d70b-5e41-43d6-80fe-a5a06d9db3dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742606fc9b90>]}
[0m09:54:40.710146 [debug] [MainThread]: On master: ROLLBACK
[0m09:54:40.712159 [debug] [MainThread]: Using postgres connection "master"
[0m09:54:40.714988 [debug] [MainThread]: On master: BEGIN
[0m09:54:40.719478 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m09:54:40.721900 [debug] [MainThread]: On master: COMMIT
[0m09:54:40.723789 [debug] [MainThread]: Using postgres connection "master"
[0m09:54:40.725526 [debug] [MainThread]: On master: COMMIT
[0m09:54:40.727391 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:54:40.728709 [debug] [MainThread]: On master: Close
[0m09:54:40.738810 [debug] [Thread-1 (]: Began running node model.data_project_1.int_air_quality_daily
[0m09:54:40.739432 [debug] [Thread-2 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:54:40.740964 [info ] [Thread-1 (]: 1 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m09:54:40.742337 [info ] [Thread-2 (]: 2 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:54:40.743994 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.int_air_quality_daily)
[0m09:54:40.745438 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.data_project_1.stg_air_quality_valencia'
[0m09:54:40.746570 [debug] [Thread-1 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m09:54:40.747731 [debug] [Thread-2 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:54:40.754402 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m09:54:40.771158 [debug] [Thread-2 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:54:40.782459 [debug] [Thread-2 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:54:40.790327 [debug] [Thread-1 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m09:54:40.808608 [debug] [Thread-2 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:54:40.825801 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m09:54:40.843959 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m09:54:40.845336 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:54:40.845752 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m09:54:40.847517 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:54:40.848835 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:54:40.852948 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m09:54:40.866097 [debug] [Thread-2 (]: SQL status: BEGIN in 0.013 seconds
[0m09:54:40.866581 [debug] [Thread-1 (]: SQL status: BEGIN in 0.018 seconds
[0m09:54:40.870123 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:54:40.872076 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m09:54:40.874003 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:54:40.875666 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
    location_id, 
    station_name, 
    pollution_type, 
    DATE TRUNC ('day', measurament_timestamp)
)
  );
  
[0m09:54:40.879423 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "("
LINE 19:     DATE TRUNC ('day', measurament_timestamp)
                        ^

[0m09:54:40.881373 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: ROLLBACK
[0m09:54:40.883145 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: Close
[0m09:54:40.890794 [debug] [Thread-2 (]: SQL status: CREATE VIEW in 0.013 seconds
[0m09:54:40.903550 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:54:40.905532 [debug] [Thread-1 (]: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp)
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:54:40.906691 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:54:40.909836 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4a00d70b-5e41-43d6-80fe-a5a06d9db3dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74260673df90>]}
[0m09:54:40.912501 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:54:40.912064 [error] [Thread-1 (]: 1 of 3 ERROR creating sql table model public.int_air_quality_daily ............. [[31mERROR[0m in 0.16s]
[0m09:54:40.916108 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:54:40.917674 [debug] [Thread-1 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m09:54:40.919187 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:54:40.920886 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_daily' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp)
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql.
[0m09:54:40.924043 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:54:40.937780 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:54:40.960529 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:54:40.961790 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:54:40.966190 [debug] [Thread-2 (]: SQL status: COMMIT in 0.003 seconds
[0m09:54:40.975918 [debug] [Thread-2 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:54:40.981322 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:54:40.982148 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:54:40.990297 [debug] [Thread-2 (]: SQL status: DROP VIEW in 0.006 seconds
[0m09:54:40.993173 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:54:40.994838 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4a00d70b-5e41-43d6-80fe-a5a06d9db3dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7425e5c59750>]}
[0m09:54:40.996482 [info ] [Thread-2 (]: 2 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.25s]
[0m09:54:40.998363 [debug] [Thread-2 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:54:41.000792 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:54:41.002142 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:54:41.003841 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:54:41.004949 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:54:41.009986 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:54:41.020560 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:54:41.024163 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:54:41.033746 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:54:41.035197 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:54:41.036557 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m09:54:41.047574 [debug] [Thread-4 (]: SQL status: BEGIN in 0.011 seconds
[0m09:54:41.050192 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:54:41.051669 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT *
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 1,2,3,4
),

variation AS (
    SELECT
        *,
        avg_hourly - LAG(avg_hourly) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_hour
        ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT * FROM variation
ORDER BY measurement_hour;
--Este modelo intermedio calcula promedios horarios, mÃ¡ximos, mÃ­nimos y variaciones horarias para cada estaciÃ³n y contaminante. Proporciona una base sÃ³lida para anÃ¡lisis mÃ¡s detallados en modelos posteriores.
  );
  
[0m09:54:41.053442 [debug] [Thread-4 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 44: ORDER BY measurement_hour;
                                  ^

[0m09:54:41.054485 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:54:41.055897 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:54:41.059119 [debug] [Thread-4 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:54:41.060621 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4a00d70b-5e41-43d6-80fe-a5a06d9db3dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742605f56f90>]}
[0m09:54:41.061958 [error] [Thread-4 (]: 3 of 3 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.06s]
[0m09:54:41.063318 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:54:41.065124 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:54:41.068873 [debug] [MainThread]: Using postgres connection "master"
[0m09:54:41.078664 [debug] [MainThread]: On master: BEGIN
[0m09:54:41.089836 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:54:41.098172 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m09:54:41.099408 [debug] [MainThread]: On master: COMMIT
[0m09:54:41.101705 [debug] [MainThread]: Using postgres connection "master"
[0m09:54:41.103091 [debug] [MainThread]: On master: COMMIT
[0m09:54:41.104513 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:54:41.105371 [debug] [MainThread]: On master: Close
[0m09:54:41.106336 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:54:41.107275 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m09:54:41.108075 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:54:41.108751 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:54:41.109527 [info ] [MainThread]: 
[0m09:54:41.110288 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.61 seconds (0.61s).
[0m09:54:41.111507 [debug] [MainThread]: Command end result
[0m09:54:41.164468 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:54:41.173144 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:54:41.197202 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:54:41.198358 [info ] [MainThread]: 
[0m09:54:41.199370 [info ] [MainThread]: [31mCompleted with 2 errors, 0 partial successes, and 0 warnings:[0m
[0m09:54:41.201976 [info ] [MainThread]: 
[0m09:54:41.203239 [error] [MainThread]: [31mFailure in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)[0m
[0m09:54:41.204173 [error] [MainThread]:   Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp)
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:54:41.204987 [info ] [MainThread]: 
[0m09:54:41.205790 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:54:41.206602 [info ] [MainThread]: 
[0m09:54:41.207409 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:54:41.208168 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:54:41.208895 [info ] [MainThread]: 
[0m09:54:41.209682 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:54:41.210539 [info ] [MainThread]: 
[0m09:54:41.211470 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=2 SKIP=0 NO-OP=0 TOTAL=3
[0m09:54:41.213205 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.8803723, "process_in_blocks": "0", "process_kernel_time": 0.602954, "process_mem_max_rss": "131836", "process_out_blocks": "0", "process_user_time": 2.186714}
[0m09:54:41.214832 [debug] [MainThread]: Command `dbt run` failed at 09:54:41.214659 after 3.88 seconds
[0m09:54:41.216262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x742607c22950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7425e5c5bd90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74260c3fae90>]}
[0m09:54:41.236784 [debug] [MainThread]: Flushing usage events
[0m09:54:41.847431 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:55:44.143560 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70543ce7c910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70543ce993d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70543ce989d0>]}


============================== 09:55:44.149806 | 095b1f39-d954-4e09-af87-5c3951bbcfeb ==============================
[0m09:55:44.149806 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:55:44.151534 [debug] [MainThread]: running dbt with arguments {'log_cache_events': 'False', 'invocation_command': 'dbt run', 'cache_selected_only': 'False', 'fail_fast': 'False', 'target_path': 'None', 'quiet': 'False', 'no_print': 'None', 'debug': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'profiles_dir': '/usr/app/dbt/dbt', 'version_check': 'True', 'empty': 'False', 'printer_width': '80', 'log_format': 'default', 'use_experimental_parser': 'False', 'write_json': 'True', 'send_anonymous_usage_stats': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'static_parser': 'True', 'introspect': 'True', 'warn_error': 'None', 'indirect_selection': 'eager', 'partial_parse': 'True', 'use_colors': 'True'}
[0m09:55:44.312931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '095b1f39-d954-4e09-af87-5c3951bbcfeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70543ce83f50>]}
[0m09:55:44.369913 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '095b1f39-d954-4e09-af87-5c3951bbcfeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70543fbe04d0>]}
[0m09:55:44.372894 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:55:44.551615 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:55:46.708865 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m09:55:46.710711 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_daily.sql
[0m09:55:47.012100 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '095b1f39-d954-4e09-af87-5c3951bbcfeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70543ad18150>]}
[0m09:55:47.127561 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:55:47.134345 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:55:47.215167 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '095b1f39-d954-4e09-af87-5c3951bbcfeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70543ec15710>]}
[0m09:55:47.216844 [info ] [MainThread]: Found 3 models, 2 data tests, 1 source, 738 macros
[0m09:55:47.218920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '095b1f39-d954-4e09-af87-5c3951bbcfeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70543edc5ad0>]}
[0m09:55:47.223269 [info ] [MainThread]: 
[0m09:55:47.225752 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:55:47.227786 [info ] [MainThread]: 
[0m09:55:47.230168 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:55:47.237436 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:55:47.297580 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:55:47.300009 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:55:47.303852 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:55:47.325624 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.022 seconds
[0m09:55:47.332489 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:55:47.338953 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:55:47.346343 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:55:47.347588 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:55:47.348524 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:55:47.373068 [debug] [ThreadPool]: SQL status: BEGIN in 0.024 seconds
[0m09:55:47.376762 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:55:47.383147 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:55:47.400285 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.008 seconds
[0m09:55:47.406178 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:55:47.408911 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:55:47.414193 [debug] [MainThread]: Using postgres connection "master"
[0m09:55:47.420019 [debug] [MainThread]: On master: BEGIN
[0m09:55:47.423736 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:55:47.435584 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m09:55:47.437414 [debug] [MainThread]: Using postgres connection "master"
[0m09:55:47.438481 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:55:47.446596 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m09:55:47.450009 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '095b1f39-d954-4e09-af87-5c3951bbcfeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70543ce23050>]}
[0m09:55:47.453094 [debug] [MainThread]: On master: ROLLBACK
[0m09:55:47.454370 [debug] [MainThread]: Using postgres connection "master"
[0m09:55:47.455868 [debug] [MainThread]: On master: BEGIN
[0m09:55:47.461176 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m09:55:47.462252 [debug] [MainThread]: On master: COMMIT
[0m09:55:47.463348 [debug] [MainThread]: Using postgres connection "master"
[0m09:55:47.465100 [debug] [MainThread]: On master: COMMIT
[0m09:55:47.466359 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:55:47.467547 [debug] [MainThread]: On master: Close
[0m09:55:47.474826 [debug] [Thread-1 (]: Began running node model.data_project_1.int_air_quality_daily
[0m09:55:47.475347 [debug] [Thread-2 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:55:47.477123 [info ] [Thread-1 (]: 1 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m09:55:47.478710 [info ] [Thread-2 (]: 2 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:55:47.479989 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.int_air_quality_daily)
[0m09:55:47.484537 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.data_project_1.stg_air_quality_valencia'
[0m09:55:47.486959 [debug] [Thread-1 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m09:55:47.487850 [debug] [Thread-2 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:55:47.493492 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m09:55:47.507025 [debug] [Thread-2 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:55:47.529791 [debug] [Thread-2 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:55:47.530569 [debug] [Thread-1 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m09:55:47.563210 [debug] [Thread-2 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:55:47.573956 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m09:55:47.587183 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m09:55:47.588181 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:55:47.588538 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m09:55:47.591289 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:55:47.592621 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:55:47.594079 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m09:55:47.604547 [debug] [Thread-2 (]: SQL status: BEGIN in 0.010 seconds
[0m09:55:47.606550 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:55:47.607736 [debug] [Thread-1 (]: SQL status: BEGIN in 0.015 seconds
[0m09:55:47.608877 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:55:47.610899 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m09:55:47.613436 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
    location_id, 
    station_name, 
    pollution_type, 
    DATE TRUNC ('day', measurament_timestamp) AS measurament_day,
    AVG (concentration_ug_m3) AS avg_daily,
    MAX (concentration_ug_m3) AS max_daily
    MIN (concentration_ug_m3) AS min_daily,
    COUNT (*) AS num_measuraments
    
FROM base
GROUP BY 1,2,3,4
)
  );
  
[0m09:55:47.614746 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "("
LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                        ^

[0m09:55:47.615918 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: ROLLBACK
[0m09:55:47.619313 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: Close
[0m09:55:47.623392 [debug] [Thread-2 (]: SQL status: CREATE VIEW in 0.011 seconds
[0m09:55:47.625176 [debug] [Thread-1 (]: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:55:47.629853 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:55:47.632352 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '095b1f39-d954-4e09-af87-5c3951bbcfeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7053f2f548d0>]}
[0m09:55:47.632619 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:55:47.633699 [error] [Thread-1 (]: 1 of 3 ERROR creating sql table model public.int_air_quality_daily ............. [[31mERROR[0m in 0.15s]
[0m09:55:47.636674 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:55:47.638930 [debug] [Thread-1 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m09:55:47.642754 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:55:47.644452 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_daily' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql.
[0m09:55:47.646008 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:55:47.652258 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:55:47.663171 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:55:47.665476 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:55:47.666708 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:55:47.670409 [debug] [Thread-2 (]: SQL status: COMMIT in 0.002 seconds
[0m09:55:47.676788 [debug] [Thread-2 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:55:47.682048 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:55:47.683395 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:55:47.688475 [debug] [Thread-2 (]: SQL status: DROP VIEW in 0.003 seconds
[0m09:55:47.690983 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:55:47.692139 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '095b1f39-d954-4e09-af87-5c3951bbcfeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7053f2fd3cd0>]}
[0m09:55:47.693532 [info ] [Thread-2 (]: 2 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.21s]
[0m09:55:47.694817 [debug] [Thread-2 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:55:47.696567 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:55:47.699706 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:55:47.700852 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:55:47.703298 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:55:47.708413 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:55:47.739534 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:55:47.745673 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:55:47.765790 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:55:47.770051 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:55:47.771398 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m09:55:47.783751 [debug] [Thread-4 (]: SQL status: BEGIN in 0.012 seconds
[0m09:55:47.787328 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:55:47.793015 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT *
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 1,2,3,4
),

variation AS (
    SELECT
        *,
        avg_hourly - LAG(avg_hourly) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_hour
        ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT * FROM variation
ORDER BY measurement_hour;
--Este modelo intermedio calcula promedios horarios, mÃ¡ximos, mÃ­nimos y variaciones horarias para cada estaciÃ³n y contaminante. Proporciona una base sÃ³lida para anÃ¡lisis mÃ¡s detallados en modelos posteriores.
  );
  
[0m09:55:47.798239 [debug] [Thread-4 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 44: ORDER BY measurement_hour;
                                  ^

[0m09:55:47.803261 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:55:47.808189 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:55:47.811915 [debug] [Thread-4 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:55:47.816031 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '095b1f39-d954-4e09-af87-5c3951bbcfeb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70543ce7ed90>]}
[0m09:55:47.821232 [error] [Thread-4 (]: 3 of 3 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.12s]
[0m09:55:47.822989 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:55:47.824611 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:55:47.827650 [debug] [MainThread]: Using postgres connection "master"
[0m09:55:47.828824 [debug] [MainThread]: On master: BEGIN
[0m09:55:47.830061 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:55:47.842013 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m09:55:47.844677 [debug] [MainThread]: On master: COMMIT
[0m09:55:47.846754 [debug] [MainThread]: Using postgres connection "master"
[0m09:55:47.848616 [debug] [MainThread]: On master: COMMIT
[0m09:55:47.850496 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:55:47.852564 [debug] [MainThread]: On master: Close
[0m09:55:47.855212 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:55:47.857365 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m09:55:47.859210 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:55:47.860937 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:55:47.862673 [info ] [MainThread]: 
[0m09:55:47.864083 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.63 seconds (0.63s).
[0m09:55:47.866324 [debug] [MainThread]: Command end result
[0m09:55:47.931102 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:55:47.940834 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:55:47.954860 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:55:47.956222 [info ] [MainThread]: 
[0m09:55:47.957751 [info ] [MainThread]: [31mCompleted with 2 errors, 0 partial successes, and 0 warnings:[0m
[0m09:55:47.959145 [info ] [MainThread]: 
[0m09:55:47.960566 [error] [MainThread]: [31mFailure in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)[0m
[0m09:55:47.962065 [error] [MainThread]:   Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:55:47.963663 [info ] [MainThread]: 
[0m09:55:47.965405 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:55:47.967162 [info ] [MainThread]: 
[0m09:55:47.968971 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:55:47.970615 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:55:47.971964 [info ] [MainThread]: 
[0m09:55:47.973580 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:55:47.975177 [info ] [MainThread]: 
[0m09:55:47.976554 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=2 SKIP=0 NO-OP=0 TOTAL=3
[0m09:55:47.978697 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.9130034, "process_in_blocks": "0", "process_kernel_time": 0.677117, "process_mem_max_rss": "132252", "process_out_blocks": "0", "process_user_time": 2.281241}
[0m09:55:47.980040 [debug] [MainThread]: Command `dbt run` failed at 09:55:47.979934 after 3.91 seconds
[0m09:55:47.981557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7054416b6dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7053f05c9b90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70543fbaf810>]}
[0m09:55:47.982898 [debug] [MainThread]: Flushing usage events
[0m09:55:48.494395 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:56:50.571455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d5177713e90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d5177929a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d51776ba710>]}


============================== 09:56:50.580272 | f9e8e9fa-79af-451c-a6ef-eaf9ad8d9f4a ==============================
[0m09:56:50.580272 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:56:50.581655 [debug] [MainThread]: running dbt with arguments {'invocation_command': 'dbt run', 'log_format': 'default', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'printer_width': '80', 'version_check': 'True', 'send_anonymous_usage_stats': 'True', 'introspect': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'partial_parse': 'True', 'target_path': 'None', 'fail_fast': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'indirect_selection': 'eager', 'no_print': 'None', 'static_parser': 'True', 'use_experimental_parser': 'False', 'log_cache_events': 'False', 'write_json': 'True', 'empty': 'False', 'cache_selected_only': 'False', 'use_colors': 'True', 'warn_error': 'None', 'quiet': 'False', 'debug': 'False'}
[0m09:56:50.760253 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f9e8e9fa-79af-451c-a6ef-eaf9ad8d9f4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d5177712ad0>]}
[0m09:56:50.816282 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f9e8e9fa-79af-451c-a6ef-eaf9ad8d9f4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d517a42ea10>]}
[0m09:56:50.819477 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:56:50.990480 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:56:53.182372 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m09:56:53.184966 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_daily.sql
[0m09:56:53.509908 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f9e8e9fa-79af-451c-a6ef-eaf9ad8d9f4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d5174f21e90>]}
[0m09:56:53.614051 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:56:53.620893 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:56:53.648748 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f9e8e9fa-79af-451c-a6ef-eaf9ad8d9f4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d5175f7d250>]}
[0m09:56:53.650507 [info ] [MainThread]: Found 3 models, 2 data tests, 1 source, 738 macros
[0m09:56:53.652072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f9e8e9fa-79af-451c-a6ef-eaf9ad8d9f4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d51753d8290>]}
[0m09:56:53.655657 [info ] [MainThread]: 
[0m09:56:53.657767 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:56:53.659077 [info ] [MainThread]: 
[0m09:56:53.660208 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:56:53.663686 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:56:53.718136 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:56:53.721160 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:56:53.724612 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:56:53.741405 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m09:56:53.748603 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:56:53.753938 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:56:53.776523 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:56:53.780539 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:56:53.784839 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:56:53.798268 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m09:56:53.799905 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:56:53.800999 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:56:53.806735 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m09:56:53.808897 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:56:53.810402 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:56:53.816062 [debug] [MainThread]: Using postgres connection "master"
[0m09:56:53.816941 [debug] [MainThread]: On master: BEGIN
[0m09:56:53.819090 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:56:53.827383 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m09:56:53.829276 [debug] [MainThread]: Using postgres connection "master"
[0m09:56:53.830660 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:56:53.836635 [debug] [MainThread]: SQL status: SELECT 1 in 0.005 seconds
[0m09:56:53.839341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f9e8e9fa-79af-451c-a6ef-eaf9ad8d9f4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d51757e3a50>]}
[0m09:56:53.840617 [debug] [MainThread]: On master: ROLLBACK
[0m09:56:53.841843 [debug] [MainThread]: Using postgres connection "master"
[0m09:56:53.843048 [debug] [MainThread]: On master: BEGIN
[0m09:56:53.844326 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:56:53.850953 [debug] [MainThread]: On master: COMMIT
[0m09:56:53.856535 [debug] [MainThread]: Using postgres connection "master"
[0m09:56:53.860628 [debug] [MainThread]: On master: COMMIT
[0m09:56:53.862473 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:56:53.864009 [debug] [MainThread]: On master: Close
[0m09:56:53.872637 [debug] [Thread-1 (]: Began running node model.data_project_1.int_air_quality_daily
[0m09:56:53.873150 [debug] [Thread-2 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:56:53.874617 [info ] [Thread-1 (]: 1 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m09:56:53.877074 [info ] [Thread-2 (]: 2 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:56:53.878736 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.int_air_quality_daily)
[0m09:56:53.880477 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.data_project_1.stg_air_quality_valencia'
[0m09:56:53.881653 [debug] [Thread-1 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m09:56:53.882589 [debug] [Thread-2 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:56:53.889440 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m09:56:53.899136 [debug] [Thread-2 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:56:53.913708 [debug] [Thread-1 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m09:56:53.914353 [debug] [Thread-2 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:56:53.949317 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m09:56:53.959995 [debug] [Thread-2 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:56:53.973645 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m09:56:53.974885 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:56:53.975303 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m09:56:53.976968 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:56:53.978505 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:56:53.979519 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m09:56:53.990935 [debug] [Thread-1 (]: SQL status: BEGIN in 0.012 seconds
[0m09:56:53.993070 [debug] [Thread-2 (]: SQL status: BEGIN in 0.013 seconds
[0m09:56:53.993604 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m09:56:53.994792 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:56:53.995884 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
    location_id, 
    station_name, 
    pollution_type, 
    DATE TRUNC ('day', measurament_timestamp) AS measurament_day,
    AVG (concentration_ug_m3) AS avg_daily,
    MAX (concentration_ug_m3) AS max_daily
    MIN (concentration_ug_m3) AS min_daily,
    COUNT (*) AS num_measuraments
    
FROM base
GROUP BY 1,2,3,4
),

variation AS (
     SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT * FROM variation
ORDER BY measurement_day;
--Este modelo intermedio calcula promedios diarios, mÃ¡ximos, mÃ­nimos y variaciones diarias para cada estaciÃ³n y contaminante. Proporciona una base sÃ³lida para anÃ¡lisis mÃ¡s detallados en modelos posteriores.
  );
  
[0m09:56:53.997042 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:56:53.998936 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "("
LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                        ^

[0m09:56:54.000671 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: ROLLBACK
[0m09:56:54.002715 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: Close
[0m09:56:54.008234 [debug] [Thread-1 (]: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:56:54.010713 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f9e8e9fa-79af-451c-a6ef-eaf9ad8d9f4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d5174f65710>]}
[0m09:56:54.011192 [debug] [Thread-2 (]: SQL status: CREATE VIEW in 0.011 seconds
[0m09:56:54.012455 [error] [Thread-1 (]: 1 of 3 ERROR creating sql table model public.int_air_quality_daily ............. [[31mERROR[0m in 0.13s]
[0m09:56:54.018543 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:56:54.019856 [debug] [Thread-1 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m09:56:54.021128 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:56:54.023456 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_daily' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql.
[0m09:56:54.026932 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:56:54.031403 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:56:54.032806 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:56:54.036305 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:56:54.051801 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:56:54.052959 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:56:54.054119 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:56:54.059730 [debug] [Thread-2 (]: SQL status: COMMIT in 0.004 seconds
[0m09:56:54.067145 [debug] [Thread-2 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:56:54.073686 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:56:54.075158 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:56:54.081505 [debug] [Thread-2 (]: SQL status: DROP VIEW in 0.005 seconds
[0m09:56:54.084377 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:56:54.085888 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f9e8e9fa-79af-451c-a6ef-eaf9ad8d9f4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d515d710e90>]}
[0m09:56:54.087788 [info ] [Thread-2 (]: 2 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.21s]
[0m09:56:54.091226 [debug] [Thread-2 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:56:54.093229 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:56:54.094562 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:56:54.095865 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:56:54.096745 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:56:54.101350 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:56:54.115472 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:56:54.119735 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:56:54.138274 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:56:54.140735 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:56:54.141944 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m09:56:54.154602 [debug] [Thread-4 (]: SQL status: BEGIN in 0.013 seconds
[0m09:56:54.156911 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:56:54.158146 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT *
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 1,2,3,4
),

variation AS (
    SELECT
        *,
        avg_hourly - LAG(avg_hourly) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_hour
        ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT * FROM variation
ORDER BY measurement_hour;
--Este modelo intermedio calcula promedios horarios, mÃ¡ximos, mÃ­nimos y variaciones horarias para cada estaciÃ³n y contaminante. Proporciona una base sÃ³lida para anÃ¡lisis mÃ¡s detallados en modelos posteriores.
  );
  
[0m09:56:54.159997 [debug] [Thread-4 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 44: ORDER BY measurement_hour;
                                  ^

[0m09:56:54.161486 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:56:54.163031 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:56:54.166654 [debug] [Thread-4 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:56:54.168345 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f9e8e9fa-79af-451c-a6ef-eaf9ad8d9f4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d515c4f3990>]}
[0m09:56:54.170067 [error] [Thread-4 (]: 3 of 3 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.07s]
[0m09:56:54.173892 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:56:54.180489 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:56:54.184211 [debug] [MainThread]: Using postgres connection "master"
[0m09:56:54.185699 [debug] [MainThread]: On master: BEGIN
[0m09:56:54.191446 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:56:54.208111 [debug] [MainThread]: SQL status: BEGIN in 0.016 seconds
[0m09:56:54.210680 [debug] [MainThread]: On master: COMMIT
[0m09:56:54.212062 [debug] [MainThread]: Using postgres connection "master"
[0m09:56:54.213364 [debug] [MainThread]: On master: COMMIT
[0m09:56:54.215176 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:56:54.216533 [debug] [MainThread]: On master: Close
[0m09:56:54.219108 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:56:54.220281 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m09:56:54.222574 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:56:54.223750 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:56:54.225012 [info ] [MainThread]: 
[0m09:56:54.225942 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.56 seconds (0.56s).
[0m09:56:54.227575 [debug] [MainThread]: Command end result
[0m09:56:54.298919 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:56:54.312207 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:56:54.327812 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:56:54.329065 [info ] [MainThread]: 
[0m09:56:54.330035 [info ] [MainThread]: [31mCompleted with 2 errors, 0 partial successes, and 0 warnings:[0m
[0m09:56:54.332212 [info ] [MainThread]: 
[0m09:56:54.333525 [error] [MainThread]: [31mFailure in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)[0m
[0m09:56:54.334891 [error] [MainThread]:   Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:56:54.336797 [info ] [MainThread]: 
[0m09:56:54.338925 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:56:54.341135 [info ] [MainThread]: 
[0m09:56:54.343165 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:56:54.344673 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:56:54.345852 [info ] [MainThread]: 
[0m09:56:54.348231 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:56:54.349136 [info ] [MainThread]: 
[0m09:56:54.350584 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=2 SKIP=0 NO-OP=0 TOTAL=3
[0m09:56:54.353291 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.8689976, "process_in_blocks": "0", "process_kernel_time": 0.605996, "process_mem_max_rss": "131792", "process_out_blocks": "0", "process_user_time": 2.14306}
[0m09:56:54.354803 [debug] [MainThread]: Command `dbt run` failed at 09:56:54.354617 after 3.87 seconds
[0m09:56:54.356650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d5176ba4c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d517bf22e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7d517c2015d0>]}
[0m09:56:54.357887 [debug] [MainThread]: Flushing usage events
[0m09:56:54.916554 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:57:58.115720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa14795de10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa1478fca90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa14a64f110>]}


============================== 09:57:58.121850 | c7de2390-fa7d-496a-97e1-c9af042f513e ==============================
[0m09:57:58.121850 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:57:58.123295 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'debug': 'False', 'quiet': 'False', 'introspect': 'True', 'version_check': 'True', 'use_colors': 'True', 'empty': 'False', 'invocation_command': 'dbt run', 'indirect_selection': 'eager', 'fail_fast': 'False', 'use_experimental_parser': 'False', 'log_cache_events': 'False', 'send_anonymous_usage_stats': 'True', 'write_json': 'True', 'log_format': 'default', 'printer_width': '80', 'no_print': 'None', 'partial_parse': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'static_parser': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'cache_selected_only': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None'}
[0m09:57:58.264135 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c7de2390-fa7d-496a-97e1-c9af042f513e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa146916310>]}
[0m09:57:58.310268 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c7de2390-fa7d-496a-97e1-c9af042f513e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa1469b9d50>]}
[0m09:57:58.312426 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:57:58.461442 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:58:00.464566 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m09:58:00.466026 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/intermediate/schema.yml
[0m09:58:00.744748 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c7de2390-fa7d-496a-97e1-c9af042f513e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa1465eb150>]}
[0m09:58:00.864643 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:58:00.875266 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:58:00.912124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c7de2390-fa7d-496a-97e1-c9af042f513e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa1465adb50>]}
[0m09:58:00.913627 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m09:58:00.914850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c7de2390-fa7d-496a-97e1-c9af042f513e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa14a2fcb90>]}
[0m09:58:00.918665 [info ] [MainThread]: 
[0m09:58:00.920158 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:58:00.921340 [info ] [MainThread]: 
[0m09:58:00.922707 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:58:00.928198 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:58:01.012965 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:58:01.015074 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:58:01.016852 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:58:01.031702 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.015 seconds
[0m09:58:01.034148 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:58:01.037259 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:58:01.043223 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:58:01.047612 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:58:01.049002 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:58:01.059019 [debug] [ThreadPool]: SQL status: BEGIN in 0.010 seconds
[0m09:58:01.064383 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:58:01.066243 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:58:01.074763 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.007 seconds
[0m09:58:01.077460 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:58:01.079026 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:58:01.083894 [debug] [MainThread]: Using postgres connection "master"
[0m09:58:01.085460 [debug] [MainThread]: On master: BEGIN
[0m09:58:01.086826 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:58:01.096843 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m09:58:01.098214 [debug] [MainThread]: Using postgres connection "master"
[0m09:58:01.099553 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:58:01.108126 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m09:58:01.110160 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c7de2390-fa7d-496a-97e1-c9af042f513e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa148a31510>]}
[0m09:58:01.111188 [debug] [MainThread]: On master: ROLLBACK
[0m09:58:01.112334 [debug] [MainThread]: Using postgres connection "master"
[0m09:58:01.113166 [debug] [MainThread]: On master: BEGIN
[0m09:58:01.114556 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:58:01.115591 [debug] [MainThread]: On master: COMMIT
[0m09:58:01.116435 [debug] [MainThread]: Using postgres connection "master"
[0m09:58:01.117559 [debug] [MainThread]: On master: COMMIT
[0m09:58:01.119017 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:58:01.120091 [debug] [MainThread]: On master: Close
[0m09:58:01.124725 [debug] [Thread-1 (]: Began running node model.data_project_1.int_air_quality_daily
[0m09:58:01.125041 [debug] [Thread-2 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:58:01.126102 [info ] [Thread-1 (]: 1 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m09:58:01.127333 [info ] [Thread-2 (]: 2 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:58:01.128437 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.int_air_quality_daily)
[0m09:58:01.129565 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.data_project_1.stg_air_quality_valencia'
[0m09:58:01.130459 [debug] [Thread-1 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m09:58:01.131465 [debug] [Thread-2 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:58:01.138594 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m09:58:01.149050 [debug] [Thread-2 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:58:01.159493 [debug] [Thread-2 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:58:01.160127 [debug] [Thread-1 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m09:58:01.201998 [debug] [Thread-2 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:58:01.206233 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m09:58:01.216747 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m09:58:01.217255 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:58:01.218403 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m09:58:01.219822 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:58:01.221230 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:58:01.222891 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m09:58:01.234940 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m09:58:01.236386 [debug] [Thread-2 (]: SQL status: BEGIN in 0.013 seconds
[0m09:58:01.237580 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m09:58:01.239360 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:58:01.241364 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
    location_id, 
    station_name, 
    pollution_type, 
    DATE TRUNC ('day', measurament_timestamp) AS measurament_day,
    AVG (concentration_ug_m3) AS avg_daily,
    MAX (concentration_ug_m3) AS max_daily
    MIN (concentration_ug_m3) AS min_daily,
    COUNT (*) AS num_measuraments
    
FROM base
GROUP BY 1,2,3,4
),

variation AS (
     SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT * FROM variation
ORDER BY measurement_day;
--Este modelo intermedio calcula promedios diarios, mÃ¡ximos, mÃ­nimos y variaciones diarias para cada estaciÃ³n y contaminante. Proporciona una base sÃ³lida para anÃ¡lisis mÃ¡s detallados en modelos posteriores.
  );
  
[0m09:58:01.243171 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:58:01.244922 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "("
LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                        ^

[0m09:58:01.247110 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: ROLLBACK
[0m09:58:01.248718 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: Close
[0m09:58:01.254772 [debug] [Thread-1 (]: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:58:01.255078 [debug] [Thread-2 (]: SQL status: CREATE VIEW in 0.009 seconds
[0m09:58:01.256993 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c7de2390-fa7d-496a-97e1-c9af042f513e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa144563c10>]}
[0m09:58:01.262343 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:58:01.263549 [error] [Thread-1 (]: 1 of 3 ERROR creating sql table model public.int_air_quality_daily ............. [[31mERROR[0m in 0.13s]
[0m09:58:01.265344 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:58:01.266731 [debug] [Thread-1 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m09:58:01.268546 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_daily' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql.
[0m09:58:01.270121 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:58:01.274210 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:58:01.275045 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:58:01.276943 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:58:01.287277 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:58:01.288529 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:58:01.289402 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:58:01.292687 [debug] [Thread-2 (]: SQL status: COMMIT in 0.002 seconds
[0m09:58:01.297889 [debug] [Thread-2 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:58:01.307517 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:58:01.309407 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:58:01.315950 [debug] [Thread-2 (]: SQL status: DROP VIEW in 0.005 seconds
[0m09:58:01.320897 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:58:01.328910 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c7de2390-fa7d-496a-97e1-c9af042f513e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa146172590>]}
[0m09:58:01.333466 [info ] [Thread-2 (]: 2 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.20s]
[0m09:58:01.337016 [debug] [Thread-2 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:58:01.348203 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:58:01.351933 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:58:01.356862 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:58:01.364831 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:58:01.378457 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:58:01.412760 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:58:01.419672 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:58:01.444252 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:58:01.446174 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:58:01.447602 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m09:58:01.462923 [debug] [Thread-4 (]: SQL status: BEGIN in 0.015 seconds
[0m09:58:01.466594 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:58:01.468339 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT *
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 1,2,3,4
),

variation AS (
    SELECT
        *,
        avg_hourly - LAG(avg_hourly) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_hour
        ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT * FROM variation
ORDER BY measurement_hour;
--Este modelo intermedio calcula promedios horarios, mÃ¡ximos, mÃ­nimos y variaciones horarias para cada estaciÃ³n y contaminante. Proporciona una base sÃ³lida para anÃ¡lisis mÃ¡s detallados en modelos posteriores.
  );
  
[0m09:58:01.470605 [debug] [Thread-4 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 44: ORDER BY measurement_hour;
                                  ^

[0m09:58:01.472410 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:58:01.474842 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:58:01.485563 [debug] [Thread-4 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:58:01.488032 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c7de2390-fa7d-496a-97e1-c9af042f513e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa14455f110>]}
[0m09:58:01.490536 [error] [Thread-4 (]: 3 of 3 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.13s]
[0m09:58:01.492749 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:58:01.494917 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:58:01.499267 [debug] [MainThread]: Using postgres connection "master"
[0m09:58:01.500802 [debug] [MainThread]: On master: BEGIN
[0m09:58:01.502431 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:58:01.514577 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m09:58:01.517416 [debug] [MainThread]: On master: COMMIT
[0m09:58:01.519791 [debug] [MainThread]: Using postgres connection "master"
[0m09:58:01.522012 [debug] [MainThread]: On master: COMMIT
[0m09:58:01.524042 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:58:01.525724 [debug] [MainThread]: On master: Close
[0m09:58:01.527905 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:58:01.529807 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m09:58:01.533873 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:58:01.537163 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:58:01.539509 [info ] [MainThread]: 
[0m09:58:01.541128 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.62 seconds (0.62s).
[0m09:58:01.543203 [debug] [MainThread]: Command end result
[0m09:58:01.627962 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:58:01.639149 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:58:01.651337 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:58:01.652486 [info ] [MainThread]: 
[0m09:58:01.653703 [info ] [MainThread]: [31mCompleted with 2 errors, 0 partial successes, and 0 warnings:[0m
[0m09:58:01.655317 [info ] [MainThread]: 
[0m09:58:01.656547 [error] [MainThread]: [31mFailure in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)[0m
[0m09:58:01.657722 [error] [MainThread]:   Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:58:01.658730 [info ] [MainThread]: 
[0m09:58:01.659880 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:58:01.660924 [info ] [MainThread]: 
[0m09:58:01.662023 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:58:01.663539 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 44: ORDER BY measurement_hour;
                                    ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:58:01.664408 [info ] [MainThread]: 
[0m09:58:01.666702 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:58:01.667594 [info ] [MainThread]: 
[0m09:58:01.668509 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=2 SKIP=0 NO-OP=0 TOTAL=3
[0m09:58:01.671001 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.631587, "process_in_blocks": "0", "process_kernel_time": 1.125536, "process_mem_max_rss": "131372", "process_out_blocks": "0", "process_user_time": 2.343526}
[0m09:58:01.672455 [debug] [MainThread]: Command `dbt run` failed at 09:58:01.672337 after 3.63 seconds
[0m09:58:01.673472 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa14c156e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa14c156dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7aa144468790>]}
[0m09:58:01.674362 [debug] [MainThread]: Flushing usage events
[0m09:58:02.219007 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m09:59:04.368064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b90991610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b9097bd90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b909765d0>]}


============================== 09:59:04.379237 | 0a209ef9-4579-45a0-afc6-f2bbe632b1dc ==============================
[0m09:59:04.379237 [info ] [MainThread]: Running with dbt=1.10.15
[0m09:59:04.382014 [debug] [MainThread]: running dbt with arguments {'fail_fast': 'False', 'partial_parse': 'True', 'printer_width': '80', 'debug': 'False', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'no_print': 'None', 'version_check': 'True', 'log_cache_events': 'False', 'indirect_selection': 'eager', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'send_anonymous_usage_stats': 'True', 'cache_selected_only': 'False', 'use_experimental_parser': 'False', 'static_parser': 'True', 'empty': 'False', 'use_colors': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'profiles_dir': '/usr/app/dbt/dbt', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])'}
[0m09:59:04.541165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0a209ef9-4579-45a0-afc6-f2bbe632b1dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b9012eb10>]}
[0m09:59:04.591537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0a209ef9-4579-45a0-afc6-f2bbe632b1dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b936e2810>]}
[0m09:59:04.594257 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m09:59:04.728369 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m09:59:06.678012 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m09:59:06.679608 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m09:59:07.065276 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0a209ef9-4579-45a0-afc6-f2bbe632b1dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b8e58e4d0>]}
[0m09:59:07.171527 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:59:07.179503 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:59:07.218741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0a209ef9-4579-45a0-afc6-f2bbe632b1dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b8c14af90>]}
[0m09:59:07.220770 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m09:59:07.222618 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a209ef9-4579-45a0-afc6-f2bbe632b1dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b8e5418d0>]}
[0m09:59:07.225840 [info ] [MainThread]: 
[0m09:59:07.227103 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m09:59:07.228397 [info ] [MainThread]: 
[0m09:59:07.230530 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m09:59:07.237376 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m09:59:07.293166 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m09:59:07.294546 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m09:59:07.295760 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:59:07.309933 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.014 seconds
[0m09:59:07.312960 [debug] [ThreadPool]: On list_data_project_1: Close
[0m09:59:07.316207 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m09:59:07.325134 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:59:07.326609 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m09:59:07.327774 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:59:07.338316 [debug] [ThreadPool]: SQL status: BEGIN in 0.010 seconds
[0m09:59:07.339857 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m09:59:07.341087 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m09:59:07.348610 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m09:59:07.353186 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m09:59:07.355143 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m09:59:07.363857 [debug] [MainThread]: Using postgres connection "master"
[0m09:59:07.365146 [debug] [MainThread]: On master: BEGIN
[0m09:59:07.368414 [debug] [MainThread]: Opening a new connection, currently in state init
[0m09:59:07.403470 [debug] [MainThread]: SQL status: BEGIN in 0.035 seconds
[0m09:59:07.412183 [debug] [MainThread]: Using postgres connection "master"
[0m09:59:07.418339 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m09:59:07.430824 [debug] [MainThread]: SQL status: SELECT 1 in 0.010 seconds
[0m09:59:07.437501 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a209ef9-4579-45a0-afc6-f2bbe632b1dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b910a7350>]}
[0m09:59:07.440174 [debug] [MainThread]: On master: ROLLBACK
[0m09:59:07.442802 [debug] [MainThread]: Using postgres connection "master"
[0m09:59:07.445037 [debug] [MainThread]: On master: BEGIN
[0m09:59:07.448581 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m09:59:07.452256 [debug] [MainThread]: On master: COMMIT
[0m09:59:07.454056 [debug] [MainThread]: Using postgres connection "master"
[0m09:59:07.455526 [debug] [MainThread]: On master: COMMIT
[0m09:59:07.457280 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:59:07.458579 [debug] [MainThread]: On master: Close
[0m09:59:07.467692 [debug] [Thread-1 (]: Began running node model.data_project_1.int_air_quality_daily
[0m09:59:07.468352 [debug] [Thread-2 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m09:59:07.470204 [info ] [Thread-1 (]: 1 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m09:59:07.471830 [info ] [Thread-2 (]: 2 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m09:59:07.473425 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.int_air_quality_daily)
[0m09:59:07.475020 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.data_project_1.stg_air_quality_valencia'
[0m09:59:07.476217 [debug] [Thread-1 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m09:59:07.478145 [debug] [Thread-2 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m09:59:07.486757 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m09:59:07.496902 [debug] [Thread-2 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m09:59:07.525265 [debug] [Thread-2 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m09:59:07.526211 [debug] [Thread-1 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m09:59:07.574492 [debug] [Thread-2 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m09:59:07.584667 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m09:59:07.595470 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m09:59:07.596031 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:59:07.597077 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m09:59:07.598670 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m09:59:07.600853 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m09:59:07.602155 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m09:59:07.611596 [debug] [Thread-2 (]: SQL status: BEGIN in 0.009 seconds
[0m09:59:07.613637 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:59:07.614349 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m09:59:07.615399 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m09:59:07.617872 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m09:59:07.620355 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
    location_id, 
    station_name, 
    pollution_type, 
    DATE TRUNC ('day', measurament_timestamp) AS measurament_day,
    AVG (concentration_ug_m3) AS avg_daily,
    MAX (concentration_ug_m3) AS max_daily
    MIN (concentration_ug_m3) AS min_daily,
    COUNT (*) AS num_measuraments
    
FROM base
GROUP BY 1,2,3,4
),

variation AS (
     SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT * FROM variation
ORDER BY measurement_day;
--Este modelo intermedio calcula promedios diarios, mÃ¡ximos, mÃ­nimos y variaciones diarias para cada estaciÃ³n y contaminante. Proporciona una base sÃ³lida para anÃ¡lisis mÃ¡s detallados en modelos posteriores.
  );
  
[0m09:59:07.622269 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "("
LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                        ^

[0m09:59:07.623461 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: ROLLBACK
[0m09:59:07.625004 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: Close
[0m09:59:07.625854 [debug] [Thread-2 (]: SQL status: CREATE VIEW in 0.006 seconds
[0m09:59:07.633910 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:59:07.635645 [debug] [Thread-1 (]: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:59:07.653127 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m09:59:07.657507 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a209ef9-4579-45a0-afc6-f2bbe632b1dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b569ace50>]}
[0m09:59:07.659518 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m09:59:07.660207 [error] [Thread-1 (]: 1 of 3 ERROR creating sql table model public.int_air_quality_daily ............. [[31mERROR[0m in 0.18s]
[0m09:59:07.664860 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:59:07.669304 [debug] [Thread-1 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m09:59:07.671064 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m09:59:07.673239 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_daily' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql.
[0m09:59:07.676209 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m09:59:07.688666 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:59:07.690380 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:59:07.691815 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m09:59:07.695602 [debug] [Thread-2 (]: SQL status: COMMIT in 0.003 seconds
[0m09:59:07.703228 [debug] [Thread-2 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m09:59:07.707847 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m09:59:07.709169 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m09:59:07.715891 [debug] [Thread-2 (]: SQL status: DROP VIEW in 0.005 seconds
[0m09:59:07.721658 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m09:59:07.723482 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a209ef9-4579-45a0-afc6-f2bbe632b1dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b57363350>]}
[0m09:59:07.726054 [info ] [Thread-2 (]: 2 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.25s]
[0m09:59:07.729258 [debug] [Thread-2 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m09:59:07.731230 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m09:59:07.733914 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m09:59:07.735581 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m09:59:07.737504 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m09:59:07.743051 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m09:59:07.756648 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m09:59:07.762737 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m09:59:07.783866 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:59:07.789836 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m09:59:07.790879 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m09:59:07.801468 [debug] [Thread-4 (]: SQL status: BEGIN in 0.010 seconds
[0m09:59:07.803141 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m09:59:07.805165 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        station_code,
        pollutant,
        measurament_timestamp,
        measurament_value
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        station_code,
        pollutant,
        DATE_TRUNC('hour', measurament_timestamp) AS measurement_hour,
        AVG(measurament_value) AS avg_value
    FROM base
    GROUP BY
        station_code,
        pollutant,
        DATE_TRUNC('hour', measurament_timestamp)
)

SELECT *
FROM hourly

--Este modelo intermedio calcula promedios horarios de concentraciÃ³n de contaminantes por estaciÃ³n, proporcionando una base para anÃ¡lisis diarios y mensuales posteriores.
  );
  
[0m09:59:07.814821 [debug] [Thread-4 (]: Postgres adapter: Postgres error: column "station_code" does not exist
LINE 16:         station_code,
                 ^
HINT:  Perhaps you meant to reference the column "stg_air_quality_valencia.station_name".

[0m09:59:07.817727 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m09:59:07.819873 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m09:59:07.822934 [debug] [Thread-4 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  column "station_code" does not exist
  LINE 16:         station_code,
                   ^
  HINT:  Perhaps you meant to reference the column "stg_air_quality_valencia.station_name".
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:59:07.824855 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a209ef9-4579-45a0-afc6-f2bbe632b1dc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b5471a390>]}
[0m09:59:07.826862 [error] [Thread-4 (]: 3 of 3 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.09s]
[0m09:59:07.828272 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m09:59:07.829736 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  column "station_code" does not exist
  LINE 16:         station_code,
                   ^
  HINT:  Perhaps you meant to reference the column "stg_air_quality_valencia.station_name".
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m09:59:07.834428 [debug] [MainThread]: Using postgres connection "master"
[0m09:59:07.835868 [debug] [MainThread]: On master: BEGIN
[0m09:59:07.836861 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m09:59:07.847973 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m09:59:07.850526 [debug] [MainThread]: On master: COMMIT
[0m09:59:07.851885 [debug] [MainThread]: Using postgres connection "master"
[0m09:59:07.853500 [debug] [MainThread]: On master: COMMIT
[0m09:59:07.854908 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m09:59:07.855705 [debug] [MainThread]: On master: Close
[0m09:59:07.856966 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:59:07.860101 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m09:59:07.864371 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m09:59:07.866293 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m09:59:07.867752 [info ] [MainThread]: 
[0m09:59:07.869008 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.64 seconds (0.64s).
[0m09:59:07.870567 [debug] [MainThread]: Command end result
[0m09:59:07.961223 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m09:59:07.972430 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m09:59:07.986820 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m09:59:07.987855 [info ] [MainThread]: 
[0m09:59:07.989092 [info ] [MainThread]: [31mCompleted with 2 errors, 0 partial successes, and 0 warnings:[0m
[0m09:59:07.990632 [info ] [MainThread]: 
[0m09:59:07.992147 [error] [MainThread]: [31mFailure in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)[0m
[0m09:59:07.993509 [error] [MainThread]:   Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:59:07.995139 [info ] [MainThread]: 
[0m09:59:07.996220 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m09:59:07.998277 [info ] [MainThread]: 
[0m09:59:08.000119 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m09:59:08.001787 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  column "station_code" does not exist
  LINE 16:         station_code,
                   ^
  HINT:  Perhaps you meant to reference the column "stg_air_quality_valencia.station_name".
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:59:08.003524 [info ] [MainThread]: 
[0m09:59:08.005158 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m09:59:08.006545 [info ] [MainThread]: 
[0m09:59:08.008180 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=2 SKIP=0 NO-OP=0 TOTAL=3
[0m09:59:08.010616 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.7263813, "process_in_blocks": "0", "process_kernel_time": 0.564562, "process_mem_max_rss": "134768", "process_out_blocks": "0", "process_user_time": 2.213574}
[0m09:59:08.012044 [debug] [MainThread]: Command `dbt run` failed at 09:59:08.011867 after 3.73 seconds
[0m09:59:08.015076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b90965d50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b951cecd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7e8b951cec50>]}
[0m09:59:08.018119 [debug] [MainThread]: Flushing usage events
[0m09:59:08.605757 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:00:11.112269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b26312cdd10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b26312cead0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b26316df650>]}


============================== 10:00:11.122106 | a4c689bb-c869-4ef0-ad23-ef0f829e7b5b ==============================
[0m10:00:11.122106 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:00:11.123774 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'use_experimental_parser': 'False', 'warn_error': 'None', 'empty': 'False', 'write_json': 'True', 'use_colors': 'True', 'cache_selected_only': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_format': 'default', 'printer_width': '80', 'indirect_selection': 'eager', 'no_print': 'None', 'fail_fast': 'False', 'log_cache_events': 'False', 'version_check': 'True', 'quiet': 'False', 'partial_parse': 'True', 'static_parser': 'True', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'invocation_command': 'dbt run', 'introspect': 'True', 'profiles_dir': '/usr/app/dbt/dbt'}
[0m10:00:11.290725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a4c689bb-c869-4ef0-ad23-ef0f829e7b5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b263125c550>]}
[0m10:00:11.347746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a4c689bb-c869-4ef0-ad23-ef0f829e7b5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2633fca910>]}
[0m10:00:11.351018 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:00:11.510023 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:00:13.436913 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:13.438082 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:13.470277 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a4c689bb-c869-4ef0-ad23-ef0f829e7b5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b262fd48950>]}
[0m10:00:13.570493 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:00:13.581370 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:00:13.617768 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a4c689bb-c869-4ef0-ad23-ef0f829e7b5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b26305aec90>]}
[0m10:00:13.619328 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m10:00:13.620860 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a4c689bb-c869-4ef0-ad23-ef0f829e7b5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2632fd9290>]}
[0m10:00:13.624543 [info ] [MainThread]: 
[0m10:00:13.626897 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:00:13.627883 [info ] [MainThread]: 
[0m10:00:13.629407 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:00:13.633295 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:00:13.748350 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:00:13.752224 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:00:13.754130 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:13.772454 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m10:00:13.775984 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:00:13.779621 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:00:13.789864 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:00:13.791365 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:00:13.792874 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:13.804259 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m10:00:13.805742 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:00:13.807031 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:00:13.814619 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.006 seconds
[0m10:00:13.817046 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:00:13.818453 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:00:13.824917 [debug] [MainThread]: Using postgres connection "master"
[0m10:00:13.826125 [debug] [MainThread]: On master: BEGIN
[0m10:00:13.827211 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:00:13.837493 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m10:00:13.838810 [debug] [MainThread]: Using postgres connection "master"
[0m10:00:13.839712 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:00:13.846730 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m10:00:13.849412 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a4c689bb-c869-4ef0-ad23-ef0f829e7b5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b262f1ddd50>]}
[0m10:00:13.850747 [debug] [MainThread]: On master: ROLLBACK
[0m10:00:13.851939 [debug] [MainThread]: Using postgres connection "master"
[0m10:00:13.852815 [debug] [MainThread]: On master: BEGIN
[0m10:00:13.853905 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m10:00:13.854834 [debug] [MainThread]: On master: COMMIT
[0m10:00:13.855843 [debug] [MainThread]: Using postgres connection "master"
[0m10:00:13.856552 [debug] [MainThread]: On master: COMMIT
[0m10:00:13.857407 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:00:13.858114 [debug] [MainThread]: On master: Close
[0m10:00:13.866007 [debug] [Thread-1 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:00:13.866569 [debug] [Thread-2 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:00:13.867695 [info ] [Thread-1 (]: 1 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:00:13.869546 [info ] [Thread-2 (]: 2 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:00:13.871376 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.int_air_quality_daily)
[0m10:00:13.873066 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.data_project_1.stg_air_quality_valencia'
[0m10:00:13.873984 [debug] [Thread-1 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:00:13.874851 [debug] [Thread-2 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:00:13.883427 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:00:13.895711 [debug] [Thread-2 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:00:13.903761 [debug] [Thread-1 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:00:13.904485 [debug] [Thread-2 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:00:13.944956 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:00:13.951187 [debug] [Thread-2 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:00:13.956978 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:00:13.957669 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:00:13.958338 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:00:13.958996 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:00:13.960401 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:00:13.961501 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m10:00:13.966487 [debug] [Thread-1 (]: SQL status: BEGIN in 0.008 seconds
[0m10:00:13.967302 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:00:13.967938 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
    location_id, 
    station_name, 
    pollution_type, 
    DATE TRUNC ('day', measurament_timestamp) AS measurament_day,
    AVG (concentration_ug_m3) AS avg_daily,
    MAX (concentration_ug_m3) AS max_daily
    MIN (concentration_ug_m3) AS min_daily,
    COUNT (*) AS num_measuraments
    
FROM base
GROUP BY 1,2,3,4
),

variation AS (
     SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT * FROM variation
ORDER BY measurement_day;
--Este modelo intermedio calcula promedios diarios, mÃ¡ximos, mÃ­nimos y variaciones diarias para cada estaciÃ³n y contaminante. Proporciona una base sÃ³lida para anÃ¡lisis mÃ¡s detallados en modelos posteriores.
  );
  
[0m10:00:13.969468 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "("
LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                        ^

[0m10:00:13.970158 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: ROLLBACK
[0m10:00:13.970977 [debug] [Thread-1 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:00:13.974073 [debug] [Thread-1 (]: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m10:00:13.974342 [debug] [Thread-2 (]: SQL status: BEGIN in 0.013 seconds
[0m10:00:13.975923 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4c689bb-c869-4ef0-ad23-ef0f829e7b5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b263117e9d0>]}
[0m10:00:13.976512 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:00:13.977570 [error] [Thread-1 (]: 1 of 3 ERROR creating sql table model public.int_air_quality_daily ............. [[31mERROR[0m in 0.10s]
[0m10:00:13.978693 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:00:13.980144 [debug] [Thread-1 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:00:13.982784 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_daily' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql.
[0m10:00:13.987463 [debug] [Thread-2 (]: SQL status: CREATE VIEW in 0.005 seconds
[0m10:00:13.992522 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:00:13.993470 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:00:13.998913 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.004 seconds
[0m10:00:14.004400 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:00:14.005427 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:00:14.007282 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:00:14.019728 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:00:14.020783 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:00:14.021537 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:00:14.024825 [debug] [Thread-2 (]: SQL status: COMMIT in 0.003 seconds
[0m10:00:14.029480 [debug] [Thread-2 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:00:14.038228 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:00:14.040039 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:00:14.045100 [debug] [Thread-2 (]: SQL status: DROP VIEW in 0.003 seconds
[0m10:00:14.049772 [debug] [Thread-2 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:00:14.051097 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4c689bb-c869-4ef0-ad23-ef0f829e7b5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b262fd48390>]}
[0m10:00:14.052678 [info ] [Thread-2 (]: 2 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.18s]
[0m10:00:14.054219 [debug] [Thread-2 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:00:14.055751 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:00:14.057156 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:00:14.058371 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:00:14.059329 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:00:14.065136 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:00:14.073948 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:00:14.078007 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:00:14.089937 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:00:14.090912 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:00:14.091793 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:00:14.101318 [debug] [Thread-4 (]: SQL status: BEGIN in 0.009 seconds
[0m10:00:14.102532 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:00:14.103458 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        station_code,
        pollutant,
        measurament_timestamp,
        measurament_value
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        station_code,
        pollutant,
        DATE_TRUNC('hour', measurament_timestamp) AS measurement_hour,
        AVG(measurament_value) AS avg_value
    FROM base
    GROUP BY
        station_code,
        pollutant,
        DATE_TRUNC('hour', measurament_timestamp)
)

SELECT *
FROM hourly

--Este modelo intermedio calcula promedios horarios de concentraciÃ³n de contaminantes por estaciÃ³n, proporcionando una base para anÃ¡lisis diarios y mensuales posteriores.
  );
  
[0m10:00:14.105896 [debug] [Thread-4 (]: Postgres adapter: Postgres error: column "station_code" does not exist
LINE 16:         station_code,
                 ^
HINT:  Perhaps you meant to reference the column "stg_air_quality_valencia.station_name".

[0m10:00:14.106825 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m10:00:14.107864 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:00:14.110886 [debug] [Thread-4 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  column "station_code" does not exist
  LINE 16:         station_code,
                   ^
  HINT:  Perhaps you meant to reference the column "stg_air_quality_valencia.station_name".
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m10:00:14.111854 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4c689bb-c869-4ef0-ad23-ef0f829e7b5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b262c693490>]}
[0m10:00:14.113097 [error] [Thread-4 (]: 3 of 3 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.05s]
[0m10:00:14.150215 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:00:14.152169 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  column "station_code" does not exist
  LINE 16:         station_code,
                   ^
  HINT:  Perhaps you meant to reference the column "stg_air_quality_valencia.station_name".
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m10:00:14.156268 [debug] [MainThread]: Using postgres connection "master"
[0m10:00:14.157879 [debug] [MainThread]: On master: BEGIN
[0m10:00:14.159300 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:00:14.172778 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m10:00:14.174859 [debug] [MainThread]: On master: COMMIT
[0m10:00:14.176516 [debug] [MainThread]: Using postgres connection "master"
[0m10:00:14.178319 [debug] [MainThread]: On master: COMMIT
[0m10:00:14.180028 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:00:14.182820 [debug] [MainThread]: On master: Close
[0m10:00:14.184764 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:00:14.188812 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:00:14.190084 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:00:14.191257 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:00:14.192490 [info ] [MainThread]: 
[0m10:00:14.194188 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.56 seconds (0.56s).
[0m10:00:14.198903 [debug] [MainThread]: Command end result
[0m10:00:14.258712 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:00:14.272279 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:00:14.291508 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:00:14.294195 [info ] [MainThread]: 
[0m10:00:14.295673 [info ] [MainThread]: [31mCompleted with 2 errors, 0 partial successes, and 0 warnings:[0m
[0m10:00:14.298947 [info ] [MainThread]: 
[0m10:00:14.303695 [error] [MainThread]: [31mFailure in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)[0m
[0m10:00:14.308140 [error] [MainThread]:   Database Error in model int_air_quality_daily (models/intermediate/int_air_quality_daily.sql)
  syntax error at or near "("
  LINE 19:     DATE TRUNC ('day', measurament_timestamp) AS measurament...
                          ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m10:00:14.310390 [info ] [MainThread]: 
[0m10:00:14.311929 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_daily.sql
[0m10:00:14.313249 [info ] [MainThread]: 
[0m10:00:14.317081 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m10:00:14.319259 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  column "station_code" does not exist
  LINE 16:         station_code,
                   ^
  HINT:  Perhaps you meant to reference the column "stg_air_quality_valencia.station_name".
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m10:00:14.323794 [info ] [MainThread]: 
[0m10:00:14.325495 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m10:00:14.327317 [info ] [MainThread]: 
[0m10:00:14.329039 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=2 SKIP=0 NO-OP=0 TOTAL=3
[0m10:00:14.334746 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.2941155, "process_in_blocks": "0", "process_kernel_time": 0.70183, "process_mem_max_rss": "128756", "process_out_blocks": "0", "process_user_time": 2.009977}
[0m10:00:14.337565 [debug] [MainThread]: Command `dbt run` failed at 10:00:14.337451 after 3.30 seconds
[0m10:00:14.338762 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2635aaae50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b263140fb90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b2635b729d0>]}
[0m10:00:14.339759 [debug] [MainThread]: Flushing usage events
[0m10:00:14.889655 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:01:16.999125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2edc0d7d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2edc6e390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2edc0c550>]}


============================== 10:01:17.007010 | 28880936-744d-4754-94ab-2e175841a27e ==============================
[0m10:01:17.007010 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:01:17.008470 [debug] [MainThread]: running dbt with arguments {'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_format': 'default', 'debug': 'False', 'use_experimental_parser': 'False', 'invocation_command': 'dbt run', 'version_check': 'True', 'quiet': 'False', 'static_parser': 'True', 'write_json': 'True', 'empty': 'False', 'warn_error': 'None', 'no_print': 'None', 'use_colors': 'True', 'introspect': 'True', 'printer_width': '80', 'cache_selected_only': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'log_cache_events': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'fail_fast': 'False', 'send_anonymous_usage_stats': 'True', 'indirect_selection': 'eager', 'target_path': 'None'}
[0m10:01:17.170188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '28880936-744d-4754-94ab-2e175841a27e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2eead5bd0>]}
[0m10:01:17.223296 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '28880936-744d-4754-94ab-2e175841a27e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2ec9ce410>]}
[0m10:01:17.225283 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:01:17.381658 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:01:19.311585 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m10:01:19.313125 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_daily.sql
[0m10:01:19.314560 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m10:01:19.737894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '28880936-744d-4754-94ab-2e175841a27e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2edd5f3d0>]}
[0m10:01:19.838344 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:01:19.853509 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:01:19.900955 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '28880936-744d-4754-94ab-2e175841a27e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2eb5d8f90>]}
[0m10:01:19.902480 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m10:01:19.903892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '28880936-744d-4754-94ab-2e175841a27e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2eb5f6c10>]}
[0m10:01:19.906783 [info ] [MainThread]: 
[0m10:01:19.909236 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:01:19.911324 [info ] [MainThread]: 
[0m10:01:19.912306 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:01:19.916734 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:01:19.957078 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:01:19.959192 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:01:19.960948 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:01:19.974295 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.013 seconds
[0m10:01:19.977978 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:01:19.982435 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:01:19.988318 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:01:19.989532 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:01:19.990992 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:01:20.002324 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m10:01:20.004247 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:01:20.005389 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:01:20.014615 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.008 seconds
[0m10:01:20.017980 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:01:20.019766 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:01:20.026381 [debug] [MainThread]: Using postgres connection "master"
[0m10:01:20.027713 [debug] [MainThread]: On master: BEGIN
[0m10:01:20.028934 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:01:20.040467 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m10:01:20.042871 [debug] [MainThread]: Using postgres connection "master"
[0m10:01:20.044409 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:01:20.053729 [debug] [MainThread]: SQL status: SELECT 1 in 0.008 seconds
[0m10:01:20.056820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '28880936-744d-4754-94ab-2e175841a27e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2eb582390>]}
[0m10:01:20.059976 [debug] [MainThread]: On master: ROLLBACK
[0m10:01:20.062941 [debug] [MainThread]: Using postgres connection "master"
[0m10:01:20.064560 [debug] [MainThread]: On master: BEGIN
[0m10:01:20.066612 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m10:01:20.068492 [debug] [MainThread]: On master: COMMIT
[0m10:01:20.070288 [debug] [MainThread]: Using postgres connection "master"
[0m10:01:20.071910 [debug] [MainThread]: On master: COMMIT
[0m10:01:20.074080 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:01:20.075976 [debug] [MainThread]: On master: Close
[0m10:01:20.086264 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:01:20.088121 [info ] [Thread-1 (]: 1 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:01:20.089914 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:01:20.091588 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:01:20.109865 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:01:20.122729 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:01:20.146985 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:01:20.159947 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:01:20.161159 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:01:20.162142 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:01:20.174889 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m10:01:20.176569 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:01:20.178105 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:01:20.189743 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.009 seconds
[0m10:01:20.200749 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:01:20.202620 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:01:20.205943 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m10:01:20.211317 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:01:20.212718 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:01:20.215484 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:01:20.230284 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:01:20.231802 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:01:20.233069 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:01:20.237588 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m10:01:20.244900 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:01:20.251013 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:01:20.252275 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:01:20.258880 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m10:01:20.262849 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:01:20.265066 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '28880936-744d-4754-94ab-2e175841a27e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2e8964690>]}
[0m10:01:20.266747 [info ] [Thread-1 (]: 1 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.17s]
[0m10:01:20.268333 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:01:20.272348 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:01:20.273146 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:01:20.274893 [info ] [Thread-3 (]: 2 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:01:20.276758 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:01:20.279197 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:01:20.280577 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:01:20.281936 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:01:20.283280 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:01:20.287158 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:01:20.290435 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:01:20.300249 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:01:20.307353 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:01:20.319680 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:01:20.325198 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:01:20.343266 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:01:20.345135 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:01:20.345677 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:01:20.347012 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:01:20.348452 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:01:20.351401 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:01:20.360075 [debug] [Thread-3 (]: SQL status: BEGIN in 0.013 seconds
[0m10:01:20.362166 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:01:20.364240 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY location_id, station_name, pollutant_type, measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
--Este modelo intermedio calcula promedios diarios de concentraciÃ³n de contaminantes por estaciÃ³n, junto con la variaciÃ³n respecto al dÃ­a anterior, proporcionando una base para anÃ¡lisis mensuales y tendencias.
  );
  
[0m10:01:20.365241 [debug] [Thread-4 (]: SQL status: BEGIN in 0.014 seconds
[0m10:01:20.368387 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:01:20.370934 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY location_id, station_name, pollutant_type, measurement_hour
),

variation AS (
    SELECT
        *,
        avg_hourly - LAG(avg_hourly) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_hour
        ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation
--Este modelo intermedio calcula promedios horarios de concentraciÃ³n de contaminantes por estaciÃ³n, junto con la variaciÃ³n respecto a la hora anterior, proporcionando una base para anÃ¡lisis diarios y tendencias.
  );
  
[0m10:01:20.407821 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.041 seconds
[0m10:01:20.408727 [debug] [Thread-4 (]: SQL status: SELECT 572 in 0.035 seconds
[0m10:01:20.416005 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:01:20.419927 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:01:20.421651 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:01:20.423324 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp" rename to "int_air_quality_hourly"
[0m10:01:20.425520 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:01:20.426443 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:01:20.427998 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:01:20.430809 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:01:20.432387 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:01:20.434157 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:01:20.435406 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:01:20.437231 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:01:20.442327 [debug] [Thread-3 (]: SQL status: COMMIT in 0.003 seconds
[0m10:01:20.443641 [debug] [Thread-4 (]: SQL status: COMMIT in 0.003 seconds
[0m10:01:20.446272 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:01:20.449889 [debug] [Thread-4 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_hourly__dbt_backup"
[0m10:01:20.454408 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:01:20.456508 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:01:20.458211 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:01:20.459957 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."int_air_quality_hourly__dbt_backup" cascade
[0m10:01:20.463852 [debug] [Thread-4 (]: SQL status: DROP TABLE in 0.001 seconds
[0m10:01:20.464307 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.003 seconds
[0m10:01:20.466369 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:01:20.468593 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:01:20.470969 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '28880936-744d-4754-94ab-2e175841a27e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2eb53df50>]}
[0m10:01:20.472671 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '28880936-744d-4754-94ab-2e175841a27e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2e84a9b50>]}
[0m10:01:20.475085 [info ] [Thread-4 (]: 3 of 3 OK created sql table model public.int_air_quality_hourly ................ [[32mSELECT 572[0m in 0.19s]
[0m10:01:20.477456 [info ] [Thread-3 (]: 2 of 3 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.19s]
[0m10:01:20.479225 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:01:20.481170 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:01:20.486112 [debug] [MainThread]: Using postgres connection "master"
[0m10:01:20.487553 [debug] [MainThread]: On master: BEGIN
[0m10:01:20.488926 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:01:20.502460 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m10:01:20.504315 [debug] [MainThread]: On master: COMMIT
[0m10:01:20.505895 [debug] [MainThread]: Using postgres connection "master"
[0m10:01:20.507815 [debug] [MainThread]: On master: COMMIT
[0m10:01:20.510058 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:01:20.511728 [debug] [MainThread]: On master: Close
[0m10:01:20.513631 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:01:20.515115 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:01:20.516513 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:01:20.517901 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:01:20.519297 [info ] [MainThread]: 
[0m10:01:20.520707 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.61 seconds (0.61s).
[0m10:01:20.522700 [debug] [MainThread]: Command end result
[0m10:01:20.606735 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:01:20.625692 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:01:20.643200 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:01:20.647897 [info ] [MainThread]: 
[0m10:01:20.651339 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:01:20.652785 [info ] [MainThread]: 
[0m10:01:20.655370 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m10:01:20.658198 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.724845, "process_in_blocks": "0", "process_kernel_time": 0.542083, "process_mem_max_rss": "133896", "process_out_blocks": "0", "process_user_time": 2.291896}
[0m10:01:20.659393 [debug] [MainThread]: Command `dbt run` succeeded at 10:01:20.659282 after 3.73 seconds
[0m10:01:20.660579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2f2777910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2f252eb90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ea2f252e9d0>]}
[0m10:01:20.661715 [debug] [MainThread]: Flushing usage events
[0m10:01:21.179881 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:02:23.190379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f4986f5050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f498755fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f498714c90>]}


============================== 10:02:23.197572 | 8fa78274-4be6-4a28-aea6-30bb4e30a19b ==============================
[0m10:02:23.197572 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:02:23.199081 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'fail_fast': 'False', 'empty': 'False', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/app/dbt/dbt/logs', 'printer_width': '80', 'log_format': 'default', 'no_print': 'None', 'cache_selected_only': 'False', 'invocation_command': 'dbt run', 'partial_parse': 'True', 'send_anonymous_usage_stats': 'True', 'write_json': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'target_path': 'None', 'use_colors': 'True', 'quiet': 'False', 'version_check': 'True', 'log_cache_events': 'False', 'debug': 'False', 'warn_error': 'None', 'introspect': 'True', 'static_parser': 'True'}
[0m10:02:23.342662 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8fa78274-4be6-4a28-aea6-30bb4e30a19b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f498728150>]}
[0m10:02:23.390668 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8fa78274-4be6-4a28-aea6-30bb4e30a19b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f4986fbb90>]}
[0m10:02:23.392816 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:02:23.509676 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:02:25.204226 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:02:25.205233 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:02:25.235866 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8fa78274-4be6-4a28-aea6-30bb4e30a19b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f496f08190>]}
[0m10:02:25.397765 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:02:25.425821 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:02:25.482324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8fa78274-4be6-4a28-aea6-30bb4e30a19b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f49775e490>]}
[0m10:02:25.484238 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m10:02:25.487643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8fa78274-4be6-4a28-aea6-30bb4e30a19b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f497bc5690>]}
[0m10:02:25.491050 [info ] [MainThread]: 
[0m10:02:25.495011 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:02:25.496541 [info ] [MainThread]: 
[0m10:02:25.498776 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:02:25.504017 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:02:25.623204 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:02:25.626404 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:02:25.628741 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:02:25.649145 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.020 seconds
[0m10:02:25.652293 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:02:25.655395 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:02:25.662880 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:02:25.664293 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:02:25.665790 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:02:25.677811 [debug] [ThreadPool]: SQL status: BEGIN in 0.012 seconds
[0m10:02:25.680704 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:02:25.692232 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:02:25.711567 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.012 seconds
[0m10:02:25.715115 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:02:25.717037 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:02:25.725919 [debug] [MainThread]: Using postgres connection "master"
[0m10:02:25.730280 [debug] [MainThread]: On master: BEGIN
[0m10:02:25.731614 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:02:25.743172 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m10:02:25.745118 [debug] [MainThread]: Using postgres connection "master"
[0m10:02:25.746700 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:02:25.753889 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m10:02:25.757101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8fa78274-4be6-4a28-aea6-30bb4e30a19b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f497bc6dd0>]}
[0m10:02:25.759190 [debug] [MainThread]: On master: ROLLBACK
[0m10:02:25.761266 [debug] [MainThread]: Using postgres connection "master"
[0m10:02:25.762631 [debug] [MainThread]: On master: BEGIN
[0m10:02:25.763941 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m10:02:25.764940 [debug] [MainThread]: On master: COMMIT
[0m10:02:25.766041 [debug] [MainThread]: Using postgres connection "master"
[0m10:02:25.767029 [debug] [MainThread]: On master: COMMIT
[0m10:02:25.768123 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:02:25.769141 [debug] [MainThread]: On master: Close
[0m10:02:25.778966 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:02:25.780302 [info ] [Thread-1 (]: 1 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:02:25.781741 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:02:25.783096 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:02:25.803812 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:02:25.819081 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:02:25.847263 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:02:25.896909 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:02:25.898857 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:02:25.900222 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:02:25.913241 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m10:02:25.914768 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:02:25.915999 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:02:25.924096 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.007 seconds
[0m10:02:25.937072 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:02:25.938235 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:02:25.942050 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.003 seconds
[0m10:02:25.947960 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:02:25.949125 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:02:25.951626 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:02:25.970649 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:02:25.973170 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:02:25.975131 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:02:25.979709 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m10:02:25.989479 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:02:25.999531 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:02:26.002136 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:02:26.009598 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m10:02:26.015592 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:02:26.018882 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fa78274-4be6-4a28-aea6-30bb4e30a19b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f497770550>]}
[0m10:02:26.020701 [info ] [Thread-1 (]: 1 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.24s]
[0m10:02:26.022585 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:02:26.025306 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:02:26.026147 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:02:26.028402 [info ] [Thread-3 (]: 2 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:02:26.030867 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:02:26.033086 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:02:26.035253 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:02:26.037580 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:02:26.038857 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:02:26.044940 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:02:26.050355 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:02:26.060617 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:02:26.061657 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:02:26.091592 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:02:26.092511 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:02:26.100788 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:02:26.102123 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:02:26.102619 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:02:26.103622 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:02:26.104682 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:02:26.105928 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:02:26.118839 [debug] [Thread-3 (]: SQL status: BEGIN in 0.014 seconds
[0m10:02:26.120579 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:02:26.121045 [debug] [Thread-4 (]: SQL status: BEGIN in 0.015 seconds
[0m10:02:26.122069 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY location_id, station_name, pollutant_type, measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
--Este modelo intermedio calcula promedios diarios de concentraciÃ³n de contaminantes por estaciÃ³n, junto con la variaciÃ³n respecto al dÃ­a anterior, proporcionando una base para anÃ¡lisis mensuales y tendencias.
  );
  
[0m10:02:26.123274 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:02:26.127221 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY location_id, station_name, pollutant_type, measurement_hour
),

variation AS (
    SELECT
        *,
        avg_hourly - LAG(avg_hourly) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_hour
        ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation
--Este modelo intermedio calcula promedios horarios de concentraciÃ³n de contaminantes por estaciÃ³n, junto con la variaciÃ³n respecto a la hora anterior, proporcionando una base para anÃ¡lisis diarios y tendencias.
  );
  
[0m10:02:26.139152 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.013 seconds
[0m10:02:26.147601 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:02:26.148039 [debug] [Thread-4 (]: SQL status: SELECT 572 in 0.019 seconds
[0m10:02:26.148919 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:02:26.151744 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:02:26.153451 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:02:26.153854 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly" rename to "int_air_quality_hourly__dbt_backup"
[0m10:02:26.156230 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:02:26.158109 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:02:26.159243 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:02:26.163882 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:02:26.166084 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp" rename to "int_air_quality_hourly"
[0m10:02:26.166398 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:02:26.167671 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.000 seconds
[0m10:02:26.168989 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:02:26.170621 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:02:26.171563 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:02:26.172438 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:02:26.173450 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:02:26.175193 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:02:26.184602 [debug] [Thread-3 (]: SQL status: COMMIT in 0.008 seconds
[0m10:02:26.188414 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:02:26.188948 [debug] [Thread-4 (]: SQL status: COMMIT in 0.012 seconds
[0m10:02:26.195247 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:02:26.199566 [debug] [Thread-4 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_hourly__dbt_backup"
[0m10:02:26.201271 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:02:26.202985 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:02:26.205013 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."int_air_quality_hourly__dbt_backup" cascade
[0m10:02:26.211080 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.007 seconds
[0m10:02:26.212685 [debug] [Thread-4 (]: SQL status: DROP TABLE in 0.006 seconds
[0m10:02:26.213877 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:02:26.215550 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:02:26.216745 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fa78274-4be6-4a28-aea6-30bb4e30a19b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f4954d6750>]}
[0m10:02:26.218003 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fa78274-4be6-4a28-aea6-30bb4e30a19b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f495495bd0>]}
[0m10:02:26.219440 [info ] [Thread-3 (]: 2 of 3 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.18s]
[0m10:02:26.220898 [info ] [Thread-4 (]: 3 of 3 OK created sql table model public.int_air_quality_hourly ................ [[32mSELECT 572[0m in 0.18s]
[0m10:02:26.222425 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:02:26.223731 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:02:26.230030 [debug] [MainThread]: Using postgres connection "master"
[0m10:02:26.231237 [debug] [MainThread]: On master: BEGIN
[0m10:02:26.232046 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:02:26.241184 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m10:02:26.244839 [debug] [MainThread]: On master: COMMIT
[0m10:02:26.246735 [debug] [MainThread]: Using postgres connection "master"
[0m10:02:26.248159 [debug] [MainThread]: On master: COMMIT
[0m10:02:26.249794 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:02:26.250875 [debug] [MainThread]: On master: Close
[0m10:02:26.251989 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:02:26.252963 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:02:26.254701 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:02:26.255636 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:02:26.256781 [info ] [MainThread]: 
[0m10:02:26.259838 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.76 seconds (0.76s).
[0m10:02:26.262359 [debug] [MainThread]: Command end result
[0m10:02:26.330223 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:02:26.338854 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:02:26.348504 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:02:26.349599 [info ] [MainThread]: 
[0m10:02:26.351363 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:02:26.354226 [info ] [MainThread]: 
[0m10:02:26.355665 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m10:02:26.358762 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.239736, "process_in_blocks": "0", "process_kernel_time": 0.509292, "process_mem_max_rss": "129752", "process_out_blocks": "0", "process_user_time": 1.981464}
[0m10:02:26.360542 [debug] [MainThread]: Command `dbt run` succeeded at 10:02:26.360317 after 3.24 seconds
[0m10:02:26.361883 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f49d253910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f49d00a7d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70f49d00a5d0>]}
[0m10:02:26.363056 [debug] [MainThread]: Flushing usage events
[0m10:02:26.907805 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:03:29.081301 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705ed0b38050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705ecde6e790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705ed0b52c10>]}


============================== 10:03:29.091016 | cd46f003-70ff-43ab-82bc-b7073a23a380 ==============================
[0m10:03:29.091016 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:03:29.092836 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'log_format': 'default', 'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'invocation_command': 'dbt run', 'static_parser': 'True', 'no_print': 'None', 'cache_selected_only': 'False', 'debug': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'indirect_selection': 'eager', 'fail_fast': 'False', 'quiet': 'False', 'write_json': 'True', 'warn_error': 'None', 'version_check': 'True', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'empty': 'False', 'use_experimental_parser': 'False', 'log_cache_events': 'False', 'introspect': 'True', 'use_colors': 'True'}
[0m10:03:29.243297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cd46f003-70ff-43ab-82bc-b7073a23a380', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705eccfb1490>]}
[0m10:03:29.303419 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cd46f003-70ff-43ab-82bc-b7073a23a380', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705ed0b6e490>]}
[0m10:03:29.306541 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:03:29.453375 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:03:31.481324 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:03:31.483155 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m10:03:31.892329 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cd46f003-70ff-43ab-82bc-b7073a23a380', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705ecc7dfdd0>]}
[0m10:03:32.013955 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:03:32.023936 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:03:32.072403 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cd46f003-70ff-43ab-82bc-b7073a23a380', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705ecb704c90>]}
[0m10:03:32.074258 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m10:03:32.075789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cd46f003-70ff-43ab-82bc-b7073a23a380', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705ecbff89d0>]}
[0m10:03:32.079080 [info ] [MainThread]: 
[0m10:03:32.080998 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:03:32.082939 [info ] [MainThread]: 
[0m10:03:32.085283 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:03:32.091617 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:03:32.151479 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:03:32.153207 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:03:32.154226 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:03:32.170276 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.016 seconds
[0m10:03:32.173424 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:03:32.176646 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:03:32.183501 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:03:32.185672 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:03:32.187470 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:03:32.201712 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m10:03:32.203823 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:03:32.206180 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:03:32.213731 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.006 seconds
[0m10:03:32.217880 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:03:32.220050 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:03:32.226790 [debug] [MainThread]: Using postgres connection "master"
[0m10:03:32.227996 [debug] [MainThread]: On master: BEGIN
[0m10:03:32.229211 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:03:32.240355 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m10:03:32.242034 [debug] [MainThread]: Using postgres connection "master"
[0m10:03:32.243378 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:03:32.250393 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m10:03:32.253554 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cd46f003-70ff-43ab-82bc-b7073a23a380', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705eccb51c90>]}
[0m10:03:32.254699 [debug] [MainThread]: On master: ROLLBACK
[0m10:03:32.255788 [debug] [MainThread]: Using postgres connection "master"
[0m10:03:32.256562 [debug] [MainThread]: On master: BEGIN
[0m10:03:32.257640 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m10:03:32.259874 [debug] [MainThread]: On master: COMMIT
[0m10:03:32.260728 [debug] [MainThread]: Using postgres connection "master"
[0m10:03:32.261559 [debug] [MainThread]: On master: COMMIT
[0m10:03:32.264598 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:03:32.265912 [debug] [MainThread]: On master: Close
[0m10:03:32.276147 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:03:32.277603 [info ] [Thread-1 (]: 1 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:03:32.281399 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:03:32.282950 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:03:32.303368 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:03:32.315647 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:03:32.352777 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:03:32.369409 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:03:32.370507 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:03:32.371359 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:03:32.382274 [debug] [Thread-1 (]: SQL status: BEGIN in 0.011 seconds
[0m10:03:32.384165 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:03:32.385784 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:03:32.398264 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.011 seconds
[0m10:03:32.404775 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:03:32.406012 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:03:32.408827 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:03:32.416398 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:03:32.418917 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:03:32.421998 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m10:03:32.435646 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:03:32.437915 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:03:32.440779 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:03:32.447327 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m10:03:32.456950 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:03:32.462623 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:03:32.464654 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:03:32.469933 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m10:03:32.474677 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:03:32.477009 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd46f003-70ff-43ab-82bc-b7073a23a380', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705ecb773250>]}
[0m10:03:32.478866 [info ] [Thread-1 (]: 1 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.19s]
[0m10:03:32.482687 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:03:32.485242 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:03:32.485567 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:03:32.486986 [info ] [Thread-3 (]: 2 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:03:32.488645 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:03:32.490349 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:03:32.491415 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:03:32.492334 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:03:32.493432 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:03:32.496855 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:03:32.503344 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:03:32.513874 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:03:32.522153 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:03:32.531854 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:03:32.535998 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:03:32.547149 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:03:32.549489 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:03:32.550962 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:03:32.551992 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:03:32.557592 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:03:32.559023 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:03:32.566578 [debug] [Thread-3 (]: SQL status: BEGIN in 0.016 seconds
[0m10:03:32.568272 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:03:32.569645 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY location_id, station_name, pollutant_type, measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
--Este modelo intermedio calcula promedios diarios de concentraciÃ³n de contaminantes por estaciÃ³n, junto con la variaciÃ³n respecto al dÃ­a anterior, proporcionando una base para anÃ¡lisis mensuales y tendencias.
  );
  
[0m10:03:32.571066 [debug] [Thread-4 (]: SQL status: BEGIN in 0.012 seconds
[0m10:03:32.572911 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:03:32.574331 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_hour
),

variation AS (
    SELECT
        *,
        avg_hourly - LAG(avg_hourly) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_hour
        ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation
  );
  
[0m10:03:32.586074 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.014 seconds
[0m10:03:32.587534 [debug] [Thread-4 (]: SQL status: SELECT 572 in 0.012 seconds
[0m10:03:32.592873 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:03:32.599592 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:03:32.602023 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:03:32.603435 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly" rename to "int_air_quality_hourly__dbt_backup"
[0m10:03:32.605552 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:03:32.609178 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:03:32.609509 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.003 seconds
[0m10:03:32.610939 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:03:32.616645 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:03:32.619383 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:03:32.619727 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp" rename to "int_air_quality_hourly"
[0m10:03:32.621676 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:03:32.623091 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.000 seconds
[0m10:03:32.623549 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:03:32.625177 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:03:32.626088 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:03:32.626910 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:03:32.628748 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:03:32.631674 [debug] [Thread-3 (]: SQL status: COMMIT in 0.004 seconds
[0m10:03:32.635451 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:03:32.635806 [debug] [Thread-4 (]: SQL status: COMMIT in 0.006 seconds
[0m10:03:32.639041 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:03:32.642309 [debug] [Thread-4 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_hourly__dbt_backup"
[0m10:03:32.643293 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:03:32.644910 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:03:32.647648 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."int_air_quality_hourly__dbt_backup" cascade
[0m10:03:32.651696 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.005 seconds
[0m10:03:32.654735 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:03:32.655063 [debug] [Thread-4 (]: SQL status: DROP TABLE in 0.006 seconds
[0m10:03:32.656129 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd46f003-70ff-43ab-82bc-b7073a23a380', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705ec84dda50>]}
[0m10:03:32.657565 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:03:32.659283 [info ] [Thread-3 (]: 2 of 3 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.17s]
[0m10:03:32.660704 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd46f003-70ff-43ab-82bc-b7073a23a380', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705ec8962bd0>]}
[0m10:03:32.662293 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:03:32.664195 [info ] [Thread-4 (]: 3 of 3 OK created sql table model public.int_air_quality_hourly ................ [[32mSELECT 572[0m in 0.17s]
[0m10:03:32.667049 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:03:32.670884 [debug] [MainThread]: Using postgres connection "master"
[0m10:03:32.672186 [debug] [MainThread]: On master: BEGIN
[0m10:03:32.673569 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:03:32.684647 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m10:03:32.687172 [debug] [MainThread]: On master: COMMIT
[0m10:03:32.688468 [debug] [MainThread]: Using postgres connection "master"
[0m10:03:32.689588 [debug] [MainThread]: On master: COMMIT
[0m10:03:32.691395 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:03:32.693226 [debug] [MainThread]: On master: Close
[0m10:03:32.694606 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:03:32.695991 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:03:32.697445 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:03:32.698477 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:03:32.700635 [info ] [MainThread]: 
[0m10:03:32.701813 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.62 seconds (0.62s).
[0m10:03:32.704021 [debug] [MainThread]: Command end result
[0m10:03:32.806329 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:03:32.817134 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:03:32.834217 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:03:32.835994 [info ] [MainThread]: 
[0m10:03:32.837320 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:03:32.838966 [info ] [MainThread]: 
[0m10:03:32.840766 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m10:03:32.843723 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.8305342, "process_in_blocks": "0", "process_kernel_time": 0.508656, "process_mem_max_rss": "133700", "process_out_blocks": "0", "process_user_time": 2.46658}
[0m10:03:32.846847 [debug] [MainThread]: Command `dbt run` succeeded at 10:03:32.846070 after 3.83 seconds
[0m10:03:32.850983 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705ecddfff50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705ecddfe710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x705ed271eb90>]}
[0m10:03:32.852916 [debug] [MainThread]: Flushing usage events
[0m10:03:33.394513 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:04:35.609523 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77119f6772d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77119f622610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77119f6200d0>]}


============================== 10:04:35.620737 | 353c2762-928a-4279-b038-2dfed7ff6e8e ==============================
[0m10:04:35.620737 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:04:35.624310 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'use_colors': 'True', 'empty': 'False', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'fail_fast': 'False', 'log_cache_events': 'False', 'target_path': 'None', 'introspect': 'True', 'use_experimental_parser': 'False', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'printer_width': '80', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'version_check': 'True', 'no_print': 'None'}
[0m10:04:35.870227 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '353c2762-928a-4279-b038-2dfed7ff6e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77119e931850>]}
[0m10:04:35.915248 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '353c2762-928a-4279-b038-2dfed7ff6e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7711a237ec10>]}
[0m10:04:35.917849 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:04:36.138123 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:04:39.204511 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:04:39.206066 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_daily.sql
[0m10:04:39.625492 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '353c2762-928a-4279-b038-2dfed7ff6e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77119d5ee810>]}
[0m10:04:39.874621 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:04:39.898000 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:04:39.943351 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '353c2762-928a-4279-b038-2dfed7ff6e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77119d180e90>]}
[0m10:04:39.945087 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m10:04:39.946689 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '353c2762-928a-4279-b038-2dfed7ff6e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77119d577950>]}
[0m10:04:39.951334 [info ] [MainThread]: 
[0m10:04:39.953522 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:04:39.955776 [info ] [MainThread]: 
[0m10:04:39.957754 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:04:39.965109 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:04:40.016861 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:04:40.021864 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:04:40.029659 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:04:40.053110 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.023 seconds
[0m10:04:40.060505 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:04:40.064397 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:04:40.073103 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:04:40.074419 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:04:40.075678 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:04:40.088319 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m10:04:40.089843 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:04:40.090869 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:04:40.098248 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.006 seconds
[0m10:04:40.100187 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:04:40.101370 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:04:40.110160 [debug] [MainThread]: Using postgres connection "master"
[0m10:04:40.111300 [debug] [MainThread]: On master: BEGIN
[0m10:04:40.112293 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:04:40.122574 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m10:04:40.123762 [debug] [MainThread]: Using postgres connection "master"
[0m10:04:40.124718 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:04:40.132098 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m10:04:40.134088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '353c2762-928a-4279-b038-2dfed7ff6e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77119e134810>]}
[0m10:04:40.135733 [debug] [MainThread]: On master: ROLLBACK
[0m10:04:40.137953 [debug] [MainThread]: Using postgres connection "master"
[0m10:04:40.139086 [debug] [MainThread]: On master: BEGIN
[0m10:04:40.140426 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m10:04:40.141728 [debug] [MainThread]: On master: COMMIT
[0m10:04:40.142688 [debug] [MainThread]: Using postgres connection "master"
[0m10:04:40.143732 [debug] [MainThread]: On master: COMMIT
[0m10:04:40.144836 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:04:40.145639 [debug] [MainThread]: On master: Close
[0m10:04:40.155052 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:04:40.156432 [info ] [Thread-1 (]: 1 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:04:40.157748 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:04:40.158723 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:04:40.176888 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:04:40.188222 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:04:40.216845 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:04:40.229058 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:04:40.229854 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:04:40.230814 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:04:40.240121 [debug] [Thread-1 (]: SQL status: BEGIN in 0.009 seconds
[0m10:04:40.241273 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:04:40.242286 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:04:40.248738 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.005 seconds
[0m10:04:40.255784 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:04:40.256726 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:04:40.258852 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:04:40.262398 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:04:40.263238 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:04:40.265081 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:04:40.281528 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:04:40.304751 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:04:40.307005 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:04:40.310726 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m10:04:40.317667 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:04:40.322423 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:04:40.323596 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:04:40.328658 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m10:04:40.332850 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:04:40.352057 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '353c2762-928a-4279-b038-2dfed7ff6e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x771185341950>]}
[0m10:04:40.357289 [info ] [Thread-1 (]: 1 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.19s]
[0m10:04:40.360516 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:04:40.364895 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:04:40.365925 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:04:40.368735 [info ] [Thread-3 (]: 2 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:04:40.371902 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:04:40.375518 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:04:40.378981 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:04:40.381363 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:04:40.384546 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:04:40.389870 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:04:40.395698 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:04:40.414313 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:04:40.428864 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:04:40.434656 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:04:40.440301 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:04:40.454126 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:04:40.455149 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:04:40.455912 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:04:40.457149 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:04:40.458794 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:04:40.460124 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:04:40.474483 [debug] [Thread-3 (]: SQL status: BEGIN in 0.015 seconds
[0m10:04:40.476762 [debug] [Thread-4 (]: SQL status: BEGIN in 0.017 seconds
[0m10:04:40.477272 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:04:40.478779 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:04:40.479791 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
  );
  
[0m10:04:40.480865 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_hour
),

variation AS (
    SELECT
        *,
        avg_hourly - LAG(avg_hourly) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_hour
        ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation
  );
  
[0m10:04:40.492140 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.010 seconds
[0m10:04:40.498327 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:04:40.498680 [debug] [Thread-4 (]: SQL status: SELECT 572 in 0.016 seconds
[0m10:04:40.499666 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:04:40.504895 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:04:40.506842 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:04:40.507127 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly" rename to "int_air_quality_hourly__dbt_backup"
[0m10:04:40.510017 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:04:40.512500 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:04:40.513030 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:04:40.516885 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:04:40.518836 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:04:40.519109 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp" rename to "int_air_quality_hourly"
[0m10:04:40.520992 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:04:40.522510 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.000 seconds
[0m10:04:40.523200 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:04:40.526812 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:04:40.527819 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:04:40.528774 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:04:40.530466 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:04:40.531966 [debug] [Thread-3 (]: SQL status: COMMIT in 0.002 seconds
[0m10:04:40.534849 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:04:40.535193 [debug] [Thread-4 (]: SQL status: COMMIT in 0.004 seconds
[0m10:04:40.538249 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:04:40.541033 [debug] [Thread-4 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_hourly__dbt_backup"
[0m10:04:40.542467 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:04:40.544389 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:04:40.547526 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."int_air_quality_hourly__dbt_backup" cascade
[0m10:04:40.551687 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.006 seconds
[0m10:04:40.553179 [debug] [Thread-4 (]: SQL status: DROP TABLE in 0.005 seconds
[0m10:04:40.559261 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:04:40.561117 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:04:40.562454 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '353c2762-928a-4279-b038-2dfed7ff6e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7711855b3290>]}
[0m10:04:40.563638 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '353c2762-928a-4279-b038-2dfed7ff6e8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7711853438d0>]}
[0m10:04:40.565117 [info ] [Thread-3 (]: 2 of 3 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.19s]
[0m10:04:40.568767 [info ] [Thread-4 (]: 3 of 3 OK created sql table model public.int_air_quality_hourly ................ [[32mSELECT 572[0m in 0.18s]
[0m10:04:40.570201 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:04:40.571145 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:04:40.574101 [debug] [MainThread]: Using postgres connection "master"
[0m10:04:40.574887 [debug] [MainThread]: On master: BEGIN
[0m10:04:40.575599 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:04:40.584188 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m10:04:40.585496 [debug] [MainThread]: On master: COMMIT
[0m10:04:40.586603 [debug] [MainThread]: Using postgres connection "master"
[0m10:04:40.587408 [debug] [MainThread]: On master: COMMIT
[0m10:04:40.588404 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:04:40.589168 [debug] [MainThread]: On master: Close
[0m10:04:40.590106 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:04:40.590962 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:04:40.592161 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:04:40.593232 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:04:40.594087 [info ] [MainThread]: 
[0m10:04:40.595176 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.64 seconds (0.64s).
[0m10:04:40.596492 [debug] [MainThread]: Command end result
[0m10:04:40.702135 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:04:40.710544 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:04:40.724768 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:04:40.725882 [info ] [MainThread]: 
[0m10:04:40.726861 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:04:40.728304 [info ] [MainThread]: 
[0m10:04:40.729607 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m10:04:40.731986 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 5.2657475, "process_in_blocks": "0", "process_kernel_time": 0.518677, "process_mem_max_rss": "134312", "process_out_blocks": "0", "process_user_time": 2.382674}
[0m10:04:40.733492 [debug] [MainThread]: Command `dbt run` succeeded at 10:04:40.733399 after 5.27 seconds
[0m10:04:40.734661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77119f6124d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x77119f610750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7711a3f0b8d0>]}
[0m10:04:40.736441 [debug] [MainThread]: Flushing usage events
[0m10:04:41.274992 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:05:43.187863 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e89c3f36d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e899a18dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e899af89d0>]}


============================== 10:05:43.193234 | 481bb96b-6ecb-4a0b-9309-77da106e7421 ==============================
[0m10:05:43.193234 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:05:43.195962 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'warn_error': 'None', 'version_check': 'True', 'introspect': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'invocation_command': 'dbt run', 'log_cache_events': 'False', 'printer_width': '80', 'quiet': 'False', 'indirect_selection': 'eager', 'fail_fast': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_format': 'default', 'empty': 'False', 'static_parser': 'True', 'partial_parse': 'True', 'write_json': 'True', 'debug': 'False', 'no_print': 'None', 'use_colors': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'target_path': 'None', 'use_experimental_parser': 'False', 'cache_selected_only': 'False'}
[0m10:05:43.327999 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '481bb96b-6ecb-4a0b-9309-77da106e7421', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e898761cd0>]}
[0m10:05:43.383093 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '481bb96b-6ecb-4a0b-9309-77da106e7421', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e89c4225d0>]}
[0m10:05:43.385697 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:05:43.557107 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:05:46.748135 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:05:46.750651 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m10:05:47.207771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '481bb96b-6ecb-4a0b-9309-77da106e7421', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e897327250>]}
[0m10:05:47.327950 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:05:47.336288 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:05:47.391437 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '481bb96b-6ecb-4a0b-9309-77da106e7421', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e8987a5810>]}
[0m10:05:47.398948 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m10:05:47.404995 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '481bb96b-6ecb-4a0b-9309-77da106e7421', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e8944b7c90>]}
[0m10:05:47.414651 [info ] [MainThread]: 
[0m10:05:47.421261 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:05:47.424367 [info ] [MainThread]: 
[0m10:05:47.427713 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:05:47.435157 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:05:47.482918 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:05:47.484753 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:05:47.485936 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:05:47.501666 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.016 seconds
[0m10:05:47.503952 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:05:47.510574 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:05:47.518352 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:05:47.531201 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:05:47.542172 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:05:47.566916 [debug] [ThreadPool]: SQL status: BEGIN in 0.025 seconds
[0m10:05:47.579642 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:05:47.587577 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:05:47.611665 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.011 seconds
[0m10:05:47.615181 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:05:47.616783 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:05:47.626680 [debug] [MainThread]: Using postgres connection "master"
[0m10:05:47.628876 [debug] [MainThread]: On master: BEGIN
[0m10:05:47.630845 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:05:47.645083 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m10:05:47.647290 [debug] [MainThread]: Using postgres connection "master"
[0m10:05:47.648906 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:05:47.660972 [debug] [MainThread]: SQL status: SELECT 1 in 0.010 seconds
[0m10:05:47.664849 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '481bb96b-6ecb-4a0b-9309-77da106e7421', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e8973ae610>]}
[0m10:05:47.666597 [debug] [MainThread]: On master: ROLLBACK
[0m10:05:47.668913 [debug] [MainThread]: Using postgres connection "master"
[0m10:05:47.670380 [debug] [MainThread]: On master: BEGIN
[0m10:05:47.673176 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m10:05:47.675586 [debug] [MainThread]: On master: COMMIT
[0m10:05:47.677158 [debug] [MainThread]: Using postgres connection "master"
[0m10:05:47.678873 [debug] [MainThread]: On master: COMMIT
[0m10:05:47.680446 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:05:47.682328 [debug] [MainThread]: On master: Close
[0m10:05:47.691096 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:05:47.694170 [info ] [Thread-1 (]: 1 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:05:47.696956 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:05:47.698528 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:05:47.719495 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:05:47.736789 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:05:47.763852 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:05:47.780200 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:05:47.781639 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:05:47.782817 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:05:47.796659 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m10:05:47.798115 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:05:47.799477 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:05:47.813308 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.012 seconds
[0m10:05:47.833368 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:05:47.843707 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:05:47.854683 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:05:47.864330 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:05:47.872821 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:05:47.878313 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:05:47.901932 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:05:47.908437 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:05:47.912751 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:05:47.924205 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m10:05:47.933433 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:05:47.945368 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:05:47.953571 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:05:47.966100 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.006 seconds
[0m10:05:47.970638 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:05:47.974849 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '481bb96b-6ecb-4a0b-9309-77da106e7421', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e896f88c50>]}
[0m10:05:47.977192 [info ] [Thread-1 (]: 1 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.28s]
[0m10:05:47.979842 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:05:47.983621 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:05:47.984159 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:05:47.985885 [info ] [Thread-3 (]: 2 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:05:47.987610 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:05:47.990069 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:05:47.991874 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:05:47.993381 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:05:47.995864 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:05:48.001810 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:05:48.007028 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:05:48.025179 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:05:48.038138 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:05:48.043765 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:05:48.047835 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:05:48.065615 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:05:48.066914 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:05:48.067565 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:05:48.069379 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:05:48.072109 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:05:48.074763 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:05:48.084141 [debug] [Thread-4 (]: SQL status: BEGIN in 0.015 seconds
[0m10:05:48.086070 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:05:48.086488 [debug] [Thread-3 (]: SQL status: BEGIN in 0.012 seconds
[0m10:05:48.087918 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_hour
),

variation AS (
    SELECT
        hourly.*,
        avg_hourly 
            - LAG(avg_hourly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_hour
            ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation;
  );
  
[0m10:05:48.090259 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:05:48.093201 [debug] [Thread-4 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 54: FROM variation;
                       ^

[0m10:05:48.094667 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
  );
  
[0m10:05:48.096426 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m10:05:48.101114 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:05:48.106679 [debug] [Thread-4 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 54: FROM variation;
                         ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m10:05:48.108809 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '481bb96b-6ecb-4a0b-9309-77da106e7421', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e88c4b25d0>]}
[0m10:05:48.110610 [error] [Thread-4 (]: 3 of 3 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.12s]
[0m10:05:48.112284 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:05:48.113770 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 54: FROM variation;
                         ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m10:05:48.114571 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.017 seconds
[0m10:05:48.121982 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:05:48.123479 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:05:48.125467 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:05:48.134465 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:05:48.136224 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:05:48.138076 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:05:48.139593 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:05:48.140393 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:05:48.141185 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:05:48.145371 [debug] [Thread-3 (]: SQL status: COMMIT in 0.003 seconds
[0m10:05:48.151357 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:05:48.156281 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:05:48.157189 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:05:48.163509 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.005 seconds
[0m10:05:48.172254 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:05:48.176163 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '481bb96b-6ecb-4a0b-9309-77da106e7421', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e88c4904d0>]}
[0m10:05:48.178462 [info ] [Thread-3 (]: 2 of 3 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.19s]
[0m10:05:48.181337 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:05:48.185114 [debug] [MainThread]: Using postgres connection "master"
[0m10:05:48.187985 [debug] [MainThread]: On master: BEGIN
[0m10:05:48.189239 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:05:48.202050 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m10:05:48.204676 [debug] [MainThread]: On master: COMMIT
[0m10:05:48.207030 [debug] [MainThread]: Using postgres connection "master"
[0m10:05:48.209645 [debug] [MainThread]: On master: COMMIT
[0m10:05:48.211715 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:05:48.214014 [debug] [MainThread]: On master: Close
[0m10:05:48.215609 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:05:48.216885 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:05:48.218373 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:05:48.219693 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:05:48.220927 [info ] [MainThread]: 
[0m10:05:48.222555 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.79 seconds (0.79s).
[0m10:05:48.224616 [debug] [MainThread]: Command end result
[0m10:05:48.291146 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:05:48.300130 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:05:48.311696 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:05:48.313152 [info ] [MainThread]: 
[0m10:05:48.314724 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m10:05:48.316217 [info ] [MainThread]: 
[0m10:05:48.317594 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m10:05:48.318696 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 54: FROM variation;
                         ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m10:05:48.319732 [info ] [MainThread]: 
[0m10:05:48.322087 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m10:05:48.323702 [info ] [MainThread]: 
[0m10:05:48.325056 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=3
[0m10:05:48.327813 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 5.1988497, "process_in_blocks": "0", "process_kernel_time": 0.556672, "process_mem_max_rss": "134700", "process_out_blocks": "0", "process_user_time": 2.155118}
[0m10:05:48.329480 [debug] [MainThread]: Command `dbt run` failed at 10:05:48.329236 after 5.20 seconds
[0m10:05:48.331121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e8983fb1d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e89defad90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x70e89defadd0>]}
[0m10:05:48.332241 [debug] [MainThread]: Flushing usage events
[0m10:05:48.852023 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:06:50.872548 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41de9f2650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41de9f1e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41de9f2250>]}


============================== 10:06:50.881439 | 7da21edd-f9cd-4d47-a252-891abafa15f8 ==============================
[0m10:06:50.881439 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:06:50.883755 [debug] [MainThread]: running dbt with arguments {'partial_parse': 'True', 'debug': 'False', 'static_parser': 'True', 'write_json': 'True', 'use_experimental_parser': 'False', 'target_path': 'None', 'log_format': 'default', 'indirect_selection': 'eager', 'invocation_command': 'dbt run', 'introspect': 'True', 'use_colors': 'True', 'cache_selected_only': 'False', 'quiet': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'version_check': 'True', 'fail_fast': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'send_anonymous_usage_stats': 'True', 'empty': 'False', 'printer_width': '80', 'log_cache_events': 'False', 'no_print': 'None'}
[0m10:06:51.039378 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7da21edd-f9cd-4d47-a252-891abafa15f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41de0f2650>]}
[0m10:06:51.091719 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7da21edd-f9cd-4d47-a252-891abafa15f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41e1710890>]}
[0m10:06:51.095252 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:06:51.268656 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:06:53.716168 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:06:53.718612 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:06:53.759491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7da21edd-f9cd-4d47-a252-891abafa15f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41de0f2790>]}
[0m10:06:53.902705 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:06:53.916570 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:06:53.960378 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7da21edd-f9cd-4d47-a252-891abafa15f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41dd9e6850>]}
[0m10:06:53.962330 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m10:06:53.964239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7da21edd-f9cd-4d47-a252-891abafa15f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41dcd00210>]}
[0m10:06:53.969218 [info ] [MainThread]: 
[0m10:06:53.971142 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:06:53.972810 [info ] [MainThread]: 
[0m10:06:53.975320 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:06:53.984508 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:06:54.130608 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:06:54.132268 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:06:54.133363 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:06:54.148960 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.015 seconds
[0m10:06:54.151235 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:06:54.154986 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:06:54.162199 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:06:54.163500 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:06:54.164679 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:06:54.174280 [debug] [ThreadPool]: SQL status: BEGIN in 0.009 seconds
[0m10:06:54.176552 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:06:54.177792 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:06:54.184398 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.006 seconds
[0m10:06:54.187488 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:06:54.189084 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:06:54.196945 [debug] [MainThread]: Using postgres connection "master"
[0m10:06:54.198220 [debug] [MainThread]: On master: BEGIN
[0m10:06:54.199312 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:06:54.210249 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m10:06:54.211968 [debug] [MainThread]: Using postgres connection "master"
[0m10:06:54.213056 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:06:54.221414 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m10:06:54.225052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7da21edd-f9cd-4d47-a252-891abafa15f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41dc9ca750>]}
[0m10:06:54.226289 [debug] [MainThread]: On master: ROLLBACK
[0m10:06:54.227462 [debug] [MainThread]: Using postgres connection "master"
[0m10:06:54.228357 [debug] [MainThread]: On master: BEGIN
[0m10:06:54.229583 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m10:06:54.230583 [debug] [MainThread]: On master: COMMIT
[0m10:06:54.231599 [debug] [MainThread]: Using postgres connection "master"
[0m10:06:54.232642 [debug] [MainThread]: On master: COMMIT
[0m10:06:54.233673 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:06:54.234533 [debug] [MainThread]: On master: Close
[0m10:06:54.242302 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:06:54.244067 [info ] [Thread-1 (]: 1 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:06:54.245647 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:06:54.247044 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:06:54.263420 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:06:54.275327 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:06:54.299900 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:06:54.313267 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:06:54.314708 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:06:54.315973 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:06:54.326762 [debug] [Thread-1 (]: SQL status: BEGIN in 0.011 seconds
[0m10:06:54.328541 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:06:54.329724 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:06:54.347784 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.017 seconds
[0m10:06:54.355514 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:06:54.358002 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:06:54.361043 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m10:06:54.365218 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:06:54.366446 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:06:54.369115 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m10:06:54.385302 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:06:54.387559 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:06:54.388696 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:06:54.391627 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m10:06:54.399030 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:06:54.406210 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:06:54.407613 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:06:54.414609 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.006 seconds
[0m10:06:54.419051 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:06:54.424161 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7da21edd-f9cd-4d47-a252-891abafa15f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41db8a1f10>]}
[0m10:06:54.428586 [info ] [Thread-1 (]: 1 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.18s]
[0m10:06:54.431067 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:06:54.434740 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:06:54.435302 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:06:54.436841 [info ] [Thread-3 (]: 2 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:06:54.439692 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:06:54.442797 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:06:54.444598 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:06:54.446904 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:06:54.448981 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:06:54.456067 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:06:54.462083 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:06:54.472875 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:06:54.482886 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:06:54.510016 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:06:54.512638 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:06:54.525206 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:06:54.527580 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:06:54.528935 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:06:54.529901 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:06:54.531617 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:06:54.535901 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:06:54.546966 [debug] [Thread-4 (]: SQL status: BEGIN in 0.017 seconds
[0m10:06:54.548670 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:06:54.549132 [debug] [Thread-3 (]: SQL status: BEGIN in 0.014 seconds
[0m10:06:54.550277 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_hour
),

variation AS (
    SELECT
        hourly.*,
        avg_hourly 
            - LAG(avg_hourly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_hour
            ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation;
  );
  
[0m10:06:54.551446 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:06:54.553652 [debug] [Thread-4 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 54: FROM variation;
                       ^

[0m10:06:54.554503 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
  );
  
[0m10:06:54.556009 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: ROLLBACK
[0m10:06:54.558582 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:06:54.563341 [debug] [Thread-4 (]: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 54: FROM variation;
                         ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m10:06:54.565247 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7da21edd-f9cd-4d47-a252-891abafa15f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41dc930d50>]}
[0m10:06:54.567273 [error] [Thread-4 (]: 3 of 3 ERROR creating sql table model public.int_air_quality_hourly ............ [[31mERROR[0m in 0.12s]
[0m10:06:54.569572 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:06:54.571417 [debug] [Thread-7 (]: Marking all children of 'model.data_project_1.int_air_quality_hourly' to be skipped because of status 'error'.  Reason: Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 54: FROM variation;
                         ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql.
[0m10:06:54.576226 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.019 seconds
[0m10:06:54.582511 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:06:54.583473 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:06:54.585204 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:06:54.591209 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:06:54.593127 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:06:54.595132 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:06:54.597324 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:06:54.598383 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:06:54.599286 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:06:54.604886 [debug] [Thread-3 (]: SQL status: COMMIT in 0.004 seconds
[0m10:06:54.609539 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:06:54.613636 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:06:54.614941 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:06:54.623406 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.007 seconds
[0m10:06:54.626270 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:06:54.627650 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7da21edd-f9cd-4d47-a252-891abafa15f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41db7e5b50>]}
[0m10:06:54.629271 [info ] [Thread-3 (]: 2 of 3 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.19s]
[0m10:06:54.631680 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:06:54.636432 [debug] [MainThread]: Using postgres connection "master"
[0m10:06:54.638566 [debug] [MainThread]: On master: BEGIN
[0m10:06:54.640191 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:06:54.650751 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m10:06:54.653326 [debug] [MainThread]: On master: COMMIT
[0m10:06:54.654708 [debug] [MainThread]: Using postgres connection "master"
[0m10:06:54.656031 [debug] [MainThread]: On master: COMMIT
[0m10:06:54.657912 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:06:54.659101 [debug] [MainThread]: On master: Close
[0m10:06:54.660500 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:06:54.661745 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:06:54.662861 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:06:54.664538 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:06:54.666473 [info ] [MainThread]: 
[0m10:06:54.667958 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.69 seconds (0.69s).
[0m10:06:54.670830 [debug] [MainThread]: Command end result
[0m10:06:54.748311 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:06:54.760892 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:06:54.776994 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:06:54.778177 [info ] [MainThread]: 
[0m10:06:54.780081 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m10:06:54.782284 [info ] [MainThread]: 
[0m10:06:54.784164 [error] [MainThread]: [31mFailure in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)[0m
[0m10:06:54.785811 [error] [MainThread]:   Database Error in model int_air_quality_hourly (models/intermediate/int_air_quality_hourly.sql)
  syntax error at or near ";"
  LINE 54: FROM variation;
                         ^
  compiled code at target/run/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m10:06:54.787962 [info ] [MainThread]: 
[0m10:06:54.789985 [info ] [MainThread]:   compiled code at target/compiled/data_project_1/models/intermediate/int_air_quality_hourly.sql
[0m10:06:54.791894 [info ] [MainThread]: 
[0m10:06:54.793580 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=0 NO-OP=0 TOTAL=3
[0m10:06:54.796481 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 4.000485, "process_in_blocks": "0", "process_kernel_time": 0.590805, "process_mem_max_rss": "129244", "process_out_blocks": "0", "process_user_time": 1.999027}
[0m10:06:54.798945 [debug] [MainThread]: Command `dbt run` failed at 10:06:54.798829 after 4.00 seconds
[0m10:06:54.803293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41de98c450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41dfadde50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c41e3202e90>]}
[0m10:06:54.805015 [debug] [MainThread]: Flushing usage events
[0m10:06:55.372368 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:07:57.501521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952e6445c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952e64527d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952e6446450>]}


============================== 10:07:57.510270 | 49bbe1aa-fa7b-44bc-b52c-1bbd4b2a2be0 ==============================
[0m10:07:57.510270 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:07:57.513420 [debug] [MainThread]: running dbt with arguments {'warn_error': 'None', 'profiles_dir': '/usr/app/dbt/dbt', 'empty': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'cache_selected_only': 'False', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'indirect_selection': 'eager', 'target_path': 'None', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True', 'version_check': 'True', 'printer_width': '80', 'log_path': '/usr/app/dbt/dbt/logs', 'use_colors': 'True', 'introspect': 'True', 'use_experimental_parser': 'False', 'log_cache_events': 'False', 'write_json': 'True', 'quiet': 'False', 'no_print': 'None', 'fail_fast': 'False', 'debug': 'False'}
[0m10:07:57.650024 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '49bbe1aa-fa7b-44bc-b52c-1bbd4b2a2be0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952e68309d0>]}
[0m10:07:57.704537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '49bbe1aa-fa7b-44bc-b52c-1bbd4b2a2be0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952e9156990>]}
[0m10:07:57.706639 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:07:57.941697 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:08:00.336984 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:08:00.338937 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/int_air_quality_hourly.sql
[0m10:08:00.788432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '49bbe1aa-fa7b-44bc-b52c-1bbd4b2a2be0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952e3d9be10>]}
[0m10:08:00.892027 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:08:00.899918 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:08:00.936629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '49bbe1aa-fa7b-44bc-b52c-1bbd4b2a2be0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952e7531650>]}
[0m10:08:00.938240 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m10:08:00.939810 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49bbe1aa-fa7b-44bc-b52c-1bbd4b2a2be0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952e3d4ac50>]}
[0m10:08:00.942703 [info ] [MainThread]: 
[0m10:08:00.944374 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:08:00.946091 [info ] [MainThread]: 
[0m10:08:00.948020 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:08:00.956926 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:08:01.020495 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:08:01.022560 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:08:01.024273 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:08:01.043383 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m10:08:01.046688 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:08:01.050403 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:08:01.059706 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:08:01.061506 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:08:01.063091 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:08:01.074348 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m10:08:01.076120 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:08:01.077888 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:08:01.087539 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.008 seconds
[0m10:08:01.090251 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:08:01.093116 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:08:01.101073 [debug] [MainThread]: Using postgres connection "master"
[0m10:08:01.107290 [debug] [MainThread]: On master: BEGIN
[0m10:08:01.109509 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:08:01.123556 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m10:08:01.125544 [debug] [MainThread]: Using postgres connection "master"
[0m10:08:01.127443 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:08:01.149451 [debug] [MainThread]: SQL status: SELECT 1 in 0.011 seconds
[0m10:08:01.159531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49bbe1aa-fa7b-44bc-b52c-1bbd4b2a2be0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952e51c4590>]}
[0m10:08:01.163540 [debug] [MainThread]: On master: ROLLBACK
[0m10:08:01.166378 [debug] [MainThread]: Using postgres connection "master"
[0m10:08:01.172315 [debug] [MainThread]: On master: BEGIN
[0m10:08:01.175777 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m10:08:01.180030 [debug] [MainThread]: On master: COMMIT
[0m10:08:01.182030 [debug] [MainThread]: Using postgres connection "master"
[0m10:08:01.184006 [debug] [MainThread]: On master: COMMIT
[0m10:08:01.186792 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:08:01.189071 [debug] [MainThread]: On master: Close
[0m10:08:01.200237 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:08:01.206001 [info ] [Thread-1 (]: 1 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:08:01.209310 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:08:01.211379 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:08:01.237238 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:08:01.255681 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:08:01.286433 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:08:01.318554 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:08:01.320349 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:08:01.321854 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:08:01.337072 [debug] [Thread-1 (]: SQL status: BEGIN in 0.015 seconds
[0m10:08:01.338820 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:08:01.340271 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:08:01.352640 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.011 seconds
[0m10:08:01.363304 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:08:01.365277 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:08:01.368368 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:08:01.373897 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:08:01.378131 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:08:01.382597 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m10:08:01.407344 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:08:01.412976 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:08:01.420653 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:08:01.428079 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m10:08:01.446048 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:08:01.458216 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:08:01.463567 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:08:01.480825 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.008 seconds
[0m10:08:01.487297 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:08:01.491761 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49bbe1aa-fa7b-44bc-b52c-1bbd4b2a2be0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952e3db0250>]}
[0m10:08:01.494854 [info ] [Thread-1 (]: 1 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.28s]
[0m10:08:01.497513 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:08:01.500727 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:08:01.501288 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:08:01.503985 [info ] [Thread-3 (]: 2 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:08:01.507380 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:08:01.510124 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:08:01.511898 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:08:01.513493 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:08:01.515516 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:08:01.521781 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:08:01.530995 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:08:01.569226 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:08:01.581284 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:08:01.592834 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:08:01.599479 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:08:01.641062 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:08:01.646201 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:08:01.647972 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:08:01.649397 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:08:01.654282 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:08:01.664677 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:08:01.674739 [debug] [Thread-3 (]: SQL status: BEGIN in 0.025 seconds
[0m10:08:01.677821 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:08:01.680224 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
  );
  
[0m10:08:01.681748 [debug] [Thread-4 (]: SQL status: BEGIN in 0.017 seconds
[0m10:08:01.686045 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:08:01.687830 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_hour
),

variation AS (
    SELECT
        hourly.*,
        avg_hourly 
            - LAG(avg_hourly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_hour
            ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation
  );
  
[0m10:08:01.700261 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.016 seconds
[0m10:08:01.710333 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:08:01.710887 [debug] [Thread-4 (]: SQL status: SELECT 572 in 0.020 seconds
[0m10:08:01.716080 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:08:01.725812 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:08:01.728582 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:08:01.731966 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly" rename to "int_air_quality_hourly__dbt_backup"
[0m10:08:01.737756 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:08:01.740208 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:08:01.741611 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:08:01.748392 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:08:01.755089 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:08:01.759563 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp" rename to "int_air_quality_hourly"
[0m10:08:01.762715 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:08:01.770079 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:08:01.774495 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:08:01.780010 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:08:01.791053 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:08:01.793821 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:08:01.804991 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:08:01.806838 [debug] [Thread-3 (]: SQL status: COMMIT in 0.006 seconds
[0m10:08:01.816785 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:08:01.817313 [debug] [Thread-4 (]: SQL status: COMMIT in 0.005 seconds
[0m10:08:01.821195 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:08:01.824709 [debug] [Thread-4 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_hourly__dbt_backup"
[0m10:08:01.825891 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:08:01.827334 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:08:01.829265 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."int_air_quality_hourly__dbt_backup" cascade
[0m10:08:01.832811 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.004 seconds
[0m10:08:01.836492 [debug] [Thread-4 (]: SQL status: DROP TABLE in 0.006 seconds
[0m10:08:01.839473 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:08:01.844153 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:08:01.853457 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49bbe1aa-fa7b-44bc-b52c-1bbd4b2a2be0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952e1181e50>]}
[0m10:08:01.858015 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49bbe1aa-fa7b-44bc-b52c-1bbd4b2a2be0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952e51b81d0>]}
[0m10:08:01.859853 [info ] [Thread-3 (]: 2 of 3 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.34s]
[0m10:08:01.863167 [info ] [Thread-4 (]: 3 of 3 OK created sql table model public.int_air_quality_hourly ................ [[32mSELECT 572[0m in 0.35s]
[0m10:08:01.867440 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:08:01.872308 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:08:01.887870 [debug] [MainThread]: Using postgres connection "master"
[0m10:08:01.892963 [debug] [MainThread]: On master: BEGIN
[0m10:08:01.894754 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:08:01.908037 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m10:08:01.912233 [debug] [MainThread]: On master: COMMIT
[0m10:08:01.915216 [debug] [MainThread]: Using postgres connection "master"
[0m10:08:01.916685 [debug] [MainThread]: On master: COMMIT
[0m10:08:01.918351 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:08:01.919953 [debug] [MainThread]: On master: Close
[0m10:08:01.921409 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:08:01.922616 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:08:01.923674 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:08:01.925432 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:08:01.926503 [info ] [MainThread]: 
[0m10:08:01.927843 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.98 seconds (0.98s).
[0m10:08:01.931584 [debug] [MainThread]: Command end result
[0m10:08:02.040821 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:08:02.067138 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:08:02.081547 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:08:02.082665 [info ] [MainThread]: 
[0m10:08:02.084343 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:08:02.086096 [info ] [MainThread]: 
[0m10:08:02.087413 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m10:08:02.089608 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 4.6744785, "process_in_blocks": "0", "process_kernel_time": 0.591028, "process_mem_max_rss": "134552", "process_out_blocks": "0", "process_user_time": 2.236324}
[0m10:08:02.091191 [debug] [MainThread]: Command `dbt run` succeeded at 10:08:02.091027 after 4.68 seconds
[0m10:08:02.092254 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952eacfb810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952eac4ae50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7952eac4ae90>]}
[0m10:08:02.095183 [debug] [MainThread]: Flushing usage events
[0m10:08:02.623731 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:09:04.776846 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caf00bb7e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caf00b63250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caf00bb43d0>]}


============================== 10:09:04.791624 | adb1fd76-ff5a-4192-a6e3-a5ba2f106f72 ==============================
[0m10:09:04.791624 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:09:04.795339 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'log_format': 'default', 'empty': 'False', 'cache_selected_only': 'False', 'use_colors': 'True', 'invocation_command': 'dbt run', 'warn_error': 'None', 'introspect': 'True', 'log_cache_events': 'False', 'write_json': 'True', 'target_path': 'None', 'static_parser': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'use_experimental_parser': 'False', 'indirect_selection': 'eager', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/app/dbt/dbt/logs', 'quiet': 'False', 'printer_width': '80', 'version_check': 'True', 'debug': 'False', 'no_print': 'None', 'partial_parse': 'True'}
[0m10:09:04.972302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'adb1fd76-ff5a-4192-a6e3-a5ba2f106f72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caf00b52310>]}
[0m10:09:05.018560 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'adb1fd76-ff5a-4192-a6e3-a5ba2f106f72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caf038ca710>]}
[0m10:09:05.020745 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:09:05.135351 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:09:06.452769 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:09:06.453655 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:09:06.489764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'adb1fd76-ff5a-4192-a6e3-a5ba2f106f72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caeff72ccd0>]}
[0m10:09:06.612613 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:09:06.618640 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:09:06.670384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'adb1fd76-ff5a-4192-a6e3-a5ba2f106f72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caefeb22650>]}
[0m10:09:06.674252 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m10:09:06.678659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'adb1fd76-ff5a-4192-a6e3-a5ba2f106f72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caefff3e050>]}
[0m10:09:06.684545 [info ] [MainThread]: 
[0m10:09:06.686494 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:09:06.688404 [info ] [MainThread]: 
[0m10:09:06.690614 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:09:06.696511 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:09:06.828571 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:09:06.830631 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:09:06.832461 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:09:06.848808 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.016 seconds
[0m10:09:06.851958 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:09:06.854985 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:09:06.863930 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:09:06.865148 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:09:06.866113 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:09:06.876454 [debug] [ThreadPool]: SQL status: BEGIN in 0.010 seconds
[0m10:09:06.878458 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:09:06.879638 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:09:06.887217 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.007 seconds
[0m10:09:06.889689 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:09:06.891058 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:09:06.898678 [debug] [MainThread]: Using postgres connection "master"
[0m10:09:06.899759 [debug] [MainThread]: On master: BEGIN
[0m10:09:06.900703 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:09:06.911755 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m10:09:06.913145 [debug] [MainThread]: Using postgres connection "master"
[0m10:09:06.914113 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:09:06.922680 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m10:09:06.924913 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'adb1fd76-ff5a-4192-a6e3-a5ba2f106f72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caf039cc110>]}
[0m10:09:06.926486 [debug] [MainThread]: On master: ROLLBACK
[0m10:09:06.928746 [debug] [MainThread]: Using postgres connection "master"
[0m10:09:06.929643 [debug] [MainThread]: On master: BEGIN
[0m10:09:06.930995 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m10:09:06.932105 [debug] [MainThread]: On master: COMMIT
[0m10:09:06.932965 [debug] [MainThread]: Using postgres connection "master"
[0m10:09:06.933791 [debug] [MainThread]: On master: COMMIT
[0m10:09:06.934799 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:09:06.935924 [debug] [MainThread]: On master: Close
[0m10:09:06.945873 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:09:06.947587 [info ] [Thread-1 (]: 1 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:09:06.948883 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:09:06.950057 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:09:06.968723 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:09:06.981473 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:09:07.004881 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:09:07.074049 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:09:07.076639 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:09:07.079521 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:09:07.093338 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m10:09:07.096026 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:09:07.097908 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:09:07.109412 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.010 seconds
[0m10:09:07.119672 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:09:07.121106 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:09:07.123537 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:09:07.133157 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:09:07.134747 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:09:07.137569 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:09:07.154917 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:09:07.156509 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:09:07.157970 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:09:07.163918 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m10:09:07.171606 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:09:07.179091 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:09:07.182319 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:09:07.188679 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m10:09:07.193637 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:09:07.198224 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adb1fd76-ff5a-4192-a6e3-a5ba2f106f72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caeffbef850>]}
[0m10:09:07.201933 [info ] [Thread-1 (]: 1 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.25s]
[0m10:09:07.204399 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:09:07.207197 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:09:07.207851 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:09:07.211294 [info ] [Thread-3 (]: 2 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:09:07.212682 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:09:07.215055 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:09:07.216270 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:09:07.217194 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:09:07.217961 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:09:07.221302 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:09:07.224132 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:09:07.232563 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:09:07.233232 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:09:07.251045 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:09:07.253750 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:09:07.260832 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:09:07.261802 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:09:07.262409 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:09:07.262883 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:09:07.263915 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:09:07.266667 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:09:07.272192 [debug] [Thread-4 (]: SQL status: BEGIN in 0.009 seconds
[0m10:09:07.273225 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:09:07.273850 [debug] [Thread-3 (]: SQL status: BEGIN in 0.007 seconds
[0m10:09:07.274163 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_hour
),

variation AS (
    SELECT
        hourly.*,
        avg_hourly 
            - LAG(avg_hourly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_hour
            ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation
  );
  
[0m10:09:07.275020 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:09:07.276306 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
  );
  
[0m10:09:07.292966 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.014 seconds
[0m10:09:07.304035 [debug] [Thread-4 (]: SQL status: SELECT 572 in 0.028 seconds
[0m10:09:07.303777 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:09:07.307764 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:09:07.309192 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:09:07.313030 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly" rename to "int_air_quality_hourly__dbt_backup"
[0m10:09:07.315024 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:09:07.318197 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:09:07.318506 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.003 seconds
[0m10:09:07.319179 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:09:07.321872 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:09:07.323583 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:09:07.324189 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp" rename to "int_air_quality_hourly"
[0m10:09:07.325798 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:09:07.329200 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:09:07.330042 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:09:07.331922 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:09:07.332840 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:09:07.333669 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:09:07.334940 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:09:07.337831 [debug] [Thread-3 (]: SQL status: COMMIT in 0.003 seconds
[0m10:09:07.340604 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:09:07.340911 [debug] [Thread-4 (]: SQL status: COMMIT in 0.005 seconds
[0m10:09:07.344097 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:09:07.347271 [debug] [Thread-4 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_hourly__dbt_backup"
[0m10:09:07.348458 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:09:07.350022 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:09:07.351993 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."int_air_quality_hourly__dbt_backup" cascade
[0m10:09:07.357759 [debug] [Thread-4 (]: SQL status: DROP TABLE in 0.005 seconds
[0m10:09:07.358597 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.007 seconds
[0m10:09:07.360213 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:09:07.362262 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:09:07.363695 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adb1fd76-ff5a-4192-a6e3-a5ba2f106f72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caeee71ae10>]}
[0m10:09:07.364738 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adb1fd76-ff5a-4192-a6e3-a5ba2f106f72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caefe7515d0>]}
[0m10:09:07.365887 [info ] [Thread-4 (]: 3 of 3 OK created sql table model public.int_air_quality_hourly ................ [[32mSELECT 572[0m in 0.15s]
[0m10:09:07.367575 [info ] [Thread-3 (]: 2 of 3 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.15s]
[0m10:09:07.369239 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:09:07.370432 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:09:07.373774 [debug] [MainThread]: Using postgres connection "master"
[0m10:09:07.374795 [debug] [MainThread]: On master: BEGIN
[0m10:09:07.375905 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:09:07.386323 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m10:09:07.387660 [debug] [MainThread]: On master: COMMIT
[0m10:09:07.388714 [debug] [MainThread]: Using postgres connection "master"
[0m10:09:07.389539 [debug] [MainThread]: On master: COMMIT
[0m10:09:07.390347 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:09:07.391041 [debug] [MainThread]: On master: Close
[0m10:09:07.392180 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:09:07.394967 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:09:07.397098 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:09:07.398049 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:09:07.399783 [info ] [MainThread]: 
[0m10:09:07.401380 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.71 seconds (0.71s).
[0m10:09:07.403266 [debug] [MainThread]: Command end result
[0m10:09:07.459408 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:09:07.468593 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:09:07.481335 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:09:07.482522 [info ] [MainThread]: 
[0m10:09:07.483825 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:09:07.485082 [info ] [MainThread]: 
[0m10:09:07.486193 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m10:09:07.488094 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.8039541, "process_in_blocks": "0", "process_kernel_time": 0.567377, "process_mem_max_rss": "129592", "process_out_blocks": "0", "process_user_time": 1.88593}
[0m10:09:07.489415 [debug] [MainThread]: Command `dbt run` succeeded at 10:09:07.489312 after 2.81 seconds
[0m10:09:07.490380 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caf00ec0d10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caf0546b810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7caf053bae90>]}
[0m10:09:07.491365 [debug] [MainThread]: Flushing usage events
[0m10:09:08.042974 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:10:10.180919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489abc30a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489ac0a3610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489acafd9d0>]}


============================== 10:10:10.190941 | 0e412107-f5e3-4265-9d71-f22e4641a8ad ==============================
[0m10:10:10.190941 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:10:10.193625 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'quiet': 'False', 'fail_fast': 'False', 'log_cache_events': 'False', 'use_colors': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'no_print': 'None', 'warn_error': 'None', 'printer_width': '80', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'partial_parse': 'True', 'invocation_command': 'dbt run', 'debug': 'False', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_experimental_parser': 'False', 'log_format': 'default', 'cache_selected_only': 'False', 'introspect': 'True', 'write_json': 'True', 'static_parser': 'True', 'version_check': 'True', 'empty': 'False'}
[0m10:10:10.342034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0e412107-f5e3-4265-9d71-f22e4641a8ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489abbd7350>]}
[0m10:10:10.396833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0e412107-f5e3-4265-9d71-f22e4641a8ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489aaffdd50>]}
[0m10:10:10.401423 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:10:10.550210 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:10:12.653353 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:10:12.655252 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:10:12.702977 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0e412107-f5e3-4265-9d71-f22e4641a8ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489aa7a9350>]}
[0m10:10:12.840509 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:10:12.852274 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:10:12.896070 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0e412107-f5e3-4265-9d71-f22e4641a8ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489aa74b150>]}
[0m10:10:12.898028 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m10:10:12.900284 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0e412107-f5e3-4265-9d71-f22e4641a8ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489abc32a90>]}
[0m10:10:12.904947 [info ] [MainThread]: 
[0m10:10:12.906920 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:10:12.908848 [info ] [MainThread]: 
[0m10:10:12.911533 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:10:12.919568 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:10:13.059152 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:10:13.061511 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:10:13.063358 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:10:13.087397 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.024 seconds
[0m10:10:13.090667 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:10:13.093653 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:10:13.100396 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:10:13.101849 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:10:13.102972 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:10:13.112510 [debug] [ThreadPool]: SQL status: BEGIN in 0.010 seconds
[0m10:10:13.114086 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:10:13.115554 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:10:13.121280 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.005 seconds
[0m10:10:13.123478 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:10:13.124936 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:10:13.131882 [debug] [MainThread]: Using postgres connection "master"
[0m10:10:13.133821 [debug] [MainThread]: On master: BEGIN
[0m10:10:13.135050 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:10:13.144075 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m10:10:13.145455 [debug] [MainThread]: Using postgres connection "master"
[0m10:10:13.146713 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:10:13.155447 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m10:10:13.158150 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0e412107-f5e3-4265-9d71-f22e4641a8ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489a979ff90>]}
[0m10:10:13.159642 [debug] [MainThread]: On master: ROLLBACK
[0m10:10:13.161237 [debug] [MainThread]: Using postgres connection "master"
[0m10:10:13.162675 [debug] [MainThread]: On master: BEGIN
[0m10:10:13.164422 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m10:10:13.166408 [debug] [MainThread]: On master: COMMIT
[0m10:10:13.167744 [debug] [MainThread]: Using postgres connection "master"
[0m10:10:13.168990 [debug] [MainThread]: On master: COMMIT
[0m10:10:13.170459 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:10:13.171800 [debug] [MainThread]: On master: Close
[0m10:10:13.179273 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:10:13.181970 [info ] [Thread-1 (]: 1 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:10:13.183729 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:10:13.185321 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:10:13.211099 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:10:13.225717 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:10:13.256722 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:10:13.271277 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:10:13.273064 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:10:13.274739 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:10:13.289636 [debug] [Thread-1 (]: SQL status: BEGIN in 0.015 seconds
[0m10:10:13.292203 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:10:13.294233 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:10:13.305608 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.009 seconds
[0m10:10:13.323219 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:10:13.324932 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:10:13.327653 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:10:13.334303 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:10:13.335858 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:10:13.338445 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:10:13.351098 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:10:13.352958 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:10:13.354827 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:10:13.358816 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m10:10:13.368529 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:10:13.375199 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:10:13.376813 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:10:13.384116 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.006 seconds
[0m10:10:13.388149 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:10:13.390966 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0e412107-f5e3-4265-9d71-f22e4641a8ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489aafab2d0>]}
[0m10:10:13.393333 [info ] [Thread-1 (]: 1 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.21s]
[0m10:10:13.395339 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:10:13.398323 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:10:13.398844 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:10:13.401126 [info ] [Thread-3 (]: 2 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:10:13.402654 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:10:13.404516 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:10:13.405790 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:10:13.406824 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:10:13.407814 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:10:13.411491 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:10:13.414454 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:10:13.426636 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:10:13.427712 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:10:13.457588 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:10:13.461915 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:10:13.470514 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:10:13.471388 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:10:13.472238 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:10:13.473284 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:10:13.474300 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:10:13.475104 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:10:13.484162 [debug] [Thread-4 (]: SQL status: BEGIN in 0.010 seconds
[0m10:10:13.486404 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:10:13.487908 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_hour
),

variation AS (
    SELECT
        hourly.*,
        avg_hourly 
            - LAG(avg_hourly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_hour
            ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation
  );
  
[0m10:10:13.489381 [debug] [Thread-3 (]: SQL status: BEGIN in 0.014 seconds
[0m10:10:13.490715 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:10:13.491677 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
  );
  
[0m10:10:13.504748 [debug] [Thread-4 (]: SQL status: SELECT 572 in 0.015 seconds
[0m10:10:13.511308 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:10:13.511670 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.019 seconds
[0m10:10:13.512521 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly" rename to "int_air_quality_hourly__dbt_backup"
[0m10:10:13.515906 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:10:13.525391 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:10:13.525973 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:10:13.529718 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:10:13.531191 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:10:13.531584 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp" rename to "int_air_quality_hourly"
[0m10:10:13.536721 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:10:13.538793 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:10:13.539447 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:10:13.540958 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:10:13.542110 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:10:13.543739 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:10:13.544678 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:10:13.545705 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:10:13.546498 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:10:13.547276 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:10:13.551663 [debug] [Thread-4 (]: SQL status: COMMIT in 0.003 seconds
[0m10:10:13.562275 [debug] [Thread-4 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_hourly__dbt_backup"
[0m10:10:13.562853 [debug] [Thread-3 (]: SQL status: COMMIT in 0.005 seconds
[0m10:10:13.569490 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:10:13.574584 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:10:13.577314 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."int_air_quality_hourly__dbt_backup" cascade
[0m10:10:13.580350 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:10:13.589814 [debug] [Thread-4 (]: SQL status: DROP TABLE in 0.006 seconds
[0m10:10:13.596561 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:10:13.603343 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:10:13.607188 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0e412107-f5e3-4265-9d71-f22e4641a8ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489a8902dd0>]}
[0m10:10:13.609966 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.005 seconds
[0m10:10:13.609202 [info ] [Thread-4 (]: 3 of 3 OK created sql table model public.int_air_quality_hourly ................ [[32mSELECT 572[0m in 0.20s]
[0m10:10:13.613169 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:10:13.614536 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:10:13.620131 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0e412107-f5e3-4265-9d71-f22e4641a8ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489a891cbd0>]}
[0m10:10:13.623429 [info ] [Thread-3 (]: 2 of 3 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.22s]
[0m10:10:13.625887 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:10:13.628872 [debug] [MainThread]: Using postgres connection "master"
[0m10:10:13.629653 [debug] [MainThread]: On master: BEGIN
[0m10:10:13.630609 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:10:13.640500 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m10:10:13.642027 [debug] [MainThread]: On master: COMMIT
[0m10:10:13.642948 [debug] [MainThread]: Using postgres connection "master"
[0m10:10:13.643732 [debug] [MainThread]: On master: COMMIT
[0m10:10:13.644803 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:10:13.646915 [debug] [MainThread]: On master: Close
[0m10:10:13.648535 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:10:13.650390 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:10:13.652381 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:10:13.654017 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:10:13.655794 [info ] [MainThread]: 
[0m10:10:13.657269 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.74 seconds (0.74s).
[0m10:10:13.659578 [debug] [MainThread]: Command end result
[0m10:10:13.716721 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:10:13.725786 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:10:13.738253 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:10:13.739620 [info ] [MainThread]: 
[0m10:10:13.741558 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:10:13.742824 [info ] [MainThread]: 
[0m10:10:13.743962 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m10:10:13.745844 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.6468854, "process_in_blocks": "0", "process_kernel_time": 0.597047, "process_mem_max_rss": "129096", "process_out_blocks": "0", "process_user_time": 2.107457}
[0m10:10:13.747340 [debug] [MainThread]: Command `dbt run` succeeded at 10:10:13.747126 after 3.65 seconds
[0m10:10:13.749220 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489abc92a90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489abfc09d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7489b0517890>]}
[0m10:10:13.750464 [debug] [MainThread]: Flushing usage events
[0m10:10:14.356485 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:10:29.351910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7956fcf33910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7956fc86ce90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7956fc8aaad0>]}


============================== 10:10:29.358517 | dd9bb9d4-d7ea-4520-ab4d-800532825d32 ==============================
[0m10:10:29.358517 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:10:29.360084 [debug] [MainThread]: running dbt with arguments {'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_colors': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'empty': 'None', 'quiet': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'partial_parse': 'True', 'fail_fast': 'False', 'no_print': 'None', 'write_json': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'cache_selected_only': 'False', 'printer_width': '80', 'log_cache_events': 'False', 'static_parser': 'True', 'use_experimental_parser': 'False', 'warn_error': 'None', 'indirect_selection': 'eager', 'debug': 'False', 'introspect': 'True', 'version_check': 'True', 'invocation_command': 'dbt test'}
[0m10:10:29.493342 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dd9bb9d4-d7ea-4520-ab4d-800532825d32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7956fb559510>]}
[0m10:10:29.540119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dd9bb9d4-d7ea-4520-ab4d-800532825d32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7956ff5b8690>]}
[0m10:10:29.544210 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:10:29.691152 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:10:31.402518 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:10:31.406656 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:10:31.462412 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dd9bb9d4-d7ea-4520-ab4d-800532825d32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7956fada0150>]}
[0m10:10:31.563003 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:10:31.570350 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:10:31.747455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dd9bb9d4-d7ea-4520-ab4d-800532825d32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7956fb9b8090>]}
[0m10:10:31.748565 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m10:10:31.749799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dd9bb9d4-d7ea-4520-ab4d-800532825d32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7956fad7fd50>]}
[0m10:10:31.752100 [info ] [MainThread]: 
[0m10:10:31.753085 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:10:31.754282 [info ] [MainThread]: 
[0m10:10:31.755416 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:10:31.762383 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1_public'
[0m10:10:31.814619 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:10:31.816025 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:10:31.817217 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:10:31.832688 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m10:10:31.834285 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:10:31.835368 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:10:31.844377 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.008 seconds
[0m10:10:31.846366 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:10:31.847474 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:10:31.852976 [debug] [MainThread]: Using postgres connection "master"
[0m10:10:31.854058 [debug] [MainThread]: On master: BEGIN
[0m10:10:31.855006 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:10:31.866363 [debug] [MainThread]: SQL status: BEGIN in 0.011 seconds
[0m10:10:31.867591 [debug] [MainThread]: Using postgres connection "master"
[0m10:10:31.868644 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:10:31.877316 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m10:10:31.879462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dd9bb9d4-d7ea-4520-ab4d-800532825d32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7956fb901010>]}
[0m10:10:31.880525 [debug] [MainThread]: On master: ROLLBACK
[0m10:10:31.881705 [debug] [MainThread]: Using postgres connection "master"
[0m10:10:31.882781 [debug] [MainThread]: On master: BEGIN
[0m10:10:31.884117 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m10:10:31.885009 [debug] [MainThread]: On master: COMMIT
[0m10:10:31.885981 [debug] [MainThread]: Using postgres connection "master"
[0m10:10:31.886815 [debug] [MainThread]: On master: COMMIT
[0m10:10:31.887882 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:10:31.888818 [debug] [MainThread]: On master: Close
[0m10:10:31.896224 [debug] [Thread-1 (]: Began running node test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670
[0m10:10:31.896801 [debug] [Thread-2 (]: Began running node test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade
[0m10:10:31.897299 [debug] [Thread-3 (]: Began running node test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e
[0m10:10:31.897625 [debug] [Thread-4 (]: Began running node test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b
[0m10:10:31.902062 [info ] [Thread-1 (]: 1 of 6 START test not_null_int_air_quality_daily_location_id ................... [RUN]
[0m10:10:31.905851 [info ] [Thread-2 (]: 2 of 6 START test not_null_int_air_quality_daily_measurement_day ............... [RUN]
[0m10:10:31.907763 [info ] [Thread-3 (]: 3 of 6 START test not_null_int_air_quality_hourly_location_id .................. [RUN]
[0m10:10:31.909668 [info ] [Thread-4 (]: 4 of 6 START test not_null_int_air_quality_hourly_measurement_hour ............. [RUN]
[0m10:10:31.913261 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670)
[0m10:10:31.914820 [debug] [Thread-2 (]: Acquiring new postgres connection 'test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade'
[0m10:10:31.916321 [debug] [Thread-3 (]: Acquiring new postgres connection 'test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e'
[0m10:10:31.917658 [debug] [Thread-4 (]: Acquiring new postgres connection 'test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b'
[0m10:10:31.918890 [debug] [Thread-1 (]: Began compiling node test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670
[0m10:10:31.920049 [debug] [Thread-2 (]: Began compiling node test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade
[0m10:10:31.921484 [debug] [Thread-3 (]: Began compiling node test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e
[0m10:10:31.922704 [debug] [Thread-4 (]: Began compiling node test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b
[0m10:10:31.937406 [debug] [Thread-1 (]: Writing injected SQL for node "test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670"
[0m10:10:31.940471 [debug] [Thread-2 (]: Writing injected SQL for node "test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade"
[0m10:10:31.943762 [debug] [Thread-3 (]: Writing injected SQL for node "test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e"
[0m10:10:31.947972 [debug] [Thread-4 (]: Writing injected SQL for node "test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b"
[0m10:10:31.957879 [debug] [Thread-3 (]: Began executing node test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e
[0m10:10:31.972897 [debug] [Thread-3 (]: Writing runtime sql for node "test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e"
[0m10:10:31.974968 [debug] [Thread-2 (]: Began executing node test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade
[0m10:10:31.975620 [debug] [Thread-1 (]: Began executing node test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670
[0m10:10:31.979093 [debug] [Thread-2 (]: Writing runtime sql for node "test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade"
[0m10:10:31.979390 [debug] [Thread-4 (]: Began executing node test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b
[0m10:10:31.982626 [debug] [Thread-1 (]: Writing runtime sql for node "test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670"
[0m10:10:31.987062 [debug] [Thread-4 (]: Writing runtime sql for node "test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b"
[0m10:10:31.991798 [debug] [Thread-2 (]: Using postgres connection "test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade"
[0m10:10:31.992828 [debug] [Thread-2 (]: On test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade: BEGIN
[0m10:10:31.994522 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m10:10:31.995037 [debug] [Thread-3 (]: Using postgres connection "test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e"
[0m10:10:31.997330 [debug] [Thread-3 (]: On test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e: BEGIN
[0m10:10:31.997896 [debug] [Thread-1 (]: Using postgres connection "test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670"
[0m10:10:31.999162 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:10:32.000387 [debug] [Thread-1 (]: On test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670: BEGIN
[0m10:10:32.001263 [debug] [Thread-4 (]: Using postgres connection "test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b"
[0m10:10:32.002817 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:10:32.003636 [debug] [Thread-4 (]: On test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b: BEGIN
[0m10:10:32.004563 [debug] [Thread-2 (]: SQL status: BEGIN in 0.010 seconds
[0m10:10:32.005987 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:10:32.007075 [debug] [Thread-2 (]: Using postgres connection "test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade"
[0m10:10:32.008717 [debug] [Thread-2 (]: On test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade"} */

    select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
  
    
    



select measurement_day
from "data_project_1"."public"."int_air_quality_daily"
where measurement_day is null



  
  
      
    ) dbt_internal_test
[0m10:10:32.011568 [debug] [Thread-3 (]: SQL status: BEGIN in 0.012 seconds
[0m10:10:32.012569 [debug] [Thread-3 (]: Using postgres connection "test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e"
[0m10:10:32.012869 [debug] [Thread-2 (]: SQL status: SELECT 1 in 0.002 seconds
[0m10:10:32.013105 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m10:10:32.013533 [debug] [Thread-3 (]: On test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e"} */

    select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
  
    
    



select location_id
from "data_project_1"."public"."int_air_quality_hourly"
where location_id is null



  
  
      
    ) dbt_internal_test
[0m10:10:32.014195 [debug] [Thread-4 (]: SQL status: BEGIN in 0.008 seconds
[0m10:10:32.017547 [debug] [Thread-2 (]: On test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade: ROLLBACK
[0m10:10:32.018408 [debug] [Thread-1 (]: Using postgres connection "test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670"
[0m10:10:32.019798 [debug] [Thread-4 (]: Using postgres connection "test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b"
[0m10:10:32.020704 [debug] [Thread-2 (]: On test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade: Close
[0m10:10:32.021191 [debug] [Thread-3 (]: SQL status: SELECT 1 in 0.002 seconds
[0m10:10:32.021520 [debug] [Thread-1 (]: On test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670"} */

    select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
  
    
    



select location_id
from "data_project_1"."public"."int_air_quality_daily"
where location_id is null



  
  
      
    ) dbt_internal_test
[0m10:10:32.022284 [debug] [Thread-4 (]: On test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b"} */

    select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
  
    
    



select measurement_hour
from "data_project_1"."public"."int_air_quality_hourly"
where measurement_hour is null



  
  
      
    ) dbt_internal_test
[0m10:10:32.023340 [info ] [Thread-2 (]: 2 of 6 PASS not_null_int_air_quality_daily_measurement_day ..................... [[32mPASS[0m in 0.11s]
[0m10:10:32.025342 [debug] [Thread-3 (]: On test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e: ROLLBACK
[0m10:10:32.027560 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.001 seconds
[0m10:10:32.029403 [debug] [Thread-2 (]: Finished running node test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade
[0m10:10:32.029928 [debug] [Thread-4 (]: SQL status: SELECT 1 in 0.002 seconds
[0m10:10:32.030794 [debug] [Thread-3 (]: On test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e: Close
[0m10:10:32.032588 [debug] [Thread-1 (]: On test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670: ROLLBACK
[0m10:10:32.033607 [debug] [Thread-2 (]: Began running node test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159
[0m10:10:32.035243 [debug] [Thread-4 (]: On test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b: ROLLBACK
[0m10:10:32.036237 [info ] [Thread-3 (]: 3 of 6 PASS not_null_int_air_quality_hourly_location_id ........................ [[32mPASS[0m in 0.12s]
[0m10:10:32.037322 [debug] [Thread-1 (]: On test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670: Close
[0m10:10:32.038328 [info ] [Thread-2 (]: 5 of 6 START test not_null_stg_air_quality_valencia_air_quality_pk ............. [RUN]
[0m10:10:32.039549 [debug] [Thread-4 (]: On test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b: Close
[0m10:10:32.040407 [debug] [Thread-3 (]: Finished running node test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e
[0m10:10:32.041590 [info ] [Thread-1 (]: 1 of 6 PASS not_null_int_air_quality_daily_location_id ......................... [[32mPASS[0m in 0.13s]
[0m10:10:32.042507 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly test.data_project_1.not_null_int_air_quality_daily_measurement_day.18d649dade, now test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159)
[0m10:10:32.044887 [info ] [Thread-4 (]: 4 of 6 PASS not_null_int_air_quality_hourly_measurement_hour ................... [[32mPASS[0m in 0.13s]
[0m10:10:32.047328 [debug] [Thread-3 (]: Began running node test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e
[0m10:10:32.048750 [debug] [Thread-1 (]: Finished running node test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670
[0m10:10:32.050044 [debug] [Thread-2 (]: Began compiling node test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159
[0m10:10:32.050867 [debug] [Thread-4 (]: Finished running node test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b
[0m10:10:32.051667 [info ] [Thread-3 (]: 6 of 6 START test unique_stg_air_quality_valencia_air_quality_pk ............... [RUN]
[0m10:10:32.056482 [debug] [Thread-2 (]: Writing injected SQL for node "test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159"
[0m10:10:32.058331 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly test.data_project_1.not_null_int_air_quality_hourly_location_id.43cdeb625e, now test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e)
[0m10:10:32.060325 [debug] [Thread-3 (]: Began compiling node test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e
[0m10:10:32.067411 [debug] [Thread-3 (]: Writing injected SQL for node "test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e"
[0m10:10:32.074380 [debug] [Thread-2 (]: Began executing node test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159
[0m10:10:32.077009 [debug] [Thread-2 (]: Writing runtime sql for node "test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159"
[0m10:10:32.080692 [debug] [Thread-3 (]: Began executing node test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e
[0m10:10:32.084487 [debug] [Thread-3 (]: Writing runtime sql for node "test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e"
[0m10:10:32.091525 [debug] [Thread-2 (]: Using postgres connection "test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159"
[0m10:10:32.092646 [debug] [Thread-2 (]: On test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159: BEGIN
[0m10:10:32.097018 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:10:32.097862 [debug] [Thread-3 (]: Using postgres connection "test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e"
[0m10:10:32.099577 [debug] [Thread-3 (]: On test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e: BEGIN
[0m10:10:32.100523 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m10:10:32.106306 [debug] [Thread-2 (]: SQL status: BEGIN in 0.009 seconds
[0m10:10:32.107454 [debug] [Thread-2 (]: Using postgres connection "test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159"
[0m10:10:32.108585 [debug] [Thread-2 (]: On test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159"} */

    select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
  
    
    



select air_quality_pk
from "data_project_1"."public"."stg_air_quality_valencia"
where air_quality_pk is null



  
  
      
    ) dbt_internal_test
[0m10:10:32.110115 [debug] [Thread-3 (]: SQL status: BEGIN in 0.010 seconds
[0m10:10:32.111713 [debug] [Thread-3 (]: Using postgres connection "test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e"
[0m10:10:32.113061 [debug] [Thread-3 (]: On test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e"} */

    select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
  
    
    

select
    air_quality_pk as unique_field,
    count(*) as n_records

from "data_project_1"."public"."stg_air_quality_valencia"
where air_quality_pk is not null
group by air_quality_pk
having count(*) > 1



  
  
      
    ) dbt_internal_test
[0m10:10:32.116270 [debug] [Thread-2 (]: SQL status: SELECT 1 in 0.005 seconds
[0m10:10:32.118977 [debug] [Thread-2 (]: On test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159: ROLLBACK
[0m10:10:32.119698 [debug] [Thread-3 (]: SQL status: SELECT 1 in 0.006 seconds
[0m10:10:32.120614 [debug] [Thread-2 (]: On test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159: Close
[0m10:10:32.122014 [debug] [Thread-3 (]: On test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e: ROLLBACK
[0m10:10:32.123129 [info ] [Thread-2 (]: 5 of 6 PASS not_null_stg_air_quality_valencia_air_quality_pk ................... [[32mPASS[0m in 0.08s]
[0m10:10:32.124198 [debug] [Thread-3 (]: On test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e: Close
[0m10:10:32.125182 [debug] [Thread-2 (]: Finished running node test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159
[0m10:10:32.126565 [info ] [Thread-3 (]: 6 of 6 PASS unique_stg_air_quality_valencia_air_quality_pk ..................... [[32mPASS[0m in 0.07s]
[0m10:10:32.130119 [debug] [Thread-3 (]: Finished running node test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e
[0m10:10:32.132782 [debug] [MainThread]: Using postgres connection "master"
[0m10:10:32.133602 [debug] [MainThread]: On master: BEGIN
[0m10:10:32.134439 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:10:32.141332 [debug] [MainThread]: SQL status: BEGIN in 0.007 seconds
[0m10:10:32.142444 [debug] [MainThread]: On master: COMMIT
[0m10:10:32.146319 [debug] [MainThread]: Using postgres connection "master"
[0m10:10:32.148205 [debug] [MainThread]: On master: COMMIT
[0m10:10:32.150037 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:10:32.151112 [debug] [MainThread]: On master: Close
[0m10:10:32.152049 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:10:32.152828 [debug] [MainThread]: Connection 'test.data_project_1.not_null_int_air_quality_daily_location_id.8516178670' was properly closed.
[0m10:10:32.153693 [debug] [MainThread]: Connection 'test.data_project_1.not_null_stg_air_quality_valencia_air_quality_pk.62e1817159' was properly closed.
[0m10:10:32.154696 [debug] [MainThread]: Connection 'test.data_project_1.unique_stg_air_quality_valencia_air_quality_pk.189816e81e' was properly closed.
[0m10:10:32.155551 [debug] [MainThread]: Connection 'test.data_project_1.not_null_int_air_quality_hourly_measurement_hour.205b8b592b' was properly closed.
[0m10:10:32.156464 [info ] [MainThread]: 
[0m10:10:32.157569 [info ] [MainThread]: Finished running 6 data tests in 0 hours 0 minutes and 0.40 seconds (0.40s).
[0m10:10:32.160460 [debug] [MainThread]: Command end result
[0m10:10:32.232122 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:10:32.253406 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:10:32.292937 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:10:32.297108 [info ] [MainThread]: 
[0m10:10:32.300004 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:10:32.302363 [info ] [MainThread]: 
[0m10:10:32.305133 [info ] [MainThread]: Done. PASS=6 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=6
[0m10:10:32.308685 [debug] [MainThread]: Resource report: {"command_name": "test", "command_success": true, "command_wall_clock_time": 3.0197718, "process_in_blocks": "0", "process_kernel_time": 0.601696, "process_mem_max_rss": "129624", "process_out_blocks": "0", "process_user_time": 1.857235}
[0m10:10:32.311110 [debug] [MainThread]: Command `dbt test` succeeded at 10:10:32.310889 after 3.02 seconds
[0m10:10:32.314408 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7957010a2e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7957010a2e90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x795701153810>]}
[0m10:10:32.316674 [debug] [MainThread]: Flushing usage events
[0m10:10:32.887526 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:11:16.461963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f19e6a150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f19f834d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f1a1e4a50>]}


============================== 10:11:16.470395 | 3e978447-191e-4b22-8f8e-c716380787f9 ==============================
[0m10:11:16.470395 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:11:16.471856 [debug] [MainThread]: running dbt with arguments {'use_colors': 'True', 'write_json': 'True', 'log_cache_events': 'False', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True', 'warn_error': 'None', 'quiet': 'False', 'partial_parse': 'True', 'version_check': 'True', 'introspect': 'True', 'cache_selected_only': 'False', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'printer_width': '80', 'profiles_dir': '/usr/app/dbt/dbt', 'empty': 'False', 'fail_fast': 'False', 'log_format': 'default', 'indirect_selection': 'eager', 'use_experimental_parser': 'False', 'log_path': '/usr/app/dbt/dbt/logs', 'invocation_command': 'dbt run', 'debug': 'False', 'no_print': 'None'}
[0m10:11:16.607248 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3e978447-191e-4b22-8f8e-c716380787f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f193e2090>]}
[0m10:11:16.669373 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3e978447-191e-4b22-8f8e-c716380787f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f1cbe8bd0>]}
[0m10:11:16.672750 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:11:16.827220 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:11:19.153488 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:11:19.160061 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:11:19.208059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3e978447-191e-4b22-8f8e-c716380787f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f1bdae010>]}
[0m10:11:19.402809 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:11:19.416834 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:11:19.458344 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3e978447-191e-4b22-8f8e-c716380787f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f17b3ef10>]}
[0m10:11:19.460107 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m10:11:19.461130 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3e978447-191e-4b22-8f8e-c716380787f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f17bb3190>]}
[0m10:11:19.463691 [info ] [MainThread]: 
[0m10:11:19.464639 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:11:19.465513 [info ] [MainThread]: 
[0m10:11:19.466674 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:11:19.470838 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:11:19.589510 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:11:19.591429 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:11:19.593324 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:11:19.611136 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m10:11:19.614412 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:11:19.617193 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:11:19.623288 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:11:19.624676 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:11:19.626116 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:11:19.635212 [debug] [ThreadPool]: SQL status: BEGIN in 0.009 seconds
[0m10:11:19.637575 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:11:19.639116 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:11:19.645094 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.005 seconds
[0m10:11:19.648433 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:11:19.650230 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:11:19.659696 [debug] [MainThread]: Using postgres connection "master"
[0m10:11:19.663007 [debug] [MainThread]: On master: BEGIN
[0m10:11:19.664976 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:11:19.675367 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m10:11:19.677548 [debug] [MainThread]: Using postgres connection "master"
[0m10:11:19.679354 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:11:19.693713 [debug] [MainThread]: SQL status: SELECT 1 in 0.007 seconds
[0m10:11:19.698756 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3e978447-191e-4b22-8f8e-c716380787f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f17bc6010>]}
[0m10:11:19.700851 [debug] [MainThread]: On master: ROLLBACK
[0m10:11:19.704242 [debug] [MainThread]: Using postgres connection "master"
[0m10:11:19.706984 [debug] [MainThread]: On master: BEGIN
[0m10:11:19.711067 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m10:11:19.714397 [debug] [MainThread]: On master: COMMIT
[0m10:11:19.717040 [debug] [MainThread]: Using postgres connection "master"
[0m10:11:19.718283 [debug] [MainThread]: On master: COMMIT
[0m10:11:19.721879 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m10:11:19.723585 [debug] [MainThread]: On master: Close
[0m10:11:19.732929 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:11:19.735653 [info ] [Thread-1 (]: 1 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:11:19.739237 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:11:19.741180 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:11:19.771184 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:11:19.844226 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:11:19.873783 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:11:19.890852 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:11:19.892114 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:11:19.893270 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:11:19.901141 [debug] [Thread-1 (]: SQL status: BEGIN in 0.008 seconds
[0m10:11:19.903234 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:11:19.904867 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:11:19.918942 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.012 seconds
[0m10:11:19.925476 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:11:19.927107 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:11:19.929843 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:11:19.934419 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:11:19.935595 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:11:19.939195 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m10:11:19.951496 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:11:19.953009 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:11:19.953975 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:11:19.959623 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m10:11:19.966408 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:11:19.970920 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:11:19.972256 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:11:19.978377 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m10:11:19.982267 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:11:19.984275 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e978447-191e-4b22-8f8e-c716380787f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f16c12010>]}
[0m10:11:19.985913 [info ] [Thread-1 (]: 1 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.24s]
[0m10:11:19.987419 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:11:19.990143 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:11:19.990903 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:11:19.992716 [info ] [Thread-3 (]: 2 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:11:19.994238 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:11:19.995268 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:11:19.996150 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:11:19.996913 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:11:19.997622 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:11:20.000664 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:11:20.003420 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:11:20.012130 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:11:20.018670 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:11:20.033958 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:11:20.037642 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:11:20.047092 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:11:20.047613 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:11:20.048461 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:11:20.049387 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:11:20.050123 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:11:20.050865 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:11:20.062428 [debug] [Thread-3 (]: SQL status: BEGIN in 0.012 seconds
[0m10:11:20.063349 [debug] [Thread-4 (]: SQL status: BEGIN in 0.012 seconds
[0m10:11:20.064235 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:11:20.065070 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:11:20.065926 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
  );
  
[0m10:11:20.066732 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_hour
),

variation AS (
    SELECT
        hourly.*,
        avg_hourly 
            - LAG(avg_hourly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_hour
            ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation
  );
  
[0m10:11:20.083981 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.016 seconds
[0m10:11:20.084625 [debug] [Thread-4 (]: SQL status: SELECT 572 in 0.016 seconds
[0m10:11:20.101765 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:11:20.105744 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:11:20.107187 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:11:20.108638 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly" rename to "int_air_quality_hourly__dbt_backup"
[0m10:11:20.112010 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:11:20.112373 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m10:11:20.115475 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:11:20.118363 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:11:20.119424 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp" rename to "int_air_quality_hourly"
[0m10:11:20.120244 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:11:20.122047 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:11:20.124692 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:11:20.125752 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:11:20.127388 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:11:20.128296 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:11:20.129312 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:11:20.130571 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:11:20.131566 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:11:20.136426 [debug] [Thread-4 (]: SQL status: COMMIT in 0.004 seconds
[0m10:11:20.140841 [debug] [Thread-4 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_hourly__dbt_backup"
[0m10:11:20.141391 [debug] [Thread-3 (]: SQL status: COMMIT in 0.008 seconds
[0m10:11:20.145678 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:11:20.148690 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:11:20.149840 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."int_air_quality_hourly__dbt_backup" cascade
[0m10:11:20.151234 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:11:20.152926 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:11:20.159108 [debug] [Thread-4 (]: SQL status: DROP TABLE in 0.007 seconds
[0m10:11:20.160491 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.007 seconds
[0m10:11:20.162805 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:11:20.164750 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:11:20.166065 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e978447-191e-4b22-8f8e-c716380787f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f16ce7750>]}
[0m10:11:20.167317 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e978447-191e-4b22-8f8e-c716380787f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f16c29310>]}
[0m10:11:20.168595 [info ] [Thread-4 (]: 3 of 3 OK created sql table model public.int_air_quality_hourly ................ [[32mSELECT 572[0m in 0.17s]
[0m10:11:20.170066 [info ] [Thread-3 (]: 2 of 3 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.17s]
[0m10:11:20.172803 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:11:20.174271 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:11:20.178754 [debug] [MainThread]: Using postgres connection "master"
[0m10:11:20.179935 [debug] [MainThread]: On master: BEGIN
[0m10:11:20.180686 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:11:20.190907 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m10:11:20.194438 [debug] [MainThread]: On master: COMMIT
[0m10:11:20.196015 [debug] [MainThread]: Using postgres connection "master"
[0m10:11:20.197524 [debug] [MainThread]: On master: COMMIT
[0m10:11:20.199320 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:11:20.200560 [debug] [MainThread]: On master: Close
[0m10:11:20.201794 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:11:20.203010 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:11:20.204275 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:11:20.206591 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:11:20.208065 [info ] [MainThread]: 
[0m10:11:20.209294 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.74 seconds (0.74s).
[0m10:11:20.210481 [debug] [MainThread]: Command end result
[0m10:11:20.315324 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:11:20.323804 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:11:20.340995 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:11:20.341948 [info ] [MainThread]: 
[0m10:11:20.343017 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:11:20.343784 [info ] [MainThread]: 
[0m10:11:20.344545 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m10:11:20.345996 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.955521, "process_in_blocks": "0", "process_kernel_time": 0.571127, "process_mem_max_rss": "128784", "process_out_blocks": "0", "process_user_time": 2.022743}
[0m10:11:20.346909 [debug] [MainThread]: Command `dbt run` succeeded at 10:11:20.346794 after 3.96 seconds
[0m10:11:20.347731 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f1e6cad90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f1e6cad10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x727f1e6d5dd0>]}
[0m10:11:20.348471 [debug] [MainThread]: Flushing usage events
[0m10:11:20.989889 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:12:23.128300 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f954a2bd10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f9549dbf10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f9549f0a50>]}


============================== 10:12:23.138463 | a7a81b4d-55c0-4d1e-98a5-e3a07bbb65d7 ==============================
[0m10:12:23.138463 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:12:23.140344 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'version_check': 'True', 'introspect': 'True', 'partial_parse': 'True', 'printer_width': '80', 'log_path': '/usr/app/dbt/dbt/logs', 'use_colors': 'True', 'indirect_selection': 'eager', 'use_experimental_parser': 'False', 'write_json': 'True', 'fail_fast': 'False', 'send_anonymous_usage_stats': 'True', 'invocation_command': 'dbt run', 'warn_error': 'None', 'quiet': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_cache_events': 'False', 'static_parser': 'True', 'cache_selected_only': 'False', 'log_format': 'default', 'debug': 'False', 'no_print': 'None', 'empty': 'False'}
[0m10:12:23.311030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a7a81b4d-55c0-4d1e-98a5-e3a07bbb65d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f953740c50>]}
[0m10:12:23.365041 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a7a81b4d-55c0-4d1e-98a5-e3a07bbb65d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f957738c90>]}
[0m10:12:23.380519 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:12:23.528616 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:12:25.542568 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:12:25.546571 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:12:25.591473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a7a81b4d-55c0-4d1e-98a5-e3a07bbb65d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f952f15390>]}
[0m10:12:25.748157 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:12:25.755286 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:12:25.797557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a7a81b4d-55c0-4d1e-98a5-e3a07bbb65d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f955164850>]}
[0m10:12:25.798813 [info ] [MainThread]: Found 3 models, 6 data tests, 1 source, 738 macros
[0m10:12:25.800018 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a7a81b4d-55c0-4d1e-98a5-e3a07bbb65d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f95237fe50>]}
[0m10:12:25.802611 [info ] [MainThread]: 
[0m10:12:25.803731 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:12:25.804757 [info ] [MainThread]: 
[0m10:12:25.805951 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:12:25.810507 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:12:25.945777 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:12:25.947197 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:12:25.948336 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:12:25.964402 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.016 seconds
[0m10:12:25.967189 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:12:25.969892 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:12:25.975050 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:12:25.976083 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:12:25.977962 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:12:25.988979 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m10:12:25.990265 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:12:25.991387 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:12:26.000737 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.008 seconds
[0m10:12:26.004536 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:12:26.006574 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:12:26.015183 [debug] [MainThread]: Using postgres connection "master"
[0m10:12:26.016557 [debug] [MainThread]: On master: BEGIN
[0m10:12:26.017719 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:12:26.026972 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m10:12:26.028499 [debug] [MainThread]: Using postgres connection "master"
[0m10:12:26.029747 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:12:26.037218 [debug] [MainThread]: SQL status: SELECT 1 in 0.006 seconds
[0m10:12:26.039575 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a7a81b4d-55c0-4d1e-98a5-e3a07bbb65d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f951702750>]}
[0m10:12:26.040861 [debug] [MainThread]: On master: ROLLBACK
[0m10:12:26.042079 [debug] [MainThread]: Using postgres connection "master"
[0m10:12:26.051415 [debug] [MainThread]: On master: BEGIN
[0m10:12:26.057496 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m10:12:26.058761 [debug] [MainThread]: On master: COMMIT
[0m10:12:26.060743 [debug] [MainThread]: Using postgres connection "master"
[0m10:12:26.062104 [debug] [MainThread]: On master: COMMIT
[0m10:12:26.063215 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:12:26.064230 [debug] [MainThread]: On master: Close
[0m10:12:26.070754 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:12:26.073448 [info ] [Thread-1 (]: 1 of 3 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:12:26.075523 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:12:26.078120 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:12:26.095433 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:12:26.108320 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:12:26.139022 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:12:26.153436 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:12:26.154815 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:12:26.155984 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:12:26.167675 [debug] [Thread-1 (]: SQL status: BEGIN in 0.012 seconds
[0m10:12:26.169144 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:12:26.170214 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:12:26.176818 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.006 seconds
[0m10:12:26.183950 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:12:26.185460 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:12:26.188997 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m10:12:26.193980 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:12:26.198542 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:12:26.209394 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:12:26.229025 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:12:26.246963 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:12:26.267259 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:12:26.280773 [debug] [Thread-1 (]: SQL status: COMMIT in 0.005 seconds
[0m10:12:26.287981 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:12:26.294536 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:12:26.295885 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:12:26.301140 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m10:12:26.304397 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:12:26.307459 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7a81b4d-55c0-4d1e-98a5-e3a07bbb65d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f953b69610>]}
[0m10:12:26.313873 [info ] [Thread-1 (]: 1 of 3 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.23s]
[0m10:12:26.315519 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:12:26.317626 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:12:26.318181 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:12:26.319503 [info ] [Thread-3 (]: 2 of 3 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:12:26.321070 [info ] [Thread-4 (]: 3 of 3 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:12:26.322866 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:12:26.324416 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:12:26.325927 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:12:26.327425 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:12:26.331427 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:12:26.335718 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:12:26.342382 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:12:26.349795 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:12:26.360674 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:12:26.363588 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:12:26.369758 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:12:26.370559 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:12:26.370862 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:12:26.371615 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:12:26.372343 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:12:26.373050 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:12:26.381828 [debug] [Thread-3 (]: SQL status: BEGIN in 0.009 seconds
[0m10:12:26.382901 [debug] [Thread-4 (]: SQL status: BEGIN in 0.010 seconds
[0m10:12:26.384133 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:12:26.385010 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:12:26.385855 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
  );
  
[0m10:12:26.386679 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_hour
),

variation AS (
    SELECT
        hourly.*,
        avg_hourly 
            - LAG(avg_hourly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_hour
            ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation
  );
  
[0m10:12:26.403048 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.015 seconds
[0m10:12:26.403528 [debug] [Thread-4 (]: SQL status: SELECT 572 in 0.015 seconds
[0m10:12:26.409267 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:12:26.412236 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:12:26.413817 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:12:26.415387 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly" rename to "int_air_quality_hourly__dbt_backup"
[0m10:12:26.417421 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:12:26.417898 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:12:26.420263 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:12:26.422735 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:12:26.423594 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:12:26.424327 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp" rename to "int_air_quality_hourly"
[0m10:12:26.425883 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:12:26.429910 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:12:26.432473 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:12:26.435270 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:12:26.436441 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:12:26.438752 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:12:26.439699 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:12:26.440523 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:12:26.445826 [debug] [Thread-3 (]: SQL status: COMMIT in 0.004 seconds
[0m10:12:26.446341 [debug] [Thread-4 (]: SQL status: COMMIT in 0.004 seconds
[0m10:12:26.448802 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:12:26.451125 [debug] [Thread-4 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_hourly__dbt_backup"
[0m10:12:26.454162 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:12:26.455308 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:12:26.470081 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:12:26.471944 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."int_air_quality_hourly__dbt_backup" cascade
[0m10:12:26.478619 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.006 seconds
[0m10:12:26.479794 [debug] [Thread-4 (]: SQL status: DROP TABLE in 0.006 seconds
[0m10:12:26.481691 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:12:26.483768 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:12:26.486361 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7a81b4d-55c0-4d1e-98a5-e3a07bbb65d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f95173c110>]}
[0m10:12:26.489033 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7a81b4d-55c0-4d1e-98a5-e3a07bbb65d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f9518a1310>]}
[0m10:12:26.491218 [info ] [Thread-3 (]: 2 of 3 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.16s]
[0m10:12:26.495525 [info ] [Thread-4 (]: 3 of 3 OK created sql table model public.int_air_quality_hourly ................ [[32mSELECT 572[0m in 0.16s]
[0m10:12:26.497709 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:12:26.500111 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:12:26.505366 [debug] [MainThread]: Using postgres connection "master"
[0m10:12:26.507178 [debug] [MainThread]: On master: BEGIN
[0m10:12:26.511112 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:12:26.525699 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m10:12:26.527732 [debug] [MainThread]: On master: COMMIT
[0m10:12:26.529559 [debug] [MainThread]: Using postgres connection "master"
[0m10:12:26.530879 [debug] [MainThread]: On master: COMMIT
[0m10:12:26.532687 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:12:26.533861 [debug] [MainThread]: On master: Close
[0m10:12:26.535217 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:12:26.535939 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:12:26.536579 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:12:26.538831 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:12:26.539947 [info ] [MainThread]: 
[0m10:12:26.541006 [info ] [MainThread]: Finished running 2 table models, 1 view model in 0 hours 0 minutes and 0.73 seconds (0.73s).
[0m10:12:26.542386 [debug] [MainThread]: Command end result
[0m10:12:26.621254 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:12:26.630902 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:12:26.646866 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:12:26.648020 [info ] [MainThread]: 
[0m10:12:26.649250 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:12:26.652000 [info ] [MainThread]: 
[0m10:12:26.653005 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=3
[0m10:12:26.654805 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.6553597, "process_in_blocks": "0", "process_kernel_time": 0.540926, "process_mem_max_rss": "129616", "process_out_blocks": "0", "process_user_time": 2.095589}
[0m10:12:26.655986 [debug] [MainThread]: Command `dbt run` succeeded at 10:12:26.655881 after 3.66 seconds
[0m10:12:26.656851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f95953f910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f95172eb10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x71f9592f7690>]}
[0m10:12:26.658843 [debug] [MainThread]: Flushing usage events
[0m10:12:27.416521 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:13:29.654385 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e781f1c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e781fe810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e781f2d50>]}


============================== 10:13:29.660245 | bb4502e3-da19-42fe-a977-c268d31206d2 ==============================
[0m10:13:29.660245 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:13:29.663534 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'version_check': 'True', 'quiet': 'False', 'target_path': 'None', 'indirect_selection': 'eager', 'empty': 'False', 'static_parser': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'no_print': 'None', 'introspect': 'True', 'write_json': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'printer_width': '80', 'log_format': 'default', 'use_experimental_parser': 'False', 'use_colors': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'fail_fast': 'False', 'warn_error': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True', 'debug': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])'}
[0m10:13:29.846627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bb4502e3-da19-42fe-a977-c268d31206d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e7792cc10>]}
[0m10:13:29.896108 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bb4502e3-da19-42fe-a977-c268d31206d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e7af0e290>]}
[0m10:13:29.898991 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:13:30.031429 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:13:31.882392 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m10:13:31.885000 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/intermediate/int_air_quality_monthly.sql
[0m10:13:32.182731 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bb4502e3-da19-42fe-a977-c268d31206d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e761f0650>]}
[0m10:13:32.292613 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:13:32.301366 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:13:32.339870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bb4502e3-da19-42fe-a977-c268d31206d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e76d97e10>]}
[0m10:13:32.341569 [info ] [MainThread]: Found 4 models, 6 data tests, 1 source, 738 macros
[0m10:13:32.343128 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bb4502e3-da19-42fe-a977-c268d31206d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e75d83dd0>]}
[0m10:13:32.347372 [info ] [MainThread]: 
[0m10:13:32.348823 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:13:32.349854 [info ] [MainThread]: 
[0m10:13:32.351164 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:13:32.356427 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:13:32.407267 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:13:32.409397 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:13:32.411551 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:13:32.438864 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.027 seconds
[0m10:13:32.442359 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:13:32.447199 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:13:32.454495 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:13:32.457077 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:13:32.458895 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:13:32.468524 [debug] [ThreadPool]: SQL status: BEGIN in 0.010 seconds
[0m10:13:32.470531 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:13:32.471765 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:13:32.478977 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.005 seconds
[0m10:13:32.482443 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:13:32.485200 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:13:32.491159 [debug] [MainThread]: Using postgres connection "master"
[0m10:13:32.493452 [debug] [MainThread]: On master: BEGIN
[0m10:13:32.494839 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:13:32.502937 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m10:13:32.504679 [debug] [MainThread]: Using postgres connection "master"
[0m10:13:32.506267 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:13:32.512775 [debug] [MainThread]: SQL status: SELECT 1 in 0.005 seconds
[0m10:13:32.515158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bb4502e3-da19-42fe-a977-c268d31206d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e79f2c1d0>]}
[0m10:13:32.516653 [debug] [MainThread]: On master: ROLLBACK
[0m10:13:32.518689 [debug] [MainThread]: Using postgres connection "master"
[0m10:13:32.520228 [debug] [MainThread]: On master: BEGIN
[0m10:13:32.521978 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m10:13:32.523346 [debug] [MainThread]: On master: COMMIT
[0m10:13:32.524467 [debug] [MainThread]: Using postgres connection "master"
[0m10:13:32.525896 [debug] [MainThread]: On master: COMMIT
[0m10:13:32.527532 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:13:32.529131 [debug] [MainThread]: On master: Close
[0m10:13:32.536456 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:13:32.537718 [info ] [Thread-1 (]: 1 of 4 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:13:32.538819 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:13:32.539777 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:13:32.553048 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:13:32.565136 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:13:32.596956 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:13:32.607107 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:13:32.609270 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:13:32.610464 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:13:32.621649 [debug] [Thread-1 (]: SQL status: BEGIN in 0.011 seconds
[0m10:13:32.623274 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:13:32.624655 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:13:32.646248 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.010 seconds
[0m10:13:32.662702 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:13:32.665472 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:13:32.669082 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:13:32.674476 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:13:32.677728 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:13:32.685598 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.003 seconds
[0m10:13:32.701054 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:13:32.703309 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:13:32.705424 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:13:32.712336 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m10:13:32.723153 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:13:32.732780 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:13:32.741343 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:13:32.750990 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.007 seconds
[0m10:13:32.759091 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:13:32.762646 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bb4502e3-da19-42fe-a977-c268d31206d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e6e441dd0>]}
[0m10:13:32.765539 [info ] [Thread-1 (]: 1 of 4 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.22s]
[0m10:13:32.768296 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:13:32.771427 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:13:32.771784 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:13:32.772066 [debug] [Thread-2 (]: Began running node model.data_project_1.int_air_quality_monthly
[0m10:13:32.773179 [info ] [Thread-3 (]: 2 of 4 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:13:32.775593 [info ] [Thread-4 (]: 3 of 4 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:13:32.777093 [info ] [Thread-2 (]: 4 of 4 START sql table model public.int_air_quality_monthly .................... [RUN]
[0m10:13:32.779065 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:13:32.781072 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:13:32.782628 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_monthly'
[0m10:13:32.784421 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:13:32.789677 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:13:32.792029 [debug] [Thread-2 (]: Began compiling node model.data_project_1.int_air_quality_monthly
[0m10:13:32.798172 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:13:32.802571 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:13:32.808753 [debug] [Thread-2 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_monthly"
[0m10:13:32.818320 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:13:32.818769 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:13:32.825126 [debug] [Thread-2 (]: Began executing node model.data_project_1.int_air_quality_monthly
[0m10:13:32.836118 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:13:32.840360 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:13:32.845095 [debug] [Thread-2 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_monthly"
[0m10:13:32.855270 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:13:32.856322 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:13:32.857745 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:13:32.859496 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: BEGIN
[0m10:13:32.860374 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:13:32.861463 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:13:32.862467 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m10:13:32.863235 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:13:32.865604 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:13:32.873660 [debug] [Thread-2 (]: SQL status: BEGIN in 0.011 seconds
[0m10:13:32.874809 [debug] [Thread-4 (]: SQL status: BEGIN in 0.013 seconds
[0m10:13:32.876883 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:13:32.877961 [debug] [Thread-3 (]: SQL status: BEGIN in 0.012 seconds
[0m10:13:32.878887 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:13:32.880088 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_monthly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('month', measurement_timestamp) AS measurement_month,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

monthly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_month,
        AVG(concentration_ug_m3) AS avg_monthly,
        MAX(concentration_ug_m3) AS max_monthly,
        MIN(concentration_ug_m3) AS min_monthly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_month
),

variation AS (
    SELECT
        monthly.*,
        avg_monthly 
            - LAG(avg_monthly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_month
            ) AS variation_vs_prev_month
    FROM monthly
)

SELECT *
FROM variation
  );
  
[0m10:13:32.881109 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:13:32.881991 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_hour
),

variation AS (
    SELECT
        hourly.*,
        avg_hourly 
            - LAG(avg_hourly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_hour
            ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation
  );
  
[0m10:13:32.883516 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
  );
  
[0m10:13:32.895961 [debug] [Thread-2 (]: SQL status: SELECT 44 in 0.013 seconds
[0m10:13:32.902909 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:13:32.903238 [debug] [Thread-4 (]: SQL status: SELECT 572 in 0.019 seconds
[0m10:13:32.904252 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */
alter table "data_project_1"."public"."int_air_quality_monthly__dbt_tmp" rename to "int_air_quality_monthly"
[0m10:13:32.904811 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.019 seconds
[0m10:13:32.907707 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:13:32.915081 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:13:32.915413 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.005 seconds
[0m10:13:32.916121 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly" rename to "int_air_quality_hourly__dbt_backup"
[0m10:13:32.916920 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:13:32.918259 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: COMMIT
[0m10:13:32.919890 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:13:32.920602 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:13:32.921372 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:13:32.925206 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:13:32.932671 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:13:32.934508 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: COMMIT
[0m10:13:32.936162 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp" rename to "int_air_quality_hourly"
[0m10:13:32.937576 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:13:32.941212 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:13:32.942595 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:13:32.944057 [debug] [Thread-2 (]: SQL status: COMMIT in 0.005 seconds
[0m10:13:32.947186 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:13:32.949880 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:13:32.955361 [debug] [Thread-2 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_monthly__dbt_backup"
[0m10:13:32.956412 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:13:32.957324 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:13:32.961382 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:13:32.962534 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:13:32.963441 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:13:32.964199 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */
drop table if exists "data_project_1"."public"."int_air_quality_monthly__dbt_backup" cascade
[0m10:13:32.966779 [debug] [Thread-2 (]: SQL status: DROP TABLE in 0.001 seconds
[0m10:13:32.967241 [debug] [Thread-4 (]: SQL status: COMMIT in 0.002 seconds
[0m10:13:32.968758 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: Close
[0m10:13:32.969047 [debug] [Thread-3 (]: SQL status: COMMIT in 0.003 seconds
[0m10:13:32.971433 [debug] [Thread-4 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_hourly__dbt_backup"
[0m10:13:32.972509 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bb4502e3-da19-42fe-a977-c268d31206d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e6e3ab910>]}
[0m10:13:32.974864 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:13:32.978036 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:13:32.979610 [info ] [Thread-2 (]: 4 of 4 OK created sql table model public.int_air_quality_monthly ............... [[32mSELECT 44[0m in 0.19s]
[0m10:13:32.980992 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:13:32.981896 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."int_air_quality_hourly__dbt_backup" cascade
[0m10:13:32.982927 [debug] [Thread-2 (]: Finished running node model.data_project_1.int_air_quality_monthly
[0m10:13:32.983885 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:13:32.989751 [debug] [Thread-4 (]: SQL status: DROP TABLE in 0.005 seconds
[0m10:13:32.990556 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.005 seconds
[0m10:13:32.993901 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:13:32.997049 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:13:32.998878 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bb4502e3-da19-42fe-a977-c268d31206d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e6e3e2990>]}
[0m10:13:33.000671 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bb4502e3-da19-42fe-a977-c268d31206d2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e7757ead0>]}
[0m10:13:33.002218 [info ] [Thread-4 (]: 3 of 4 OK created sql table model public.int_air_quality_hourly ................ [[32mSELECT 572[0m in 0.22s]
[0m10:13:33.004399 [info ] [Thread-3 (]: 2 of 4 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.22s]
[0m10:13:33.005497 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:13:33.006410 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:13:33.013515 [debug] [MainThread]: Using postgres connection "master"
[0m10:13:33.015147 [debug] [MainThread]: On master: BEGIN
[0m10:13:33.016333 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:13:33.025648 [debug] [MainThread]: SQL status: BEGIN in 0.009 seconds
[0m10:13:33.029732 [debug] [MainThread]: On master: COMMIT
[0m10:13:33.031070 [debug] [MainThread]: Using postgres connection "master"
[0m10:13:33.032056 [debug] [MainThread]: On master: COMMIT
[0m10:13:33.033456 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:13:33.034745 [debug] [MainThread]: On master: Close
[0m10:13:33.036123 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:13:33.037016 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:13:33.038308 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:13:33.039635 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:13:33.043105 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_monthly' was properly closed.
[0m10:13:33.048159 [info ] [MainThread]: 
[0m10:13:33.052572 [info ] [MainThread]: Finished running 3 table models, 1 view model in 0 hours 0 minutes and 0.70 seconds (0.70s).
[0m10:13:33.056348 [debug] [MainThread]: Command end result
[0m10:13:33.132180 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:13:33.142357 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:13:33.156705 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:13:33.158113 [info ] [MainThread]: 
[0m10:13:33.160163 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:13:33.161701 [info ] [MainThread]: 
[0m10:13:33.163420 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=4
[0m10:13:33.165465 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.5886736, "process_in_blocks": "0", "process_kernel_time": 0.575307, "process_mem_max_rss": "132212", "process_out_blocks": "0", "process_user_time": 2.293125}
[0m10:13:33.166528 [debug] [MainThread]: Command `dbt run` succeeded at 10:13:33.166361 after 3.59 seconds
[0m10:13:33.167538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e7819f550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e7819ea50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x797e7caa7810>]}
[0m10:13:33.169346 [debug] [MainThread]: Flushing usage events
[0m10:13:33.687621 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:14:35.751644 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00e15b1910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00e15be1d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00e157d010>]}


============================== 10:14:35.757953 | cc1ff8c9-da46-46f8-8bc1-4e1a420bdd16 ==============================
[0m10:14:35.757953 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:14:35.762478 [debug] [MainThread]: running dbt with arguments {'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_experimental_parser': 'False', 'version_check': 'True', 'log_format': 'default', 'use_colors': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'cache_selected_only': 'False', 'debug': 'False', 'quiet': 'False', 'introspect': 'True', 'empty': 'False', 'warn_error': 'None', 'log_path': '/usr/app/dbt/dbt/logs', 'log_cache_events': 'False', 'send_anonymous_usage_stats': 'True', 'no_print': 'None', 'invocation_command': 'dbt run', 'target_path': 'None', 'static_parser': 'True', 'write_json': 'True', 'fail_fast': 'False', 'printer_width': '80', 'indirect_selection': 'eager', 'partial_parse': 'True'}
[0m10:14:35.888743 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cc1ff8c9-da46-46f8-8bc1-4e1a420bdd16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00e0542290>]}
[0m10:14:35.942306 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cc1ff8c9-da46-46f8-8bc1-4e1a420bdd16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00e42be790>]}
[0m10:14:35.948766 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:14:36.086285 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:14:37.798133 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:14:37.801650 [debug] [MainThread]: Partial parsing: updated file: data_project_1://models/intermediate/schema.yml
[0m10:14:38.167917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cc1ff8c9-da46-46f8-8bc1-4e1a420bdd16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00e093d8d0>]}
[0m10:14:38.271810 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:14:38.278962 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:14:38.310233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cc1ff8c9-da46-46f8-8bc1-4e1a420bdd16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00df187610>]}
[0m10:14:38.311597 [info ] [MainThread]: Found 4 models, 2 data tests, 1 source, 738 macros
[0m10:14:38.312614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc1ff8c9-da46-46f8-8bc1-4e1a420bdd16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00e15f5850>]}
[0m10:14:38.314702 [info ] [MainThread]: 
[0m10:14:38.315962 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:14:38.317706 [info ] [MainThread]: 
[0m10:14:38.318723 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:14:38.322661 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:14:38.371641 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:14:38.372891 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:14:38.373937 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:14:38.388747 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.015 seconds
[0m10:14:38.391444 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:14:38.394048 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:14:38.401158 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:14:38.402252 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:14:38.403276 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:14:38.411091 [debug] [ThreadPool]: SQL status: BEGIN in 0.008 seconds
[0m10:14:38.412203 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:14:38.413251 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:14:38.419620 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.006 seconds
[0m10:14:38.424775 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:14:38.431277 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:14:38.438393 [debug] [MainThread]: Using postgres connection "master"
[0m10:14:38.444169 [debug] [MainThread]: On master: BEGIN
[0m10:14:38.446383 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:14:38.459424 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m10:14:38.462728 [debug] [MainThread]: Using postgres connection "master"
[0m10:14:38.465597 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:14:38.478445 [debug] [MainThread]: SQL status: SELECT 1 in 0.010 seconds
[0m10:14:38.482145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cc1ff8c9-da46-46f8-8bc1-4e1a420bdd16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00d75ab710>]}
[0m10:14:38.484132 [debug] [MainThread]: On master: ROLLBACK
[0m10:14:38.486937 [debug] [MainThread]: Using postgres connection "master"
[0m10:14:38.488219 [debug] [MainThread]: On master: BEGIN
[0m10:14:38.491136 [debug] [MainThread]: SQL status: BEGIN in 0.000 seconds
[0m10:14:38.492937 [debug] [MainThread]: On master: COMMIT
[0m10:14:38.494102 [debug] [MainThread]: Using postgres connection "master"
[0m10:14:38.496776 [debug] [MainThread]: On master: COMMIT
[0m10:14:38.498541 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:14:38.499835 [debug] [MainThread]: On master: Close
[0m10:14:38.507480 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:14:38.509127 [info ] [Thread-1 (]: 1 of 4 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:14:38.510285 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:14:38.511116 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:14:38.528480 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:14:38.548639 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:14:38.573963 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:14:38.587684 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:14:38.589403 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:14:38.591726 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:14:38.603027 [debug] [Thread-1 (]: SQL status: BEGIN in 0.011 seconds
[0m10:14:38.606573 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:14:38.608059 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:14:38.622499 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.012 seconds
[0m10:14:38.629051 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:14:38.637372 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:14:38.639884 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:14:38.644520 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:14:38.645864 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:14:38.651052 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:14:38.664147 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:14:38.667721 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:14:38.670475 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:14:38.673971 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m10:14:38.682225 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:14:38.690033 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:14:38.694342 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:14:38.700335 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m10:14:38.704484 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:14:38.706957 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cc1ff8c9-da46-46f8-8bc1-4e1a420bdd16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00ded09550>]}
[0m10:14:38.708622 [info ] [Thread-1 (]: 1 of 4 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.20s]
[0m10:14:38.711083 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:14:38.714307 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:14:38.714900 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:14:38.715513 [debug] [Thread-2 (]: Began running node model.data_project_1.int_air_quality_monthly
[0m10:14:38.727173 [info ] [Thread-3 (]: 2 of 4 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:14:38.731084 [info ] [Thread-4 (]: 3 of 4 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:14:38.732445 [info ] [Thread-2 (]: 4 of 4 START sql table model public.int_air_quality_monthly .................... [RUN]
[0m10:14:38.734487 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:14:38.735710 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:14:38.736747 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_monthly'
[0m10:14:38.738710 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:14:38.740889 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:14:38.742160 [debug] [Thread-2 (]: Began compiling node model.data_project_1.int_air_quality_monthly
[0m10:14:38.746627 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:14:38.752345 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:14:38.759823 [debug] [Thread-2 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_monthly"
[0m10:14:38.775972 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:14:38.777848 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:14:38.783686 [debug] [Thread-2 (]: Began executing node model.data_project_1.int_air_quality_monthly
[0m10:14:38.798991 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:14:38.801774 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:14:38.806023 [debug] [Thread-2 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_monthly"
[0m10:14:38.818688 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:14:38.819947 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:14:38.820292 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:14:38.821529 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: BEGIN
[0m10:14:38.823807 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:14:38.825485 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:14:38.828296 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m10:14:38.831778 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:14:38.836661 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:14:38.841471 [debug] [Thread-4 (]: SQL status: BEGIN in 0.016 seconds
[0m10:14:38.842263 [debug] [Thread-2 (]: SQL status: BEGIN in 0.014 seconds
[0m10:14:38.847793 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:14:38.849613 [debug] [Thread-3 (]: SQL status: BEGIN in 0.013 seconds
[0m10:14:38.850732 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:14:38.853928 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_hour
),

variation AS (
    SELECT
        hourly.*,
        avg_hourly 
            - LAG(avg_hourly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_hour
            ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation
  );
  
[0m10:14:38.856065 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:14:38.858711 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_monthly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('month', measurement_timestamp) AS measurement_month,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

monthly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_month,
        AVG(concentration_ug_m3) AS avg_monthly,
        MAX(concentration_ug_m3) AS max_monthly,
        MIN(concentration_ug_m3) AS min_monthly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_month
),

variation AS (
    SELECT
        monthly.*,
        avg_monthly 
            - LAG(avg_monthly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_month
            ) AS variation_vs_prev_month
    FROM monthly
)

SELECT *
FROM variation
  );
  
[0m10:14:38.864317 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
  );
  
[0m10:14:38.876131 [debug] [Thread-2 (]: SQL status: SELECT 44 in 0.010 seconds
[0m10:14:38.877311 [debug] [Thread-4 (]: SQL status: SELECT 572 in 0.014 seconds
[0m10:14:38.881135 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.015 seconds
[0m10:14:38.886850 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:14:38.890587 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:14:38.896419 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:14:38.898007 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */
alter table "data_project_1"."public"."int_air_quality_monthly" rename to "int_air_quality_monthly__dbt_backup"
[0m10:14:38.899284 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly" rename to "int_air_quality_hourly__dbt_backup"
[0m10:14:38.901894 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:14:38.904308 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:14:38.905668 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:14:38.907282 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.000 seconds
[0m10:14:38.910385 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:14:38.914477 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:14:38.918705 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:14:38.920030 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */
alter table "data_project_1"."public"."int_air_quality_monthly__dbt_tmp" rename to "int_air_quality_monthly"
[0m10:14:38.922557 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp" rename to "int_air_quality_hourly"
[0m10:14:38.923864 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:14:38.925932 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:14:38.926974 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:14:38.928041 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:14:38.930196 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: COMMIT
[0m10:14:38.932692 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:14:38.935253 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:14:38.936852 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:14:38.937958 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:14:38.939120 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:14:38.940262 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: COMMIT
[0m10:14:38.941252 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:14:38.943383 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:14:38.948058 [debug] [Thread-2 (]: SQL status: COMMIT in 0.003 seconds
[0m10:14:38.949285 [debug] [Thread-3 (]: SQL status: COMMIT in 0.003 seconds
[0m10:14:38.951303 [debug] [Thread-2 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_monthly__dbt_backup"
[0m10:14:38.951671 [debug] [Thread-4 (]: SQL status: COMMIT in 0.006 seconds
[0m10:14:38.957483 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:14:38.962548 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:14:38.967052 [debug] [Thread-4 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_hourly__dbt_backup"
[0m10:14:38.968749 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:14:38.970046 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */
drop table if exists "data_project_1"."public"."int_air_quality_monthly__dbt_backup" cascade
[0m10:14:38.971577 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:14:38.972685 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:14:38.974884 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."int_air_quality_hourly__dbt_backup" cascade
[0m10:14:38.978310 [debug] [Thread-2 (]: SQL status: DROP TABLE in 0.004 seconds
[0m10:14:38.982561 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: Close
[0m10:14:38.983020 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.007 seconds
[0m10:14:38.985886 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cc1ff8c9-da46-46f8-8bc1-4e1a420bdd16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00d74bbf50>]}
[0m10:14:38.986464 [debug] [Thread-4 (]: SQL status: DROP TABLE in 0.006 seconds
[0m10:14:38.987473 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:14:38.988938 [info ] [Thread-2 (]: 4 of 4 OK created sql table model public.int_air_quality_monthly ............... [[32mSELECT 44[0m in 0.25s]
[0m10:14:38.991927 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:14:38.993275 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cc1ff8c9-da46-46f8-8bc1-4e1a420bdd16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00d74dc890>]}
[0m10:14:38.996623 [debug] [Thread-2 (]: Finished running node model.data_project_1.int_air_quality_monthly
[0m10:14:38.998073 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cc1ff8c9-da46-46f8-8bc1-4e1a420bdd16', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00dfdac8d0>]}
[0m10:14:39.000094 [info ] [Thread-3 (]: 2 of 4 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.26s]
[0m10:14:39.002971 [info ] [Thread-4 (]: 3 of 4 OK created sql table model public.int_air_quality_hourly ................ [[32mSELECT 572[0m in 0.26s]
[0m10:14:39.005261 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:14:39.007170 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:14:39.011581 [debug] [MainThread]: Using postgres connection "master"
[0m10:14:39.014022 [debug] [MainThread]: On master: BEGIN
[0m10:14:39.015094 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:14:39.025115 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m10:14:39.026330 [debug] [MainThread]: On master: COMMIT
[0m10:14:39.027856 [debug] [MainThread]: Using postgres connection "master"
[0m10:14:39.028688 [debug] [MainThread]: On master: COMMIT
[0m10:14:39.029634 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:14:39.030465 [debug] [MainThread]: On master: Close
[0m10:14:39.031688 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:14:39.032601 [debug] [MainThread]: Connection 'model.data_project_1.stg_air_quality_valencia' was properly closed.
[0m10:14:39.033823 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:14:39.034887 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:14:39.035923 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_monthly' was properly closed.
[0m10:14:39.037001 [info ] [MainThread]: 
[0m10:14:39.037883 [info ] [MainThread]: Finished running 3 table models, 1 view model in 0 hours 0 minutes and 0.72 seconds (0.72s).
[0m10:14:39.039273 [debug] [MainThread]: Command end result
[0m10:14:39.106350 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:14:39.117823 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:14:39.132807 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:14:39.134111 [info ] [MainThread]: 
[0m10:14:39.135572 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:14:39.136739 [info ] [MainThread]: 
[0m10:14:39.137624 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=4
[0m10:14:39.139806 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.4526527, "process_in_blocks": "0", "process_kernel_time": 0.455244, "process_mem_max_rss": "133908", "process_out_blocks": "0", "process_user_time": 2.239964}
[0m10:14:39.143181 [debug] [MainThread]: Command `dbt run` succeeded at 10:14:39.142985 after 3.46 seconds
[0m10:14:39.145334 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00e60c3910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00e5e7a9d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7c00e5e7b690>]}
[0m10:14:39.147833 [debug] [MainThread]: Flushing usage events
[0m10:14:39.668042 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:15:41.643605 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b683b7a6650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b683b7a6510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b683b7a64d0>]}


============================== 10:15:41.649167 | 7f6346e0-ec2b-4212-9c86-154f3bf6a200 ==============================
[0m10:15:41.649167 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:15:41.650447 [debug] [MainThread]: running dbt with arguments {'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_path': '/usr/app/dbt/dbt/logs', 'use_experimental_parser': 'False', 'debug': 'False', 'cache_selected_only': 'False', 'profiles_dir': '/usr/app/dbt/dbt', 'fail_fast': 'False', 'invocation_command': 'dbt run', 'empty': 'False', 'printer_width': '80', 'version_check': 'True', 'target_path': 'None', 'static_parser': 'True', 'warn_error': 'None', 'log_cache_events': 'False', 'indirect_selection': 'eager', 'partial_parse': 'True', 'send_anonymous_usage_stats': 'True', 'quiet': 'False', 'no_print': 'None', 'introspect': 'True', 'write_json': 'True', 'use_colors': 'True', 'log_format': 'default'}
[0m10:15:41.801134 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7f6346e0-ec2b-4212-9c86-154f3bf6a200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b683b8c7790>]}
[0m10:15:41.849280 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7f6346e0-ec2b-4212-9c86-154f3bf6a200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b683e4b6890>]}
[0m10:15:41.853308 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:15:42.010169 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:15:43.898140 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m10:15:43.900346 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/marts/mart_air_quality_hourly.sql
[0m10:15:44.180960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7f6346e0-ec2b-4212-9c86-154f3bf6a200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b6839f31890>]}
[0m10:15:44.300429 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:15:44.315405 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:15:44.366437 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7f6346e0-ec2b-4212-9c86-154f3bf6a200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b6839f68790>]}
[0m10:15:44.368060 [info ] [MainThread]: Found 5 models, 2 data tests, 1 source, 738 macros
[0m10:15:44.369505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7f6346e0-ec2b-4212-9c86-154f3bf6a200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b6838f43690>]}
[0m10:15:44.373817 [info ] [MainThread]: 
[0m10:15:44.375558 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:15:44.378212 [info ] [MainThread]: 
[0m10:15:44.379893 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:15:44.383962 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:15:44.440189 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:15:44.441504 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:15:44.442362 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:15:44.453875 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.011 seconds
[0m10:15:44.456765 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:15:44.459842 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:15:44.466761 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:15:44.468283 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:15:44.470542 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:15:44.480369 [debug] [ThreadPool]: SQL status: BEGIN in 0.010 seconds
[0m10:15:44.481977 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:15:44.483334 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:15:44.491808 [debug] [ThreadPool]: SQL status: SELECT 5 in 0.006 seconds
[0m10:15:44.495376 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:15:44.497532 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:15:44.504152 [debug] [MainThread]: Using postgres connection "master"
[0m10:15:44.505435 [debug] [MainThread]: On master: BEGIN
[0m10:15:44.506782 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:15:44.517178 [debug] [MainThread]: SQL status: BEGIN in 0.010 seconds
[0m10:15:44.519325 [debug] [MainThread]: Using postgres connection "master"
[0m10:15:44.520959 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:15:44.531753 [debug] [MainThread]: SQL status: SELECT 1 in 0.009 seconds
[0m10:15:44.534510 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7f6346e0-ec2b-4212-9c86-154f3bf6a200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b68393470d0>]}
[0m10:15:44.536190 [debug] [MainThread]: On master: ROLLBACK
[0m10:15:44.537944 [debug] [MainThread]: Using postgres connection "master"
[0m10:15:44.539380 [debug] [MainThread]: On master: BEGIN
[0m10:15:44.542766 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m10:15:44.545362 [debug] [MainThread]: On master: COMMIT
[0m10:15:44.546624 [debug] [MainThread]: Using postgres connection "master"
[0m10:15:44.547631 [debug] [MainThread]: On master: COMMIT
[0m10:15:44.548810 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:15:44.549806 [debug] [MainThread]: On master: Close
[0m10:15:44.557616 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:15:44.559238 [info ] [Thread-1 (]: 1 of 5 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:15:44.560959 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:15:44.561972 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:15:44.581968 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:15:44.596009 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:15:44.629718 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:15:44.643386 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:15:44.645147 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:15:44.646856 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:15:44.663113 [debug] [Thread-1 (]: SQL status: BEGIN in 0.016 seconds
[0m10:15:44.664929 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:15:44.666763 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:15:44.676712 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.008 seconds
[0m10:15:44.688604 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:15:44.690305 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:15:44.696472 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m10:15:44.701431 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:15:44.702896 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:15:44.705762 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m10:15:44.720005 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:15:44.721373 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:15:44.722491 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:15:44.728192 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m10:15:44.735866 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:15:44.743611 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:15:44.745200 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:15:44.753364 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.007 seconds
[0m10:15:44.756665 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:15:44.759239 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7f6346e0-ec2b-4212-9c86-154f3bf6a200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b6831745450>]}
[0m10:15:44.762526 [info ] [Thread-1 (]: 1 of 5 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.20s]
[0m10:15:44.764413 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:15:44.767016 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:15:44.767624 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:15:44.768131 [debug] [Thread-2 (]: Began running node model.data_project_1.int_air_quality_monthly
[0m10:15:44.769646 [info ] [Thread-3 (]: 2 of 5 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:15:44.773674 [info ] [Thread-4 (]: 3 of 5 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:15:44.775630 [info ] [Thread-2 (]: 4 of 5 START sql table model public.int_air_quality_monthly .................... [RUN]
[0m10:15:44.777907 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:15:44.779271 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:15:44.780471 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_monthly'
[0m10:15:44.781487 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:15:44.782381 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:15:44.783614 [debug] [Thread-2 (]: Began compiling node model.data_project_1.int_air_quality_monthly
[0m10:15:44.787051 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:15:44.790994 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:15:44.793750 [debug] [Thread-2 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_monthly"
[0m10:15:44.804535 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:15:44.805301 [debug] [Thread-2 (]: Began executing node model.data_project_1.int_air_quality_monthly
[0m10:15:44.812305 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:15:44.827789 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:15:44.831416 [debug] [Thread-2 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_monthly"
[0m10:15:44.835671 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:15:44.853896 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:15:44.856039 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:15:44.856584 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:15:44.858008 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:15:44.858713 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:15:44.861804 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:15:44.864519 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: BEGIN
[0m10:15:44.865814 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:15:44.867011 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m10:15:44.879958 [debug] [Thread-3 (]: SQL status: BEGIN in 0.022 seconds
[0m10:15:44.880810 [debug] [Thread-4 (]: SQL status: BEGIN in 0.015 seconds
[0m10:15:44.881625 [debug] [Thread-2 (]: SQL status: BEGIN in 0.015 seconds
[0m10:15:44.882068 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:15:44.883028 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:15:44.883937 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:15:44.885048 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
  );
  
[0m10:15:44.886183 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_hour
),

variation AS (
    SELECT
        hourly.*,
        avg_hourly 
            - LAG(avg_hourly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_hour
            ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation
  );
  
[0m10:15:44.887264 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_monthly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('month', measurement_timestamp) AS measurement_month,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

monthly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_month,
        AVG(concentration_ug_m3) AS avg_monthly,
        MAX(concentration_ug_m3) AS max_monthly,
        MIN(concentration_ug_m3) AS min_monthly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_month
),

variation AS (
    SELECT
        monthly.*,
        avg_monthly 
            - LAG(avg_monthly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_month
            ) AS variation_vs_prev_month
    FROM monthly
)

SELECT *
FROM variation
  );
  
[0m10:15:44.899224 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.011 seconds
[0m10:15:44.900599 [debug] [Thread-2 (]: SQL status: SELECT 44 in 0.011 seconds
[0m10:15:44.905629 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:15:44.905972 [debug] [Thread-4 (]: SQL status: SELECT 572 in 0.017 seconds
[0m10:15:44.910110 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:15:44.911552 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:15:44.914150 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:15:44.915077 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */
alter table "data_project_1"."public"."int_air_quality_monthly" rename to "int_air_quality_monthly__dbt_backup"
[0m10:15:44.916433 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:15:44.916707 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly" rename to "int_air_quality_hourly__dbt_backup"
[0m10:15:44.919969 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:15:44.920226 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.003 seconds
[0m10:15:44.921499 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:15:44.921814 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:15:44.924745 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:15:44.926598 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:15:44.929010 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:15:44.930203 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */
alter table "data_project_1"."public"."int_air_quality_monthly__dbt_tmp" rename to "int_air_quality_monthly"
[0m10:15:44.931681 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:15:44.932540 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp" rename to "int_air_quality_hourly"
[0m10:15:44.934005 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:15:44.934341 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:15:44.935846 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:15:44.937169 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: COMMIT
[0m10:15:44.939229 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:15:44.942037 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:15:44.943865 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:15:44.945814 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:15:44.947194 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: COMMIT
[0m10:15:44.948012 [debug] [Thread-3 (]: SQL status: COMMIT in 0.003 seconds
[0m10:15:44.948368 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:15:44.951993 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:15:44.952298 [debug] [Thread-2 (]: SQL status: COMMIT in 0.003 seconds
[0m10:15:44.958990 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:15:44.959534 [debug] [Thread-4 (]: SQL status: COMMIT in 0.006 seconds
[0m10:15:44.962678 [debug] [Thread-2 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_monthly__dbt_backup"
[0m10:15:44.965196 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:15:44.969162 [debug] [Thread-4 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_hourly__dbt_backup"
[0m10:15:44.971003 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:15:44.974438 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:15:44.976100 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */
drop table if exists "data_project_1"."public"."int_air_quality_monthly__dbt_backup" cascade
[0m10:15:44.977682 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."int_air_quality_hourly__dbt_backup" cascade
[0m10:15:44.981518 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.009 seconds
[0m10:15:44.982850 [debug] [Thread-2 (]: SQL status: DROP TABLE in 0.004 seconds
[0m10:15:44.984106 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:15:44.987176 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: Close
[0m10:15:44.987679 [debug] [Thread-4 (]: SQL status: DROP TABLE in 0.007 seconds
[0m10:15:44.989403 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7f6346e0-ec2b-4212-9c86-154f3bf6a200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b68304f64d0>]}
[0m10:15:44.990705 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7f6346e0-ec2b-4212-9c86-154f3bf6a200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b68316c7190>]}
[0m10:15:44.992163 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:15:44.994738 [info ] [Thread-3 (]: 2 of 5 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.21s]
[0m10:15:44.997019 [info ] [Thread-2 (]: 4 of 5 OK created sql table model public.int_air_quality_monthly ............... [[32mSELECT 44[0m in 0.21s]
[0m10:15:44.999561 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7f6346e0-ec2b-4212-9c86-154f3bf6a200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b6831688f90>]}
[0m10:15:45.001144 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:15:45.002969 [debug] [Thread-2 (]: Finished running node model.data_project_1.int_air_quality_monthly
[0m10:15:45.004571 [info ] [Thread-4 (]: 3 of 5 OK created sql table model public.int_air_quality_hourly ................ [[32mSELECT 572[0m in 0.22s]
[0m10:15:45.012524 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:15:45.014721 [debug] [Thread-1 (]: Began running node model.data_project_1.mart_air_quality_hourly
[0m10:15:45.016288 [info ] [Thread-1 (]: 5 of 5 START sql table model public.mart_air_quality_hourly .................... [RUN]
[0m10:15:45.018061 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.data_project_1.stg_air_quality_valencia, now model.data_project_1.mart_air_quality_hourly)
[0m10:15:45.019585 [debug] [Thread-1 (]: Began compiling node model.data_project_1.mart_air_quality_hourly
[0m10:15:45.027653 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.mart_air_quality_hourly"
[0m10:15:45.048536 [debug] [Thread-1 (]: Began executing node model.data_project_1.mart_air_quality_hourly
[0m10:15:45.053432 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.mart_air_quality_hourly"
[0m10:15:45.074336 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.mart_air_quality_hourly"
[0m10:15:45.076458 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_hourly: BEGIN
[0m10:15:45.077568 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:15:45.087145 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m10:15:45.089426 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.mart_air_quality_hourly"
[0m10:15:45.091743 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.mart_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."mart_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

SELECT
    location_id,
    station_name,
    pollutant_type,
    measurement_hour,
    avg_hourly,
    max_hourly,
    min_hourly,
    num_measurements,
    variation_vs_prev_hour
FROM "data_project_1"."public"."int_air_quality_hourly"
--Este mart proporciona un resumen horario de las mediciones de calidad del aire, incluyendo promedios, mÃ¡ximos, mÃ­nimos y variaciones respecto a la hora anterior. Es Ãºtil para anÃ¡lisis detallados y monitoreo en tiempo real.
  );
  
[0m10:15:45.100222 [debug] [Thread-1 (]: SQL status: SELECT 572 in 0.006 seconds
[0m10:15:45.106261 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.mart_air_quality_hourly"
[0m10:15:45.108273 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.mart_air_quality_hourly"} */
alter table "data_project_1"."public"."mart_air_quality_hourly__dbt_tmp" rename to "mart_air_quality_hourly"
[0m10:15:45.111834 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:15:45.115790 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_hourly: COMMIT
[0m10:15:45.117781 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.mart_air_quality_hourly"
[0m10:15:45.119508 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_hourly: COMMIT
[0m10:15:45.123399 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m10:15:45.127016 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."mart_air_quality_hourly__dbt_backup"
[0m10:15:45.128923 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.mart_air_quality_hourly"
[0m10:15:45.130272 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.mart_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."mart_air_quality_hourly__dbt_backup" cascade
[0m10:15:45.132145 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.000 seconds
[0m10:15:45.134870 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_hourly: Close
[0m10:15:45.136605 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7f6346e0-ec2b-4212-9c86-154f3bf6a200', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b68305bb690>]}
[0m10:15:45.138854 [info ] [Thread-1 (]: 5 of 5 OK created sql table model public.mart_air_quality_hourly ............... [[32mSELECT 572[0m in 0.12s]
[0m10:15:45.141175 [debug] [Thread-1 (]: Finished running node model.data_project_1.mart_air_quality_hourly
[0m10:15:45.147217 [debug] [MainThread]: Using postgres connection "master"
[0m10:15:45.149153 [debug] [MainThread]: On master: BEGIN
[0m10:15:45.150818 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:15:45.163195 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m10:15:45.165249 [debug] [MainThread]: On master: COMMIT
[0m10:15:45.166535 [debug] [MainThread]: Using postgres connection "master"
[0m10:15:45.167964 [debug] [MainThread]: On master: COMMIT
[0m10:15:45.169628 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:15:45.170926 [debug] [MainThread]: On master: Close
[0m10:15:45.172263 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:15:45.173337 [debug] [MainThread]: Connection 'model.data_project_1.mart_air_quality_hourly' was properly closed.
[0m10:15:45.174791 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_daily' was properly closed.
[0m10:15:45.177494 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:15:45.178648 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_monthly' was properly closed.
[0m10:15:45.180058 [info ] [MainThread]: 
[0m10:15:45.181252 [info ] [MainThread]: Finished running 4 table models, 1 view model in 0 hours 0 minutes and 0.80 seconds (0.80s).
[0m10:15:45.182966 [debug] [MainThread]: Command end result
[0m10:15:45.304960 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:15:45.328045 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:15:45.345629 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:15:45.347256 [info ] [MainThread]: 
[0m10:15:45.348794 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:15:45.350181 [info ] [MainThread]: 
[0m10:15:45.354736 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=5
[0m10:15:45.357566 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 3.7730787, "process_in_blocks": "0", "process_kernel_time": 0.588821, "process_mem_max_rss": "133208", "process_out_blocks": "0", "process_user_time": 2.078901}
[0m10:15:45.360409 [debug] [MainThread]: Command `dbt run` succeeded at 10:15:45.360276 after 3.78 seconds
[0m10:15:45.361891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b683ffaae50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b683ffaadd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b684005b810>]}
[0m10:15:45.363087 [debug] [MainThread]: Flushing usage events
[0m10:15:45.871406 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m10:16:48.154085 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7356a4fc6910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7356a4f72bd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7356a53e35d0>]}


============================== 10:16:48.160340 | 6aa36375-282f-4490-997e-7534b53f56a7 ==============================
[0m10:16:48.160340 [info ] [MainThread]: Running with dbt=1.10.15
[0m10:16:48.161465 [debug] [MainThread]: running dbt with arguments {'write_json': 'True', 'profiles_dir': '/usr/app/dbt/dbt', 'cache_selected_only': 'False', 'send_anonymous_usage_stats': 'True', 'indirect_selection': 'eager', 'quiet': 'False', 'no_print': 'None', 'introspect': 'True', 'printer_width': '80', 'partial_parse': 'True', 'log_path': '/usr/app/dbt/dbt/logs', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'target_path': 'None', 'log_cache_events': 'False', 'invocation_command': 'dbt run', 'empty': 'False', 'log_format': 'default', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'static_parser': 'True', 'version_check': 'True'}
[0m10:16:48.296785 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6aa36375-282f-4490-997e-7534b53f56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7356a4f70910>]}
[0m10:16:48.361453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6aa36375-282f-4490-997e-7534b53f56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7356a3ff0990>]}
[0m10:16:48.363606 [info ] [MainThread]: Registered adapter: postgres=1.9.1
[0m10:16:48.526298 [debug] [MainThread]: checksum: 14a228079bd6df63ba81633f9a3cf44ecfaa31056ac397c602753ec895dbf885, vars: {}, profile: , target: , version: 1.10.15
[0m10:16:50.408113 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 3 files added, 0 files changed.
[0m10:16:50.410589 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/marts/mart_air_quality_daily.sql
[0m10:16:50.412181 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/marts/mart_air_quality_monthly.sql
[0m10:16:50.414191 [debug] [MainThread]: Partial parsing: added file: data_project_1://models/marts/schema.yml
[0m10:16:50.815144 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6aa36375-282f-4490-997e-7534b53f56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7356a27baf50>]}
[0m10:16:50.953198 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:16:50.964702 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:16:51.003213 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6aa36375-282f-4490-997e-7534b53f56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7356a6486350>]}
[0m10:16:51.004730 [info ] [MainThread]: Found 7 models, 2 data tests, 1 source, 738 macros
[0m10:16:51.007089 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6aa36375-282f-4490-997e-7534b53f56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7356a7ce0b90>]}
[0m10:16:51.010312 [info ] [MainThread]: 
[0m10:16:51.012249 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:16:51.013415 [info ] [MainThread]: 
[0m10:16:51.014617 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m10:16:51.019124 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_project_1'
[0m10:16:51.084500 [debug] [ThreadPool]: Using postgres connection "list_data_project_1"
[0m10:16:51.086438 [debug] [ThreadPool]: On list_data_project_1: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1"} */

    select distinct nspname from pg_namespace
  
[0m10:16:51.088191 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:16:51.110697 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.022 seconds
[0m10:16:51.113868 [debug] [ThreadPool]: On list_data_project_1: Close
[0m10:16:51.117577 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data_project_1, now list_data_project_1_public)
[0m10:16:51.124386 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:16:51.125887 [debug] [ThreadPool]: On list_data_project_1_public: BEGIN
[0m10:16:51.127278 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:16:51.138992 [debug] [ThreadPool]: SQL status: BEGIN in 0.011 seconds
[0m10:16:51.141206 [debug] [ThreadPool]: Using postgres connection "list_data_project_1_public"
[0m10:16:51.142696 [debug] [ThreadPool]: On list_data_project_1_public: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "list_data_project_1_public"} */
select
      'data_project_1' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_project_1' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m10:16:51.151350 [debug] [ThreadPool]: SQL status: SELECT 6 in 0.007 seconds
[0m10:16:51.153479 [debug] [ThreadPool]: On list_data_project_1_public: ROLLBACK
[0m10:16:51.155465 [debug] [ThreadPool]: On list_data_project_1_public: Close
[0m10:16:51.164427 [debug] [MainThread]: Using postgres connection "master"
[0m10:16:51.165659 [debug] [MainThread]: On master: BEGIN
[0m10:16:51.166479 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:16:51.179054 [debug] [MainThread]: SQL status: BEGIN in 0.012 seconds
[0m10:16:51.181047 [debug] [MainThread]: Using postgres connection "master"
[0m10:16:51.182556 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "connection_name": "master"} */
select distinct
        dependent_namespace.nspname as dependent_schema,
        dependent_class.relname as dependent_name,
        referenced_namespace.nspname as referenced_schema,
        referenced_class.relname as referenced_name

    -- Query for views: views are entries in pg_class with an entry in pg_rewrite, but we avoid
    -- a seq scan on pg_rewrite by leveraging the fact there is an "internal" row in pg_depend for
    -- the view...
    from pg_class as dependent_class
    join pg_namespace as dependent_namespace on dependent_namespace.oid = dependent_class.relnamespace
    join pg_depend as dependent_depend on dependent_depend.refobjid = dependent_class.oid
        and dependent_depend.classid = 'pg_rewrite'::regclass
        and dependent_depend.refclassid = 'pg_class'::regclass
        and dependent_depend.deptype = 'i'

    -- ... and via pg_depend (that has a row per column, hence the need for "distinct" above, and
    -- making sure to exclude the internal row to avoid a view appearing to depend on itself)...
    join pg_depend as joining_depend on joining_depend.objid = dependent_depend.objid
        and joining_depend.classid = 'pg_rewrite'::regclass
        and joining_depend.refclassid = 'pg_class'::regclass
        and joining_depend.refobjid != dependent_depend.refobjid

    -- ... we can find the tables they query from in pg_class, but excluding system tables. Note we
    -- don't need need to exclude _dependent_ system tables, because they only query from other
    -- system tables, and so are automatically excluded by excluding _referenced_ system tables
    join pg_class as referenced_class on referenced_class.oid = joining_depend.refobjid
    join pg_namespace as referenced_namespace on referenced_namespace.oid = referenced_class.relnamespace
        and referenced_namespace.nspname != 'information_schema'
        and referenced_namespace.nspname not like 'pg\_%'

    order by
        dependent_schema, dependent_name, referenced_schema, referenced_name;
[0m10:16:51.195852 [debug] [MainThread]: SQL status: SELECT 1 in 0.011 seconds
[0m10:16:51.199522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6aa36375-282f-4490-997e-7534b53f56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73567b9a7a10>]}
[0m10:16:51.201188 [debug] [MainThread]: On master: ROLLBACK
[0m10:16:51.202930 [debug] [MainThread]: Using postgres connection "master"
[0m10:16:51.204423 [debug] [MainThread]: On master: BEGIN
[0m10:16:51.206714 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m10:16:51.208308 [debug] [MainThread]: On master: COMMIT
[0m10:16:51.209777 [debug] [MainThread]: Using postgres connection "master"
[0m10:16:51.211041 [debug] [MainThread]: On master: COMMIT
[0m10:16:51.212557 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:16:51.214118 [debug] [MainThread]: On master: Close
[0m10:16:51.223433 [debug] [Thread-1 (]: Began running node model.data_project_1.stg_air_quality_valencia
[0m10:16:51.225646 [info ] [Thread-1 (]: 1 of 7 START sql view model public.stg_air_quality_valencia .................... [RUN]
[0m10:16:51.227572 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data_project_1_public, now model.data_project_1.stg_air_quality_valencia)
[0m10:16:51.229216 [debug] [Thread-1 (]: Began compiling node model.data_project_1.stg_air_quality_valencia
[0m10:16:51.249126 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.stg_air_quality_valencia"
[0m10:16:51.264580 [debug] [Thread-1 (]: Began executing node model.data_project_1.stg_air_quality_valencia
[0m10:16:51.287989 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.stg_air_quality_valencia"
[0m10:16:51.301564 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:16:51.302662 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: BEGIN
[0m10:16:51.303679 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:16:51.316580 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m10:16:51.318585 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:16:51.320405 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */

  create view "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp"
    
    
  as (
    -- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias. 
--1) DESPIVOTEAMOS:
--La tabla fuente(estaciones) tiene un formato ancho (wide), donde cada contaminante es una columna separada (so2, no2 ...)
--Necesitamos calcular promedios de forma genÃ©rica para cualquier contaminante, de modo que necesitamos un formato ancho (long) donde los contaminantes se apilan en filas. Esto lo conseguimos utilizando los UNION ALL.
-- Toma los datos directamente de la tabla fuente (estaciones) y los prepara para que se puedan consumir de forma sencilla en las capas intermedias.
WITH raw_data AS (
    SELECT
        objectid,
        nombre,
        direccion,
        tipozona,
        fecha_carg,
        so2,
        no2,
        o3,
        co,
        pm10,
        pm25,
        lon,
        lat
    FROM "data_project_1"."public"."estaciones"
),

unpivoted_data AS (

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'SO2' AS pollutant_type,
        so2 AS concentration_ug_m3
    FROM raw_data
    WHERE so2 IS NOT NULL AND so2 >= 0 AND so2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'NO2' AS pollutant_type,
        no2 AS concentration_ug_m3
    FROM raw_data
    WHERE no2 IS NOT NULL AND no2 >= 0 AND no2 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'O3' AS pollutant_type,
        o3 AS concentration_ug_m3
    FROM raw_data
    WHERE o3 IS NOT NULL AND o3 >= 0 AND o3 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'CO' AS pollutant_type,
        co AS concentration_ug_m3
    FROM raw_data
    WHERE co IS NOT NULL AND co >= 0 AND co < 50

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM10' AS pollutant_type,
        pm10 AS concentration_ug_m3
    FROM raw_data
    WHERE pm10 IS NOT NULL AND pm10 >= 0 AND pm10 < 1000

    UNION ALL

    SELECT
        objectid AS location_id,
        nombre AS station_name,
        direccion AS station_address,
        tipozona AS zona_type,
        lon,
        lat,
        fecha_carg AS measurement_timestamp,
        'PM25' AS pollutant_type,
        pm25 AS concentration_ug_m3
    FROM raw_data
    WHERE pm25 IS NOT NULL AND pm25 >= 0 AND pm25 < 1000
)

SELECT
    md5(cast(coalesce(cast(measurement_timestamp as TEXT), '') || '-' || coalesce(cast(location_id as TEXT), '') || '-' || coalesce(cast(pollutant_type as TEXT), '') as TEXT)) AS air_quality_pk,
    location_id,
    station_name,
    station_address,
    zona_type,
    measurement_timestamp,
    lon AS longitude,
    lat AS latitude,
    pollutant_type,
    concentration_ug_m3,
    CASE
        WHEN pollutant_type IN ('PM10', 'PM25') THEN 'Particulates'
        WHEN pollutant_type IN ('NO2', 'SO2') THEN 'Gases_InorgÃ¡nicos'
        WHEN pollutant_type IN ('O3', 'CO') THEN 'Gases_MonÃ³xido'
        ELSE 'Otro'
    END AS pollutant_category
FROM unpivoted_data
WHERE concentration_ug_m3 >= 0
  );
[0m10:16:51.341367 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.019 seconds
[0m10:16:51.350596 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:16:51.352155 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia" rename to "stg_air_quality_valencia__dbt_backup"
[0m10:16:51.354468 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:16:51.360419 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:16:51.361949 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
alter table "data_project_1"."public"."stg_air_quality_valencia__dbt_tmp" rename to "stg_air_quality_valencia"
[0m10:16:51.365986 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m10:16:51.383494 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:16:51.385586 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:16:51.386876 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: COMMIT
[0m10:16:51.392439 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m10:16:51.402315 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."stg_air_quality_valencia__dbt_backup"
[0m10:16:51.411900 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.stg_air_quality_valencia"
[0m10:16:51.413779 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.stg_air_quality_valencia"} */
drop view if exists "data_project_1"."public"."stg_air_quality_valencia__dbt_backup" cascade
[0m10:16:51.419205 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m10:16:51.422430 [debug] [Thread-1 (]: On model.data_project_1.stg_air_quality_valencia: Close
[0m10:16:51.426819 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6aa36375-282f-4490-997e-7534b53f56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73567adf4b10>]}
[0m10:16:51.429105 [info ] [Thread-1 (]: 1 of 7 OK created sql view model public.stg_air_quality_valencia ............... [[32mCREATE VIEW[0m in 0.20s]
[0m10:16:51.430875 [debug] [Thread-1 (]: Finished running node model.data_project_1.stg_air_quality_valencia
[0m10:16:51.432692 [debug] [Thread-3 (]: Began running node model.data_project_1.int_air_quality_daily
[0m10:16:51.433364 [debug] [Thread-4 (]: Began running node model.data_project_1.int_air_quality_hourly
[0m10:16:51.433786 [debug] [Thread-2 (]: Began running node model.data_project_1.int_air_quality_monthly
[0m10:16:51.434492 [info ] [Thread-3 (]: 2 of 7 START sql table model public.int_air_quality_daily ...................... [RUN]
[0m10:16:51.435602 [info ] [Thread-4 (]: 3 of 7 START sql table model public.int_air_quality_hourly ..................... [RUN]
[0m10:16:51.437373 [info ] [Thread-2 (]: 4 of 7 START sql table model public.int_air_quality_monthly .................... [RUN]
[0m10:16:51.439454 [debug] [Thread-3 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_daily'
[0m10:16:51.441207 [debug] [Thread-4 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_hourly'
[0m10:16:51.443393 [debug] [Thread-2 (]: Acquiring new postgres connection 'model.data_project_1.int_air_quality_monthly'
[0m10:16:51.445232 [debug] [Thread-3 (]: Began compiling node model.data_project_1.int_air_quality_daily
[0m10:16:51.446946 [debug] [Thread-4 (]: Began compiling node model.data_project_1.int_air_quality_hourly
[0m10:16:51.448491 [debug] [Thread-2 (]: Began compiling node model.data_project_1.int_air_quality_monthly
[0m10:16:51.452536 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_daily"
[0m10:16:51.456148 [debug] [Thread-4 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_hourly"
[0m10:16:51.461302 [debug] [Thread-2 (]: Writing injected SQL for node "model.data_project_1.int_air_quality_monthly"
[0m10:16:51.469828 [debug] [Thread-3 (]: Began executing node model.data_project_1.int_air_quality_daily
[0m10:16:51.470270 [debug] [Thread-4 (]: Began executing node model.data_project_1.int_air_quality_hourly
[0m10:16:51.477030 [debug] [Thread-2 (]: Began executing node model.data_project_1.int_air_quality_monthly
[0m10:16:51.497757 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_daily"
[0m10:16:51.501636 [debug] [Thread-4 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_hourly"
[0m10:16:51.507286 [debug] [Thread-2 (]: Writing runtime sql for node "model.data_project_1.int_air_quality_monthly"
[0m10:16:51.518726 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:16:51.519565 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:16:51.521690 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: BEGIN
[0m10:16:51.523003 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:16:51.524149 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: BEGIN
[0m10:16:51.526256 [debug] [Thread-2 (]: Opening a new connection, currently in state init
[0m10:16:51.528471 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: BEGIN
[0m10:16:51.530360 [debug] [Thread-3 (]: Opening a new connection, currently in state init
[0m10:16:51.534672 [debug] [Thread-4 (]: Opening a new connection, currently in state init
[0m10:16:51.547282 [debug] [Thread-2 (]: SQL status: BEGIN in 0.021 seconds
[0m10:16:51.548684 [debug] [Thread-3 (]: SQL status: BEGIN in 0.018 seconds
[0m10:16:51.549266 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:16:51.551118 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:16:51.553178 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_monthly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('month', measurement_timestamp) AS measurement_month,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

monthly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_month,
        AVG(concentration_ug_m3) AS avg_monthly,
        MAX(concentration_ug_m3) AS max_monthly,
        MIN(concentration_ug_m3) AS min_monthly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_month
),

variation AS (
    SELECT
        monthly.*,
        avg_monthly 
            - LAG(avg_monthly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_month
            ) AS variation_vs_prev_month
    FROM monthly
)

SELECT *
FROM variation
  );
  
[0m10:16:51.554759 [debug] [Thread-4 (]: SQL status: BEGIN in 0.020 seconds
[0m10:16:51.555479 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('day', measurement_timestamp) AS measurement_day,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

daily AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_day,
        AVG(concentration_ug_m3) AS avg_daily,
        MAX(concentration_ug_m3) AS max_daily,
        MIN(concentration_ug_m3) AS min_daily,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id, 
        station_name, 
        pollutant_type, 
        measurement_day
),

variation AS (
    SELECT
        *,
        avg_daily - LAG(avg_daily) OVER (
            PARTITION BY location_id, pollutant_type
            ORDER BY measurement_day
        ) AS variation_vs_prev_day
    FROM daily
)

SELECT *
FROM variation
  );
  
[0m10:16:51.558608 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:16:51.561767 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

WITH base AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        DATE_TRUNC('hour', measurement_timestamp) AS measurement_hour,
        concentration_ug_m3
    FROM "data_project_1"."public"."stg_air_quality_valencia"
),

hourly AS (
    SELECT
        location_id,
        station_name,
        pollutant_type,
        measurement_hour,
        AVG(concentration_ug_m3) AS avg_hourly,
        MAX(concentration_ug_m3) AS max_hourly,
        MIN(concentration_ug_m3) AS min_hourly,
        COUNT(*) AS num_measurements
    FROM base
    GROUP BY 
        location_id,
        station_name,
        pollutant_type,
        measurement_hour
),

variation AS (
    SELECT
        hourly.*,
        avg_hourly 
            - LAG(avg_hourly) OVER (
                PARTITION BY location_id, pollutant_type
                ORDER BY measurement_hour
            ) AS variation_vs_prev_hour
    FROM hourly
)

SELECT *
FROM variation
  );
  
[0m10:16:51.576102 [debug] [Thread-2 (]: SQL status: SELECT 44 in 0.019 seconds
[0m10:16:51.585031 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:16:51.585559 [debug] [Thread-3 (]: SQL status: SELECT 132 in 0.025 seconds
[0m10:16:51.586051 [debug] [Thread-4 (]: SQL status: SELECT 572 in 0.022 seconds
[0m10:16:51.586785 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */
alter table "data_project_1"."public"."int_air_quality_monthly" rename to "int_air_quality_monthly__dbt_backup"
[0m10:16:51.589754 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:16:51.594130 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:16:51.596625 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:16:51.597118 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily" rename to "int_air_quality_daily__dbt_backup"
[0m10:16:51.598056 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly" rename to "int_air_quality_hourly__dbt_backup"
[0m10:16:51.600833 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:16:51.603148 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:16:51.603907 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:16:51.605224 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */
alter table "data_project_1"."public"."int_air_quality_monthly__dbt_tmp" rename to "int_air_quality_monthly"
[0m10:16:51.610730 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:16:51.614542 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:16:51.616630 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
alter table "data_project_1"."public"."int_air_quality_daily__dbt_tmp" rename to "int_air_quality_daily"
[0m10:16:51.616962 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:16:51.617931 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
alter table "data_project_1"."public"."int_air_quality_hourly__dbt_tmp" rename to "int_air_quality_hourly"
[0m10:16:51.621466 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: COMMIT
[0m10:16:51.622180 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.003 seconds
[0m10:16:51.624458 [debug] [Thread-4 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:16:51.624929 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:16:51.628033 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:16:51.631466 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:16:51.633003 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: COMMIT
[0m10:16:51.634235 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:16:51.635600 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:16:51.637602 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: COMMIT
[0m10:16:51.638756 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: COMMIT
[0m10:16:51.641553 [debug] [Thread-2 (]: SQL status: COMMIT in 0.005 seconds
[0m10:16:51.642570 [debug] [Thread-3 (]: SQL status: COMMIT in 0.002 seconds
[0m10:16:51.646935 [debug] [Thread-2 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_monthly__dbt_backup"
[0m10:16:51.647446 [debug] [Thread-4 (]: SQL status: COMMIT in 0.004 seconds
[0m10:16:51.651384 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_daily__dbt_backup"
[0m10:16:51.654894 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.int_air_quality_monthly"
[0m10:16:51.658492 [debug] [Thread-4 (]: Applying DROP to: "data_project_1"."public"."int_air_quality_hourly__dbt_backup"
[0m10:16:51.660345 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.int_air_quality_daily"
[0m10:16:51.661777 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_monthly"} */
drop table if exists "data_project_1"."public"."int_air_quality_monthly__dbt_backup" cascade
[0m10:16:51.663334 [debug] [Thread-4 (]: Using postgres connection "model.data_project_1.int_air_quality_hourly"
[0m10:16:51.664547 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_daily"} */
drop table if exists "data_project_1"."public"."int_air_quality_daily__dbt_backup" cascade
[0m10:16:51.667043 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.int_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."int_air_quality_hourly__dbt_backup" cascade
[0m10:16:51.672801 [debug] [Thread-2 (]: SQL status: DROP TABLE in 0.007 seconds
[0m10:16:51.674549 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.006 seconds
[0m10:16:51.677074 [debug] [Thread-4 (]: SQL status: DROP TABLE in 0.006 seconds
[0m10:16:51.678799 [debug] [Thread-2 (]: On model.data_project_1.int_air_quality_monthly: Close
[0m10:16:51.680997 [debug] [Thread-3 (]: On model.data_project_1.int_air_quality_daily: Close
[0m10:16:51.682944 [debug] [Thread-4 (]: On model.data_project_1.int_air_quality_hourly: Close
[0m10:16:51.684702 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6aa36375-282f-4490-997e-7534b53f56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73567adf64d0>]}
[0m10:16:51.685815 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6aa36375-282f-4490-997e-7534b53f56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73567ade9110>]}
[0m10:16:51.687298 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6aa36375-282f-4490-997e-7534b53f56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73567849bdd0>]}
[0m10:16:51.688780 [info ] [Thread-2 (]: 4 of 7 OK created sql table model public.int_air_quality_monthly ............... [[32mSELECT 44[0m in 0.24s]
[0m10:16:51.690405 [info ] [Thread-3 (]: 2 of 7 OK created sql table model public.int_air_quality_daily ................. [[32mSELECT 132[0m in 0.25s]
[0m10:16:51.693025 [info ] [Thread-4 (]: 3 of 7 OK created sql table model public.int_air_quality_hourly ................ [[32mSELECT 572[0m in 0.25s]
[0m10:16:51.694716 [debug] [Thread-2 (]: Finished running node model.data_project_1.int_air_quality_monthly
[0m10:16:51.696183 [debug] [Thread-3 (]: Finished running node model.data_project_1.int_air_quality_daily
[0m10:16:51.697480 [debug] [Thread-4 (]: Finished running node model.data_project_1.int_air_quality_hourly
[0m10:16:51.699153 [debug] [Thread-1 (]: Began running node model.data_project_1.mart_air_quality_monthly
[0m10:16:51.700469 [debug] [Thread-2 (]: Began running node model.data_project_1.mart_air_quality_daily
[0m10:16:51.701634 [debug] [Thread-3 (]: Began running node model.data_project_1.mart_air_quality_hourly
[0m10:16:51.702484 [info ] [Thread-1 (]: 5 of 7 START sql table model public.mart_air_quality_monthly ................... [RUN]
[0m10:16:51.703570 [info ] [Thread-2 (]: 6 of 7 START sql table model public.mart_air_quality_daily ..................... [RUN]
[0m10:16:51.704731 [info ] [Thread-3 (]: 7 of 7 START sql table model public.mart_air_quality_hourly .................... [RUN]
[0m10:16:51.705932 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.data_project_1.stg_air_quality_valencia, now model.data_project_1.mart_air_quality_monthly)
[0m10:16:51.707198 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.data_project_1.int_air_quality_monthly, now model.data_project_1.mart_air_quality_daily)
[0m10:16:51.709006 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly model.data_project_1.int_air_quality_daily, now model.data_project_1.mart_air_quality_hourly)
[0m10:16:51.710264 [debug] [Thread-1 (]: Began compiling node model.data_project_1.mart_air_quality_monthly
[0m10:16:51.711866 [debug] [Thread-2 (]: Began compiling node model.data_project_1.mart_air_quality_daily
[0m10:16:51.713480 [debug] [Thread-3 (]: Began compiling node model.data_project_1.mart_air_quality_hourly
[0m10:16:51.718732 [debug] [Thread-1 (]: Writing injected SQL for node "model.data_project_1.mart_air_quality_monthly"
[0m10:16:51.722328 [debug] [Thread-2 (]: Writing injected SQL for node "model.data_project_1.mart_air_quality_daily"
[0m10:16:51.727110 [debug] [Thread-3 (]: Writing injected SQL for node "model.data_project_1.mart_air_quality_hourly"
[0m10:16:51.734090 [debug] [Thread-1 (]: Began executing node model.data_project_1.mart_air_quality_monthly
[0m10:16:51.738046 [debug] [Thread-1 (]: Writing runtime sql for node "model.data_project_1.mart_air_quality_monthly"
[0m10:16:51.740485 [debug] [Thread-2 (]: Began executing node model.data_project_1.mart_air_quality_daily
[0m10:16:51.745701 [debug] [Thread-2 (]: Writing runtime sql for node "model.data_project_1.mart_air_quality_daily"
[0m10:16:51.746113 [debug] [Thread-3 (]: Began executing node model.data_project_1.mart_air_quality_hourly
[0m10:16:51.751602 [debug] [Thread-3 (]: Writing runtime sql for node "model.data_project_1.mart_air_quality_hourly"
[0m10:16:51.754930 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.mart_air_quality_monthly"
[0m10:16:51.757100 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_monthly: BEGIN
[0m10:16:51.757649 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.mart_air_quality_daily"
[0m10:16:51.758782 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m10:16:51.760507 [debug] [Thread-2 (]: On model.data_project_1.mart_air_quality_daily: BEGIN
[0m10:16:51.762133 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.mart_air_quality_hourly"
[0m10:16:51.763227 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m10:16:51.764289 [debug] [Thread-3 (]: On model.data_project_1.mart_air_quality_hourly: BEGIN
[0m10:16:51.766173 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m10:16:51.769366 [debug] [Thread-1 (]: SQL status: BEGIN in 0.010 seconds
[0m10:16:51.770627 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.mart_air_quality_monthly"
[0m10:16:51.771715 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.mart_air_quality_monthly"} */

  
    

  create  table "data_project_1"."public"."mart_air_quality_monthly__dbt_tmp"
  
  
    as
  
  (
    

SELECT
    location_id,
    station_name,
    pollutant_type,
    measurement_month,
    avg_monthly,
    max_monthly,
    min_monthly,
    num_measurements,
    variation_vs_prev_month
FROM "data_project_1"."public"."int_air_quality_monthly"
  );
  
[0m10:16:51.772158 [debug] [Thread-2 (]: SQL status: BEGIN in 0.009 seconds
[0m10:16:51.774280 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.mart_air_quality_daily"
[0m10:16:51.775522 [debug] [Thread-3 (]: SQL status: BEGIN in 0.009 seconds
[0m10:16:51.776472 [debug] [Thread-2 (]: On model.data_project_1.mart_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.mart_air_quality_daily"} */

  
    

  create  table "data_project_1"."public"."mart_air_quality_daily__dbt_tmp"
  
  
    as
  
  (
    

SELECT
    location_id,
    station_name,
    pollutant_type,
    measurement_day,
    avg_daily,
    max_daily,
    min_daily,
    num_measurements,
    variation_vs_prev_day
FROM "data_project_1"."public"."int_air_quality_daily"
--Este mart proporciona un resumen diario de las mediciones de calidad del aire, incluyendo promedios, mÃ¡ximos, mÃ­nimos y variaciones respecto al dÃ­a anterior. Es Ãºtil para anÃ¡lisis diarios y reportes de cumplimiento.
  );
  
[0m10:16:51.777506 [debug] [Thread-1 (]: SQL status: SELECT 44 in 0.004 seconds
[0m10:16:51.778226 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.mart_air_quality_hourly"
[0m10:16:51.784598 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.mart_air_quality_monthly"
[0m10:16:51.784989 [debug] [Thread-2 (]: SQL status: SELECT 132 in 0.006 seconds
[0m10:16:51.785901 [debug] [Thread-3 (]: On model.data_project_1.mart_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.mart_air_quality_hourly"} */

  
    

  create  table "data_project_1"."public"."mart_air_quality_hourly__dbt_tmp"
  
  
    as
  
  (
    

SELECT
    location_id,
    station_name,
    pollutant_type,
    measurement_hour,
    avg_hourly,
    max_hourly,
    min_hourly,
    num_measurements,
    variation_vs_prev_hour
FROM "data_project_1"."public"."int_air_quality_hourly"
--Este mart proporciona un resumen horario de las mediciones de calidad del aire, incluyendo promedios, mÃ¡ximos, mÃ­nimos y variaciones respecto a la hora anterior. Es Ãºtil para anÃ¡lisis detallados y monitoreo en tiempo real.
  );
  
[0m10:16:51.786866 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.mart_air_quality_monthly"} */
alter table "data_project_1"."public"."mart_air_quality_monthly__dbt_tmp" rename to "mart_air_quality_monthly"
[0m10:16:51.790869 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.mart_air_quality_daily"
[0m10:16:51.793934 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:16:51.794854 [debug] [Thread-2 (]: On model.data_project_1.mart_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.mart_air_quality_daily"} */
alter table "data_project_1"."public"."mart_air_quality_daily__dbt_tmp" rename to "mart_air_quality_daily"
[0m10:16:51.797489 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_monthly: COMMIT
[0m10:16:51.797883 [debug] [Thread-3 (]: SQL status: SELECT 572 in 0.006 seconds
[0m10:16:51.799268 [debug] [Thread-2 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:16:51.799582 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.mart_air_quality_monthly"
[0m10:16:51.803235 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.mart_air_quality_hourly"
[0m10:16:51.805381 [debug] [Thread-2 (]: On model.data_project_1.mart_air_quality_daily: COMMIT
[0m10:16:51.806567 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_monthly: COMMIT
[0m10:16:51.807596 [debug] [Thread-3 (]: On model.data_project_1.mart_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.mart_air_quality_hourly"} */
alter table "data_project_1"."public"."mart_air_quality_hourly" rename to "mart_air_quality_hourly__dbt_backup"
[0m10:16:51.808898 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.mart_air_quality_daily"
[0m10:16:51.811622 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:16:51.812207 [debug] [Thread-2 (]: On model.data_project_1.mart_air_quality_daily: COMMIT
[0m10:16:51.812692 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m10:16:51.816128 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.mart_air_quality_hourly"
[0m10:16:51.820142 [debug] [Thread-1 (]: Applying DROP to: "data_project_1"."public"."mart_air_quality_monthly__dbt_backup"
[0m10:16:51.820496 [debug] [Thread-2 (]: SQL status: COMMIT in 0.003 seconds
[0m10:16:51.821296 [debug] [Thread-3 (]: On model.data_project_1.mart_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.mart_air_quality_hourly"} */
alter table "data_project_1"."public"."mart_air_quality_hourly__dbt_tmp" rename to "mart_air_quality_hourly"
[0m10:16:51.822796 [debug] [Thread-1 (]: Using postgres connection "model.data_project_1.mart_air_quality_monthly"
[0m10:16:51.827184 [debug] [Thread-2 (]: Applying DROP to: "data_project_1"."public"."mart_air_quality_daily__dbt_backup"
[0m10:16:51.829251 [debug] [Thread-3 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m10:16:51.830086 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_monthly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.mart_air_quality_monthly"} */
drop table if exists "data_project_1"."public"."mart_air_quality_monthly__dbt_backup" cascade
[0m10:16:51.831263 [debug] [Thread-2 (]: Using postgres connection "model.data_project_1.mart_air_quality_daily"
[0m10:16:51.833190 [debug] [Thread-3 (]: On model.data_project_1.mart_air_quality_hourly: COMMIT
[0m10:16:51.834671 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.001 seconds
[0m10:16:51.835209 [debug] [Thread-2 (]: On model.data_project_1.mart_air_quality_daily: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.mart_air_quality_daily"} */
drop table if exists "data_project_1"."public"."mart_air_quality_daily__dbt_backup" cascade
[0m10:16:51.836558 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.mart_air_quality_hourly"
[0m10:16:51.838753 [debug] [Thread-1 (]: On model.data_project_1.mart_air_quality_monthly: Close
[0m10:16:51.841189 [debug] [Thread-2 (]: SQL status: DROP TABLE in 0.001 seconds
[0m10:16:51.842185 [debug] [Thread-3 (]: On model.data_project_1.mart_air_quality_hourly: COMMIT
[0m10:16:51.843973 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6aa36375-282f-4490-997e-7534b53f56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73567849bc10>]}
[0m10:16:51.845889 [debug] [Thread-2 (]: On model.data_project_1.mart_air_quality_daily: Close
[0m10:16:51.848304 [info ] [Thread-1 (]: 5 of 7 OK created sql table model public.mart_air_quality_monthly .............. [[32mSELECT 44[0m in 0.14s]
[0m10:16:51.848673 [debug] [Thread-3 (]: SQL status: COMMIT in 0.002 seconds
[0m10:16:51.849828 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6aa36375-282f-4490-997e-7534b53f56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73567ad92410>]}
[0m10:16:51.850820 [debug] [Thread-1 (]: Finished running node model.data_project_1.mart_air_quality_monthly
[0m10:16:51.853716 [debug] [Thread-3 (]: Applying DROP to: "data_project_1"."public"."mart_air_quality_hourly__dbt_backup"
[0m10:16:51.854944 [info ] [Thread-2 (]: 6 of 7 OK created sql table model public.mart_air_quality_daily ................ [[32mSELECT 132[0m in 0.14s]
[0m10:16:51.857537 [debug] [Thread-3 (]: Using postgres connection "model.data_project_1.mart_air_quality_hourly"
[0m10:16:51.858922 [debug] [Thread-2 (]: Finished running node model.data_project_1.mart_air_quality_daily
[0m10:16:51.860220 [debug] [Thread-3 (]: On model.data_project_1.mart_air_quality_hourly: /* {"app": "dbt", "dbt_version": "1.10.15", "profile_name": "data_project_1", "target_name": "dev", "node_id": "model.data_project_1.mart_air_quality_hourly"} */
drop table if exists "data_project_1"."public"."mart_air_quality_hourly__dbt_backup" cascade
[0m10:16:51.868763 [debug] [Thread-3 (]: SQL status: DROP TABLE in 0.006 seconds
[0m10:16:51.871288 [debug] [Thread-3 (]: On model.data_project_1.mart_air_quality_hourly: Close
[0m10:16:51.873045 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6aa36375-282f-4490-997e-7534b53f56a7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73567849bc50>]}
[0m10:16:51.874535 [info ] [Thread-3 (]: 7 of 7 OK created sql table model public.mart_air_quality_hourly ............... [[32mSELECT 572[0m in 0.16s]
[0m10:16:51.876069 [debug] [Thread-3 (]: Finished running node model.data_project_1.mart_air_quality_hourly
[0m10:16:51.879256 [debug] [MainThread]: Using postgres connection "master"
[0m10:16:51.880762 [debug] [MainThread]: On master: BEGIN
[0m10:16:51.882019 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:16:51.889638 [debug] [MainThread]: SQL status: BEGIN in 0.008 seconds
[0m10:16:51.891234 [debug] [MainThread]: On master: COMMIT
[0m10:16:51.892638 [debug] [MainThread]: Using postgres connection "master"
[0m10:16:51.893652 [debug] [MainThread]: On master: COMMIT
[0m10:16:51.895112 [debug] [MainThread]: SQL status: COMMIT in 0.000 seconds
[0m10:16:51.898366 [debug] [MainThread]: On master: Close
[0m10:16:51.899836 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:16:51.903767 [debug] [MainThread]: Connection 'model.data_project_1.mart_air_quality_monthly' was properly closed.
[0m10:16:51.907467 [debug] [MainThread]: Connection 'model.data_project_1.mart_air_quality_hourly' was properly closed.
[0m10:16:51.909042 [debug] [MainThread]: Connection 'model.data_project_1.int_air_quality_hourly' was properly closed.
[0m10:16:51.910696 [debug] [MainThread]: Connection 'model.data_project_1.mart_air_quality_daily' was properly closed.
[0m10:16:51.912470 [info ] [MainThread]: 
[0m10:16:51.913917 [info ] [MainThread]: Finished running 6 table models, 1 view model in 0 hours 0 minutes and 0.90 seconds (0.90s).
[0m10:16:51.915933 [debug] [MainThread]: Command end result
[0m10:16:52.091656 [debug] [MainThread]: Wrote artifact WritableManifest to /usr/app/dbt/dbt/target/manifest.json
[0m10:16:52.100645 [debug] [MainThread]: Wrote artifact SemanticManifest to /usr/app/dbt/dbt/target/semantic_manifest.json
[0m10:16:52.112541 [debug] [MainThread]: Wrote artifact RunExecutionResult to /usr/app/dbt/dbt/target/run_results.json
[0m10:16:52.114123 [info ] [MainThread]: 
[0m10:16:52.115167 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:16:52.116175 [info ] [MainThread]: 
[0m10:16:52.117212 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=7
[0m10:16:52.118949 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 4.040474, "process_in_blocks": "0", "process_kernel_time": 0.647334, "process_mem_max_rss": "133872", "process_out_blocks": "0", "process_user_time": 2.743078}
[0m10:16:52.120360 [debug] [MainThread]: Command `dbt run` succeeded at 10:16:52.120222 after 4.04 seconds
[0m10:16:52.121604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7356a5300c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7356a97aaf10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7356a9857890>]}
[0m10:16:52.122454 [debug] [MainThread]: Flushing usage events
[0m10:16:52.794508 [debug] [MainThread]: An error was encountered while trying to flush usage events
